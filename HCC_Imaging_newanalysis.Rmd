---
title: "HCC_imaging_newanalysis"
author: "Shelley \"the bomb\" Facente and Steph \"the badass\" Holm"
date: "January 30, 2020"
output: pdf_document
---


```{r setup, include=FALSE}
library(tidyverse)
library(readxl)
library(skimr)
library(knitr)
library(xlsx)
library(lubridate)
library(MASS)
library(ggplot2)
library(ggpubr)
#library(Hmisc)

knitr::opts_chunk$set(include = FALSE, cache = TRUE)

# First, load the data
StephandShelleyDataLoad <- function(filename) 
{
  if(Sys.info()['sysname']=="Darwin"){
    
     read_excel(as.character(filename))}
  else{
    windowsfilepath <- paste("~/GitHub/stephandshelley/", filename, sep = "")
     read_excel(as.character(windowsfilepath))
  }
}

StephandShelleyDataLoad2 <- function(filename) 
{
  if(Sys.info()['sysname']=="Darwin"){
    
     load(as.character(filename))}
  else{
    windowsfilepath <- paste("~/GitHub/stephandshelley/", filename, sep = "")
     load(as.character(windowsfilepath))
  }
}

```


```{r Data_Cleaning, include = FALSE}

# HCVData <- StephandShelleyDataLoad("Deidentified Chronic HCV Dataset 11-21-19.xlsx")
# 
# #first just making variables their proper type, and renaming so there's no spaces
# HCVData$`Deidentifier  11-21-19` <-  as.factor(HCVData$`Deidentifier  11-21-19`)
# colnames(HCVData)[colnames(HCVData) == 'Deidentifier  11-21-19'] <- 'PtID'
# 
# HCVData$'Hep Visit?'<- as.factor(HCVData$'Hep Visit?')
# colnames(HCVData)[colnames(HCVData) == 'Hep Visit?'] <- 'EverHepVisit'
# 
# HCVData$'Ever Chronic HCV?' <- as.factor(HCVData$'Ever Chronic HCV?')
# colnames(HCVData)[colnames(HCVData) == 'Ever Chronic HCV?'] <- 'EverChronicHCV'
# 
# HCVData$'Spontaneous Clearance?' <- as.factor(HCVData$'Spontaneous Clearance?')
# colnames(HCVData)[colnames(HCVData) == 'Spontaneous Clearance?'] <- 'SpontClearance'
# 
# HCVData$'Ever Ab positive HCV?' <- as.factor(HCVData$'Ever Ab positive HCV?')
# colnames(HCVData)[colnames(HCVData) == 'Ever Ab positive HCV?'] <- 'EverAbPosHCV'
# 
# HCVData$'Ever Treated?'<- as.factor(HCVData$'Ever Treated?')
# colnames(HCVData)[colnames(HCVData) == 'Ever Treated?'] <- 'EverTreated'
# 
# HCVData$'Evidence of SVR?'<- as.factor(HCVData$'Evidence of SVR?')
# colnames(HCVData)[colnames(HCVData) == 'Evidence of SVR?'] <- 'SVRAchieved'
# 
# HCVData$'Treatment Definition' <- as.factor(HCVData$'Treatment Definition')
# colnames(HCVData)[colnames(HCVData) == 'Treatment Definition'] <- 'TreatmentDefinition'
# 
# HCVData$'DX_TYPE OR TEST_TYPE' <- as.factor(HCVData$'DX_TYPE OR TEST_TYPE')
# colnames(HCVData)[colnames(HCVData) == 'DX_TYPE OR TEST_TYPE'] <- 'inclusion.source'
# 
# HCVData$'DX_NAME OR TEST RESULT'<- as.factor(HCVData$'DX_NAME OR TEST RESULT')
# colnames(HCVData)[colnames(HCVData) == 'DX_NAME OR TEST RESULT'] <- 'inclusion.reason'
# 
# #Didn't do anything with the column 'ICD10 OR RESULT_DATE' because it's a mix of formats/info
# 
# colnames(HCVData)[colnames(HCVData) == 'SPECIMN TAKEN DATE'] <- 'date.first.pos.HCV.test'
# 
# HCVData$RESULT <- as.factor(HCVData$RESULT)
# colnames(HCVData)[colnames(HCVData) == 'RESULT'] <- 'HCV.test.result'
# 
# HCVData$'RNA EVER TESTED' <- as.factor(HCVData$'RNA EVER TESTED')
# colnames(HCVData)[colnames(HCVData) == 'RNA EVER TESTED'] <- 'RNAeverTested'
# 
# colnames(HCVData)[colnames(HCVData) == 'FIRST POS (Or if no POS, "SEE TEXT") RNA TEST DATE'] <- 'Date.First.Pos.RNA'
# 
# HCVData$'FIRST POS (Or if no POS, "SEE TEXT") RNA TEST RESULT' <- as.factor(HCVData$'FIRST POS (Or if no POS, "SEE TEXT") RNA TEST RESULT')
# colnames(HCVData)[colnames(HCVData) == 'FIRST POS (Or if no POS, "SEE TEXT") RNA TEST RESULT'] <- 'Result.First.Pos.RNA'
# 
# #Added this to address the "See Text" weirdness; I think "See Text" was inserted here when the test was undetectable or lab error, etc. ##### MAY WANT TO REMOVE IF NUMERIC PREFERRED
# ##Note from Steph- it's not undetectable/lab error, it's just that for a number of years, they used this as a way to 'hide' results so that people in someone's chart inadvertantly didn't see sensitive test results. It was sort of a weird thing and they eventually dropped it. But that's why it's there. Right now though this is erroring over the RNA.interpretation column so I've commented it out.
# #HCVData$Result.First.Pos.RNA <- ifelse(HCVData$Result.First.Pos.RNA == 'See Text', HCVData$RNA.interpretation, HCVData$Result.First.Pos.RNA)
# 
# colnames(HCVData)[colnames(HCVData) == 'MOST RECENT RNA POS'] <- 'Most.Recent.RNA.Pos'
# 
# colnames(HCVData)[colnames(HCVData) == 'MOST RECENT RNA NEG'] <- 'Most.Recent.RNA.Neg'
# 
# #This column is in the midst of the RNA testing section but is unlabeled. It's a date.
# colnames(HCVData)[colnames(HCVData) == '..19'] <- 'UnknownColumn'
# 
# colnames(HCVData)[colnames(HCVData) == 'MOST RECENT RNA "SEE TEXT"'] <- 'Most.Recent.RNA.SeeText'
# 
# colnames(HCVData)[colnames(HCVData) == 'RNA interpretation'] <- 'RNA.interpretation'
# 
# colnames(HCVData)[colnames(HCVData) == 'other notes on diagnosis'] <- 'Notes'
# 
# HCVData$'Where getting care' <- as.factor(HCVData$'Where getting care')
# colnames(HCVData)[colnames(HCVData) == 'Where getting care'] <- 'Care.Location'
# 
# #This errors because there are a number of non-dates in this column. Should discuss with Rena if using.
# #HCVData$'HEP C GENOTYPE DATE' <- as.POSIXct(HCVData$'HEP C GENOTYPE DATE')
# #colnames(HCVData)[colnames(HCVData) == 'HEP C GENOTYPE DATE'] <- 'HCV.Genotype.Date'
# 
# HCVData$'HEP C GENOTYPE RESULT' <- as.factor(HCVData$'HEP C GENOTYPE RESULT')
# colnames(HCVData)[colnames(HCVData) == 'HEP C GENOTYPE RESULT'] <- 'HCV.Genotype.Result'
# 
# colnames(HCVData)[colnames(HCVData) == 'ALPHAFETOPROTEIN_RESULT_DATE'] <- 'AFP.Date'
# 
# colnames(HCVData)[colnames(HCVData) == 'ALPHAFETOPROTEIN_RESULT'] <- 'AFP.Result'
# 
# colnames(HCVData)[colnames(HCVData) == 'FIRST_HEPATOLOGY_APPT'] <- 'First.Hep.Appt'
# 
# colnames(HCVData)[colnames(HCVData) == 'MOST_RECENT_HEPATOLOGY_APPT'] <- 'Most.Recent.Hep.Appt'
# 
# colnames(HCVData)[colnames(HCVData) == 'PLATLET_RESULT_DATE'] <- 'Lowest.Platelet.Date'
# 
# colnames(HCVData)[colnames(HCVData) == 'LOWEST_PLATELETS_RESULT'] <- 'Lowest.Platelet.Result'
# 
# colnames(HCVData)[colnames(HCVData) == 'HEPA_VACCINE_DATE'] <- 'HAV.Vax.Date'
# 
# colnames(HCVData)[colnames(HCVData) == 'HEPB_VACCINE_DATE'] <- 'HBV.Vax.Date'
# 
# HCVData$'Ever Had a Primary Care Visit' <- as.factor(HCVData$'Ever Had a Primary Care Visit')
# colnames(HCVData)[colnames(HCVData) == 'Ever Had a Primary Care Visit'] <- 'EverPrimaryCareVisit'
# 
# HCVData$'DEPT_NAME' <- as.factor(HCVData$'DEPT_NAME')
# 
# HCVData$'CURRENT_PCP' <- as.factor(HCVData$'CURRENT_PCP')
# 
# HCVData$'CURRENT_PCP_DEPT' <- as.factor(HCVData$'CURRENT_PCP_DEPT')
# 
# colnames(HCVData)[colnames(HCVData) == 'HBsAb_RESULT_DATE'] <- 'HBsAG.Date'
# 
# HCVData$'HBsAb_ORD_VALUE' <- as.factor(HCVData$'HBsAb_ORD_VALUE')
# colnames(HCVData)[colnames(HCVData) == 'HBsAb_ORD_VALUE'] <- 'HBsAb.Result'
# 
# colnames(HCVData)[colnames(HCVData) == 'HIV_RESULT_DATE'] <- 'HIV.Date'
# 
# HCVData$'ORD_VALUE' <- as.factor(HCVData$'ORD_VALUE')
# colnames(HCVData)[colnames(HCVData) == 'ORD_VALUE'] <- 'HIV.Result'
# 
# HCVData$'HepA_IgG_Result_Date' <- as.factor(HCVData$'HepA_IgG_Result_Date')
# colnames(HCVData)[colnames(HCVData) == 'HepA_IgG_Result_Date'] <- 'HepA_IgG.Date'
# 
# HCVData$'HepA_IgG' <- as.factor(HCVData$'HepA_IgG')
# colnames(HCVData)[colnames(HCVData) == 'HepA_IgG'] <- 'HepA_IgG.Result'
# 
# HCVData$'HBsAg_RESULT_DATE' <- as.factor(HCVData$'HBsAg_RESULT_DATE')
# colnames(HCVData)[colnames(HCVData) == 'HBsAg_RESULT_DATE'] <- 'HBsAg_Date'
# 
# HCVData$'HBsAg_Value' <- as.factor(HCVData$'HBsAg_Value')
# 
# HCVData$'Med_1' <- as.factor(HCVData$'Med_1')
# 
# HCVData$'Med_2' <- as.factor(HCVData$'Med_2')
# 
# HCVData$'HEPB_CORE_IgM_RESULT' <- as.factor(HCVData$'HEPB_CORE_IgM_RESULT')
# 
# HCVData$'HEPB_CORE_Total_RESULT' <- as.factor(HCVData$'HEPB_CORE_Total_RESULT')
# 
# HCVData$DX_TYPE <- as.factor(HCVData$DX_TYPE)
# colnames(HCVData)[colnames(HCVData) == 'DX_TYPE'] <- 'Cancer.Diagnosis.Source'
# 
# HCVData$'DX_NAME..56' <- as.factor(HCVData$'DX_NAME..56')
# colnames(HCVData)[colnames(HCVData) == 'DX_NAME..56'] <- 'Cancer.Diagnosis.Name'
# 
# HCVData$ICD10 <- as.factor(HCVData$ICD10)
# colnames(HCVData)[colnames(HCVData) == 'ICD10'] <- 'Cancer.ICD10'
# 
# HCVData$FIRST_DX_DATE <- as.numeric(HCVData$FIRST_DX_DATE)
# HCVData$FIRST_DX_DATE <- as.Date(HCVData$FIRST_DX_DATE, origin = "1899-12-30")
# colnames(HCVData)[colnames(HCVData) == 'FIRST_DX_DATE'] <- 'Cancer.Diagnosis.Date'
# 
# HCVData$RACE <- as.factor(HCVData$RACE)
# colnames(HCVData)[colnames(HCVData) == 'RACE'] <- 'Race'
# 
# HCVData$ETHNICTY <- as.factor(HCVData$ETHNICTY)
# colnames(HCVData)[colnames(HCVData) == 'ETHNICTY'] <- 'Ethnicity'
# 
# #Appears to only be male/female, I suspect really sex :(
# HCVData$SEX <- as.factor(HCVData$SEX)
# colnames(HCVData)[colnames(HCVData) == 'SEX'] <- 'Sex'
# 
# HCVData$LANGUAGE <- as.factor(HCVData$LANGUAGE)
# colnames(HCVData)[colnames(HCVData) == 'LANGUAGE'] <- 'Language'
# 
# colnames(HCVData)[colnames(HCVData) == 'Outpatient Completed'] <- 'Num.Outpatient.Visits'
# 
# colnames(HCVData)[colnames(HCVData) == 'Outpatient Canceled'] <- 'Num.Outpatient.Cancellations'
# 
# colnames(HCVData)[colnames(HCVData) == 'Outpatient No Show'] <- 'Num.Outpatient.NoShows'
# 
# colnames(HCVData)[colnames(HCVData) == 'Opiod'] <- 'Opioid.Hx'
# 
# colnames(HCVData)[colnames(HCVData) == 'ED'] <- 'ED.Visits'
# 
# colnames(HCVData)[colnames(HCVData) == 'Hosp Admission'] <- 'Hospital.Admissions'
# 
# ##removing extra variables with the same column names, unneeded for our analysis as far as I can tell
# HCVData <- subset(HCVData, select = -c(DX_NAME..71,
#            CURRENT_ICD10_LIST..72,
#            DX_NAME..74,
#            CURRENT_ICD10_LIST..75,
#            DX_NAME..77,
#            CURRENT_ICD10_LIST..78,
#            DX_NAME..80,
#            CURRENT_ICD10_LIST..81,
#            DX_NAME..83,
#            CURRENT_ICD10_LIST..84,
#            DX_NAME..86,
#            CURRENT_ICD10_LIST..87,
#            DX_NAME..89,
#            CURRENT_ICD10_LIST..90,
#            DX_NAME..92,
#            CURRENT_ICD10_LIST..93,
#            DX_NAME..95,
#            CURRENT_ICD10_LIST..96,
#            DX_NAME..98,
#            CURRENT_ICD10_LIST..99,
#            DX_NAME..101,
#            CURRENT_ICD10_LIST..102,
#            CURRENT_ICD10_LIST..104,
#            DX_NAME..105,
#            CURRENT_ICD10_LIST..107,
#            DX_NAME..108,
#            DX_NAME..110,
#            CURRENT_ICD10_LIST..111,
#            CURRENT_ICD10_LIST..113,
#            DX_NAME..114,
#            CURRENT_ICD10_LIST..116,
#            DX_NAME..117,
#            DX_NAME..119,
#            CURRENT_ICD10_LIST..120,
#            DX_NAME..122,
#            CURRENT_ICD10_LIST..123,
#            DX_NAME..125,
#            CURRENT_ICD10_LIST..126))
# 
# colnames(HCVData)[colnames(HCVData) == 'METASTATIC Cancer'] <- 'Metastatic.Cancer'
# 
# colnames(HCVData)[colnames(HCVData) == 'Nonmetastatic Cancer'] <- 'NON-Metastatic.Cancer'
# 
# colnames(HCVData)[colnames(HCVData) == 'Alcohol Abuse'] <- 'Alcohol.Abuse'
# 
# colnames(HCVData)[colnames(HCVData) == 'Drug Abuse'] <- 'Drug.Abuse'
# 
# colnames(HCVData)[colnames(HCVData) == 'Othe Neurological Disorder'] <- 'Other.Neuro.Disorder'
# 
# colnames(HCVData)[colnames(HCVData) == 'CHRONIC PULMONARY DISORDER'] <- 'CPD'
# 
# colnames(HCVData)[colnames(HCVData) == 'Renal Failure'] <- 'Renal.Failure'
# 
# colnames(HCVData)[colnames(HCVData) == 'Liver Disease'] <- 'Liver.Disease'
# 
# HCVData$PAYOR_NAME <- as.factor(HCVData$PAYOR_NAME)
# colnames(HCVData)[colnames(HCVData) == 'PAYOR_NAME'] <- 'PAYOR'
# 
# HCVData <- HCVData %>% mutate(PayorType = ifelse(str_detect(HCVData$PAYOR, "MCAL"), "MediCal", "Commercial"),
#                               PayorType = ifelse(str_detect(HCVData$PAYOR, "M-CAL"), "MediCal", PayorType),
#                               PayorType = ifelse(str_detect(HCVData$PAYOR, "MEDI-CAL"), "MediCal", PayorType),
#                               PayorType = ifelse(str_detect(HCVData$PAYOR, "SENIOR"), "Medicare", PayorType),
#                               PayorType = ifelse(str_detect(HCVData$PAYOR, "SNR"), "Medicare", PayorType),
#                               PayorType = ifelse(str_detect(HCVData$PAYOR, "MEDICARE"), "Medicare", PayorType),
#                               PayorType = ifelse(PayorType=="MediCal", "MediCal", "NotMediCal"))
# 
# HCVData$'FIRST PC APPT DEPT' <- as.factor(HCVData$'FIRST PC APPT DEPT')
# colnames(HCVData)[colnames(HCVData) == 'FIRST PC APPT DEPT'] <- 'FIRST_PC_APPT_DEPT'
# 
# HCVData$'MOST RECENT PC APPT DEPT' <- as.factor(HCVData$'MOST RECENT PC APPT DEPT')
# colnames(HCVData)[colnames(HCVData) == 'MOST RECENT PC APPT DEPT'] <- 'MOST_RECENT_PC_APPT_DEPT'
# 
# HCVData$VISIT_COUNT_2011 <-rowSums(cbind(HCVData$PC_2011_VISIT_COUNT, HCVData$HEP_2011_VISIT_COUNT), na.rm=TRUE)
# HCVData$VISIT_COUNT_2012 <-rowSums(cbind(HCVData$PC_2012_VISIT_COUNT, HCVData$HEP_2012_VISIT_COUNT), na.rm=TRUE)
# HCVData$VISIT_COUNT_2013 <-rowSums(cbind(HCVData$PC_2013_VISIT_COUNT, HCVData$HEP_2013_VISIT_COUNT), na.rm=TRUE)
# HCVData$VISIT_COUNT_2014 <-rowSums(cbind(HCVData$PC_2014_VISIT_COUNT, HCVData$HEP_2014_VISIT_COUNT), na.rm=TRUE)
# HCVData$VISIT_COUNT_2015 <-rowSums(cbind(HCVData$PC_2015_VISIT_COUNT, HCVData$HEP_2015_VISIT_COUNT), na.rm=TRUE)
# HCVData$VISIT_COUNT_2016 <-rowSums(cbind(HCVData$PC_2016_VISIT_COUNT, HCVData$HEP_2016_VISIT_COUNT), na.rm=TRUE)
# HCVData$VISIT_COUNT_2017 <-rowSums(cbind(HCVData$PC_2017_VISIT_COUNT, HCVData$HEP_2017_VISIT_COUNT), na.rm=TRUE)
# HCVData$VISIT_COUNT_2018 <-rowSums(cbind(HCVData$PC_2018_VISIT_COUNT, HCVData$HEP_2018_VISIT_COUNT), na.rm=TRUE)
# HCVData$VISIT_COUNT_2019 <-rowSums(cbind(HCVData$PC_2019_VISIT_COUNT, HCVData$HEP_2019_VISIT_COUNT), na.rm=TRUE)
# 
# HCVData$TotalVisits<- HCVData$VISIT_COUNT_2011 + HCVData$VISIT_COUNT_2012 + HCVData$VISIT_COUNT_2013 + HCVData$VISIT_COUNT_2014 + HCVData$VISIT_COUNT_2015 + HCVData$VISIT_COUNT_2016 + HCVData$VISIT_COUNT_2017 + HCVData$VISIT_COUNT_2018
# 
# HCVData$TotalVisits15to18 <- HCVData$VISIT_COUNT_2015 + HCVData$VISIT_COUNT_2016 + HCVData$VISIT_COUNT_2017 + HCVData$VISIT_COUNT_2018
# 
#  age <- function(dob, curryear, units = "years", floor = TRUE) {
#      calc.age = interval(dob, curryear) / duration(num = 1, units = units)
#      return(as.integer(floor(calc.age)))
#  }
# 
# HCVData$AGE_2009 <- age(dob = HCVData$BIRTH_DATE, curryear = as.Date('2009-12-31'))
# 
# HCVData$AGE_2010 <- age(dob = HCVData$BIRTH_DATE, curryear = as.Date('2010-12-31'))
# 
# HCVData$AGE_2011 <- age(dob = HCVData$BIRTH_DATE, curryear = as.Date('2011-12-31'))
# 
# HCVData$AGE_2012 <- age(dob = HCVData$BIRTH_DATE, curryear = as.Date('2012-12-31'))
# 
# HCVData$AGE_2013 <- age(dob = HCVData$BIRTH_DATE, curryear = as.Date('2013-12-31'))
# 
# HCVData$AGE_2014 <- age(dob = HCVData$BIRTH_DATE, curryear = as.Date('2014-12-31'))
# 
# HCVData$AGE_2015 <- age(dob = HCVData$BIRTH_DATE, curryear = as.Date('2015-12-31'))
# 
# HCVData$AGE_2016 <- age(dob = HCVData$BIRTH_DATE, curryear = as.Date('2016-12-31'))
# 
# HCVData$AGE_2017 <- age(dob = HCVData$BIRTH_DATE, curryear = as.Date('2017-12-31'))
# 
# HCVData$AGE_2018 <- age(dob = HCVData$BIRTH_DATE, curryear = as.Date('2018-12-31'))
# 
# HCVData$AGE_2019 <- age(dob = HCVData$BIRTH_DATE, curryear = as.Date('2019-12-31'))
# 
# #drop DOB from dataset for privacy reasons
# HCVData <- subset(HCVData, select = -c(BIRTH_DATE))
# 
# HCVData$FIB4_2009 <- HCVData$AGE_2009 * HCVData$AST_2009 / (HCVData$PLATELET_2009 * sqrt(HCVData$ALT_2009))
# 
# HCVData$FIB4_2010 <- HCVData$AGE_2010 * HCVData$AST_2010 / (HCVData$PLATELET_2010 * sqrt(HCVData$ALT_2010))
# 
# HCVData$FIB4_2011 <- HCVData$AGE_2011 * HCVData$AST_2011 / (HCVData$PLATELET_2011 * sqrt(HCVData$ALT_2011))
# 
# HCVData$FIB4_2012 <- HCVData$AGE_2012 * HCVData$AST_2012 / (HCVData$PLATELET_2012 * sqrt(HCVData$ALT_2012))
# 
# HCVData$FIB4_2013 <- HCVData$AGE_2013 * HCVData$AST_2013 / (HCVData$PLATELET_2013 * sqrt(HCVData$ALT_2013))
# 
# HCVData$FIB4_2014 <- HCVData$AGE_2011 * HCVData$AST_2014 / (HCVData$PLATELET_2014 * sqrt(HCVData$ALT_2014))
# 
# HCVData$FIB4_2015 <- HCVData$AGE_2011 * HCVData$AST_2015 / (HCVData$PLATELET_2015 * sqrt(HCVData$ALT_2015))
# 
# HCVData$FIB4_2016 <- HCVData$AGE_2011 * HCVData$AST_2016 / (HCVData$PLATELET_2016 * sqrt(HCVData$ALT_2016))
# 
# HCVData$FIB4_2017 <- HCVData$AGE_2011 * HCVData$AST_2017 / (HCVData$PLATELET_2017 * sqrt(HCVData$ALT_2017))
# 
# HCVData$FIB4_2018 <- HCVData$AGE_2011 * HCVData$AST_2018 / (HCVData$PLATELET_2018 * sqrt(HCVData$ALT_2018))
# 
# HCVData$FIB4_2019 <- HCVData$AGE_2011 * HCVData$AST_2019 / (HCVData$PLATELET_2019 * sqrt(HCVData$ALT_2019))
# 
# save(HCVData, file="HCVData.Rdata")

```

```{r filter_to_adults_with_visits_and_no_Ca_at_start_historical_FIB4s, include = FALSE, eval = TRUE}
load("HCVData.Rdata")

# #calculating a total fib4, NOT  because it's meaningful but to be ableto see how many had NO FIB4
# #commenting out for now bc just used this to explore
# HCVData$totalFIB4 <-rowSums(cbind(HCVData$FIB4_2009,
#                                   HCVData$FIB4_2010,
#                                   HCVData$FIB4_2011,
#                                   HCVData$FIB4_2012,
#                                   HCVData$FIB4_2013,
#                                   HCVData$FIB4_2014,
#                                   HCVData$FIB4_2015,
#                                   HCVData$FIB4_2016,
#                                   HCVData$FIB4_2017,
#                                   HCVData$FIB4_2018), na.rm=TRUE)
# summary(HCVData$totalFIB4==0)
# 
# HCVData$totalFIB4BY2011 <-rowSums(cbind(HCVData$FIB4_2009,
#                                   HCVData$FIB4_2010,
#                                   HCVData$FIB4_2011), na.rm=TRUE)
# summary(HCVData$totalFIB4BY2011==0)
# 
# HCVData$totalFIB4BY2014 <-rowSums(cbind(HCVData$FIB4_2009,
#                                   HCVData$FIB4_2010,
#                                   HCVData$FIB4_2011,
#                                   HCVData$FIB4_2012,
#                                   HCVData$FIB4_2013,
#                                   HCVData$FIB4_2014), na.rm=TRUE)
# summary(HCVData$totalFIB4BY2014==0)
# 
# HCVData$totalFIB4BY2015 <-rowSums(cbind(HCVData$FIB4_2009,
#                                   HCVData$FIB4_2010,
#                                   HCVData$FIB4_2011,
#                                   HCVData$FIB4_2012,
#                                   HCVData$FIB4_2013,
#                                   HCVData$FIB4_2014,
#                                   HCVData$FIB4_2015), na.rm=TRUE)
# summary(HCVData$totalFIB4BY2015==0)
# #note- by 2015 72% of our sample has a FIB4.
# 
# HCVData$totalFIB4BY2016 <-rowSums(cbind(HCVData$FIB4_2009,
#                                   HCVData$FIB4_2010,
#                                   HCVData$FIB4_2011,
#                                   HCVData$FIB4_2012,
#                                   HCVData$FIB4_2013,
#                                   HCVData$FIB4_2014,
#                                   HCVData$FIB4_2015,
#                                   HCVData$FIB4_2016), na.rm=TRUE)
# summary(HCVData$totalFIB4BY2016==0)
# 
# HCVData$totalFIB4BY2017 <-rowSums(cbind(HCVData$FIB4_2009,
#                                   HCVData$FIB4_2010,
#                                   HCVData$FIB4_2011,
#                                   HCVData$FIB4_2012,
#                                   HCVData$FIB4_2013,
#                                   HCVData$FIB4_2014,
#                                   HCVData$FIB4_2015,
#                                   HCVData$FIB4_2016,
#                                   HCVData$FIB4_2017), na.rm=TRUE)
# summary(HCVData$totalFIB4BY2017==0)
# 
# HCVData$totalFIB4BY2018 <-rowSums(cbind(HCVData$FIB4_2009,
#                                   HCVData$FIB4_2010,
#                                   HCVData$FIB4_2011,
#                                   HCVData$FIB4_2012,
#                                   HCVData$FIB4_2013,
#                                   HCVData$FIB4_2014,
#                                   HCVData$FIB4_2015,
#                                   HCVData$FIB4_2016,
#                                   HCVData$FIB4_2017,
#                                   HCVData$FIB4_2018), na.rm=TRUE)
# summary(HCVData$totalFIB4BY2018==0)
# 
# HCVData$totalFIB4BY2019 <-rowSums(cbind(HCVData$FIB4_2009,
#                                   HCVData$FIB4_2010,
#                                   HCVData$FIB4_2011,
#                                   HCVData$FIB4_2012,
#                                   HCVData$FIB4_2013,
#                                   HCVData$FIB4_2014,
#                                   HCVData$FIB4_2015,
#                                   HCVData$FIB4_2016,
#                                   HCVData$FIB4_2017,
#                                   HCVData$FIB4_2018,
#                                   HCVData$FIB4_2019), na.rm=TRUE)
# summary(HCVData$totalFIB4BY2019==0)




#creating the FIB4 scores that  pull forward past scores
HCVData <- HCVData %>% mutate(FIB4_by2010 = FIB4_2010, YearsSinceFib4_2010 = 0)
HCVData <- HCVData %>% mutate(FIB4_by2010 = ifelse(is.na(FIB4_2010)== "TRUE", FIB4_2009, FIB4_by2010),
                               YearsSinceFib4_2010 = ifelse(is.na(FIB4_2010)== "TRUE", 1, 0))
 

HCVData <-  HCVData %>% mutate(FIB4_by2011 = FIB4_2011, YearsSinceFib4_2011 = 0)
HCVData <-  HCVData %>% mutate(FIB4_by2011 = ifelse(is.na(FIB4_2011)== "TRUE", FIB4_by2010, FIB4_by2011),
                               YearsSinceFib4_2011 = ifelse(is.na(FIB4_2011)== "TRUE", YearsSinceFib4_2010 + 1, 0))

HCVData <-  HCVData %>% mutate(FIB4_by2012 = FIB4_2012, YearsSinceFib4_2012 = 0)
HCVData <-  HCVData %>% mutate(FIB4_by2012 = ifelse(is.na(FIB4_2012)== "TRUE", FIB4_by2011, FIB4_by2012),
                               YearsSinceFib4_2012 = ifelse(is.na(FIB4_2012)== "TRUE", YearsSinceFib4_2011 + 1, 0))

HCVData <-  HCVData %>% mutate(FIB4_by2013 = FIB4_2013, YearsSinceFib4_2013 = 0)
HCVData <-  HCVData %>%  mutate(FIB4_by2013 = ifelse(is.na(FIB4_2013)== "TRUE", FIB4_by2012, FIB4_by2013),
                               YearsSinceFib4_2013 = ifelse(is.na(FIB4_2013)== "TRUE", YearsSinceFib4_2012 + 1, 0))

HCVData <-  HCVData %>% mutate(FIB4_by2014 = FIB4_2014, YearsSinceFib4_2014 = 0)
HCVData <-  HCVData %>% mutate(FIB4_by2014 = ifelse(is.na(FIB4_2014)== "TRUE", FIB4_by2013, FIB4_by2014),
                               YearsSinceFib4_2014 = ifelse(is.na(FIB4_2014)== "TRUE", YearsSinceFib4_2013 + 1, 0))

HCVData <-  HCVData %>% mutate(FIB4_by2015 = FIB4_2015, YearsSinceFib4_2015 = 0)
HCVData <-  HCVData %>% mutate(FIB4_by2015 = ifelse(is.na(FIB4_2015)== "TRUE", FIB4_by2014, FIB4_by2015),
                               YearsSinceFib4_2015 = ifelse(is.na(FIB4_2015)== "TRUE", YearsSinceFib4_2014 + 1, 0))


#Imputing as the median value for those without a FIB4 by 2015
HCVData <-  HCVData %>% mutate(YearsSinceFib4_2015 = ifelse(is.na(FIB4_by2015)== "TRUE", 0, YearsSinceFib4_2015),
                               ImputedFIB4_2015 = ifelse(is.na(FIB4_by2015)== "TRUE", 1, 0),
                               FIB4_by2015 = ifelse(is.na(FIB4_by2015)== "TRUE", median(HCVData$FIB4_by2015,na.rm= "TRUE"), FIB4_by2015))


HCVData <-  HCVData %>% mutate(FIB4_by2016 = FIB4_2016, YearsSinceFib4_2016 = 0)
HCVData <-  HCVData %>% mutate(FIB4_by2016 = ifelse(is.na(FIB4_2016)== "TRUE", FIB4_by2015, FIB4_by2016),
                               YearsSinceFib4_2016 = ifelse(is.na(FIB4_2016)== "TRUE", YearsSinceFib4_2015 + 1, 0),
                               ImputedFIB4_2016 = ifelse(is.na(FIB4_2016)== "TRUE", ImputedFIB4_2015, 0))

HCVData <-  HCVData %>% mutate(FIB4_by2017 = FIB4_2017, YearsSinceFib4_2017 = 0)
HCVData <-  HCVData %>% mutate(FIB4_by2017 = ifelse(is.na(FIB4_2017)== "TRUE", FIB4_by2016, FIB4_by2017),
                               YearsSinceFib4_2017 = ifelse(is.na(FIB4_2017)== "TRUE", YearsSinceFib4_2016 + 1, 0),
                               ImputedFIB4_2017 = ifelse(is.na(FIB4_2017)== "TRUE", ImputedFIB4_2016, 0))

HCVData <-  HCVData %>% mutate(FIB4_by2018 = FIB4_2018, YearsSinceFib4_2018 = 0)
HCVData <-  HCVData %>% mutate(FIB4_by2018 = ifelse(is.na(FIB4_2018)== "TRUE", FIB4_by2017, FIB4_by2018),
                               YearsSinceFib4_2018 = ifelse(is.na(FIB4_2018)== "TRUE", YearsSinceFib4_2017 + 1, 0),
                               ImputedFIB4_2018 = ifelse(is.na(FIB4_2018)== "TRUE", ImputedFIB4_2017, 0))

HCVData <-  HCVData %>% mutate(FIB4_by2019 = FIB4_2019, YearsSinceFib4_2019 = 0)
HCVData <-  HCVData %>% mutate(FIB4_by2019 = ifelse(is.na(FIB4_2019)== "TRUE", FIB4_by2018, FIB4_by2019),
                               YearsSinceFib4_2019 = ifelse(is.na(FIB4_2019)== "TRUE", YearsSinceFib4_2018 + 1, 0),
                               ImputedFIB4_2019 = ifelse(is.na(FIB4_2019)== "TRUE", ImputedFIB4_2018, 0))

#Fixing Outcome Variables
HCVData$HCC_2012only <- ifelse((HCVData$Cancer.Diagnosis.Date<'2012-1-1' | HCVData$Cancer.Diagnosis.Date>'2012-12-31') | is.na(HCVData$Cancer.Diagnosis.Date), 0, 1)
HCVData$HCC_2013only <- ifelse((HCVData$Cancer.Diagnosis.Date<'2013-1-1' | HCVData$Cancer.Diagnosis.Date>'2013-12-31') | is.na(HCVData$Cancer.Diagnosis.Date), 0, 1)
HCVData$HCC_2014only <- ifelse((HCVData$Cancer.Diagnosis.Date<'2014-1-1' | HCVData$Cancer.Diagnosis.Date>'2014-12-31') | is.na(HCVData$Cancer.Diagnosis.Date), 0, 1)
HCVData$HCC_2015only <- ifelse((HCVData$Cancer.Diagnosis.Date<'2015-1-1' | HCVData$Cancer.Diagnosis.Date>'2015-12-31') | is.na(HCVData$Cancer.Diagnosis.Date), 0, 1)
HCVData$HCC_2016only <- ifelse((HCVData$Cancer.Diagnosis.Date<'2016-1-1' | HCVData$Cancer.Diagnosis.Date>'2016-12-31') | is.na(HCVData$Cancer.Diagnosis.Date), 0, 1)
HCVData$HCC_2017only <- ifelse((HCVData$Cancer.Diagnosis.Date<'2017-1-1' | HCVData$Cancer.Diagnosis.Date>'2017-12-31') | is.na(HCVData$Cancer.Diagnosis.Date), 0, 1)
HCVData$HCC_2018only <- ifelse((HCVData$Cancer.Diagnosis.Date<'2018-1-1' | HCVData$Cancer.Diagnosis.Date>'2018-12-31') | is.na(HCVData$Cancer.Diagnosis.Date), 0, 1)
HCVData$HCC_2019only <- ifelse((HCVData$Cancer.Diagnosis.Date<'2019-1-1' | HCVData$Cancer.Diagnosis.Date>'2019-12-31') | is.na(HCVData$Cancer.Diagnosis.Date), 0, 1)

HCVData$HCC_2012 <- ifelse(HCVData$Cancer.Diagnosis.Date>'2012-12-31' | is.na(HCVData$Cancer.Diagnosis.Date), 0, 1)
HCVData$HCC_2013 <- ifelse(HCVData$Cancer.Diagnosis.Date>'2013-12-31' | is.na(HCVData$Cancer.Diagnosis.Date), 0, 1)
HCVData$HCC_2014 <- ifelse(HCVData$Cancer.Diagnosis.Date>'2014-12-31' | is.na(HCVData$Cancer.Diagnosis.Date), 0, 1)
HCVData$HCC_2015 <- ifelse(HCVData$Cancer.Diagnosis.Date>'2015-12-31' | is.na(HCVData$Cancer.Diagnosis.Date), 0, 1)
HCVData$HCC_2016 <- ifelse(HCVData$Cancer.Diagnosis.Date>'2016-12-31' | is.na(HCVData$Cancer.Diagnosis.Date), 0, 1)
HCVData$HCC_2017 <- ifelse(HCVData$Cancer.Diagnosis.Date>'2017-12-31' | is.na(HCVData$Cancer.Diagnosis.Date), 0, 1)
HCVData$HCC_2018 <- ifelse(HCVData$Cancer.Diagnosis.Date>'2018-12-31' | is.na(HCVData$Cancer.Diagnosis.Date), 0, 1)
HCVData$HCC_2019 <- ifelse(HCVData$Cancer.Diagnosis.Date>'2019-12-31' | is.na(HCVData$Cancer.Diagnosis.Date), 0, 1)

HCVData$InSystemBy2015 <- ifelse(as.POSIXct(HCVData$First.Hep.Appt) <'2015-12-31' | 
                                   as.POSIXct(HCVData$FIRST_PC_APPT) <'2015-12-31' | 
                                   as.POSIXct(HCVData$First.Hep.Appt) <'2015-12-31' | 
                                   as.POSIXct(HCVData$date.first.pos.HCV.test) < '2015-12-31' | 
                                   as.POSIXct(HCVData$Date.First.Pos.RNA) < '2015-12-31' | 
                                   as.POSIXct(HCVData$AFP.Date) < '2015-12-31'| 
                                   as.POSIXct(HCVData$Lowest.Platelet.Date) < '2015-12-31'| 
                                   as.POSIXct(HCVData$APPT_DATE) < '2015-12-31' | 
                                   as.POSIXct(HCVData$HBsAG.Date) < '2015-12-31' | 
                                   as.POSIXct(HCVData$HBsAg_Date) < '2015-12-31'| 
                                   as.POSIXct(HCVData$HIV.Date) < '2015-12-31'|
                                   as.POSIXct(HCVData$HepA_IgG.Date) < '2015-12-31'|
                                   as.POSIXct(HCVData$HEPB_CORE_IgM_Date) < '2015-12-31' |
                                   as.POSIXct(HCVData$HEPB_CORE_Total_Date) < '2015-12-31' |
                                   as.POSIXct(HCVData$ABD_IMAGING_DATE) < '2015-12-31' |
                                   as.POSIXct(HCVData$BIOPSY_DATE) < '2015-12-31' |
                                   HCVData$VISIT_COUNT_2011 >0 |
                                   HCVData$VISIT_COUNT_2012 >0 |
                                   HCVData$VISIT_COUNT_2013 >0 |
                                   HCVData$VISIT_COUNT_2014 >0 |
                                   HCVData$VISIT_COUNT_2015 >0 |
                                   !is.na(HCVData$AST_2009) |
                                   !is.na(HCVData$AST_2010) |
                                   !is.na(HCVData$AST_2011) |
                                   !is.na(HCVData$AST_2012) |
                                   !is.na(HCVData$AST_2013) |
                                   !is.na(HCVData$AST_2014) |
                                   !is.na(HCVData$AST_2015) |
                                   !is.na(HCVData$ALT_2009) |
                                   !is.na(HCVData$ALT_2010) |
                                   !is.na(HCVData$ALT_2011) |
                                   !is.na(HCVData$ALT_2012) |
                                   !is.na(HCVData$ALT_2013) |
                                   !is.na(HCVData$ALT_2014) |
                                   !is.na(HCVData$ALT_2015) |
                                   !is.na(HCVData$PLATELET_2009) |
                                   !is.na(HCVData$PLATELET_2010) |
                                   !is.na(HCVData$PLATELET_2011) |
                                   !is.na(HCVData$PLATELET_2012) |
                                   !is.na(HCVData$PLATELET_2013) |
                                   !is.na(HCVData$PLATELET_2014) |
                                   !is.na(HCVData$PLATELET_2015), 1, 0)

#Filtering to those who had some visits in 2011-2019, were adults at the start of the data and didn't have HCC before 12/31/15
HCVData_inclcirr<- HCVData %>% filter(TotalVisits != 0) %>%
                      filter(AGE_2011 >18) %>%
                      filter(HCC_2015 == 0) %>%
                      filter(InSystemBy2015 ==1)

#Filtering to those with no cirrhosis at baseline
HCVData <- HCVData_inclcirr %>% filter(FIB4_by2015 < 3.25)


#These were just to explore the data once we filtered out those with cirrhosis at baseline
# table(HCVData_inclcirr$HCC_2019)
# table(HCVData$HCC_2019)
# HCVData_outcome <- HCVData %>% filter(HCC_2019==1)
# HCVData_nooutcome <- HCVData %>% filter(HCC_2019==0)
# summary(HCVData_outcome$FIB4_2019)
# summary(HCVData_nooutcome$FIB4_2019)
# 
# table(HCVData$VISIT_COUNT_2015, HCVData$ABD_IMAGING_2015)
# 
# HCVData_imaging <- HCVData %>% filter(HCVData$ABD_IMAGING_2015 > 0 & HCVData$ABD_IMAGING_2016 > 0 & HCVData$ABD_IMAGING_2017 > 0 & HCVData$ABD_IMAGING_2018 > 0)
# table(HCVData_imaging$HCC_2019)
```

```{r demographics, include = FALSE, eval = TRUE}
sex <- table(HCVData$Sex, useNA = "ifany")
HCVData$race.ethnicity <- ifelse(HCVData$Race == "White or Caucasian" & HCVData$Ethnicity == "Not Hispanic or Latino", "W", ifelse(HCVData$Race == "Black or African American" & HCVData$Ethnicity == "Not Hispanic or Latino", "B", ifelse(HCVData$Ethnicity == "Hispanic or Latino", "L", ifelse(HCVData$Race == "Unknown" | HCVData$Race == "Declined" | HCVData$Race == "Unknown/Declined", NA, "O"))))
race <- table(HCVData$race.ethnicity, useNA  = "ifany")
SES <- table(HCVData$PayorType, useNA = "ifany")
n <- nrow(HCVData)
male <- sex[2]
malep <- male/n*100
female <- sex[1]
femalep <- female/n*100
white <- race[4]
whitep <- white/n*100
black <- race[1]
blackp <- black/n*100
latinx <- race[2]
latinxp <- latinx/n*100
other <- race[3]
otherp <- other/n*100
unkrace <- race[5]
unkracep <- unkrace/n*100
medical <- SES[1]
medicalp <- medical/n*100
notmedical <- SES[2]
notmedicalp <- notmedical/n*100

```

* \textbf{Sex}. This is a dichotomous variable, with two categories (male, female), as UCSF has not been capturing other gender categories within Epic.

* \textbf{Race}. This is a categorical variable, which we have recategorized into White, Black/African American, Latinx, and Other for ease of analysis.

* \textbf{SES}. We are using insurance type (Medi-Cal, or not Medi-Cal) as a marker of SES status, which is again a categorical variable.

The table below displays the demographic breakdown of the sample.

| Demographic | Category | n | % |
| ----------------- | ----------------- | -------- | --------|
| Sex | Male | `r male` | `r round(malep, 1)`% |
|        | Female | `r female` | `r round(femalep, 1)`% |
|  | 
|        | Black/African American | `r black` | `r round(blackp, 1)`% |
|        | Latinx | `r latinx` | `r round(latinxp, 1)`% |
| Race/ethnicity | White | `r white` | `r round(whitep, 1)`% |
|        | Other | `r other` | `r round(otherp, 1)`% |
|        | Unknown | `r unkrace` | `r round(unkracep, 1)`% |  
|  | 
|   SES (Payor type)   | Medi-Cal | `r medical` | `r round(medicalp, 1)`% |
|  | Not Medi-Cal | `r notmedical` | `r round(notmedicalp, 1)`% |
|  | 
| TOTAL | | `r n` | 100% |
 


From here on we're using code from prior labs, for data structure 3 (the survival structure)
Data Structure 3: $O = (L(1), A(1), Y(2), L(2), A(2), Y(3))$

Here, $Y(t)$ is an indicator variable describing whether or not the student has become ill by time $t$; as such, it deterministically jumps to 1 and remains there once an individual has become ill. This is an example of a ``survival" or ``time to event" data structure.  For outcomes such as this, once the event of interest has occurred, by definition, no future interventions can change it. We could thus truncate the observed data for an individual at the point that the event occurs (this is often done when defining survival data structures). However, in the longitudinal causal inference literature, for notational convenience, we often instead define the values of observed variables as something deterministic (such as last observed value) after the event occurs. This allows us to write down a data structure that extends through time $K+1$ for all individuals (instead of a data structure where the number of time points varies by individual).

```{r Data Structure 3 Simulation From R Lab 1}
#2. write function to generate O = (L(1), A(1), Y(2), ...Y(3))
generate_data3  <- function(n) {
  U <- data.frame(UL1 = rnorm(n=n, mean=0, sd = 1), 
                  UL2 = rnorm(n=n, mean=0, sd = 1), 
                  UA1 = runif(n = n, min = 0, max = 1),
                  UA2 = runif(n = n, min = 0, max = 1),
                  UY2 = runif(n=n, min=0, max = 1),
                  UY3 = runif(n=n, min=0, max = 1))
  
  O <- U
  O <- O %>% 
    mutate(L1 = UL1,
           A1 = as.numeric(UA1 < plogis(0.001*L1)),
           Y2 = as.numeric(UY2 < plogis(L1-2*A1-6)),
           L2 = ifelse(Y2==0,A1+L1+UL2, NA),
           A2 = ifelse(Y2==0, as.numeric(UA2 < plogis(0.001*(L1+A1+L2))),NA),
           Y3 = ifelse(Y2==0, as.numeric(UY3 < plogis(L1-2*A1+L2-A2)),NA))
  return(O)
}
```

 Causal Question: How would the counterfactual probability of becoming sick differ by the time of the test under an intervention to get 8 or more hours of sleep for 2 nights before a statistics test versus an intervention to get less than 8 hours of sleep for 2 nights before a statistics test?
 
 The target causal parameter is 

$\psi^F (\mathcal{P}_{U,X}) = E_{U,X}(Y_{\bar{a}=1(3)}-Y_{\bar{a}=0(3)})$ 

the average treatment effect, assuming that all students had the intervention both nights prior to the exam ($Y_{\bar{a}=1}$) and the outcomes if all students did NOT have the intervention at any time point ($Y_{\bar{a}=0}$). This looks at having had the outcome up until time 3, based on the Y(3) notation.

```{r Intervene on Data Structure 3 from R lab 2}
# 3.3 - intervene on SCM/data generating function
generate_data3_intervene  <- function(n, a) {
  U <- data.frame(UL1 = rnorm(n=n, mean=0, sd = 1), 
                  UL2 = rnorm(n=n, mean=0, sd = 1), 
                 # UA1 = runif(n = n, min = 0, max = 1),
                 # UA2 = runif(n = n, min = 0, max = 1),
                  UY2 = runif(n=n, min=0, max = 1),
                  UY3 = runif(n=n, min=0, max = 1))
  
  O <- U
  O <- O %>% 
    mutate(L1 = UL1,
           A1 = a,
           Y2 = as.numeric(UY2 < plogis(L1-2*A1-6)),
           L2 = ifelse(Y2==0,A1+L1+UL2, NA),
           A2 = a,
           Y3 = ifelse(Y2==0, as.numeric(UY3 < plogis(L1-2*A1+L2-A2)),NA))
  return(O)
}

ObsData3Intervene.0 <- generate_data3_intervene(100000, 0)
ObsData3Intervene.0 <- ObsData3Intervene.0 %>% select(L1, A1, Y2, L2, A2, Y3)

ObsData3Intervene.1 <- generate_data3_intervene(100000, 1)
ObsData3Intervene.1 <- ObsData3Intervene.1 %>% select(L1, A1, Y2, L2, A2, Y3)


# 3.4 - evaluate Psi.F
Psi.F.3= mean(ObsData3Intervene.1$Y3-ObsData3Intervene.0$Y3, na.rm = TRUE)
  Psi.F.3
```

```{r ltmle run on data structure 4 which is like 3 but with a censoring variable}
ObsData4$C1 = ltmle::BinaryToCensoring(is.censored = ObsData4$C1)
ObsData4$C2 = ltmle::BinaryToCensoring(is.censored = ObsData4$C2)
head(ObsData4)

results4 <- ltmle(ObsData4,
                     Anodes= c("A1", "A2"),
                     Lnodes = c("L1", "L2"),
                     Cnodes = c("C1", "C2"),
                     Ynodes = c("Y2","Y3"),
                     abar = list(c(1,1), c(0,0)),
                     survivalOutcome = TRUE
)



results4.gcomp <- ltmle(ObsData4,
                     Anodes= c("A1", "A2"),
                     Lnodes = c("L1", "L2"),
                     Cnodes = c("C1", "C2"),
                     Ynodes = c("Y2","Y3"),
                     abar = list(c(1,1), c(0,0)),
                     survivalOutcome = TRUE,
                    gcomp = T
)

sum4tmle <- summary(results4, "tmle")
sum4iptw <- summary(results4, "iptw")
sum4gcomp <- summary(results4.gcomp, "gcomp")

sum4tmle$effect.measures$ATE$estimate
sum4iptw$effect.measures$ATE$estimate
sum4gcomp$effect.measures$ATE$estimate

```
Note add in superlearner once working
