---
title: "Abdominal Imaging and HCC Risk"
author: "Shelley \"the bomb\" Facente and Steph \"the badass\" Holm"
date: "February 17, 2020"
output: pdf_document
---


```{r setup, include=FALSE}
library(pacman)
p_load(tidyverse, readxl, skimr, knitr, xlsx, lubridate, MASS, ggplot2, ggpubr, data.table, mice)
#library(Hmisc)

knitr::opts_chunk$set(include = FALSE, cache = TRUE)

# First, set up data loading functions
StephandShelleyDataLoad <- function(filename) 
{
  if(Sys.info()['sysname']=="Darwin"){
    
     read_excel(as.character(filename))}
  else{
    windowsfilepath <- paste("~/GitHub/stephandshelley/", filename, sep = "")
     read_excel(as.character(windowsfilepath))
  }
}

StephandShelleyDataLoad2 <- function(filename) 
{
  if(Sys.info()['sysname']=="Darwin"){
    
     load(as.character(filename))}
  else{
    windowsfilepath <- paste("~/GitHub/stephandshelley/", filename, sep = "")
     load(as.character(windowsfilepath))
  }
}

```

```{r Data_Cleaning, include = FALSE}

# HCVData <- StephandShelleyDataLoad("Deidentified Chronic HCV Dataset 11-21-19.xlsx")
# 
# #first just making variables their proper type, and renaming so there's no spaces
# HCVData$`Deidentifier  11-21-19` <-  as.factor(HCVData$`Deidentifier  11-21-19`)
# colnames(HCVData)[colnames(HCVData) == 'Deidentifier  11-21-19'] <- 'PtID'
# 
# HCVData$'Hep Visit?'<- as.factor(HCVData$'Hep Visit?')
# colnames(HCVData)[colnames(HCVData) == 'Hep Visit?'] <- 'EverHepVisit'
# 
# HCVData$'Ever Chronic HCV?' <- as.factor(HCVData$'Ever Chronic HCV?')
# colnames(HCVData)[colnames(HCVData) == 'Ever Chronic HCV?'] <- 'EverChronicHCV'
# 
# HCVData$'Spontaneous Clearance?' <- as.factor(HCVData$'Spontaneous Clearance?')
# colnames(HCVData)[colnames(HCVData) == 'Spontaneous Clearance?'] <- 'SpontClearance'
# 
# HCVData$'Ever Ab positive HCV?' <- as.factor(HCVData$'Ever Ab positive HCV?')
# colnames(HCVData)[colnames(HCVData) == 'Ever Ab positive HCV?'] <- 'EverAbPosHCV'
# 
# HCVData$'Ever Treated?'<- as.factor(HCVData$'Ever Treated?')
# colnames(HCVData)[colnames(HCVData) == 'Ever Treated?'] <- 'EverTreated'
# 
# HCVData$'Evidence of SVR?'<- as.factor(HCVData$'Evidence of SVR?')
# colnames(HCVData)[colnames(HCVData) == 'Evidence of SVR?'] <- 'SVRAchieved'
# 
# HCVData$'Treatment Definition' <- as.factor(HCVData$'Treatment Definition')
# colnames(HCVData)[colnames(HCVData) == 'Treatment Definition'] <- 'TreatmentDefinition'
# 
# HCVData$'DX_TYPE OR TEST_TYPE' <- as.factor(HCVData$'DX_TYPE OR TEST_TYPE')
# colnames(HCVData)[colnames(HCVData) == 'DX_TYPE OR TEST_TYPE'] <- 'inclusion.source'
# 
# HCVData$'DX_NAME OR TEST RESULT'<- as.factor(HCVData$'DX_NAME OR TEST RESULT')
# colnames(HCVData)[colnames(HCVData) == 'DX_NAME OR TEST RESULT'] <- 'inclusion.reason'
# 
# #Didn't do anything with the column 'ICD10 OR RESULT_DATE' because it's a mix of formats/info
# 
# colnames(HCVData)[colnames(HCVData) == 'SPECIMN TAKEN DATE'] <- 'date.first.pos.HCV.test'
# 
# HCVData$RESULT <- as.factor(HCVData$RESULT)
# colnames(HCVData)[colnames(HCVData) == 'RESULT'] <- 'HCV.test.result'
# 
# HCVData$'RNA EVER TESTED' <- as.factor(HCVData$'RNA EVER TESTED')
# colnames(HCVData)[colnames(HCVData) == 'RNA EVER TESTED'] <- 'RNAeverTested'
# 
# colnames(HCVData)[colnames(HCVData) == 'FIRST POS (Or if no POS, "SEE TEXT") RNA TEST DATE'] <- 'Date.First.Pos.RNA'
# 
# HCVData$'FIRST POS (Or if no POS, "SEE TEXT") RNA TEST RESULT' <- as.factor(HCVData$'FIRST POS (Or if no POS, "SEE TEXT") RNA TEST RESULT')
# colnames(HCVData)[colnames(HCVData) == 'FIRST POS (Or if no POS, "SEE TEXT") RNA TEST RESULT'] <- 'Result.First.Pos.RNA'
# 
# #Added this to address the "See Text" weirdness; I think "See Text" was inserted here when the test was undetectable or lab error, etc. ##### MAY WANT TO REMOVE IF NUMERIC PREFERRED
# ##Note from Steph- it's not undetectable/lab error, it's just that for a number of years, they used this as a way to 'hide' results so that people in someone's chart inadvertantly didn't see sensitive test results. It was sort of a weird thing and they eventually dropped it. But that's why it's there. Right now though this is erroring over the RNA.interpretation column so I've commented it out.
# #HCVData$Result.First.Pos.RNA <- ifelse(HCVData$Result.First.Pos.RNA == 'See Text', HCVData$RNA.interpretation, HCVData$Result.First.Pos.RNA)
# 
# colnames(HCVData)[colnames(HCVData) == 'MOST RECENT RNA POS'] <- 'Most.Recent.RNA.Pos'
# 
# colnames(HCVData)[colnames(HCVData) == 'MOST RECENT RNA NEG'] <- 'Most.Recent.RNA.Neg'
# 
# #This column is in the midst of the RNA testing section but is unlabeled. It's a date.
# colnames(HCVData)[colnames(HCVData) == '..19'] <- 'UnknownColumn'
# 
# colnames(HCVData)[colnames(HCVData) == 'MOST RECENT RNA "SEE TEXT"'] <- 'Most.Recent.RNA.SeeText'
# 
# colnames(HCVData)[colnames(HCVData) == 'RNA interpretation'] <- 'RNA.interpretation'
# 
# colnames(HCVData)[colnames(HCVData) == 'other notes on diagnosis'] <- 'Notes'
# 
# HCVData$'Where getting care' <- as.factor(HCVData$'Where getting care')
# colnames(HCVData)[colnames(HCVData) == 'Where getting care'] <- 'Care.Location'
# 
# #This errors because there are a number of non-dates in this column. Should discuss with Rena if using.
# #HCVData$'HEP C GENOTYPE DATE' <- as.POSIXct(HCVData$'HEP C GENOTYPE DATE')
# #colnames(HCVData)[colnames(HCVData) == 'HEP C GENOTYPE DATE'] <- 'HCV.Genotype.Date'
# 
# HCVData$'HEP C GENOTYPE RESULT' <- as.factor(HCVData$'HEP C GENOTYPE RESULT')
# colnames(HCVData)[colnames(HCVData) == 'HEP C GENOTYPE RESULT'] <- 'HCV.Genotype.Result'
# 
# colnames(HCVData)[colnames(HCVData) == 'ALPHAFETOPROTEIN_RESULT_DATE'] <- 'AFP.Date'
# 
# colnames(HCVData)[colnames(HCVData) == 'ALPHAFETOPROTEIN_RESULT'] <- 'AFP.Result'
# 
# colnames(HCVData)[colnames(HCVData) == 'FIRST_HEPATOLOGY_APPT'] <- 'First.Hep.Appt'
# 
# colnames(HCVData)[colnames(HCVData) == 'MOST_RECENT_HEPATOLOGY_APPT'] <- 'Most.Recent.Hep.Appt'
# 
# colnames(HCVData)[colnames(HCVData) == 'PLATLET_RESULT_DATE'] <- 'Lowest.Platelet.Date'
# 
# colnames(HCVData)[colnames(HCVData) == 'LOWEST_PLATELETS_RESULT'] <- 'Lowest.Platelet.Result'
# 
# colnames(HCVData)[colnames(HCVData) == 'HEPA_VACCINE_DATE'] <- 'HAV.Vax.Date'
# 
# colnames(HCVData)[colnames(HCVData) == 'HEPB_VACCINE_DATE'] <- 'HBV.Vax.Date'
# 
# HCVData$'Ever Had a Primary Care Visit' <- as.factor(HCVData$'Ever Had a Primary Care Visit')
# colnames(HCVData)[colnames(HCVData) == 'Ever Had a Primary Care Visit'] <- 'EverPrimaryCareVisit'
# 
# HCVData$'DEPT_NAME' <- as.factor(HCVData$'DEPT_NAME')
# 
# HCVData$'CURRENT_PCP' <- as.factor(HCVData$'CURRENT_PCP')
# 
# HCVData$'CURRENT_PCP_DEPT' <- as.factor(HCVData$'CURRENT_PCP_DEPT')
# 
# colnames(HCVData)[colnames(HCVData) == 'HBsAb_RESULT_DATE'] <- 'HBsAG.Date'
# 
# HCVData$'HBsAb_ORD_VALUE' <- as.factor(HCVData$'HBsAb_ORD_VALUE')
# colnames(HCVData)[colnames(HCVData) == 'HBsAb_ORD_VALUE'] <- 'HBsAb.Result'
# 
# colnames(HCVData)[colnames(HCVData) == 'HIV_RESULT_DATE'] <- 'HIV.Date'
# 
# HCVData$'ORD_VALUE' <- as.factor(HCVData$'ORD_VALUE')
# colnames(HCVData)[colnames(HCVData) == 'ORD_VALUE'] <- 'HIV.Result'
# 
# HCVData$'HepA_IgG_Result_Date' <- as.factor(HCVData$'HepA_IgG_Result_Date')
# colnames(HCVData)[colnames(HCVData) == 'HepA_IgG_Result_Date'] <- 'HepA_IgG.Date'
# 
# HCVData$'HepA_IgG' <- as.factor(HCVData$'HepA_IgG')
# colnames(HCVData)[colnames(HCVData) == 'HepA_IgG'] <- 'HepA_IgG.Result'
# 
# HCVData$'HBsAg_RESULT_DATE' <- as.factor(HCVData$'HBsAg_RESULT_DATE')
# colnames(HCVData)[colnames(HCVData) == 'HBsAg_RESULT_DATE'] <- 'HBsAg_Date'
# 
# HCVData$'HBsAg_Value' <- as.factor(HCVData$'HBsAg_Value')
# 
# HCVData$'Med_1' <- as.factor(HCVData$'Med_1')
# 
# HCVData$'Med_2' <- as.factor(HCVData$'Med_2')
# 
# HCVData$'HEPB_CORE_IgM_RESULT' <- as.factor(HCVData$'HEPB_CORE_IgM_RESULT')
# 
# HCVData$'HEPB_CORE_Total_RESULT' <- as.factor(HCVData$'HEPB_CORE_Total_RESULT')
# 
# HCVData$DX_TYPE <- as.factor(HCVData$DX_TYPE)
# colnames(HCVData)[colnames(HCVData) == 'DX_TYPE'] <- 'Cancer.Diagnosis.Source'
# 
# HCVData$'DX_NAME..56' <- as.factor(HCVData$'DX_NAME..56')
# colnames(HCVData)[colnames(HCVData) == 'DX_NAME..56'] <- 'Cancer.Diagnosis.Name'
# 
# HCVData$ICD10 <- as.factor(HCVData$ICD10)
# colnames(HCVData)[colnames(HCVData) == 'ICD10'] <- 'Cancer.ICD10'
# 
# HCVData$FIRST_DX_DATE <- as.numeric(HCVData$FIRST_DX_DATE)
# HCVData$FIRST_DX_DATE <- as.Date(HCVData$FIRST_DX_DATE, origin = "1899-12-30")
# colnames(HCVData)[colnames(HCVData) == 'FIRST_DX_DATE'] <- 'Cancer.Diagnosis.Date'
# 
# HCVData$RACE <- as.factor(HCVData$RACE)
# colnames(HCVData)[colnames(HCVData) == 'RACE'] <- 'Race'
# 
# HCVData$ETHNICTY <- as.factor(HCVData$ETHNICTY)
# colnames(HCVData)[colnames(HCVData) == 'ETHNICTY'] <- 'Ethnicity'
# 
# #Appears to only be male/female, I suspect really sex :(
# HCVData$SEX <- as.factor(HCVData$SEX)
# colnames(HCVData)[colnames(HCVData) == 'SEX'] <- 'Sex'
# 
# HCVData$LANGUAGE <- as.factor(HCVData$LANGUAGE)
# colnames(HCVData)[colnames(HCVData) == 'LANGUAGE'] <- 'Language'
# 
# colnames(HCVData)[colnames(HCVData) == 'Outpatient Completed'] <- 'Num.Outpatient.Visits'
# 
# colnames(HCVData)[colnames(HCVData) == 'Outpatient Canceled'] <- 'Num.Outpatient.Cancellations'
# 
# colnames(HCVData)[colnames(HCVData) == 'Outpatient No Show'] <- 'Num.Outpatient.NoShows'
# 
# colnames(HCVData)[colnames(HCVData) == 'Opiod'] <- 'Opioid.Hx'
# 
# colnames(HCVData)[colnames(HCVData) == 'ED'] <- 'ED.Visits'
# 
# colnames(HCVData)[colnames(HCVData) == 'Hosp Admission'] <- 'Hospital.Admissions'
# 
# ##removing extra variables with the same column names, unneeded for our analysis as far as I can tell
# HCVData <- subset(HCVData, select = -c(DX_NAME..71,
#            CURRENT_ICD10_LIST..72,
#            DX_NAME..74,
#            CURRENT_ICD10_LIST..75,
#            DX_NAME..77,
#            CURRENT_ICD10_LIST..78,
#            DX_NAME..80,
#            CURRENT_ICD10_LIST..81,
#            DX_NAME..83,
#            CURRENT_ICD10_LIST..84,
#            DX_NAME..86,
#            CURRENT_ICD10_LIST..87,
#            DX_NAME..89,
#            CURRENT_ICD10_LIST..90,
#            DX_NAME..92,
#            CURRENT_ICD10_LIST..93,
#            DX_NAME..95,
#            CURRENT_ICD10_LIST..96,
#            DX_NAME..98,
#            CURRENT_ICD10_LIST..99,
#            DX_NAME..101,
#            CURRENT_ICD10_LIST..102,
#            CURRENT_ICD10_LIST..104,
#            DX_NAME..105,
#            CURRENT_ICD10_LIST..107,
#            DX_NAME..108,
#            DX_NAME..110,
#            CURRENT_ICD10_LIST..111,
#            CURRENT_ICD10_LIST..113,
#            DX_NAME..114,
#            CURRENT_ICD10_LIST..116,
#            DX_NAME..117,
#            DX_NAME..119,
#            CURRENT_ICD10_LIST..120,
#            DX_NAME..122,
#            CURRENT_ICD10_LIST..123,
#            DX_NAME..125,
#            CURRENT_ICD10_LIST..126))
# 
# colnames(HCVData)[colnames(HCVData) == 'METASTATIC Cancer'] <- 'Metastatic.Cancer'
# 
# colnames(HCVData)[colnames(HCVData) == 'Nonmetastatic Cancer'] <- 'NON-Metastatic.Cancer'
# 
# colnames(HCVData)[colnames(HCVData) == 'Alcohol Abuse'] <- 'Alcohol.Abuse'
# 
# colnames(HCVData)[colnames(HCVData) == 'Drug Abuse'] <- 'Drug.Abuse'
# 
# colnames(HCVData)[colnames(HCVData) == 'Othe Neurological Disorder'] <- 'Other.Neuro.Disorder'
# 
# colnames(HCVData)[colnames(HCVData) == 'CHRONIC PULMONARY DISORDER'] <- 'CPD'
# 
# colnames(HCVData)[colnames(HCVData) == 'Renal Failure'] <- 'Renal.Failure'
# 
# colnames(HCVData)[colnames(HCVData) == 'Liver Disease'] <- 'Liver.Disease'
# 
# HCVData$PAYOR_NAME <- as.factor(HCVData$PAYOR_NAME)
# colnames(HCVData)[colnames(HCVData) == 'PAYOR_NAME'] <- 'PAYOR'
# 
# HCVData <- HCVData %>% mutate(PayorType = ifelse(str_detect(HCVData$PAYOR, "MCAL"), "MediCal", "Commercial"),
#                               PayorType = ifelse(str_detect(HCVData$PAYOR, "M-CAL"), "MediCal", PayorType),
#                               PayorType = ifelse(str_detect(HCVData$PAYOR, "MEDI-CAL"), "MediCal", PayorType),
#                               PayorType = ifelse(str_detect(HCVData$PAYOR, "SENIOR"), "Medicare", PayorType),
#                               PayorType = ifelse(str_detect(HCVData$PAYOR, "SNR"), "Medicare", PayorType),
#                               PayorType = ifelse(str_detect(HCVData$PAYOR, "MEDICARE"), "Medicare", PayorType),
#                               PayorType = ifelse(PayorType=="MediCal", "MediCal", "NotMediCal"))
# 
# HCVData$'FIRST PC APPT DEPT' <- as.factor(HCVData$'FIRST PC APPT DEPT')
# colnames(HCVData)[colnames(HCVData) == 'FIRST PC APPT DEPT'] <- 'FIRST_PC_APPT_DEPT'
# 
# HCVData$'MOST RECENT PC APPT DEPT' <- as.factor(HCVData$'MOST RECENT PC APPT DEPT')
# colnames(HCVData)[colnames(HCVData) == 'MOST RECENT PC APPT DEPT'] <- 'MOST_RECENT_PC_APPT_DEPT'
# 
# HCVData$VISIT_COUNT_2011 <-rowSums(cbind(HCVData$PC_2011_VISIT_COUNT, HCVData$HEP_2011_VISIT_COUNT), na.rm=TRUE)
# HCVData$VISIT_COUNT_2012 <-rowSums(cbind(HCVData$PC_2012_VISIT_COUNT, HCVData$HEP_2012_VISIT_COUNT), na.rm=TRUE)
# HCVData$VISIT_COUNT_2013 <-rowSums(cbind(HCVData$PC_2013_VISIT_COUNT, HCVData$HEP_2013_VISIT_COUNT), na.rm=TRUE)
# HCVData$VISIT_COUNT_2014 <-rowSums(cbind(HCVData$PC_2014_VISIT_COUNT, HCVData$HEP_2014_VISIT_COUNT), na.rm=TRUE)
# HCVData$VISIT_COUNT_2015 <-rowSums(cbind(HCVData$PC_2015_VISIT_COUNT, HCVData$HEP_2015_VISIT_COUNT), na.rm=TRUE)
# HCVData$VISIT_COUNT_2016 <-rowSums(cbind(HCVData$PC_2016_VISIT_COUNT, HCVData$HEP_2016_VISIT_COUNT), na.rm=TRUE)
# HCVData$VISIT_COUNT_2017 <-rowSums(cbind(HCVData$PC_2017_VISIT_COUNT, HCVData$HEP_2017_VISIT_COUNT), na.rm=TRUE)
# HCVData$VISIT_COUNT_2018 <-rowSums(cbind(HCVData$PC_2018_VISIT_COUNT, HCVData$HEP_2018_VISIT_COUNT), na.rm=TRUE)
# HCVData$VISIT_COUNT_2019 <-rowSums(cbind(HCVData$PC_2019_VISIT_COUNT, HCVData$HEP_2019_VISIT_COUNT), na.rm=TRUE)
# 
# HCVData$TotalVisits<- HCVData$VISIT_COUNT_2011 + HCVData$VISIT_COUNT_2012 + HCVData$VISIT_COUNT_2013 + HCVData$VISIT_COUNT_2014 + HCVData$VISIT_COUNT_2015 + HCVData$VISIT_COUNT_2016 + HCVData$VISIT_COUNT_2017 + HCVData$VISIT_COUNT_2018
# 
# HCVData$TotalVisits15to18 <- HCVData$VISIT_COUNT_2015 + HCVData$VISIT_COUNT_2016 + HCVData$VISIT_COUNT_2017 + HCVData$VISIT_COUNT_2018
# 
#  age <- function(dob, curryear, units = "years", floor = TRUE) {
#      calc.age = interval(dob, curryear) / duration(num = 1, units = units)
#      return(as.integer(floor(calc.age)))
#  }
# 
# HCVData$AGE_2009 <- age(dob = HCVData$BIRTH_DATE, curryear = as.Date('2009-12-31'))
# 
# HCVData$AGE_2010 <- age(dob = HCVData$BIRTH_DATE, curryear = as.Date('2010-12-31'))
# 
# HCVData$AGE_2011 <- age(dob = HCVData$BIRTH_DATE, curryear = as.Date('2011-12-31'))
# 
# HCVData$AGE_2012 <- age(dob = HCVData$BIRTH_DATE, curryear = as.Date('2012-12-31'))
# 
# HCVData$AGE_2013 <- age(dob = HCVData$BIRTH_DATE, curryear = as.Date('2013-12-31'))
# 
# HCVData$AGE_2014 <- age(dob = HCVData$BIRTH_DATE, curryear = as.Date('2014-12-31'))
# 
# HCVData$AGE_2015 <- age(dob = HCVData$BIRTH_DATE, curryear = as.Date('2015-12-31'))
# 
# HCVData$AGE_2016 <- age(dob = HCVData$BIRTH_DATE, curryear = as.Date('2016-12-31'))
# 
# HCVData$AGE_2017 <- age(dob = HCVData$BIRTH_DATE, curryear = as.Date('2017-12-31'))
# 
# HCVData$AGE_2018 <- age(dob = HCVData$BIRTH_DATE, curryear = as.Date('2018-12-31'))
# 
# HCVData$AGE_2019 <- age(dob = HCVData$BIRTH_DATE, curryear = as.Date('2019-12-31'))
# 
# #drop DOB from dataset for privacy reasons
# HCVData <- subset(HCVData, select = -c(BIRTH_DATE))
# 
# HCVData$FIB4_2009 <- HCVData$AGE_2009 * HCVData$AST_2009 / (HCVData$PLATELET_2009 * sqrt(HCVData$ALT_2009))
# 
# HCVData$FIB4_2010 <- HCVData$AGE_2010 * HCVData$AST_2010 / (HCVData$PLATELET_2010 * sqrt(HCVData$ALT_2010))
# 
# HCVData$FIB4_2011 <- HCVData$AGE_2011 * HCVData$AST_2011 / (HCVData$PLATELET_2011 * sqrt(HCVData$ALT_2011))
# 
# HCVData$FIB4_2012 <- HCVData$AGE_2012 * HCVData$AST_2012 / (HCVData$PLATELET_2012 * sqrt(HCVData$ALT_2012))
# 
# HCVData$FIB4_2013 <- HCVData$AGE_2013 * HCVData$AST_2013 / (HCVData$PLATELET_2013 * sqrt(HCVData$ALT_2013))
# 
# HCVData$FIB4_2014 <- HCVData$AGE_2011 * HCVData$AST_2014 / (HCVData$PLATELET_2014 * sqrt(HCVData$ALT_2014))
# 
# HCVData$FIB4_2015 <- HCVData$AGE_2011 * HCVData$AST_2015 / (HCVData$PLATELET_2015 * sqrt(HCVData$ALT_2015))
# 
# HCVData$FIB4_2016 <- HCVData$AGE_2011 * HCVData$AST_2016 / (HCVData$PLATELET_2016 * sqrt(HCVData$ALT_2016))
# 
# HCVData$FIB4_2017 <- HCVData$AGE_2011 * HCVData$AST_2017 / (HCVData$PLATELET_2017 * sqrt(HCVData$ALT_2017))
# 
# HCVData$FIB4_2018 <- HCVData$AGE_2011 * HCVData$AST_2018 / (HCVData$PLATELET_2018 * sqrt(HCVData$ALT_2018))
# 
# HCVData$FIB4_2019 <- HCVData$AGE_2011 * HCVData$AST_2019 / (HCVData$PLATELET_2019 * sqrt(HCVData$ALT_2019))
# 
# save(HCVData, file="HCVData.Rdata")

```

```{r filter_to_adults_with_visits_and_no_Ca_at_start_historical_FIB4s, include = FALSE, eval = TRUE}
load("HCVData.Rdata") 

#consolidating race categories
HCVData$race.ethnicity <- ifelse(HCVData$Race == "White or Caucasian" & HCVData$Ethnicity == "Not Hispanic or Latino", "W", ifelse(HCVData$Race == "Black or African American" & HCVData$Ethnicity == "Not Hispanic or Latino", "B", ifelse(HCVData$Ethnicity == "Hispanic or Latino", "L", ifelse(HCVData$Race == "Unknown" | HCVData$Race == "Declined" | HCVData$Race == "Unknown/Declined", NA, "O"))))
 
# #calculating a total fib4, NOT  because it's meaningful but to be ableto see how many had NO FIB4
# #commenting out for now bc just used this to explore
# HCVData$totalFIB4 <-rowSums(cbind(HCVData$FIB4_2009,
#                                   HCVData$FIB4_2010,
#                                   HCVData$FIB4_2011,
#                                   HCVData$FIB4_2012,
#                                   HCVData$FIB4_2013,
#                                   HCVData$FIB4_2014,
#                                   HCVData$FIB4_2015,
#                                   HCVData$FIB4_2016,
#                                   HCVData$FIB4_2017,
#                                   HCVData$FIB4_2018), na.rm=TRUE)
# summary(HCVData$totalFIB4==0)
# 
# HCVData$totalFIB4BY2011 <-rowSums(cbind(HCVData$FIB4_2009,
#                                   HCVData$FIB4_2010,
#                                   HCVData$FIB4_2011), na.rm=TRUE)
# summary(HCVData$totalFIB4BY2011==0)
# 
# HCVData$totalFIB4BY2014 <-rowSums(cbind(HCVData$FIB4_2009,
#                                   HCVData$FIB4_2010,
#                                   HCVData$FIB4_2011,
#                                   HCVData$FIB4_2012,
#                                   HCVData$FIB4_2013,
#                                   HCVData$FIB4_2014), na.rm=TRUE)
# summary(HCVData$totalFIB4BY2014==0)
# 
# HCVData$totalFIB4BY2015 <-rowSums(cbind(HCVData$FIB4_2009,
#                                   HCVData$FIB4_2010,
#                                   HCVData$FIB4_2011,
#                                   HCVData$FIB4_2012,
#                                   HCVData$FIB4_2013,
#                                   HCVData$FIB4_2014,
#                                   HCVData$FIB4_2015), na.rm=TRUE)
# summary(HCVData$totalFIB4BY2015==0)
# #note- by 2015 72% of our sample has a FIB4.
# 
# HCVData$totalFIB4BY2016 <-rowSums(cbind(HCVData$FIB4_2009,
#                                   HCVData$FIB4_2010,
#                                   HCVData$FIB4_2011,
#                                   HCVData$FIB4_2012,
#                                   HCVData$FIB4_2013,
#                                   HCVData$FIB4_2014,
#                                   HCVData$FIB4_2015,
#                                   HCVData$FIB4_2016), na.rm=TRUE)
# summary(HCVData$totalFIB4BY2016==0)
# 
# HCVData$totalFIB4BY2017 <-rowSums(cbind(HCVData$FIB4_2009,
#                                   HCVData$FIB4_2010,
#                                   HCVData$FIB4_2011,
#                                   HCVData$FIB4_2012,
#                                   HCVData$FIB4_2013,
#                                   HCVData$FIB4_2014,
#                                   HCVData$FIB4_2015,
#                                   HCVData$FIB4_2016,
#                                   HCVData$FIB4_2017), na.rm=TRUE)
# summary(HCVData$totalFIB4BY2017==0)
# 
# HCVData$totalFIB4BY2018 <-rowSums(cbind(HCVData$FIB4_2009,
#                                   HCVData$FIB4_2010,
#                                   HCVData$FIB4_2011,
#                                   HCVData$FIB4_2012,
#                                   HCVData$FIB4_2013,
#                                   HCVData$FIB4_2014,
#                                   HCVData$FIB4_2015,
#                                   HCVData$FIB4_2016,
#                                   HCVData$FIB4_2017,
#                                   HCVData$FIB4_2018), na.rm=TRUE)
# summary(HCVData$totalFIB4BY2018==0)
# 
# HCVData$totalFIB4BY2019 <-rowSums(cbind(HCVData$FIB4_2009,
#                                   HCVData$FIB4_2010,
#                                   HCVData$FIB4_2011,
#                                   HCVData$FIB4_2012,
#                                   HCVData$FIB4_2013,
#                                   HCVData$FIB4_2014,
#                                   HCVData$FIB4_2015,
#                                   HCVData$FIB4_2016,
#                                   HCVData$FIB4_2017,
#                                   HCVData$FIB4_2018,
#                                   HCVData$FIB4_2019), na.rm=TRUE)
# summary(HCVData$totalFIB4BY2019==0)

#Pulling forward FIB4 scores until 2014 where needed
HCVData <- HCVData %>% mutate(FIB4_by2010 = FIB4_2010, YearsSinceFib4_2010 = 0)
HCVData <- HCVData %>% mutate(FIB4_by2010 = ifelse(is.na(FIB4_2010)== "TRUE", FIB4_2009, FIB4_by2010),
                               YearsSinceFib4_2010 = ifelse(is.na(FIB4_2010)== "TRUE", 1, 0))
 
HCVData <-  HCVData %>% mutate(FIB4_by2011 = FIB4_2011, YearsSinceFib4_2011 = 0)
HCVData <-  HCVData %>% mutate(FIB4_by2011 = ifelse(is.na(FIB4_2011)== "TRUE", FIB4_by2010, FIB4_by2011),
                               YearsSinceFib4_2011 = ifelse(is.na(FIB4_2011)== "TRUE", YearsSinceFib4_2010 + 1, 0))

HCVData <-  HCVData %>% mutate(FIB4_by2012 = FIB4_2012, YearsSinceFib4_2012 = 0)
HCVData <-  HCVData %>% mutate(FIB4_by2012 = ifelse(is.na(FIB4_2012)== "TRUE", FIB4_by2011, FIB4_by2012),
                               YearsSinceFib4_2012 = ifelse(is.na(FIB4_2012)== "TRUE", YearsSinceFib4_2011 + 1, 0))

HCVData <-  HCVData %>% mutate(FIB4_by2013 = FIB4_2013, YearsSinceFib4_2013 = 0)
HCVData <-  HCVData %>%  mutate(FIB4_by2013 = ifelse(is.na(FIB4_2013)== "TRUE", FIB4_by2012, FIB4_by2013),
                               YearsSinceFib4_2013 = ifelse(is.na(FIB4_2013)== "TRUE", YearsSinceFib4_2012 + 1, 0))

HCVData <-  HCVData %>% mutate(FIB4_by2014 = FIB4_2014, YearsSinceFib4_2014 = 0)
HCVData <-  HCVData %>% mutate(FIB4_by2014 = ifelse(is.na(FIB4_2014)== "TRUE", FIB4_by2013, FIB4_by2014),
                               YearsSinceFib4_2014 = ifelse(is.na(FIB4_2014)== "TRUE", YearsSinceFib4_2013 + 1, 0))

#Fixing Outcome Variables
HCVData$HCC_2012only <- ifelse((HCVData$Cancer.Diagnosis.Date<'2012-1-1' | HCVData$Cancer.Diagnosis.Date>'2012-12-31') | is.na(HCVData$Cancer.Diagnosis.Date), 0, 1)
HCVData$HCC_2013only <- ifelse((HCVData$Cancer.Diagnosis.Date<'2013-1-1' | HCVData$Cancer.Diagnosis.Date>'2013-12-31') | is.na(HCVData$Cancer.Diagnosis.Date), 0, 1)
HCVData$HCC_2014only <- ifelse((HCVData$Cancer.Diagnosis.Date<'2014-1-1' | HCVData$Cancer.Diagnosis.Date>'2014-12-31') | is.na(HCVData$Cancer.Diagnosis.Date), 0, 1)
HCVData$HCC_2015only <- ifelse((HCVData$Cancer.Diagnosis.Date<'2015-1-1' | HCVData$Cancer.Diagnosis.Date>'2015-12-31') | is.na(HCVData$Cancer.Diagnosis.Date), 0, 1)
HCVData$HCC_2016only <- ifelse((HCVData$Cancer.Diagnosis.Date<'2016-1-1' | HCVData$Cancer.Diagnosis.Date>'2016-12-31') | is.na(HCVData$Cancer.Diagnosis.Date), 0, 1)
HCVData$HCC_2017only <- ifelse((HCVData$Cancer.Diagnosis.Date<'2017-1-1' | HCVData$Cancer.Diagnosis.Date>'2017-12-31') | is.na(HCVData$Cancer.Diagnosis.Date), 0, 1)
HCVData$HCC_2018only <- ifelse((HCVData$Cancer.Diagnosis.Date<'2018-1-1' | HCVData$Cancer.Diagnosis.Date>'2018-12-31') | is.na(HCVData$Cancer.Diagnosis.Date), 0, 1)
HCVData$HCC_2019only <- ifelse((HCVData$Cancer.Diagnosis.Date<'2019-1-1' | HCVData$Cancer.Diagnosis.Date>'2019-12-31') | is.na(HCVData$Cancer.Diagnosis.Date), 0, 1)

HCVData$HCC_2012 <- ifelse(HCVData$Cancer.Diagnosis.Date>'2012-12-31' | is.na(HCVData$Cancer.Diagnosis.Date), 0, 1)
HCVData$HCC_2013 <- ifelse(HCVData$Cancer.Diagnosis.Date>'2013-12-31' | is.na(HCVData$Cancer.Diagnosis.Date), 0, 1)
HCVData$HCC_2014 <- ifelse(HCVData$Cancer.Diagnosis.Date>'2014-12-31' | is.na(HCVData$Cancer.Diagnosis.Date), 0, 1)
HCVData$HCC_2015 <- ifelse(HCVData$Cancer.Diagnosis.Date>'2015-12-31' | is.na(HCVData$Cancer.Diagnosis.Date), 0, 1)
HCVData$HCC_2016 <- ifelse(HCVData$Cancer.Diagnosis.Date>'2016-12-31' | is.na(HCVData$Cancer.Diagnosis.Date), 0, 1)
HCVData$HCC_2017 <- ifelse(HCVData$Cancer.Diagnosis.Date>'2017-12-31' | is.na(HCVData$Cancer.Diagnosis.Date), 0, 1)
HCVData$HCC_2018 <- ifelse(HCVData$Cancer.Diagnosis.Date>'2018-12-31' | is.na(HCVData$Cancer.Diagnosis.Date), 0, 1)
HCVData$HCC_2019 <- ifelse(HCVData$Cancer.Diagnosis.Date>'2019-12-31' | is.na(HCVData$Cancer.Diagnosis.Date), 0, 1)

HCVData$InSystemBy2015 <- ifelse(as.POSIXct(HCVData$First.Hep.Appt) <'2015-12-31' | 
                                   as.POSIXct(HCVData$FIRST_PC_APPT) <'2015-12-31' | 
                                   as.POSIXct(HCVData$First.Hep.Appt) <'2015-12-31' | 
                                   as.POSIXct(HCVData$date.first.pos.HCV.test) < '2015-12-31' | 
                                   as.POSIXct(HCVData$Date.First.Pos.RNA) < '2015-12-31' | 
                                   as.POSIXct(HCVData$AFP.Date) < '2015-12-31'| 
                                   as.POSIXct(HCVData$Lowest.Platelet.Date) < '2015-12-31'| 
                                   as.POSIXct(HCVData$APPT_DATE) < '2015-12-31' | 
                                   as.POSIXct(HCVData$HBsAG.Date) < '2015-12-31' | 
                                   as.POSIXct(HCVData$HBsAg_Date) < '2015-12-31'| 
                                   as.POSIXct(HCVData$HIV.Date) < '2015-12-31'|
                                   as.POSIXct(HCVData$HepA_IgG.Date) < '2015-12-31'|
                                   as.POSIXct(HCVData$HEPB_CORE_IgM_Date) < '2015-12-31' |
                                   as.POSIXct(HCVData$HEPB_CORE_Total_Date) < '2015-12-31' |
                                   as.POSIXct(HCVData$ABD_IMAGING_DATE) < '2015-12-31' |
                                   as.POSIXct(HCVData$BIOPSY_DATE) < '2015-12-31' |
                                   HCVData$VISIT_COUNT_2011 >0 |
                                   HCVData$VISIT_COUNT_2012 >0 |
                                   HCVData$VISIT_COUNT_2013 >0 |
                                   HCVData$VISIT_COUNT_2014 >0 |
                                   HCVData$VISIT_COUNT_2015 >0 |
                                   !is.na(HCVData$AST_2009) |
                                   !is.na(HCVData$AST_2010) |
                                   !is.na(HCVData$AST_2011) |
                                   !is.na(HCVData$AST_2012) |
                                   !is.na(HCVData$AST_2013) |
                                   !is.na(HCVData$AST_2014) |
                                   !is.na(HCVData$AST_2015) |
                                   !is.na(HCVData$ALT_2009) |
                                   !is.na(HCVData$ALT_2010) |
                                   !is.na(HCVData$ALT_2011) |
                                   !is.na(HCVData$ALT_2012) |
                                   !is.na(HCVData$ALT_2013) |
                                   !is.na(HCVData$ALT_2014) |
                                   !is.na(HCVData$ALT_2015) |
                                   !is.na(HCVData$PLATELET_2009) |
                                   !is.na(HCVData$PLATELET_2010) |
                                   !is.na(HCVData$PLATELET_2011) |
                                   !is.na(HCVData$PLATELET_2012) |
                                   !is.na(HCVData$PLATELET_2013) |
                                   !is.na(HCVData$PLATELET_2014) |
                                   !is.na(HCVData$PLATELET_2015), 1, 0)

#Filtering to those who had some visits in 2015-2019, were adults at the start of 2015 and didn't have HCC before 12/31/14
HCVData <- HCVData %>% filter(TotalVisits != 0) %>%
                      filter(AGE_2015 >18) %>%
                      filter(HCC_2014 == 0) %>%
                      filter(InSystemBy2015 ==1)

#Changing abdominal imaging variables to be zero if it's NA
HCVData$ABD_IMAGING_2015[is.na(HCVData$ABD_IMAGING_2015)] <-0
HCVData$ABD_IMAGING_2016[is.na(HCVData$ABD_IMAGING_2016)] <-0
HCVData$ABD_IMAGING_2017[is.na(HCVData$ABD_IMAGING_2017)] <-0
HCVData$ABD_IMAGING_2018[is.na(HCVData$ABD_IMAGING_2018)] <-0

#Making Abd imaging variables that are yes/no to whether someone had imaging that year
HCVData$ABD_IMAGING_YN_2015[HCVData$ABD_IMAGING_2015 == 0] <- 0
HCVData$ABD_IMAGING_YN_2015[HCVData$ABD_IMAGING_2015 > 0] <- 1

HCVData$ABD_IMAGING_YN_2016[HCVData$ABD_IMAGING_2016 == 0] <- 0
HCVData$ABD_IMAGING_YN_2016[HCVData$ABD_IMAGING_2016 > 0] <- 1

HCVData$ABD_IMAGING_YN_2017[HCVData$ABD_IMAGING_2017 == 0] <- 0
HCVData$ABD_IMAGING_YN_2017[HCVData$ABD_IMAGING_2017 > 0] <- 1

HCVData$ABD_IMAGING_YN_2018[HCVData$ABD_IMAGING_2018 == 0] <- 0
HCVData$ABD_IMAGING_YN_2018[HCVData$ABD_IMAGING_2018 > 0] <- 1

#These were just to explore the data once we filtered out those with cirrhosis at baseline
# table(HCVData_inclcirr$HCC_2019)
# table(HCVData$HCC_2019)
# HCVData_outcome <- HCVData %>% filter(HCC_2019==1)
# HCVData_nooutcome <- HCVData %>% filter(HCC_2019==0)
# summary(HCVData_outcome$FIB4_2019)
# summary(HCVData_nooutcome$FIB4_2019)
# 
# table(HCVData$VISIT_COUNT_2015, HCVData$ABD_IMAGING_2015)
# 
# HCVData_imaging <- HCVData %>% filter(HCVData$ABD_IMAGING_2015 > 0 & HCVData$ABD_IMAGING_2016 > 0 & HCVData$ABD_IMAGING_2017 > 0 & HCVData$ABD_IMAGING_2018 > 0)
# table(HCVData_imaging$HCC_2019)


#impute FIB4, SES, Race
impute <- c("PtID", "PayorType", "race.ethnicity", "FIB4_by2014")
keeps <- c("PayorType", "race.ethnicity", "FIB4_by2014")
imputation <- mice(HCVData[, (names(HCVData) %in% impute)], m=5, maxit=5, printFlag=TRUE, seed = 252)

impute1 <- complete(imputation, 1)
impute2 <- complete(imputation, 2)
impute3 <- complete(imputation, 3)
impute4 <- complete(imputation, 4)
impute5 <- complete(imputation, 5)
HCVData1 <- merge(impute1, HCVData[, !(names(HCVData) %in% keeps)], by = "PtID")
HCVData2 <- merge(impute2, HCVData[, !(names(HCVData) %in% keeps)], by = "PtID")
HCVData3 <- merge(impute3, HCVData[, !(names(HCVData) %in% keeps)], by = "PtID")
HCVData4 <- merge(impute4, HCVData[, !(names(HCVData) %in% keeps)], by = "PtID")
HCVData5 <- merge(impute5, HCVData[, !(names(HCVData) %in% keeps)], by = "PtID")

# imputed <- rbindlist(list(impute1, impute2, impute3, impute4, impute5))[,lapply(.SD,mean), list(PtID)]
# 
# calculate_mode <- function(x) {
#   uniqx <- unique(na.omit(x))
#   uniqx[which.max(tabulate(match(x, uniqx)))]
# }
# race.ethnicity_imp <- mode()

# #OLD - keeping just in case
# #Imputing as the median value for those without a FIB4 by 2014
# HCVData <-  HCVData %>% mutate(YearsSinceFib4_2014 = ifelse(is.na(FIB4_by2014)== "TRUE", 0, YearsSinceFib4_2014),
#                                ImputedFIB4_2014 = ifelse(is.na(FIB4_by2014)== "TRUE", 1, 0),
#                                FIB4_by2014 = ifelse(is.na(FIB4_by2014)== "TRUE", median(HCVData$FIB4_by2014,na.rm= "TRUE"), FIB4_by2014))
# 
# HCVData <-  HCVData %>% mutate(FIB4_by2015 = FIB4_2015, YearsSinceFib4_2015 = 0)
# HCVData <-  HCVData %>% mutate(FIB4_by2015 = ifelse(is.na(FIB4_2015)== "TRUE", FIB4_by2014, FIB4_by2015),
#                                YearsSinceFib4_2015 = ifelse(is.na(FIB4_2015)== "TRUE", YearsSinceFib4_2014 + 1, 0),
#                                ImputedFIB4_2015 = ifelse(is.na(FIB4_2015)== "TRUE", ImputedFIB4_2014, 0))
# 
# HCVData <-  HCVData %>% mutate(FIB4_by2016 = FIB4_2016, YearsSinceFib4_2016 = 0)
# HCVData <-  HCVData %>% mutate(FIB4_by2016 = ifelse(is.na(FIB4_2016)== "TRUE", FIB4_by2015, FIB4_by2016),
#                                YearsSinceFib4_2016 = ifelse(is.na(FIB4_2016)== "TRUE", YearsSinceFib4_2015 + 1, 0),
#                                ImputedFIB4_2016 = ifelse(is.na(FIB4_2016)== "TRUE", ImputedFIB4_2015, 0))
# 
# HCVData <-  HCVData %>% mutate(FIB4_by2017 = FIB4_2017, YearsSinceFib4_2017 = 0)
# HCVData <-  HCVData %>% mutate(FIB4_by2017 = ifelse(is.na(FIB4_2017)== "TRUE", FIB4_by2016, FIB4_by2017),
#                                YearsSinceFib4_2017 = ifelse(is.na(FIB4_2017)== "TRUE", YearsSinceFib4_2016 + 1, 0),
#                                ImputedFIB4_2017 = ifelse(is.na(FIB4_2017)== "TRUE", ImputedFIB4_2016, 0))
# 
# HCVData <-  HCVData %>% mutate(FIB4_by2018 = FIB4_2018, YearsSinceFib4_2018 = 0)
# HCVData <-  HCVData %>% mutate(FIB4_by2018 = ifelse(is.na(FIB4_2018)== "TRUE", FIB4_by2017, FIB4_by2018),
#                                YearsSinceFib4_2018 = ifelse(is.na(FIB4_2018)== "TRUE", YearsSinceFib4_2017 + 1, 0),
#                                ImputedFIB4_2018 = ifelse(is.na(FIB4_2018)== "TRUE", ImputedFIB4_2017, 0))
# 
# HCVData <-  HCVData %>% mutate(FIB4_by2019 = FIB4_2019, YearsSinceFib4_2019 = 0)
# HCVData <-  HCVData %>% mutate(FIB4_by2019 = ifelse(is.na(FIB4_2019)== "TRUE", FIB4_by2018, FIB4_by2019),
#                                YearsSinceFib4_2019 = ifelse(is.na(FIB4_2019)== "TRUE", YearsSinceFib4_2018 + 1, 0),
#                                ImputedFIB4_2019 = ifelse(is.na(FIB4_2019)== "TRUE", ImputedFIB4_2018, 0))

#Filtering to those with no cirrhosis at baseline
HCVData1 <- HCVData1 %>% filter(FIB4_by2014 < 3.25)
HCVData2 <- HCVData2 %>% filter(FIB4_by2014 < 3.25)
HCVData3 <- HCVData3 %>% filter(FIB4_by2014 < 3.25)
HCVData4 <- HCVData4 %>% filter(FIB4_by2014 < 3.25)
HCVData5 <- HCVData5 %>% filter(FIB4_by2014 < 3.25)

#Pulling forward FIB4s post-2014
HCVData1 <-  HCVData1 %>% mutate(FIB4_by2015 = FIB4_2015, YearsSinceFib4_2015 = 0)
HCVData1 <-  HCVData1 %>% mutate(FIB4_by2015 = ifelse(is.na(FIB4_2015)== "TRUE", FIB4_by2014, FIB4_by2015),
                               YearsSinceFib4_2015 = ifelse(is.na(FIB4_2015)== "TRUE", YearsSinceFib4_2014 + 1, 0),
                               ImputedFIB4_2015 = ifelse(is.na(FIB4_2015)== "TRUE", ImputedFIB4_2014, 0))
HCVData1 <-  HCVData1 %>% mutate(FIB4_by2016 = FIB4_2016, YearsSinceFib4_2016 = 0)
HCVData1 <-  HCVData1 %>% mutate(FIB4_by2016 = ifelse(is.na(FIB4_2016)== "TRUE", FIB4_by2015, FIB4_by2016),
                               YearsSinceFib4_2016 = ifelse(is.na(FIB4_2016)== "TRUE", YearsSinceFib4_2015 + 1, 0),
                               ImputedFIB4_2016 = ifelse(is.na(FIB4_2016)== "TRUE", ImputedFIB4_2015, 0))
HCVData1 <-  HCVData1 %>% mutate(FIB4_by2017 = FIB4_2017, YearsSinceFib4_2017 = 0)
HCVData1 <-  HCVData1 %>% mutate(FIB4_by2017 = ifelse(is.na(FIB4_2017)== "TRUE", FIB4_by2016, FIB4_by2017),
                               YearsSinceFib4_2017 = ifelse(is.na(FIB4_2017)== "TRUE", YearsSinceFib4_2016 + 1, 0),
                               ImputedFIB4_2017 = ifelse(is.na(FIB4_2017)== "TRUE", ImputedFIB4_2016, 0))
HCVData1 <-  HCVData1 %>% mutate(FIB4_by2018 = FIB4_2018, YearsSinceFib4_2018 = 0)
HCVData1 <-  HCVData1 %>% mutate(FIB4_by2018 = ifelse(is.na(FIB4_2018)== "TRUE", FIB4_by2017, FIB4_by2018),
                               YearsSinceFib4_2018 = ifelse(is.na(FIB4_2018)== "TRUE", YearsSinceFib4_2017 + 1, 0),
                               ImputedFIB4_2018 = ifelse(is.na(FIB4_2018)== "TRUE", ImputedFIB4_2017, 0))
HCVData1 <-  HCVData1 %>% mutate(FIB4_by2019 = FIB4_2019, YearsSinceFib4_2019 = 0)
HCVData1 <-  HCVData1 %>% mutate(FIB4_by2019 = ifelse(is.na(FIB4_2019)== "TRUE", FIB4_by2018, FIB4_by2019),
                               YearsSinceFib4_2019 = ifelse(is.na(FIB4_2019)== "TRUE", YearsSinceFib4_2018 + 1, 0),
                               ImputedFIB4_2019 = ifelse(is.na(FIB4_2019)== "TRUE", ImputedFIB4_2018, 0))

HCVData2 <-  HCVData2 %>% mutate(FIB4_by2015 = FIB4_2015, YearsSinceFib4_2015 = 0)
HCVData2 <-  HCVData2 %>% mutate(FIB4_by2015 = ifelse(is.na(FIB4_2015)== "TRUE", FIB4_by2014, FIB4_by2015),
                               YearsSinceFib4_2015 = ifelse(is.na(FIB4_2015)== "TRUE", YearsSinceFib4_2014 + 1, 0),
                               ImputedFIB4_2015 = ifelse(is.na(FIB4_2015)== "TRUE", ImputedFIB4_2014, 0))
HCVData2 <-  HCVData2 %>% mutate(FIB4_by2016 = FIB4_2016, YearsSinceFib4_2016 = 0)
HCVData2 <-  HCVData2 %>% mutate(FIB4_by2016 = ifelse(is.na(FIB4_2016)== "TRUE", FIB4_by2015, FIB4_by2016),
                               YearsSinceFib4_2016 = ifelse(is.na(FIB4_2016)== "TRUE", YearsSinceFib4_2015 + 1, 0),
                               ImputedFIB4_2016 = ifelse(is.na(FIB4_2016)== "TRUE", ImputedFIB4_2015, 0))
HCVData2 <-  HCVData2 %>% mutate(FIB4_by2017 = FIB4_2017, YearsSinceFib4_2017 = 0)
HCVData2 <-  HCVData2 %>% mutate(FIB4_by2017 = ifelse(is.na(FIB4_2017)== "TRUE", FIB4_by2016, FIB4_by2017),
                               YearsSinceFib4_2017 = ifelse(is.na(FIB4_2017)== "TRUE", YearsSinceFib4_2016 + 1, 0),
                               ImputedFIB4_2017 = ifelse(is.na(FIB4_2017)== "TRUE", ImputedFIB4_2016, 0))
HCVData2 <-  HCVData2 %>% mutate(FIB4_by2018 = FIB4_2018, YearsSinceFib4_2018 = 0)
HCVData2 <-  HCVData2 %>% mutate(FIB4_by2018 = ifelse(is.na(FIB4_2018)== "TRUE", FIB4_by2017, FIB4_by2018),
                               YearsSinceFib4_2018 = ifelse(is.na(FIB4_2018)== "TRUE", YearsSinceFib4_2017 + 1, 0),
                               ImputedFIB4_2018 = ifelse(is.na(FIB4_2018)== "TRUE", ImputedFIB4_2017, 0))
HCVData2 <-  HCVData2 %>% mutate(FIB4_by2019 = FIB4_2019, YearsSinceFib4_2019 = 0)
HCVData2 <-  HCVData2 %>% mutate(FIB4_by2019 = ifelse(is.na(FIB4_2019)== "TRUE", FIB4_by2018, FIB4_by2019),
                               YearsSinceFib4_2019 = ifelse(is.na(FIB4_2019)== "TRUE", YearsSinceFib4_2018 + 1, 0),
                               ImputedFIB4_2019 = ifelse(is.na(FIB4_2019)== "TRUE", ImputedFIB4_2018, 0))

HCVData3 <-  HCVData3 %>% mutate(FIB4_by2015 = FIB4_2015, YearsSinceFib4_2015 = 0)
HCVData3 <-  HCVData3 %>% mutate(FIB4_by2015 = ifelse(is.na(FIB4_2015)== "TRUE", FIB4_by2014, FIB4_by2015),
                               YearsSinceFib4_2015 = ifelse(is.na(FIB4_2015)== "TRUE", YearsSinceFib4_2014 + 1, 0),
                               ImputedFIB4_2015 = ifelse(is.na(FIB4_2015)== "TRUE", ImputedFIB4_2014, 0))
HCVData3 <-  HCVData3 %>% mutate(FIB4_by2016 = FIB4_2016, YearsSinceFib4_2016 = 0)
HCVData3 <-  HCVData3 %>% mutate(FIB4_by2016 = ifelse(is.na(FIB4_2016)== "TRUE", FIB4_by2015, FIB4_by2016),
                               YearsSinceFib4_2016 = ifelse(is.na(FIB4_2016)== "TRUE", YearsSinceFib4_2015 + 1, 0),
                               ImputedFIB4_2016 = ifelse(is.na(FIB4_2016)== "TRUE", ImputedFIB4_2015, 0))
HCVData3 <-  HCVData3 %>% mutate(FIB4_by2017 = FIB4_2017, YearsSinceFib4_2017 = 0)
HCVData3 <-  HCVData3 %>% mutate(FIB4_by2017 = ifelse(is.na(FIB4_2017)== "TRUE", FIB4_by2016, FIB4_by2017),
                               YearsSinceFib4_2017 = ifelse(is.na(FIB4_2017)== "TRUE", YearsSinceFib4_2016 + 1, 0),
                               ImputedFIB4_2017 = ifelse(is.na(FIB4_2017)== "TRUE", ImputedFIB4_2016, 0))
HCVData3 <-  HCVData3 %>% mutate(FIB4_by2018 = FIB4_2018, YearsSinceFib4_2018 = 0)
HCVData3 <-  HCVData3 %>% mutate(FIB4_by2018 = ifelse(is.na(FIB4_2018)== "TRUE", FIB4_by2017, FIB4_by2018),
                               YearsSinceFib4_2018 = ifelse(is.na(FIB4_2018)== "TRUE", YearsSinceFib4_2017 + 1, 0),
                               ImputedFIB4_2018 = ifelse(is.na(FIB4_2018)== "TRUE", ImputedFIB4_2017, 0))
HCVData3 <-  HCVData3 %>% mutate(FIB4_by2019 = FIB4_2019, YearsSinceFib4_2019 = 0)
HCVData3 <-  HCVData3 %>% mutate(FIB4_by2019 = ifelse(is.na(FIB4_2019)== "TRUE", FIB4_by2018, FIB4_by2019),
                               YearsSinceFib4_2019 = ifelse(is.na(FIB4_2019)== "TRUE", YearsSinceFib4_2018 + 1, 0),
                               ImputedFIB4_2019 = ifelse(is.na(FIB4_2019)== "TRUE", ImputedFIB4_2018, 0))

HCVData4 <-  HCVData4 %>% mutate(FIB4_by2015 = FIB4_2015, YearsSinceFib4_2015 = 0)
HCVData4 <-  HCVData4 %>% mutate(FIB4_by2015 = ifelse(is.na(FIB4_2015)== "TRUE", FIB4_by2014, FIB4_by2015),
                               YearsSinceFib4_2015 = ifelse(is.na(FIB4_2015)== "TRUE", YearsSinceFib4_2014 + 1, 0),
                               ImputedFIB4_2015 = ifelse(is.na(FIB4_2015)== "TRUE", ImputedFIB4_2014, 0))
HCVData4 <-  HCVData4 %>% mutate(FIB4_by2016 = FIB4_2016, YearsSinceFib4_2016 = 0)
HCVData4 <-  HCVData4 %>% mutate(FIB4_by2016 = ifelse(is.na(FIB4_2016)== "TRUE", FIB4_by2015, FIB4_by2016),
                               YearsSinceFib4_2016 = ifelse(is.na(FIB4_2016)== "TRUE", YearsSinceFib4_2015 + 1, 0),
                               ImputedFIB4_2016 = ifelse(is.na(FIB4_2016)== "TRUE", ImputedFIB4_2015, 0))
HCVData4 <-  HCVData4 %>% mutate(FIB4_by2017 = FIB4_2017, YearsSinceFib4_2017 = 0)
HCVData4 <-  HCVData4 %>% mutate(FIB4_by2017 = ifelse(is.na(FIB4_2017)== "TRUE", FIB4_by2016, FIB4_by2017),
                               YearsSinceFib4_2017 = ifelse(is.na(FIB4_2017)== "TRUE", YearsSinceFib4_2016 + 1, 0),
                               ImputedFIB4_2017 = ifelse(is.na(FIB4_2017)== "TRUE", ImputedFIB4_2016, 0))
HCVData4 <-  HCVData4 %>% mutate(FIB4_by2018 = FIB4_2018, YearsSinceFib4_2018 = 0)
HCVData4 <-  HCVData4 %>% mutate(FIB4_by2018 = ifelse(is.na(FIB4_2018)== "TRUE", FIB4_by2017, FIB4_by2018),
                               YearsSinceFib4_2018 = ifelse(is.na(FIB4_2018)== "TRUE", YearsSinceFib4_2017 + 1, 0),
                               ImputedFIB4_2018 = ifelse(is.na(FIB4_2018)== "TRUE", ImputedFIB4_2017, 0))
HCVData4 <-  HCVData4 %>% mutate(FIB4_by2019 = FIB4_2019, YearsSinceFib4_2019 = 0)
HCVData4 <-  HCVData4 %>% mutate(FIB4_by2019 = ifelse(is.na(FIB4_2019)== "TRUE", FIB4_by2018, FIB4_by2019),
                               YearsSinceFib4_2019 = ifelse(is.na(FIB4_2019)== "TRUE", YearsSinceFib4_2018 + 1, 0),
                               ImputedFIB4_2019 = ifelse(is.na(FIB4_2019)== "TRUE", ImputedFIB4_2018, 0))

HCVData5 <-  HCVData5 %>% mutate(FIB4_by2015 = FIB4_2015, YearsSinceFib4_2015 = 0)
HCVData5 <-  HCVData5 %>% mutate(FIB4_by2015 = ifelse(is.na(FIB4_2015)== "TRUE", FIB4_by2014, FIB4_by2015),
                               YearsSinceFib4_2015 = ifelse(is.na(FIB4_2015)== "TRUE", YearsSinceFib4_2014 + 1, 0),
                               ImputedFIB4_2015 = ifelse(is.na(FIB4_2015)== "TRUE", ImputedFIB4_2014, 0))
HCVData5 <-  HCVData5 %>% mutate(FIB4_by2016 = FIB4_2016, YearsSinceFib4_2016 = 0)
HCVData5 <-  HCVData5 %>% mutate(FIB4_by2016 = ifelse(is.na(FIB4_2016)== "TRUE", FIB4_by2015, FIB4_by2016),
                               YearsSinceFib4_2016 = ifelse(is.na(FIB4_2016)== "TRUE", YearsSinceFib4_2015 + 1, 0),
                               ImputedFIB4_2016 = ifelse(is.na(FIB4_2016)== "TRUE", ImputedFIB4_2015, 0))
HCVData5 <-  HCVData5 %>% mutate(FIB4_by2017 = FIB4_2017, YearsSinceFib4_2017 = 0)
HCVData5 <-  HCVData5 %>% mutate(FIB4_by2017 = ifelse(is.na(FIB4_2017)== "TRUE", FIB4_by2016, FIB4_by2017),
                               YearsSinceFib4_2017 = ifelse(is.na(FIB4_2017)== "TRUE", YearsSinceFib4_2016 + 1, 0),
                               ImputedFIB4_2017 = ifelse(is.na(FIB4_2017)== "TRUE", ImputedFIB4_2016, 0))
HCVData5 <-  HCVData5 %>% mutate(FIB4_by2018 = FIB4_2018, YearsSinceFib4_2018 = 0)
HCVData5 <-  HCVData5 %>% mutate(FIB4_by2018 = ifelse(is.na(FIB4_2018)== "TRUE", FIB4_by2017, FIB4_by2018),
                               YearsSinceFib4_2018 = ifelse(is.na(FIB4_2018)== "TRUE", YearsSinceFib4_2017 + 1, 0),
                               ImputedFIB4_2018 = ifelse(is.na(FIB4_2018)== "TRUE", ImputedFIB4_2017, 0))
HCVData5 <-  HCVData5 %>% mutate(FIB4_by2019 = FIB4_2019, YearsSinceFib4_2019 = 0)
HCVData5 <-  HCVData5 %>% mutate(FIB4_by2019 = ifelse(is.na(FIB4_2019)== "TRUE", FIB4_by2018, FIB4_by2019),
                               YearsSinceFib4_2019 = ifelse(is.na(FIB4_2019)== "TRUE", YearsSinceFib4_2018 + 1, 0),
                               ImputedFIB4_2019 = ifelse(is.na(FIB4_2019)== "TRUE", ImputedFIB4_2018, 0))
```

We have restricted our dataset to adult UCSF patients diagnosed with HCV who, prior to the start of follow up (ie. as of 12/31/14) had no cirrhosis and no HCC. (n = `r nrow(HCVData1)`) For those who had been in the system prior to 2015, historical data back to 2011 was used to calculate their FIB-4 score at the beinning of follow up (ie. by the end of 2014), for those who did not yet have those data, the FIB-4 score in 2014 was imputed using multiple imputation (m=5). 

<!-- reminder that if someone had no data through 2014, and first showed up in 2015, they're still in this dataset even if they had, say, cirrhosis diagnosed elsewhere prior to 2015. So we should be careful to describe the dataset as those in the system, 'not known to have cirrhosis' prior to 1/1/2015 or sth similar-->

```{r demographics, include = FALSE, eval = TRUE}
#note that the demographics in this table are based on imputation dataset 1, for simplicity
sex <- table(HCVData1$Sex, useNA = "ifany")
race <- table(HCVData1$race.ethnicity, useNA  = "ifany")
SES <- table(HCVData1$PayorType, useNA = "ifany")
n <- nrow(HCVData1)
male <- sex[2]
malep <- male/n*100
female <- sex[1]
femalep <- female/n*100
white <- race[4]
whitep <- white/n*100
black <- race[1]
blackp <- black/n*100
latinx <- race[2]
latinxp <- latinx/n*100
other <- race[3]
otherp <- other/n*100
unkrace <- race[5]
unkracep <- unkrace/n*100
medical <- SES[1]
medicalp <- medical/n*100
notmedical <- SES[2]
notmedicalp <- notmedical/n*100

```

* \textbf{Sex}. This is a dichotomous variable, with two categories (male, female), as UCSF has not been capturing other gender categories within Epic.

* \textbf{Race}. This is a categorical variable, which we have recategorized into White, Black/African American, Latinx, and Other for ease of analysis.

* \textbf{SES}. We are using insurance type (Medi-Cal, or not Medi-Cal) as a marker of SES status, which is again a dichotomous variable.

The table below displays the demographic breakdown of the sample.

| Demographic | Category | n | % |
| ----------------- | ----------------- | -------- | --------|
| Sex | Male | `r male` | `r round(malep, 1)`% |
|        | Female | `r female` | `r round(femalep, 1)`% |
|  | 
|        | Black/African American | `r black` | `r round(blackp, 1)`% |
|        | Latinx | `r latinx` | `r round(latinxp, 1)`% |
| Race/ethnicity | White | `r white` | `r round(whitep, 1)`% |
|        | Other | `r other` | `r round(otherp, 1)`% |
|        | Unknown | `r unkrace` | `r round(unkracep, 1)`% |  
|  | 
|   SES (Payor type)   | Medi-Cal | `r medical` | `r round(medicalp, 1)`% |
|  | Not Medi-Cal | `r notmedical` | `r round(notmedicalp, 1)`% |
|  | 
| TOTAL | | `r n` | 100% |
 

<!-- From here on we're using code from prior labs, for data structure 3 (the survival structure) -->
<!-- Data Structure 3: $O = (L(1), A(1), Y(2), L(2), A(2), Y(3))$ -->

Here, $Y(t)$ is an indicator variable describing whether or not the patient has been diagnosed with HCC by time $t$; as such, it deterministically jumps to 1 and remains there once an individual has become ill. 

```{r Simulation Prep}

#First just exploring our data distributions so our sims can match
#Because A is the number imaging occurrences in a year, A1 is imaging in 2015, A2 is in 2016...
summary(HCVData$ABD_IMAGING_YN_2015)
summary(HCVData$ABD_IMAGING_YN_2016)
summary(HCVData$ABD_IMAGING_YN_2017)
summary(HCVData$ABD_IMAGING_YN_2018)

#Because L_a is visit count, L_a1 is visits in 2015,...
summary(HCVData$VISIT_COUNT_2015)
summary(HCVData$VISIT_COUNT_2016)
summary(HCVData$VISIT_COUNT_2017)
summary(HCVData$VISIT_COUNT_2018)

#Because L_b is fib4 score, L_b1 is FIB4 in 2015,...
summary(HCVData$FIB4_by2015)
summary(HCVData$FIB4_by2016)
summary(HCVData$FIB4_by2017)
summary(HCVData$FIB4_by2018)

    #In case we're curious, this shows what percent of the FIB4 scores are using the imputed values
    summary(HCVData$ImputedFIB4_2015)
    summary(HCVData$ImputedFIB4_2016)
    summary(HCVData$ImputedFIB4_2017)
    summary(HCVData$ImputedFIB4_2018)
    #and what percent among the cases
    HCVData %>% filter(HCC_2019 == 1) %>% summarise(n(), mean(ImputedFIB4_2015), mean(ImputedFIB4_2018))

#Because Y is HCC occurence, Y2 is HCV diagnoses in 2016...
summary(HCVData$HCC_2016)
summary(HCVData$HCC_2017)
summary(HCVData$HCC_2018)
summary(HCVData$HCC_2019)


#So that our w's will represent the distributions in the population

racep1 = race[1]/nrow(HCVData)
racep2 = race[2]/nrow(HCVData)
racep4 = race[4]/nrow(HCVData)
racep3 = (race[3]+ race[5])/nrow(HCVData)
sexp1 = sex[1]/nrow(HCVData)
sexp2 = sex[2]/nrow(HCVData)
SESp1 = SES[1]/nrow(HCVData)
SESp2 = SES[2]/nrow(HCVData)

w1 = racep1 * sexp1 * SESp1
w2 = racep1 * sexp1 * SESp2
w3 = racep1 * sexp2 * SESp1
w4 = racep1 * sexp2 * SESp1

w5 = racep2 * sexp1 * SESp1
w6 = racep2 * sexp1 * SESp2
w7 = racep2 * sexp2 * SESp1
w8 = racep2 * sexp2 * SESp2

w9 = racep3 * sexp1 * SESp1
w10 = racep3 * sexp1 * SESp2
w11 = racep3 * sexp2 * SESp1
w12 = racep3 * sexp2 * SESp2

w13 = racep4 * sexp1 * SESp1
w14 = racep4 * sexp1 * SESp2
w15 = racep4 * sexp2 * SESp1
w16 = racep4 * sexp2 * SESp2
```


```{r Data Structure 3 Simulation From R Lab 1, cache = TRUE}
#2. write function to generate O = (L(1), A(1), Y(2), ...Y(3))
generate_data  <- function(n) {
  U <- data.frame(UW = runif(n = n, min = 0, max = 1),
                  ULa1 = rnbinom(n=n, size = 4, prob = 0.6), 
                  ULa2 = rnbinom(n=n, size = 4, prob = 0.6), 
                  ULa3 = rnbinom(n=n, size = 4, prob = 0.6), 
                  ULa4 = rnbinom(n=n, size = 4, prob = 0.6), 
                  ULa5 = rnbinom(n=n, size = 4, prob = 0.6),  
                  ULb1 = rgamma(n = n, shape = 2, scale = 1), 
                  ULb2 = rgamma(n = n, shape = 2, scale = 1), 
                  ULb3 = rgamma(n = n, shape = 2, scale = 1), 
                  ULb4 = rgamma(n = n, shape = 2, scale = 1), 
                  ULb5 = rgamma(n = n, shape = 2, scale = 1), 
                  UA1 = runif(n=n, min = 0, max = 1),
                  UA2 = runif(n=n, min = 0, max = 1),
                  UA3 = runif(n=n, min = 0, max = 1),
                  UA4 = runif(n=n, min = 0, max = 1),
                  UA5 = runif(n=n, min = 0, max = 1),
                  UY2 = runif(n=n, min = 0, max = 1),
                  UY3 = runif(n=n, min = 0, max = 1),
                  UY4 = runif(n=n, min = 0, max = 1),
                  UY5 = runif(n=n, min = 0, max = 1))
  
  O <- U
  O <- O %>% 
    mutate(W = ifelse(UW < w1, 1,
                      ifelse(UW<(w1+w2), 2,
                             ifelse(UW<(w1+w2+w3), 3, 
                                    ifelse(UW<(w1+w2+w3+w4),4,
                                           ifelse(UW<(w1+w2+w3+w4+w5), 5,
                                                  ifelse(UW<(w1+w2+w3+w4+w5+w6), 6, 
                                                         ifelse(UW<(w1+w2+w3+w4+w5+w6+w7), 7, 
                        ifelse(UW<(w1+w2+w3+w4+w5+w6+w7+w8), 8, 
                               ifelse(UW<(w1+w2+w3+w4+w5+w6+w7+w8+w9), 9,
                                      ifelse(UW<(w1+w2+w3+w4+w5+w6+w7+w8+w9+w10), 10,
                                             ifelse(UW<(w1+w2+w3+w4+w5+w6+w7+w8+w9+w10+w11), 11,
                        ifelse(UW<(w1+w2+w3+w4+w5+w6+w7+w8+w9+w10+w11+w12), 12,
                                ifelse(UW<(w1+w2+w3+w4+w5+w6+w7+w8+w9+w10+w11+w12+w13), 13,
                        ifelse(UW<(w1+w2+w3+w4+w5+w6+w7+w8+w9+w10+w11+w12+w13+w14), 14,
                                ifelse(UW<(w1+w2+w3+w4+w5+w6+w7+w8+w9+w10+w11+w12+w13+w14+w15), 15, 16))))))))))))))),
           La1 = ULa1,
           Lb1 = ULb1,
           A1 = as.numeric(UA1 < 0.33* plogis(La1 + Lb1)),
           Y2 = as.numeric(UY2 < 0.07*plogis(Lb1 - La1 - A1)),
           
           La2 = ifelse(Y2==0, La1 + 0.1*ULa2, NA),
           Lb2 = ifelse(Y2==0, as.integer(Lb1 + 0.1*ULb2), NA),
           A2  = ifelse(Y2==0, as.numeric(UA2 < 0.33* plogis((La2 + Lb2 + A1))),NA),
           Y3  = ifelse(Y2==0, as.numeric(UY3 < 0.07*plogis(Lb2 - La2 - A2)),1),
           
           La3 = ifelse(Y3==0, La2 + 0.1*ULa3, NA),
           Lb3 = ifelse(Y3==0, as.integer(Lb2 + 0.1*ULb3), NA),
           A3  = ifelse(Y3==0, as.numeric(UA3 < 0.33* plogis((La3 + Lb3 + A2))),NA),
           Y4  = ifelse(Y3==0, as.numeric(UY4 < 0.07*plogis(Lb3 - La3 - A3)),1),
           
           La4 = ifelse(Y4==0, La3 + 0.1*ULa4, NA),
           Lb4 = ifelse(Y4==0, as.integer(Lb3 + 0.1*ULb4), NA),
           A4  = ifelse(Y4==0, as.numeric(UA4 < 0.33* plogis((La4 + Lb4 + A3))),NA),
           Y5  = ifelse(Y4==0, as.numeric(UY5 < 0.07*plogis(Lb4 - La4 - A4)),1)
           )
  return(O)
}

SimData <- generate_data(100000)
#skimr::skim(SimData)
```

Causal Question: How would the counterfactual probability of getting HCC differ by the end of the 5 year follow up under an intervention to get abdominal imaging at least once a year every year for four years?
 
The target causal parameter is $\psi^F (\mathcal{P}_{U,X}) = E_{U,X}(Y_{\bar{a}=1(5)}-Y_{\bar{a}=0(5)})$ 

the average treatment effect on HCC diagnosis in year 5 assuming that all patients had abdominal imaging every year for the 4 prior years ($Y_{\bar{a}=1}$), compared to HCC outcomes in year 5 if all patients did NOT have abdominal imaging at any time point during the preceding four years ($Y_{\bar{a}=0}$). 

```{r Intervene on Our Data structure, cache = TRUE}
# 3.3 - intervene on SCM/data generating function
generate_data_intervene  <- function(n, a) {
  U <- data.frame(UW = runif(n = n, min = 0, max = 1),
                  ULa1 = rnbinom(n=n, size = 4, prob = 0.6), 
                  ULa2 = rnbinom(n=n, size = 4, prob = 0.6), 
                  ULa3 = rnbinom(n=n, size = 4, prob = 0.6), 
                  ULa4 = rnbinom(n=n, size = 4, prob = 0.6), 
                  ULa5 = rnbinom(n=n, size = 4, prob = 0.6),  
                  ULb1 = rgamma(n = n, shape = 2, scale = 1), 
                  ULb2 = rgamma(n = n, shape = 2, scale = 1), 
                  ULb3 = rgamma(n = n, shape = 2, scale = 1), 
                  ULb4 = rgamma(n = n, shape = 2, scale = 1), 
                  ULb5 = rgamma(n = n, shape = 2, scale = 1), 
                  UY2 = runif(n=n, min = 0, max = 1),
                  UY3 = runif(n=n, min = 0, max = 1),
                  UY4 = runif(n=n, min = 0, max = 1),
                  UY5 = runif(n=n, min = 0, max = 1))
 
  O <- U
  O <- O %>%
    
 mutate(W = ifelse(UW < w1, 1,
                      ifelse(UW<(w1+w2), 2,
                             ifelse(UW<(w1+w2+w3), 3, 
                                    ifelse(UW<(w1+w2+w3+w4),4,
                                           ifelse(UW<(w1+w2+w3+w4+w5), 5,
                                                  ifelse(UW<(w1+w2+w3+w4+w5+w6), 6, 
                                                         ifelse(UW<(w1+w2+w3+w4+w5+w6+w7), 7, 
                        ifelse(UW<(w1+w2+w3+w4+w5+w6+w7+w8), 8, 
                               ifelse(UW<(w1+w2+w3+w4+w5+w6+w7+w8+w9), 9,
                                      ifelse(UW<(w1+w2+w3+w4+w5+w6+w7+w8+w9+w10), 10,
                                             ifelse(UW<(w1+w2+w3+w4+w5+w6+w7+w8+w9+w10+w11), 11,
                        ifelse(UW<(w1+w2+w3+w4+w5+w6+w7+w8+w9+w10+w11+w12), 12,
                                ifelse(UW<(w1+w2+w3+w4+w5+w6+w7+w8+w9+w10+w11+w12+w13), 13,
                        ifelse(UW<(w1+w2+w3+w4+w5+w6+w7+w8+w9+w10+w11+w12+w13+w14), 14,
                                ifelse(UW<(w1+w2+w3+w4+w5+w6+w7+w8+w9+w10+w11+w12+w13+w14+w15), 15, 16))))))))))))))),
           La1 = ULa1,
           Lb1 = ULb1,
           A1 = a,
           Y2 = as.numeric(UY2 < 0.07*plogis(Lb1 - La1 - A1)),
           
           La2 = ifelse(Y2==0, La1 + 0.1*ULa2, NA),
           Lb2 = ifelse(Y2==0, as.integer(Lb1 + 0.1*ULb2), NA),
           A2  = ifelse(Y2==0, a, NA),
           Y3  = ifelse(Y2==0, as.numeric(UY3 < 0.07*plogis(Lb2 - La2 - A2)),1),
           
           La3 = ifelse(Y3==0, La2 + 0.1*ULa3, NA),
           Lb3 = ifelse(Y3==0, as.integer(Lb2 + 0.1*ULb3), NA),
           A3  = ifelse(Y3==0, a, NA),
           Y4  = ifelse(Y3==0, as.numeric(UY4 < 0.07*plogis(Lb3 - La3 - A3)),1),
           
           La4 = ifelse(Y4==0, La3 + 0.1*ULa4, NA),
           Lb4 = ifelse(Y4==0, as.integer(Lb3 + 0.1*ULb4), NA),
           A4  = ifelse(Y4==0, a, NA),
           Y5  = ifelse(Y4==0, as.numeric(UY5 < 0.07*plogis(Lb4 - La4 - A4)),1)
           )
  return(O)
}

SimDataIntervene.0 <- generate_data_intervene(100000, 0)

SimDataIntervene.1 <- generate_data_intervene(100000, 1)


# 3.4 - evaluate Psi.F
True.Psi.F= mean(SimDataIntervene.1$Y5-SimDataIntervene.0$Y5, na.rm = TRUE)
True.Psi.F
```

```{r ltmle run on our simulation with SuperLearner, cache=TRUE}

SL.library <- c("SL.glm", "SL.bayesglm", "SL.mean") ## armadillo - need to discuss further

results_sim <- ltmle::ltmle(SimData,
                     Anodes= c("A1", "A2", "A3", "A4"),
                     Lnodes = c("La1", "Lb1", "La2", "Lb2", "La3", "Lb3", "La4", "Lb4"),
                     Ynodes = c("Y2","Y3", "Y4", "Y5"),
                     abar = list(c(1,1,1,1), c(0,0,0,0)),
                     survivalOutcome = TRUE,
                     SL.library = SL.library,
                     attr(SL.library, "return.fit")
)

results_sim.gcomp <- ltmle::ltmle(SimData,
                     Anodes= c("A1", "A2", "A3", "A4"),
                     Lnodes = c("La1", "Lb1", "La2", "Lb2", "La3", "Lb3", "La4", "Lb4"),
                     Ynodes = c("Y2","Y3", "Y4", "Y5"),
                     abar = list(c(1,1,1,1), c(0,0,0,0)),
                     survivalOutcome = TRUE,
                     gcomp = TRUE,
                     SL.library = SL.library,
                     attr(SL.library, "return.fit")
)

simtmle_SL <- summary(results_sim, "tmle")
simiptw_SL <- summary(results_sim, "iptw")
simgcomp_SL <- summary(results_sim.gcomp, "gcomp")

simtmle_ATE <- simtmle_SL$effect.measures$ATE$estimate; simtmle_ATE
simiptw_ATE <- simiptw_SL$effect.measures$ATE$estimate; simiptw_ATE
simgcomp_ATE <- simgcomp_SL$effect.measures$ATE$estimate; simgcomp_ATE

# performance of algorithms
results_sim$fit
results_sim.gcomp$fit

```

```{r Performance of estimators}

options(scipen = 999)

Bias.g <- simgcomp_ATE - True.Psi.F
Variance.g <- (simgcomp_SL$effect.measures$ATE$std.dev)^2
MSE.g <- Variance.g + Bias.g^2
rVariance.g <- as.character(round(Variance.g, 5))
rMSE.g <- as.character(round(MSE.g, 5))

Bias.iptw <- simiptw_ATE - True.Psi.F
Variance.iptw <- (simiptw_SL$effect.measures$ATE$std.dev)^2
MSE.iptw <- Variance.iptw + Bias.iptw^2

Bias.tmle <- simtmle_ATE - True.Psi.F
Variance.tmle <- (simtmle_SL$effect.measures$ATE$std.dev)^2
MSE.tmle <- Variance.tmle + Bias.tmle^2
rVariance.tmle <- as.character(round(Variance.tmle, 5))
rMSE.tmle <- as.character(round(MSE.tmle, 5))
```

When testing our estimators against a simulation of 100,000 patients roughly matching the variable distribution of our observed dataset, here is how they performed:

|| G-Comp | IPTW | TMLE |
|----------| ------ | ------ | ------ |
| Bias | `r round(Bias.g, 5)` | `r round(Bias.iptw, 6)` | `r round(Bias.tmle, 5)` |
| Variance | `r rVariance.g` | `r round(Variance.iptw, 6)` | `r rVariance.tmle` |
| MSE | `r rMSE.g` | `r round(MSE.iptw, 6)` | `r rMSE.tmle` |


```{r Reconfigure Dataset, warning = FALSE, message = FALSE, cache = TRUE}

O1a <- as.data.frame(matrix(nrow=nrow(HCVData1), NA))
 
O1a$Y2 <- HCVData1$HCC_2016
O1a$Y3 <- HCVData1$HCC_2017
O1a$Y4 <- HCVData1$HCC_2018
O1a$Y5 <- HCVData1$HCC_2019

O1a$A1 <- HCVData1$ABD_IMAGING_YN_2015
O1a$A2 <- HCVData1$ABD_IMAGING_YN_2016
O1a$A3 <- HCVData1$ABD_IMAGING_YN_2017
O1a$A4 <- HCVData1$ABD_IMAGING_YN_2018

O1a$La1 <- ifelse(HCVData1$VISIT_COUNT_2015>0,1,0)
O1a$La2 <- ifelse(HCVData1$VISIT_COUNT_2016>0,1,0)
O1a$La3 <- ifelse(HCVData1$VISIT_COUNT_2017>0,1,0)
O1a$La4 <- ifelse(HCVData1$VISIT_COUNT_2018>0,1,0)

O1a$Lb1 <- HCVData1$FIB4_by2015
O1a$Lb2 <- HCVData1$FIB4_by2016
O1a$Lb3 <- HCVData1$FIB4_by2017
O1a$Lb4 <- HCVData1$FIB4_by2018

O1a$Lb1lm <- HCVData1$YearsSinceFib4_2015
O1a$Lb2lm <- HCVData1$YearsSinceFib4_2016
O1a$Lb3lm <- HCVData1$YearsSinceFib4_2017
O1a$Lb4lm <- HCVData1$YearsSinceFib4_2018

O1a$SES <- HCVData1$PayorType
O1a$Sex <- HCVData1$Sex
O1a$Race <- HCVData1$race.ethnicity
  
#O1a$C5 <- ifelse(O$A5 == 0, 1, 0)  armadillo
  
# #remove NAs before we imputed (now commented out) 
#   O1a <- subset(O, !is.na(O1a$SES))
#   O1a <- subset(O, !is.na(O1a$Race))
  
  O1a <- O1a %>% dplyr::select(SES, Race, Sex, La1, Lb1, Lb1lm, A1, 
                           Y2, La2, Lb2, Lb2lm, A2, 
                           Y3, La3, Lb3, Lb3lm, A3,
                           Y4, La4, Lb4, Lb4lm, A4, 
                           Y5)

O2a <- as.data.frame(matrix(nrow=nrow(HCVData2), NA))
 
O2a$Y2 <- HCVData2$HCC_2016
O2a$Y3 <- HCVData2$HCC_2017
O2a$Y4 <- HCVData2$HCC_2018
O2a$Y5 <- HCVData2$HCC_2019

O2a$A1 <- HCVData2$ABD_IMAGING_YN_2015
O2a$A2 <- HCVData2$ABD_IMAGING_YN_2016
O2a$A3 <- HCVData2$ABD_IMAGING_YN_2017
O2a$A4 <- HCVData2$ABD_IMAGING_YN_2018

O2a$La1 <- ifelse(HCVData2$VISIT_COUNT_2015>0,1,0)
O2a$La2 <- ifelse(HCVData2$VISIT_COUNT_2016>0,1,0)
O2a$La3 <- ifelse(HCVData2$VISIT_COUNT_2017>0,1,0)
O2a$La4 <- ifelse(HCVData2$VISIT_COUNT_2018>0,1,0)

O2a$Lb1 <- HCVData2$FIB4_by2015
O2a$Lb2 <- HCVData2$FIB4_by2016
O2a$Lb3 <- HCVData2$FIB4_by2017
O2a$Lb4 <- HCVData2$FIB4_by2018

O2a$Lb1lm <- HCVData2$YearsSinceFib4_2015
O2a$Lb2lm <- HCVData2$YearsSinceFib4_2016
O2a$Lb3lm <- HCVData2$YearsSinceFib4_2017
O2a$Lb4lm <- HCVData2$YearsSinceFib4_2018

O2a$SES <- HCVData2$PayorType
O2a$Sex <- HCVData2$Sex
O2a$Race <- HCVData2$race.ethnicity

  O2a <- O2a %>% dplyr::select(SES, Race, Sex, La1, Lb1, Lb1lm, A1, 
                           Y2, La2, Lb2, Lb2lm, A2, 
                           Y3, La3, Lb3, Lb3lm, A3,
                           Y4, La4, Lb4, Lb4lm, A4, 
                           Y5)

  
O3a <- as.data.frame(matrix(nrow=nrow(HCVData3), NA))
 
O3a$Y2 <- HCVData3$HCC_2016
O3a$Y3 <- HCVData3$HCC_2017
O3a$Y4 <- HCVData3$HCC_2018
O3a$Y5 <- HCVData3$HCC_2019

O3a$A1 <- HCVData3$ABD_IMAGING_YN_2015
O3a$A2 <- HCVData3$ABD_IMAGING_YN_2016
O3a$A3 <- HCVData3$ABD_IMAGING_YN_2017
O3a$A4 <- HCVData3$ABD_IMAGING_YN_2018

O3a$La1 <- ifelse(HCVData3$VISIT_COUNT_2015>0,1,0)
O3a$La2 <- ifelse(HCVData3$VISIT_COUNT_2016>0,1,0)
O3a$La3 <- ifelse(HCVData3$VISIT_COUNT_2017>0,1,0)
O3a$La4 <- ifelse(HCVData3$VISIT_COUNT_2018>0,1,0)

O3a$Lb1 <- HCVData3$FIB4_by2015
O3a$Lb2 <- HCVData3$FIB4_by2016
O3a$Lb3 <- HCVData3$FIB4_by2017
O3a$Lb4 <- HCVData3$FIB4_by2018

O3a$Lb1lm <- HCVData3$YearsSinceFib4_2015
O3a$Lb2lm <- HCVData3$YearsSinceFib4_2016
O3a$Lb3lm <- HCVData3$YearsSinceFib4_2017
O3a$Lb4lm <- HCVData3$YearsSinceFib4_2018

O3a$SES <- HCVData3$PayorType
O3a$Sex <- HCVData3$Sex
O3a$Race <- HCVData3$race.ethnicity

  O3a <- O3a %>% dplyr::select(SES, Race, Sex, La1, Lb1, Lb1lm, A1, 
                           Y2, La2, Lb2, Lb2lm, A2, 
                           Y3, La3, Lb3, Lb3lm, A3,
                           Y4, La4, Lb4, Lb4lm, A4, 
                           Y5)
  
O4a <- as.data.frame(matrix(nrow=nrow(HCVData4), NA))
 
O4a$Y2 <- HCVData4$HCC_2016
O4a$Y3 <- HCVData4$HCC_2017
O4a$Y4 <- HCVData4$HCC_2018
O4a$Y5 <- HCVData4$HCC_2019

O4a$A1 <- HCVData4$ABD_IMAGING_YN_2015
O4a$A2 <- HCVData4$ABD_IMAGING_YN_2016
O4a$A3 <- HCVData4$ABD_IMAGING_YN_2017
O4a$A4 <- HCVData4$ABD_IMAGING_YN_2018

O4a$La1 <- ifelse(HCVData4$VISIT_COUNT_2015>0,1,0)
O4a$La2 <- ifelse(HCVData4$VISIT_COUNT_2016>0,1,0)
O4a$La3 <- ifelse(HCVData4$VISIT_COUNT_2017>0,1,0)
O4a$La4 <- ifelse(HCVData4$VISIT_COUNT_2018>0,1,0)

O4a$Lb1 <- HCVData4$FIB4_by2015
O4a$Lb2 <- HCVData4$FIB4_by2016
O4a$Lb3 <- HCVData4$FIB4_by2017
O4a$Lb4 <- HCVData4$FIB4_by2018

O4a$Lb1lm <- HCVData4$YearsSinceFib4_2015
O4a$Lb2lm <- HCVData4$YearsSinceFib4_2016
O4a$Lb3lm <- HCVData4$YearsSinceFib4_2017
O4a$Lb4lm <- HCVData4$YearsSinceFib4_2018

O4a$SES <- HCVData4$PayorType
O4a$Sex <- HCVData4$Sex
O4a$Race <- HCVData4$race.ethnicity

  O4a <- O4a %>% dplyr::select(SES, Race, Sex, La1, Lb1, Lb1lm, A1, 
                           Y2, La2, Lb2, Lb2lm, A2, 
                           Y3, La3, Lb3, Lb3lm, A3,
                           Y4, La4, Lb4, Lb4lm, A4, 
                           Y5)

O5a <- as.data.frame(matrix(nrow=nrow(HCVData5), NA))
 
O5a$Y2 <- HCVData5$HCC_2016
O5a$Y3 <- HCVData5$HCC_2017
O5a$Y4 <- HCVData5$HCC_2018
O5a$Y5 <- HCVData5$HCC_2019

O5a$A1 <- HCVData5$ABD_IMAGING_YN_2015
O5a$A2 <- HCVData5$ABD_IMAGING_YN_2016
O5a$A3 <- HCVData5$ABD_IMAGING_YN_2017
O5a$A4 <- HCVData5$ABD_IMAGING_YN_2018

O5a$La1 <- ifelse(HCVData5$VISIT_COUNT_2015>0,1,0)
O5a$La2 <- ifelse(HCVData5$VISIT_COUNT_2016>0,1,0)
O5a$La3 <- ifelse(HCVData5$VISIT_COUNT_2017>0,1,0)
O5a$La4 <- ifelse(HCVData5$VISIT_COUNT_2018>0,1,0)

O5a$Lb1 <- HCVData5$FIB4_by2015
O5a$Lb2 <- HCVData5$FIB4_by2016
O5a$Lb3 <- HCVData5$FIB4_by2017
O5a$Lb4 <- HCVData5$FIB4_by2018

O5a$Lb1lm <- HCVData5$YearsSinceFib4_2015
O5a$Lb2lm <- HCVData5$YearsSinceFib4_2016
O5a$Lb3lm <- HCVData5$YearsSinceFib4_2017
O5a$Lb4lm <- HCVData5$YearsSinceFib4_2018

O5a$SES <- HCVData5$PayorType
O5a$Sex <- HCVData5$Sex
O5a$Race <- HCVData5$race.ethnicity

  O5a <- O5a %>% dplyr::select(SES, Race, Sex, La1, Lb1, Lb1lm, A1, 
                           Y2, La2, Lb2, Lb2lm, A2, 
                           Y3, La3, Lb3, Lb3lm, A3,
                           Y4, La4, Lb4, Lb4lm, A4, 
                           Y5)
```


```{r ltmle run on our DATA with SuperLearner, cache=TRUE}

results1 <- ltmle::ltmle(O1a,
                     Anodes= c("A1", "A2", "A3", "A4"),
                     Lnodes = c("La1", "Lb1", "Lb1lm", "La2", "Lb2", "Lb2lm", "La3", "Lb3", "Lb3lm", "La4", "Lb4", "Lb4lm"),
                     Ynodes = c("Y2","Y3", "Y4", "Y5"),
                     abar = list(c(1,1,1,1), c(0,0,0,0)),
                     survivalOutcome = TRUE,
                     SL.library = SL.library,
                     attr(SL.library, "return.fit")
)

results.gcomp1 <- ltmle::ltmle(O1a,
                     Anodes= c("A1", "A2", "A3", "A4"),
                     Lnodes = c("La1", "Lb1", "Lb1lm", "La2", "Lb2", "Lb2lm", "La3", "Lb3", "Lb3lm", "La4", "Lb4", "Lb4lm"),
                     Ynodes = c("Y2","Y3", "Y4", "Y5"),
                     abar = list(c(1,1,1,1), c(0,0,0,0)),
                     survivalOutcome = TRUE,
                     gcomp = TRUE,
                     SL.library = SL.library,
                     attr(SL.library, "return.fit")
)


results2 <- ltmle::ltmle(O2a,
                     Anodes= c("A1", "A2", "A3", "A4"),
                     Lnodes = c("La1", "Lb1", "Lb1lm", "La2", "Lb2", "Lb2lm", "La3", "Lb3", "Lb3lm", "La4", "Lb4", "Lb4lm"),
                     Ynodes = c("Y2","Y3", "Y4", "Y5"),
                     abar = list(c(1,1,1,1), c(0,0,0,0)),
                     survivalOutcome = TRUE,
                     SL.library = SL.library,
                     attr(SL.library, "return.fit")
)

results.gcomp2 <- ltmle::ltmle(O2a,
                     Anodes= c("A1", "A2", "A3", "A4"),
                     Lnodes = c("La1", "Lb1", "Lb1lm", "La2", "Lb2", "Lb2lm", "La3", "Lb3", "Lb3lm", "La4", "Lb4", "Lb4lm"),
                     Ynodes = c("Y2","Y3", "Y4", "Y5"),
                     abar = list(c(1,1,1,1), c(0,0,0,0)),
                     survivalOutcome = TRUE,
                     gcomp = TRUE,
                     SL.library = SL.library,
                     attr(SL.library, "return.fit")
)


results3 <- ltmle::ltmle(O3a,
                     Anodes= c("A1", "A2", "A3", "A4"),
                     Lnodes = c("La1", "Lb1", "Lb1lm", "La2", "Lb2", "Lb2lm", "La3", "Lb3", "Lb3lm", "La4", "Lb4", "Lb4lm"),
                     Ynodes = c("Y2","Y3", "Y4", "Y5"),
                     abar = list(c(1,1,1,1), c(0,0,0,0)),
                     survivalOutcome = TRUE,
                     SL.library = SL.library,
                     attr(SL.library, "return.fit")
)

results.gcomp3 <- ltmle::ltmle(O3a,
                     Anodes= c("A1", "A2", "A3", "A4"),
                     Lnodes = c("La1", "Lb1", "Lb1lm", "La2", "Lb2", "Lb2lm", "La3", "Lb3", "Lb3lm", "La4", "Lb4", "Lb4lm"),
                     Ynodes = c("Y2","Y3", "Y4", "Y5"),
                     abar = list(c(1,1,1,1), c(0,0,0,0)),
                     survivalOutcome = TRUE,
                     gcomp = TRUE,
                     SL.library = SL.library,
                     attr(SL.library, "return.fit")
)


results4 <- ltmle::ltmle(O4a,
                     Anodes= c("A1", "A2", "A3", "A4"),
                     Lnodes = c("La1", "Lb1", "Lb1lm", "La2", "Lb2", "Lb2lm", "La3", "Lb3", "Lb3lm", "La4", "Lb4", "Lb4lm"),
                     Ynodes = c("Y2","Y3", "Y4", "Y5"),
                     abar = list(c(1,1,1,1), c(0,0,0,0)),
                     survivalOutcome = TRUE,
                     SL.library = SL.library,
                     attr(SL.library, "return.fit")
)

results.gcomp4 <- ltmle::ltmle(O4a,
                     Anodes= c("A1", "A2", "A3", "A4"),
                     c("La1", "Lb1", "Lb1lm", "La2", "Lb2", "Lb2lm", "La3", "Lb3", "Lb3lm", "La4", "Lb4", "Lb4lm"),
                     Ynodes = c("Y2","Y3", "Y4", "Y5"),
                     abar = list(c(1,1,1,1), c(0,0,0,0)),
                     survivalOutcome = TRUE,
                     gcomp = TRUE,
                     SL.library = SL.library,
                     attr(SL.library, "return.fit")
)


results5 <- ltmle::ltmle(O5a,
                     Anodes= c("A1", "A2", "A3", "A4"),
                     Lnodes = c("La1", "Lb1", "Lb1lm", "La2", "Lb2", "Lb2lm", "La3", "Lb3", "Lb3lm", "La4", "Lb4", "Lb4lm"),
                     Ynodes = c("Y2","Y3", "Y4", "Y5"),
                     abar = list(c(1,1,1,1), c(0,0,0,0)),
                     survivalOutcome = TRUE,
                     SL.library = SL.library,
                     attr(SL.library, "return.fit")
)

results.gcomp5 <- ltmle::ltmle(O5a,
                     Anodes= c("A1", "A2", "A3", "A4"),
                     Lnodes = c("La1", "Lb1", "Lb1lm", "La2", "Lb2", "Lb2lm", "La3", "Lb3", "Lb3lm", "La4", "Lb4", "Lb4lm"),
                     Ynodes = c("Y2","Y3", "Y4", "Y5"),
                     abar = list(c(1,1,1,1), c(0,0,0,0)),
                     survivalOutcome = TRUE,
                     gcomp = TRUE,
                     SL.library = SL.library,
                     attr(SL.library, "return.fit")
)

```

```{r rerun with dataset including cirrhosis at baseline}

# O2 <- as.data.frame(matrix(nrow=nrow(HCVData), NA))
#  
# O2$Y2 <- HCVData$HCC_2016
# O2$Y3 <- HCVData$HCC_2017
# O2$Y4 <- HCVData$HCC_2018
# O2$Y5 <- HCVData$HCC_2019
# 
# O2$A1 <- HCVData$ABD_IMAGING_YN_2015
# O2$A2 <- HCVData$ABD_IMAGING_YN_2016
# O2$A3 <- HCVData$ABD_IMAGING_YN_2017
# O2$A4 <- HCVData$ABD_IMAGING_YN_2018
# 
# O2$La1 <- ifelse(HCVData$VISIT_COUNT_2015>0,1,0)
# O2$La2 <- ifelse(HCVData$VISIT_COUNT_2016>0,1,0)
# O2$La3 <- ifelse(HCVData$VISIT_COUNT_2017>0,1,0)
# O2$La4 <- ifelse(HCVData$VISIT_COUNT_2018>0,1,0)
# 
# O2$Lb1 <- HCVData$FIB4_by2015
# O2$Lb2 <- HCVData$FIB4_by2016
# O2$Lb3 <- HCVData$FIB4_by2017
# O2$Lb4 <- HCVData$FIB4_by2018
# 
# O2$Lb1lm <- HCVData$YearsSinceFib4_2015
# O2$Lb2lm <- HCVData$YearsSinceFib4_2016
# O2$Lb3lm <- HCVData$YearsSinceFib4_2017
# O2$Lb4lm <- HCVData$YearsSinceFib4_2018
# 
# O2$SES <- HCVData$PayorType
# O2$Sex <- HCVData$Sex
# O2$Race <- HCVData$race.ethnicity
#   
# #O2$C5 <- ifelse(O$A5 == 0, 1, 0)  armadillo
#   
# #remove NAs for now, until we impute -- armadillo
#   O2 <- subset(O2, !is.na(O$SES))
#   O2 <- subset(O2, !is.na(O$Race))
#   
#   O2 <- O %>% dplyr::select(SES, Race, Sex, La1, Lb1, A1, 
#                            Y2, La2, Lb2, A2,  
#                            Y3, La3, Lb3, A3,  
#                            Y4, La4, Lb4, A4,  
#                            Y5)
# 
# results_withcirr <- ltmle::ltmle(O2,
#                      Anodes= c("A1", "A2", "A3", "A4"),
#                      Lnodes = c("La1", "Lb1", "La2", "Lb2", "La3", "Lb3", "La4", "Lb4"),
#                      Ynodes = c("Y2","Y3", "Y4", "Y5"),
#                      abar = list(c(1,1,1,1), c(0,0,0,0)),
#                      survivalOutcome = TRUE,
#                      SL.library = SL.library,
#                      attr(SL.library, "return.fit")
# )
# 
# results.gcomp_withcirr <- ltmle::ltmle(O2,
#                      Anodes= c("A1", "A2", "A3", "A4"),
#                      Lnodes = c("La1", "Lb1", "La2", "Lb2", "La3", "Lb3", "La4", "Lb4"),
#                      Ynodes = c("Y2","Y3", "Y4", "Y5"),
#                      abar = list(c(1,1,1,1), c(0,0,0,0)),
#                      survivalOutcome = TRUE,
#                      gcomp = TRUE,
#                      SL.library = SL.library,
#                      attr(SL.library, "return.fit")
# )
# 
#   
```


```{r results_nocirrhosis}

tmle_SL1 <- summary(results1, "tmle")
iptw_SL1 <- summary(results1, "iptw")
gcomp_SL1 <- summary(results.gcomp1, "gcomp")
tmle_SL2 <- summary(results2, "tmle")
iptw_SL2 <- summary(results2, "iptw")
gcomp_SL2 <- summary(results.gcomp2, "gcomp")
tmle_SL3 <- summary(results3, "tmle")
iptw_SL3 <- summary(results3, "iptw")
gcomp_SL3 <- summary(results.gcomp3, "gcomp")
tmle_SL4 <- summary(results4, "tmle")
iptw_SL4 <- summary(results4, "iptw")
gcomp_SL4 <- summary(results.gcomp4, "gcomp")
tmle_SL5 <- summary(results5, "tmle")
iptw_SL5 <- summary(results5, "iptw")
gcomp_SL5 <- summary(results.gcomp5, "gcomp")

tmle_ATE1 <- exp(tmle_SL1$effect.measures$ATE$estimate); tmle_ATE1
iptw_ATE1 <- exp(iptw_SL1$effect.measures$ATE$estimate); iptw_ATE1
gcomp_ATE1 <- exp(gcomp_SL1$effect.measures$ATE$estimate); gcomp_ATE1
tmle_ATE2 <- exp(tmle_SL2$effect.measures$ATE$estimate); tmle_ATE2
iptw_ATE2 <- exp(iptw_SL2$effect.measures$ATE$estimate); iptw_ATE2
gcomp_ATE2 <- exp(gcomp_SL2$effect.measures$ATE$estimate); gcomp_ATE2
tmle_ATE3 <- exp(tmle_SL3$effect.measures$ATE$estimate); tmle_ATE3
iptw_ATE3 <- exp(iptw_SL3$effect.measures$ATE$estimate); iptw_ATE3
gcomp_ATE3 <- exp(gcomp_SL3$effect.measures$ATE$estimate); gcomp_ATE3
tmle_ATE4 <- exp(tmle_SL4$effect.measures$ATE$estimate); tmle_ATE4
iptw_ATE4 <- exp(iptw_SL4$effect.measures$ATE$estimate); iptw_ATE4
gcomp_ATE4 <- exp(gcomp_SL4$effect.measures$ATE$estimate); gcomp_ATE4
tmle_ATE5 <- exp(tmle_SL5$effect.measures$ATE$estimate); tmle_ATE5
iptw_ATE5 <- exp(iptw_SL5$effect.measures$ATE$estimate); iptw_ATE5
gcomp_ATE5 <- exp(gcomp_SL5$effect.measures$ATE$estimate); gcomp_ATE5
# tmle_low <- exp(tmle_SL$effect.measures$treatment$CI[1])
# tmle_high <- exp(tmle_SL$effect.measures$treatment$CI[2])
# iptw_low <- exp(iptw_SL$effect.measures$treatment$CI[1])
# iptw_high <- exp(iptw_SL$effect.measures$treatment$CI[2])
# gcomp_low <- exp(gcomp_SL$effect.measures$treatment$CI[1])
# gcomp_high <- exp(gcomp_SL$effect.measures$treatment$CI[2])

#average results across imputed datasets
tmle_ATE <- as.vector(c(tmle_ATE1, tmle_ATE2, tmle_ATE3, tmle_ATE4, tmle_ATE5))
tmle_ATE <- mean(tmle_ATE)
iptw_ATE <- as.vector(c(iptw_ATE1, iptw_ATE2, iptw_ATE3, iptw_ATE4, iptw_ATE5))
iptw_ATE <- mean(iptw_ATE)
gcomp_ATE <- as.vector(c(gcomp_ATE1, gcomp_ATE2, gcomp_ATE3, gcomp_ATE4, gcomp_ATE5))
gcomp_ATE <- mean(gcomp_ATE)

# performance of algorithms
results1$fit
results.gcomp1$fit
results2$fit
results.gcomp2$fit
results3$fit
results.gcomp3$fit
results4$fit
results.gcomp4$fit
results5$fit
results.gcomp5$fit

#NNT
NNTdenom <- gcomp_ATE/100
NNT <- round(1/(gcomp_ATE/100), 0)
```

```{r results_withcirrhosis}

# tmle_SL_withcirr <- summary(results_withcirr, "tmle")
# iptw_SL_withcirr <- summary(results_withcirr, "iptw")
# gcomp_SL_withcirr <- summary(results.gcomp_withcirr, "gcomp")
# 
# tmle_ATE_withcirr <- exp(tmle_SL_withcirr$effect.measures$ATE$estimate); tmle_ATE_withcirr
# iptw_ATE_withcirr <- exp(iptw_SL_withcirr$effect.measures$ATE$estimate); iptw_ATE_withcirr
# gcomp_ATE_withcirr <- exp(gcomp_SL_withcirr$effect.measures$ATE$estimate); gcomp_ATE_withcirr
# tmle_low_withcirr <- exp(tmle_SL_withcirr$effect.measures$treatment$CI[1])
# tmle_high_withcirr <- exp(tmle_SL_withcirr$effect.measures$treatment$CI[2])
# iptw_low_withcirr <- exp(iptw_SL_withcirr$effect.measures$treatment$CI[1])
# iptw_high_withcirr <- exp(iptw_SL_withcirr$effect.measures$treatment$CI[2])
# gcomp_low_withcirr <- exp(gcomp_SL_withcirr$effect.measures$treatment$CI[1])
# gcomp_high_withcirr <- exp(gcomp_SL_withcirr$effect.measures$treatment$CI[2])
# 
# # performance of algorithms
# results_withcirr$fit
# results.gcomp_withcirr$fit
# 
# #NNT
# NNT_withcirr <- round(1/(gcomp_ATE_withcirr/100), 0)
```

Ultimately, implementing \textit{ltmle} with \textit{Super Learner} on our observed data produced the following estimates for the risk difference of developing HCC in year 5 when receiving abdominal imaging at least once per year for the 4 preceding years, compared to not receiving abdominal imaging during that time, when controlling for the number of hepatology or primary care visits, FIB-4 score, sex, race, and SES was:

| G-Comp (95% CI) | IPTW (95% CI) | TMLE (95% CI) |
| ------------- | ------------- | ------------- |
| `r round(gcomp_ATE, 3)` (`r round(gcomp_low, 3)`, `r round(gcomp_high, 3)`) | `r round(iptw_ATE, 3)` (`r round(iptw_low, 3)`, `r round(iptw_high, 3)`) | `r round(tmle_ATE, 3)` (`r round(tmle_low, 3)`, `r round(tmle_high, 3)`) |

If we use the G-computation estimate, this means that over the five years under study, patients with no cirrhosis at baseline were `r round(gcomp_ATE, 1)`% less likely to develop HCC by year 5 when they had abdominal imaging each year for the 4 previous years, compared to patients who had no abdominal imaging, when controlling for liver cirrhosis, number of primary care or hepatology visits, sex, race, and SES. **This represents a number needed to treat (NNT) of `r round(1/(round(gcomp_ATE, 1)/100),0)` **: for every `r round(1/(round(gcomp_ATE, 1)/100),0)` people who receive annual abdominal imaging despite no evidence of cirrhosis at baseline, 1 case of HHC could be prevented over 5 years.


<!--
If this analysis is repeated including people who had cirrhosis at baseline (with all other inclusion criteria remaining the same), the findings are:

| G-Comp (95% CI) | IPTW (95% CI) | TMLE (95% CI) |
| ------------- | ------------- | ------------- |
| `r round(gcomp_ATE_withcirr, 3)` (`r round(gcomp_low_withcirr, 3)`, `r round(gcomp_high_withcirr, 3)`) | `r round(iptw_ATE_withcirr, 3)` (`r round(iptw_low_withcirr, 3)`, `r round(iptw_high_withcirr, 3)`) | `r round(tmle_ATE_withcirr, 3)` (`r round(tmle_low_withcirr, 3)`, `r round(tmle_high_withcirr, 3)`) |

If we again use the G-computation estimate, this means that over the five years under study, patients (regardless of cirrhosis at baseline) were `r round(gcomp_ATE_withcirr, 1)`% less likely to develop HCC by year 5 when they had abdominal imaging each year for the 4 previous years, compared to patients who had no abdominal imaging, when controlling for liver cirrhosis, number of primary care or hepatology visits, sex, race, and SES. **This represents a number needed to treat (NNT) of `r NNT_withcirr`**: for every `r NNT_withcirr` people who receive annual abdominal imaging regardless of cirrhosis at baseline, 1 case of HHC could be prevented over 5 years. This is slightly higher than in the case where people with cirrhosis at baseline were excluded, which makes sense because people with cirrhosis are more likely to develop HCC within 5 years regardless of the imaging they receive.
-->