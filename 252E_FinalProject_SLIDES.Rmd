---
title: |
  | 252E Final Project  
  | \textcolor{white}{.}
  | Relationship between Frequency of Care 
  | and Progression to Hepatocellular Carcinoma
  | among Chronic Hepatitis C Patients
author: "Stephanie Holm and Shelley Facente"
date: "12/11/2019"
output: beamer_presentation
---

```{r setup, include=FALSE}
library(tidyverse)
library(readxl)
library(skimr)
library(knitr)
library(xlsx)
library(lubridate)
library(MASS)
library(ggplot2)
library(ggpubr)
#library(Hmisc)

knitr::opts_chunk$set(include = FALSE, cache = TRUE)

# First, load the data
StephandShelleyDataLoad <- function(filename) 
{
  if(Sys.info()['sysname']=="Darwin"){
    
     read_excel(as.character(filename))}
  else{
    windowsfilepath <- paste("~/GitHub/stephandshelley/", filename, sep = "")
     read_excel(as.character(windowsfilepath))
  }
}

StephandShelleyDataLoad2 <- function(filename) 
{
  if(Sys.info()['sysname']=="Darwin"){
    
     load(as.character(filename))}
  else{
    windowsfilepath <- paste("~/GitHub/stephandshelley/", filename, sep = "")
     load(as.character(windowsfilepath))
  }
}

#HCVData <- StephandShelleyDataLoad("Deidentified Chronic HCV Dataset 11-21-19.xlsx")

```

```{r filter_to_adults_with_visits_and_no_Ca_at_start_historical_FIB4s, include = FALSE, eval = TRUE}
load("HCVData.Rdata")

#calculating a total fib4, NOT  because it's meaningful but to be ableto see how many had NO FIB4
#commenting out for now bc just used this to explore
HCVData$totalFIB4 <-rowSums(cbind(HCVData$FIB4_2009,
                                  HCVData$FIB4_2010,
                                  HCVData$FIB4_2011,
                                  HCVData$FIB4_2012,
                                  HCVData$FIB4_2013,
                                  HCVData$FIB4_2014,
                                  HCVData$FIB4_2015,
                                  HCVData$FIB4_2016,
                                  HCVData$FIB4_2017,
                                  HCVData$FIB4_2018), na.rm=TRUE)
summary(HCVData$totalFIB4==0)

HCVData$totalFIB4BY2011 <-rowSums(cbind(HCVData$FIB4_2009,
                                  HCVData$FIB4_2010,
                                  HCVData$FIB4_2011), na.rm=TRUE)
summary(HCVData$totalFIB4BY2011==0)

HCVData$totalFIB4BY2014 <-rowSums(cbind(HCVData$FIB4_2009,
                                  HCVData$FIB4_2010,
                                  HCVData$FIB4_2011,
                                  HCVData$FIB4_2012,
                                  HCVData$FIB4_2013,
                                  HCVData$FIB4_2014), na.rm=TRUE)
summary(HCVData$totalFIB4BY2014==0)

HCVData$totalFIB4BY2015 <-rowSums(cbind(HCVData$FIB4_2009,
                                  HCVData$FIB4_2010,
                                  HCVData$FIB4_2011,
                                  HCVData$FIB4_2012,
                                  HCVData$FIB4_2013,
                                  HCVData$FIB4_2014,
                                  HCVData$FIB4_2015), na.rm=TRUE)
summary(HCVData$totalFIB4BY2015==0)
#note- by 2015 72% of our sample has a FIB4.

HCVData$totalFIB4BY2016 <-rowSums(cbind(HCVData$FIB4_2009,
                                  HCVData$FIB4_2010,
                                  HCVData$FIB4_2011,
                                  HCVData$FIB4_2012,
                                  HCVData$FIB4_2013,
                                  HCVData$FIB4_2014,
                                  HCVData$FIB4_2015,
                                  HCVData$FIB4_2016), na.rm=TRUE)
summary(HCVData$totalFIB4BY2016==0)

HCVData$totalFIB4BY2017 <-rowSums(cbind(HCVData$FIB4_2009,
                                  HCVData$FIB4_2010,
                                  HCVData$FIB4_2011,
                                  HCVData$FIB4_2012,
                                  HCVData$FIB4_2013,
                                  HCVData$FIB4_2014,
                                  HCVData$FIB4_2015,
                                  HCVData$FIB4_2016,
                                  HCVData$FIB4_2017), na.rm=TRUE)
summary(HCVData$totalFIB4BY2017==0)

HCVData$totalFIB4BY2018 <-rowSums(cbind(HCVData$FIB4_2009,
                                  HCVData$FIB4_2010,
                                  HCVData$FIB4_2011,
                                  HCVData$FIB4_2012,
                                  HCVData$FIB4_2013,
                                  HCVData$FIB4_2014,
                                  HCVData$FIB4_2015,
                                  HCVData$FIB4_2016,
                                  HCVData$FIB4_2017,
                                  HCVData$FIB4_2018), na.rm=TRUE)
summary(HCVData$totalFIB4BY2018==0)

HCVData$totalFIB4BY2019 <-rowSums(cbind(HCVData$FIB4_2009,
                                  HCVData$FIB4_2010,
                                  HCVData$FIB4_2011,
                                  HCVData$FIB4_2012,
                                  HCVData$FIB4_2013,
                                  HCVData$FIB4_2014,
                                  HCVData$FIB4_2015,
                                  HCVData$FIB4_2016,
                                  HCVData$FIB4_2017,
                                  HCVData$FIB4_2018,
                                  HCVData$FIB4_2019), na.rm=TRUE)
summary(HCVData$totalFIB4BY2019==0)




#creating the FIB4 scores that  pull forward past scores
HCVData <- HCVData %>% mutate(FIB4_by2010 = FIB4_2010, YearsSinceFib4_2010 = 0)
HCVData <- HCVData %>% mutate(FIB4_by2010 = ifelse(is.na(FIB4_2010)== "TRUE", FIB4_2009, FIB4_by2010),
                               YearsSinceFib4_2010 = ifelse(is.na(FIB4_2010)== "TRUE", 1, 0))
 

HCVData <-  HCVData %>% mutate(FIB4_by2011 = FIB4_2011, YearsSinceFib4_2011 = 0)
HCVData <-  HCVData %>% mutate(FIB4_by2011 = ifelse(is.na(FIB4_2011)== "TRUE", FIB4_by2010, FIB4_by2011),
                               YearsSinceFib4_2011 = ifelse(is.na(FIB4_2011)== "TRUE", YearsSinceFib4_2010 + 1, 0))

HCVData <-  HCVData %>% mutate(FIB4_by2012 = FIB4_2012, YearsSinceFib4_2012 = 0)
HCVData <-  HCVData %>% mutate(FIB4_by2012 = ifelse(is.na(FIB4_2012)== "TRUE", FIB4_by2011, FIB4_by2012),
                               YearsSinceFib4_2012 = ifelse(is.na(FIB4_2012)== "TRUE", YearsSinceFib4_2011 + 1, 0))

HCVData <-  HCVData %>% mutate(FIB4_by2013 = FIB4_2013, YearsSinceFib4_2013 = 0)
HCVData <-  HCVData %>%  mutate(FIB4_by2013 = ifelse(is.na(FIB4_2013)== "TRUE", FIB4_by2012, FIB4_by2013),
                               YearsSinceFib4_2013 = ifelse(is.na(FIB4_2013)== "TRUE", YearsSinceFib4_2012 + 1, 0))

HCVData <-  HCVData %>% mutate(FIB4_by2014 = FIB4_2014, YearsSinceFib4_2014 = 0)
HCVData <-  HCVData %>% mutate(FIB4_by2014 = ifelse(is.na(FIB4_2014)== "TRUE", FIB4_by2013, FIB4_by2014),
                               YearsSinceFib4_2014 = ifelse(is.na(FIB4_2014)== "TRUE", YearsSinceFib4_2013 + 1, 0))

HCVData <-  HCVData %>% mutate(FIB4_by2015 = FIB4_2015, YearsSinceFib4_2015 = 0)
HCVData <-  HCVData %>% mutate(FIB4_by2015 = ifelse(is.na(FIB4_2015)== "TRUE", FIB4_by2014, FIB4_by2015),
                               YearsSinceFib4_2015 = ifelse(is.na(FIB4_2015)== "TRUE", YearsSinceFib4_2014 + 1, 0))


#Imputing as the median value for those without a FIB4 by 2015
HCVData <-  HCVData %>% mutate(YearsSinceFib4_2015 = ifelse(is.na(FIB4_by2015)== "TRUE", 0, YearsSinceFib4_2015),
                               ImputedFIB4_2015 = ifelse(is.na(FIB4_by2015)== "TRUE", 1, 0),
                               FIB4_by2015 = ifelse(is.na(FIB4_by2015)== "TRUE", median(HCVData$FIB4_by2015,na.rm= "TRUE"), FIB4_by2015))


HCVData <-  HCVData %>% mutate(FIB4_by2016 = FIB4_2016, YearsSinceFib4_2016 = 0)
HCVData <-  HCVData %>% mutate(FIB4_by2016 = ifelse(is.na(FIB4_2016)== "TRUE", FIB4_by2015, FIB4_by2016),
                               YearsSinceFib4_2016 = ifelse(is.na(FIB4_2016)== "TRUE", YearsSinceFib4_2015 + 1, 0),
                               ImputedFIB4_2016 = ifelse(is.na(FIB4_2016)== "TRUE", ImputedFIB4_2015, 0))

HCVData <-  HCVData %>% mutate(FIB4_by2017 = FIB4_2017, YearsSinceFib4_2017 = 0)
HCVData <-  HCVData %>% mutate(FIB4_by2017 = ifelse(is.na(FIB4_2017)== "TRUE", FIB4_by2016, FIB4_by2017),
                               YearsSinceFib4_2017 = ifelse(is.na(FIB4_2017)== "TRUE", YearsSinceFib4_2016 + 1, 0),
                               ImputedFIB4_2017 = ifelse(is.na(FIB4_2017)== "TRUE", ImputedFIB4_2016, 0))

HCVData <-  HCVData %>% mutate(FIB4_by2018 = FIB4_2018, YearsSinceFib4_2018 = 0)
HCVData <-  HCVData %>% mutate(FIB4_by2018 = ifelse(is.na(FIB4_2018)== "TRUE", FIB4_by2017, FIB4_by2018),
                               YearsSinceFib4_2018 = ifelse(is.na(FIB4_2018)== "TRUE", YearsSinceFib4_2017 + 1, 0),
                               ImputedFIB4_2018 = ifelse(is.na(FIB4_2018)== "TRUE", ImputedFIB4_2017, 0))

HCVData <-  HCVData %>% mutate(FIB4_by2019 = FIB4_2019, YearsSinceFib4_2019 = 0)
HCVData <-  HCVData %>% mutate(FIB4_by2019 = ifelse(is.na(FIB4_2019)== "TRUE", FIB4_by2018, FIB4_by2019),
                               YearsSinceFib4_2019 = ifelse(is.na(FIB4_2019)== "TRUE", YearsSinceFib4_2018 + 1, 0),
                               ImputedFIB4_2019 = ifelse(is.na(FIB4_2019)== "TRUE", ImputedFIB4_2018, 0))

#Fixing Outcome Variables
HCVData$HCC_2012only <- ifelse((HCVData$Cancer.Diagnosis.Date<'2012-1-1' | HCVData$Cancer.Diagnosis.Date>'2012-12-31') | is.na(HCVData$Cancer.Diagnosis.Date), 0, 1)
HCVData$HCC_2013only <- ifelse((HCVData$Cancer.Diagnosis.Date<'2013-1-1' | HCVData$Cancer.Diagnosis.Date>'2013-12-31') | is.na(HCVData$Cancer.Diagnosis.Date), 0, 1)
HCVData$HCC_2014only <- ifelse((HCVData$Cancer.Diagnosis.Date<'2014-1-1' | HCVData$Cancer.Diagnosis.Date>'2014-12-31') | is.na(HCVData$Cancer.Diagnosis.Date), 0, 1)
HCVData$HCC_2015only <- ifelse((HCVData$Cancer.Diagnosis.Date<'2015-1-1' | HCVData$Cancer.Diagnosis.Date>'2015-12-31') | is.na(HCVData$Cancer.Diagnosis.Date), 0, 1)
HCVData$HCC_2016only <- ifelse((HCVData$Cancer.Diagnosis.Date<'2016-1-1' | HCVData$Cancer.Diagnosis.Date>'2016-12-31') | is.na(HCVData$Cancer.Diagnosis.Date), 0, 1)
HCVData$HCC_2017only <- ifelse((HCVData$Cancer.Diagnosis.Date<'2017-1-1' | HCVData$Cancer.Diagnosis.Date>'2017-12-31') | is.na(HCVData$Cancer.Diagnosis.Date), 0, 1)
HCVData$HCC_2018only <- ifelse((HCVData$Cancer.Diagnosis.Date<'2018-1-1' | HCVData$Cancer.Diagnosis.Date>'2018-12-31') | is.na(HCVData$Cancer.Diagnosis.Date), 0, 1)
HCVData$HCC_2019only <- ifelse((HCVData$Cancer.Diagnosis.Date<'2019-1-1' | HCVData$Cancer.Diagnosis.Date>'2019-12-31') | is.na(HCVData$Cancer.Diagnosis.Date), 0, 1)

HCVData$HCC_2012 <- ifelse(HCVData$Cancer.Diagnosis.Date>'2012-12-31' | is.na(HCVData$Cancer.Diagnosis.Date), 0, 1)
HCVData$HCC_2013 <- ifelse(HCVData$Cancer.Diagnosis.Date>'2013-12-31' | is.na(HCVData$Cancer.Diagnosis.Date), 0, 1)
HCVData$HCC_2014 <- ifelse(HCVData$Cancer.Diagnosis.Date>'2014-12-31' | is.na(HCVData$Cancer.Diagnosis.Date), 0, 1)
HCVData$HCC_2015 <- ifelse(HCVData$Cancer.Diagnosis.Date>'2015-12-31' | is.na(HCVData$Cancer.Diagnosis.Date), 0, 1)
HCVData$HCC_2016 <- ifelse(HCVData$Cancer.Diagnosis.Date>'2016-12-31' | is.na(HCVData$Cancer.Diagnosis.Date), 0, 1)
HCVData$HCC_2017 <- ifelse(HCVData$Cancer.Diagnosis.Date>'2017-12-31' | is.na(HCVData$Cancer.Diagnosis.Date), 0, 1)
HCVData$HCC_2018 <- ifelse(HCVData$Cancer.Diagnosis.Date>'2018-12-31' | is.na(HCVData$Cancer.Diagnosis.Date), 0, 1)
HCVData$HCC_2019 <- ifelse(HCVData$Cancer.Diagnosis.Date>'2019-12-31' | is.na(HCVData$Cancer.Diagnosis.Date), 0, 1)

HCVData$InSystemBy2015 <- ifelse(as.POSIXct(HCVData$First.Hep.Appt) <'2015-12-31' | 
                                   as.POSIXct(HCVData$FIRST_PC_APPT) <'2015-12-31' | 
                                   as.POSIXct(HCVData$First.Hep.Appt) <'2015-12-31' | 
                                   as.POSIXct(HCVData$date.first.pos.HCV.test) < '2015-12-31' | 
                                   as.POSIXct(HCVData$Date.First.Pos.RNA) < '2015-12-31' | 
                                   as.POSIXct(HCVData$AFP.Date) < '2015-12-31'| 
                                   as.POSIXct(HCVData$Lowest.Platelet.Date) < '2015-12-31'| 
                                   as.POSIXct(HCVData$APPT_DATE) < '2015-12-31' | 
                                   as.POSIXct(HCVData$HBsAG.Date) < '2015-12-31' | 
                                   as.POSIXct(HCVData$HBsAg_Date) < '2015-12-31'| 
                                   as.POSIXct(HCVData$HIV.Date) < '2015-12-31'|
                                   as.POSIXct(HCVData$HepA_IgG.Date) < '2015-12-31'|
                                   as.POSIXct(HCVData$HEPB_CORE_IgM_Date) < '2015-12-31' |
                                   as.POSIXct(HCVData$HEPB_CORE_Total_Date) < '2015-12-31' |
                                   as.POSIXct(HCVData$ABD_IMAGING_DATE) < '2015-12-31' |
                                   as.POSIXct(HCVData$BIOPSY_DATE) < '2015-12-31' |
                                   HCVData$VISIT_COUNT_2011 >0 |
                                   HCVData$VISIT_COUNT_2012 >0 |
                                   HCVData$VISIT_COUNT_2013 >0 |
                                   HCVData$VISIT_COUNT_2014 >0 |
                                   HCVData$VISIT_COUNT_2015 >0 |
                                   !is.na(HCVData$AST_2009) |
                                   !is.na(HCVData$AST_2010) |
                                   !is.na(HCVData$AST_2011) |
                                   !is.na(HCVData$AST_2012) |
                                   !is.na(HCVData$AST_2013) |
                                   !is.na(HCVData$AST_2014) |
                                   !is.na(HCVData$AST_2015) |
                                   !is.na(HCVData$ALT_2009) |
                                   !is.na(HCVData$ALT_2010) |
                                   !is.na(HCVData$ALT_2011) |
                                   !is.na(HCVData$ALT_2012) |
                                   !is.na(HCVData$ALT_2013) |
                                   !is.na(HCVData$ALT_2014) |
                                   !is.na(HCVData$ALT_2015) |
                                   !is.na(HCVData$PLATELET_2009) |
                                   !is.na(HCVData$PLATELET_2010) |
                                   !is.na(HCVData$PLATELET_2011) |
                                   !is.na(HCVData$PLATELET_2012) |
                                   !is.na(HCVData$PLATELET_2013) |
                                   !is.na(HCVData$PLATELET_2014) |
                                   !is.na(HCVData$PLATELET_2015), 1, 0)

#Filtering to those who had some visits in 2011-2019, were adults at the start of the data and didn't have HCC before 12/31/15
HCVData<- HCVData %>% filter(TotalVisits != 0) %>%
                      filter(AGE_2011 >18) %>%
                      filter(HCC_2015 == 0) %>%
                      filter(InSystemBy2015 ==1)
  
```

# Description of our Dataset

We are using a dataset of patients with chronic hepatitis C virus (HCV), receiving care in the UCSF system since 2009. 

<!--
# 1. Background
## a. Brief Introduction
Hepatocellular carcinoma (HCC), a type of liver cancer, is the second most common cause of liver-related death throughout the world (Bosetti et al 2014). HCC is a major complication of infection with hepatitis C (HCV) virus, occuring in 1%-4% of people with liver cirrhosis each year (Omland et al 2010). HCV becomes chronic infection for about 80% of adults, and if left untreated can cause increasing cirrhosis over a period of 20-30 years of often asymptomatic disease, until damage is severe and major complications are irreversable (El-Serag 2012). Certain HCV viral genotypes (particularly genotype 3) are associated with higher risk of HCC, as is continued smoking (Chuang et al 2010) and alcohol use (Donato et al 2002), as well as concurrent diabetes or obesity (Huang et al 2017, Calle et al 2003). 

Since 2014, direct-acting antiviral (DAA) therapy has dramatically improved prognosis for people living with HCV; 8-12 weeks of well-tolerated oral therapy leads to cure in more than 90% of patients (Burstow et al 2017), halting cirrhosis progression and apparently reducing the elevated risk of HCC (Axley et al 2017). Patients whose HCV has already caused some cirrhosis continue to be at some increased risk of HCC even post-cure, and given the high mortality risk it is critical that people with HCV infection receive systematic monitoring with liver ultrasound (the European Association for Study of the Liver currently recommends screening twice per year) (EASL 2015). Therefore, we hypothesize that regular visits to a primary care physician or hepatologist who can provide screening and ongoing disease management (including curative treatment for HCV infection in most cases) is preventive for development of HCC among people with known chronic HCV infection.
-->

\vspace{6pt}  

* n = `r nrow(HCVData)`

\vspace{6pt}  

* Adults seen in the UCSF system by the end of 2015 

\vspace{6pt}  

* At least one visit in the primary care or hepatology (liver)  
clinic between 2015 and 2019

\vspace{6pt}  

* Did not already have HCC at the start of the study period

<!--These data come from a query of Apex, the UCSF-specific build of the electronic medical record system Epic.-->

#
\begin{center} \usebeamerfont*{frametitle} \usebeamercolor[fg]{frametitle} Roadmap \end{center}

#
\begin{center} \usebeamerfont*{frametitle} \usebeamercolor[fg]{frametitle} 1. Specify Causal Model \end{center}

# 1. Specify Causal Model

## Defining Our Variables

\vspace{6pt}  

**Exposure**: $A(t), \  t = 1,2,...,4$: A binary variable indicating whether or not the patient had at least two clinical visits at UCSF that year, from 2015 through 2018.*

\vspace{6pt}  

**Outcome**: $Y(K)$: Diagnosis of HCC by the final year (2019), which occurred in `r nrow(HCVData)- as.numeric(summary(HCVData$Cancer.Diagnosis.Source)["NA's"])` patients. 

\vspace{6pt}  

**Covariates**: FIB-4 score, years since FIB-4 score last measured, sex (Male, Female), race (Black, Latinx, White, Other), insurance type (Medi-Cal vs Private/Medicare) as a surrogate of SES.
<!-- FIB-4 is a validated measure used for prediction of cirrhosis (Khan et al 2017), which uses age, platelet count and liver transaminases-->

# 1. Specify Causal Model

## Our DAG
```{r DAG, include = TRUE, echo = FALSE, out.width= "90%"}
knitr::include_graphics("dagitty-model.png")
```

<!--
This analysis includes 5 years worth of data (4 of exposure and 1 of outcome), but in order to simplify the DAG we present only the final 3 years (two of exposure data and the final year of outcome) here. This DAG includes a $C$ value indicating whether or not the patient had the outcome measured by the end of the study.
-->

# 1. Specify Causal Model

## Our SCM

\vspace{10pt}  

$\mathbf{O= (W, C(K), L(t), Y(t), A(t))}$

\vspace{10pt}  

This is survival data with missingness and censoring, where:

* W = baseline covariates (race, sex and SES)
* L(t) = the set of covariates (most recent FIB-4 score, years since last FIB-4) at time $t$
* A(t) = the exposure (number of visits) at time $t$
* C(K) = indicator of being censored at the final timepoint 
* Y(t) = outcome (an indicator of HCC diagnosis)

\vspace{8pt}  

$U = (U_{L(t)}, U_{A(t)}, U_{C(t)}, U_{Y(t)}), \ t = 1,2,3,4,5$ ~ $P_U$

# 1. Specify Causal Model

Structural Equations, $\mathcal{M^F}$, for $t$ from 1 to 5:
\vspace{-8pt}
\begin{align*}
W &= f_{W}(U_{W}) \\
L(1) &= f_{L(1)}(U_{L(1)}) \\
A(1) &= f_{A(1)}(W, L(1), U_{A(1)}) \\
L(t) &= f_{L(t)}(\bar{L}(t-1), \bar{A}(t-1), U_{L(t)}) \\
A(t) &= f_{A(t)}(W, \bar{L}(t), \bar{A}(t-1), U_{A(t)}) \\
C(t) &= f_{C(t)}(W, \bar{A}(t-1), \bar{Y}(t-1)) \\
Y(t) &= f_{Y(t)}(W, \bar{L}(t-1), \bar{A}(t-1), Y(t-1), U_{Y(t)}) \\
Y(K) &= f_{Y(K)}(W, C(K), \bar{L}(K-1), \bar{A}(K-1), Y(K-1), U_{Y(K)}) \\
\end{align*}

# 1. Specify Causal Model

We are also operating with one key exclusion restriction: 

\vspace{10pt}

Once someone develops the outcome [$Y(t) = 1$], we set their $A(t+1...K)$ and $L(t+1,...,K)$ to \textit{\textcolor{orange}{NA}} for the remainder of the analysis, and set $C(K) = 0$ for that subject. 

#
\begin{center} \usebeamerfont*{frametitle} \usebeamercolor[fg]{frametitle} 2. Specify Causal Question \end{center}

# 2. Specify Causal Question

**How do the number of years with at least 2 primary care and/or hepatology visits at UCSF affect the likelihood of developing hepatocellular carcinoma (HCC) by the end of the follow up period among patients diagnosed with chronic hepatitis C (HCV), who were HCC-free at the beginning of the follow up interval?**

<!--
**What is the ideal experiment that would answer your Causal Question?**

The ideal experiment to answer our Causal Question would be to deny people access to primary care and hepatology visits, and see how many developed HCC, then roll back the clock and give them access to just one visit annually (primary care OR hepatology) and see how many developed HCC, then roll back the clock and give them access to 1 additional visit annually and see how many developed HCC, then roll back the clock and give them access to 1 additional visit annually and see how many developed HCC, and so on.

**Which of your variables would you intervene on to answer your Causal Question(s)? What values would you set them equal to?**

We would intervene on $\bar{A}(t)$ to answer our Causal Question, and set them all equal to zero, then just one of the A timepoints equal to 1 (ultimately we might be interested in the effect of only A(1)=1 compared to only A(2)=1, compared to only A(3)=1, etc.), then each of them equal to 1. We also intervene on C(K) to ensure that all participants have outcome assessed at the end of the interval.

**What outcomes are you interested in? Measured when?**

We are interested in whether a patient is diagnosed with HCC, measured at each timepoint (by the end of each year in our study period). For our time-to-event analysis, anyone diagnosed with HCC anytime before the final timepoint in the dataset (i.e. the date the data were pulled from the electronic medical record) will be counted as having the outcome during the period of study.

**What are your counterfactual outcomes, and how would you explain them in words?**

Our counterfactual outcomes are the prevalence of HCC by the end of study follow-up if no one had any primary care or hepatology visits, and the difference in prevalence of HCC at the end of study follow-up for every additional annual primary care or hepatology visit (up to a maximum of four annually) over the study period (i.e. the association between the number of primary care or hepatology visits each year and the hazard of developing HCC.

**What aspects of the counterfactual outcome distribution are you interested in contrasting?**
-->
  
# 2. Specify Causal Question

We are interested in contrasting the counterfactual outcome from various numbers of years with 2+ primary care and/or hepatology visits with the counterfactual outcome from fewer years with 2+ visits, to see if there is some sort of exposure-response relationship.

\vspace{8pt}

To do this, we will use a MSM that helps us understand the relationship between number of years of 2+ primary care or hepatology visits and risk of HCC diagnosis, accounting for time-varying FIB-4 score (as a proxy for liver cirrhosis) and a variety of other baseline demographics.

<!--
**How would you intervene on the SCM you came up with to evaluate the causal target parameter?**
-->

\vspace{8pt}

We will intervene to deterministically set $\bar{C}(K) = 0$ and $\bar{A}(t) = \bar{a}(t)$.

#
\begin{center} \usebeamerfont*{frametitle} \usebeamercolor[fg]{frametitle} 3. Specify Observed Data \end{center}

# 3. Specify Observed Data

## Number of Visits (annually)

The number of visits per patient ranges from 0 to 44 in any given year, with a median of 1 visit per year overall. 

\vspace{10pt}

```{r numvisits, include = TRUE, echo = FALSE, cache = TRUE, warning = FALSE, message = FALSE, fig.height = 5}

plot_multi_histonly <- function(df, feature, label_column) {
    plt <- ggplot(df, aes(x=eval(parse(text=feature)), fill=eval(parse(text=label_column)))) +
    geom_histogram(alpha=0.7, binwidth=.9, position="dodge", aes(y = ..density..), color="black") +
    geom_vline(aes(xintercept=mean(eval(parse(text=feature)))), color="black", linetype="dashed", size=1) +
    labs(x=feature, y = "Density")
    plt + guides(fill=guide_legend(title=label_column))
}

plot_multi_density <- function(df, feature, label_column) {
    plt <- ggplot(df, aes(x=eval(parse(text=feature)), fill=eval(parse(text=label_column)))) +
    geom_density(alpha=0.7) +
    geom_vline(aes(xintercept=mean(eval(parse(text=feature)))), color="black", linetype="dashed", size=1) +
    labs(x=feature, y = "Density")
    plt + guides(fill=guide_legend(title=label_column))
}

VisitCounts <- HCVData %>% dplyr::select(VISIT_COUNT_2011, VISIT_COUNT_2012, VISIT_COUNT_2013, VISIT_COUNT_2014, VISIT_COUNT_2015, VISIT_COUNT_2016, VISIT_COUNT_2017, VISIT_COUNT_2018)
VisitCountsLong <- VisitCounts %>% gather
plot2011 <- ggplot(data = subset(VisitCountsLong, key=="VISIT_COUNT_2011"), aes(x=value)) + geom_histogram(fill = "darkred") + scale_y_continuous(breaks = seq(0,1500,200)) + scale_x_continuous(breaks = seq(0,50,5)) + xlab("Number of Visits") + ylab("Number of Patients") + ggtitle("2011") + theme(legend.position = "none") + theme_minimal() + theme(plot.title = element_text(size = 12, hjust = 0.5))
plot2012 <- ggplot(data = subset(VisitCountsLong, key=="VISIT_COUNT_2012"), aes(x=value)) + geom_histogram(fill = "darkred") + scale_y_continuous(breaks = seq(0,1500,200)) + scale_x_continuous(breaks = seq(0,50,5)) + xlab("Number of Visits") + ylab("Number of Patients") + ggtitle("2012") + theme(legend.position = "none") + theme_minimal() + theme(plot.title = element_text(size = 12, hjust = 0.5))
plot2013 <- ggplot(data = subset(VisitCountsLong, key=="VISIT_COUNT_2013"), aes(x=value)) + geom_histogram(fill = "darkred") + scale_y_continuous(breaks = seq(0,1500,200)) + scale_x_continuous(breaks = seq(0,50,5)) + xlab("Number of Visits") + ylab("Number of Patients") + ggtitle("2013") + theme(legend.position = "none") + theme_minimal() + theme(plot.title = element_text(size = 12, hjust = 0.5))
plot2014 <- ggplot(data = subset(VisitCountsLong, key=="VISIT_COUNT_2014"), aes(x=value)) + geom_histogram(fill = "darkred") + scale_y_continuous(breaks = seq(0,1500,200)) + scale_x_continuous(breaks = seq(0,50,5)) + xlab("Number of Visits") + ylab("Number of Patients") + ggtitle("2014") + theme(legend.position = "none") + theme_minimal() + theme(plot.title = element_text(size = 12, hjust = 0.5))
plot2015 <- ggplot(data = subset(VisitCountsLong, key=="VISIT_COUNT_2015"), aes(x=value)) + geom_histogram(fill = "darkred") + scale_y_continuous(breaks = seq(0,1500,200)) + scale_x_continuous(breaks = seq(0,50,5)) + xlab("Number of Visits") + ylab("Number of Patients") + ggtitle("2015") + theme(legend.position = "none") + theme_minimal() + theme(plot.title = element_text(size = 12, hjust = 0.5))
plot2016 <- ggplot(data = subset(VisitCountsLong, key=="VISIT_COUNT_2016"), aes(x=value)) + geom_histogram(fill = "darkred") + scale_y_continuous(breaks = seq(0,1500,200)) + scale_x_continuous(breaks = seq(0,50,5)) + xlab("Number of Visits") + ylab("Number of Patients") + ggtitle("2016") + theme(legend.position = "none") + theme_minimal() + theme(plot.title = element_text(size = 12, hjust = 0.5))
plot2017 <- ggplot(data = subset(VisitCountsLong, key=="VISIT_COUNT_2017"), aes(x=value)) + geom_histogram(fill = "darkred") + scale_y_continuous(breaks = seq(0,1500,200)) + scale_x_continuous(breaks = seq(0,50,5)) + xlab("Number of Visits") + ylab("Number of Patients") + ggtitle("2017") + theme(legend.position = "none") + theme_minimal() + theme(plot.title = element_text(size = 12, hjust = 0.5))
plot2018 <- ggplot(data = subset(VisitCountsLong, key=="VISIT_COUNT_2018"), aes(x=value)) + geom_histogram(fill = "darkred") + scale_y_continuous(breaks = seq(0,1500,200)) + scale_x_continuous(breaks = seq(0,50,5)) + xlab("Number of Visits") + ylab("Number of Patients") + ggtitle("2018") + theme(legend.position = "none") + theme_minimal() + theme(plot.title = element_text(size = 12, hjust = 0.5))
Visitplots <- ggarrange(plot2011, plot2012, plot2013, plot2014, plot2015, plot2016, plot2017, plot2018, ncol = 4, nrow = 2)
Visitplots <- annotate_figure(Visitplots, top = "Number of Visits per Patient (Annually)")
suppressWarnings(print(Visitplots))
```

# 3. Specify Observed Data

## Diagnosed with HCC (annually)

```{r HCC, include=FALSE}
HCVData$HCC <- ifelse(is.na(HCVData$Cancer.Diagnosis.Name), 0, 1)
HCCpercent <- mean(HCVData$HCC)*100
```

`r sum(HCVData$HCC)` people (`r round(HCCpercent, 1)`%) developed the outcome by $Y(K)$.

\vspace{10pt}

```{r HCCplots, include = TRUE, echo = FALSE, warning = FALSE, message = FALSE, fig.width=9, fig.height=4.5}

#note-calculation of the HCC year variables was moved upto chunk that's called filter_to_adults_with_visits_and_no_Ca_at_start_historical_FIB4s

#These Plots Have ALL years of HCC data. Below is just for the years in our analysis
# HCCyearly <- HCVData %>% dplyr::select(HCC_2012only, HCC_2013only, HCC_2014only, HCC_2015only, HCC_2016only, HCC_2017only, HCC_2018only, HCC_2019only)
# colnames(HCCyearly) <- c("2012", "2013", "2014", "2015", "2016", "2017", "2018", "2019")
# HCCYearlyLong <- HCCyearly %>% gather
# plotHCCann <- ggplot(HCCYearlyLong, aes(x=key, y=value)) + geom_col(fill = "darkgreen") + scale_y_continuous(breaks = seq(0,100,10)) + xlab("Year") + ylab("Number of Patients") + ggtitle("New HCC diagnoses, by year") + theme(legend.position = "none") + theme_minimal() + theme(plot.title = element_text(size = 14, hjust = 0.5))
# 
# 
# HCCtotal <- HCVData %>% dplyr::select(HCC_2012, HCC_2013, HCC_2014, HCC_2015, HCC_2016, HCC_2017, HCC_2018, HCC_2019)
# colnames(HCCtotal) <- c("2012", "2013", "2014", "2015", "2016", "2017", "2018", "2019")
# HCCLong <- HCCtotal %>% gather
# plotHCCcum <- ggplot(HCCLong, aes(x=key, y=value)) + geom_col(fill = "darkgreen") + scale_y_continuous(breaks = seq(0,500,50)) + xlab("Year") + ylab("Number of Patients") + ggtitle("Cumulative HCC cases, by year") + theme(legend.position = "none") + theme_minimal() + theme(plot.title = element_text(size = 14, hjust = 0.5))

#These Plots Have HCC data for only the years of our study.
HCCyearly <- HCVData %>% dplyr::select(HCC_2016only, HCC_2017only, HCC_2018only, HCC_2019only)
colnames(HCCyearly) <- c("2016", "2017", "2018", "2019")
HCCYearlyLong <- HCCyearly %>% gather
plotHCCann <- ggplot(HCCYearlyLong, aes(x=key, y=value)) + geom_col(fill = "darkgreen") + scale_y_continuous(breaks = seq(0,100,10)) + xlab("Year") + ylab("Number of Patients") + ggtitle("New HCC diagnoses, by year") + theme(legend.position = "none") + theme_minimal() + theme(plot.title = element_text(size = 14, hjust = 0.5))


HCCtotal <- HCVData %>% dplyr::select(HCC_2016, HCC_2017, HCC_2018, HCC_2019)
colnames(HCCtotal) <- c("2016", "2017", "2018", "2019")
HCCLong <- HCCtotal %>% gather
plotHCCcum <- ggplot(HCCLong, aes(x=key, y=value)) + geom_col(fill = "darkgreen") + scale_y_continuous(breaks = seq(0,500,50)) + xlab("Year") + ylab("Number of Patients") + ggtitle("Cumulative HCC cases, by year") + theme(legend.position = "none") + theme_minimal() + theme(plot.title = element_text(size = 14, hjust = 0.5))

HCCplots <- ggarrange(plotHCCann, plotHCCcum, ncol = 2, nrow = 1)
suppressWarnings(print(HCCplots))
```

\*\textbf{note} 2019 is an incomplete year!

# 3. Specify Observed Data

## FIB-4 Score (annually)

```{r FIBLongitems, include = FALSE, eval = TRUE}
FIBscores <- HCVData %>% dplyr::select(FIB4_2011, FIB4_2012, FIB4_2013, FIB4_2014, FIB4_2015, FIB4_2016, FIB4_2017, FIB4_2018)
FIBLong <- FIBscores %>% gather
cirrhosis <- nrow(subset(FIBLong, value>3.25))
outliers <- nrow(subset(FIBLong, value>9))
```

\vspace{8pt}

FIB-4 scores are calculated using age, platelet count, AST, and ALT. 

* Scores of <1.45 are considered to be strongly suggestive of no liver fibrosis
* Scores >3.25 are indicative of advanced fibrosis and/or cirrhosis.

\vspace{8pt}

FIB-4 scores in this dataset range of 0.181 to 45.956, with an IQR of 1.198-2.872. 

* `r cirrhosis` FIB-4 scores are >3.25 throughout all years of follow-up on all patients
* There are `r outliers` instances where a patient's FIB-4 score was calculated to be > 9.

# 3. Specify Observed Data

## FIB-4 Score (annually)

\vspace{10pt}

```{r fibplots, include = TRUE, echo = FALSE, cache=TRUE, warning = FALSE, message = FALSE, fig.height = 5.5}

fib2011 <- ggplot(data = subset(FIBLong, key=="FIB4_2011"), aes(x=value)) + geom_histogram(aes(y=..density..), fill = "darkblue") + scale_x_continuous(breaks = seq(0,25,5)) + xlab("FIB-4 Score") + ylab("Density") + ggtitle("2011") + theme(legend.position = "none") + theme_minimal() + theme(plot.title = element_text(size = 12, hjust = 0.5))
fib2012 <- ggplot(data = subset(FIBLong, key=="FIB4_2012"), aes(x=value)) + geom_histogram(aes(y=..density..), fill = "darkblue") + scale_x_continuous(breaks = seq(0,25,5)) + xlab("FIB-4 Score") + ylab("Density") + ggtitle("2012") + theme(legend.position = "none") + theme_minimal() + theme(plot.title = element_text(size = 12, hjust = 0.5))
fib2013 <- ggplot(data = subset(FIBLong, key=="FIB4_2013"), aes(x=value)) + geom_histogram(aes(y=..density..), fill = "darkblue") + scale_x_continuous(breaks = seq(0,25,5)) + xlab("FIB-4 Score") + ylab("Density") + ggtitle("2013") + theme(legend.position = "none") + theme_minimal() + theme(plot.title = element_text(size = 12, hjust = 0.5))
fib2014 <- ggplot(data = subset(FIBLong, key=="FIB4_2014"), aes(x=value)) + geom_histogram(aes(y=..density..), fill = "darkblue") + scale_x_continuous(breaks = seq(0,25,5)) + xlab("FIB-4 Score") + ylab("Density") + ggtitle("2014") + theme(legend.position = "none") + theme_minimal() + theme(plot.title = element_text(size = 12, hjust = 0.5))
fib2015 <- ggplot(data = subset(FIBLong, key=="FIB4_2015"), aes(x=value)) + geom_histogram(aes(y=..density..), fill = "darkblue") + scale_x_continuous(breaks = seq(0,25,5)) + xlab("FIB-4 Score") + ylab("Density") + ggtitle("2015") + theme(legend.position = "none") + theme_minimal() + theme(plot.title = element_text(size = 12, hjust = 0.5))
fib2016 <- ggplot(data = subset(FIBLong, key=="FIB4_2016"), aes(x=value)) + geom_histogram(aes(y=..density..), fill = "darkblue") + scale_x_continuous(breaks = seq(0,25,5)) + xlab("FIB-4 Score") + ylab("Density") + ggtitle("2016") + theme(legend.position = "none") + theme_minimal() + theme(plot.title = element_text(size = 12, hjust = 0.5))
fib2017 <- ggplot(data = subset(FIBLong, key=="FIB4_2017"), aes(x=value)) + geom_histogram(aes(y=..density..), fill = "darkblue") + scale_x_continuous(breaks = seq(0,25,5)) + xlab("FIB-4 Score") + ylab("Density") + ggtitle("2017") + theme(legend.position = "none") + theme_minimal() + theme(plot.title = element_text(size = 12, hjust = 0.5))
fib2018 <- ggplot(data = subset(FIBLong, key=="FIB4_2018"), aes(x=value)) + geom_histogram(aes(y=..density..), fill = "darkblue") + scale_x_continuous(breaks = seq(0,25,5)) + xlab("FIB-4 Score") + ylab("Density") + ggtitle("2018") + theme(legend.position = "none") + theme_minimal() + theme(plot.title = element_text(size = 12, hjust = 0.5))
Visitplots <- ggarrange(fib2011, fib2012, fib2013, fib2014, fib2015, fib2016, fib2017, fib2018, ncol = 4, nrow = 2)
FIBplots <- annotate_figure(Visitplots, top = "FIB-4 Score Distribution (Annually)")
suppressWarnings(print(FIBplots))
```

# 3. Specify Observed Data

\vspace{8pt}

## Other demographics

\vspace{-4pt}

```{r demographics, include = FALSE, eval = TRUE}
sex <- table(HCVData$Sex, useNA = "ifany")
HCVData$race.ethnicity <- ifelse(HCVData$Race == "White or Caucasian" & HCVData$Ethnicity == "Not Hispanic or Latino", "W", ifelse(HCVData$Race == "Black or African American" & HCVData$Ethnicity == "Not Hispanic or Latino", "B", ifelse(HCVData$Ethnicity == "Hispanic or Latino", "L", ifelse(HCVData$Race == "Unknown" | HCVData$Race == "Declined" | HCVData$Race == "Unknown/Declined", NA, "O"))))
race <- table(HCVData$race.ethnicity, useNA  = "ifany")
SES <- table(HCVData$PayorType, useNA = "ifany")
n <- nrow(HCVData)
male <- sex[2]
malep <- male/n*100
female <- sex[1]
femalep <- female/n*100
white <- race[4]
whitep <- white/n*100
black <- race[1]
blackp <- black/n*100
latinx <- race[2]
latinxp <- latinx/n*100
other <- race[3]
otherp <- other/n*100
unkrace <- race[5]
unkracep <- unkrace/n*100
medical <- SES[2]
medicalp <- medical/n*100
medicare <- SES[3]
medicarep <- medicare/n*100
private <- SES[1]
privatep <- private/n*100
unkins <- SES[4]
unkinsp <- unkins/n*100
```

<!--
* \textbf{Sex}. This is a dichotomous variable, with two categories (male, female), as UCSF has not been capturing other gender categories within Epic.

* \textbf{Race}. This is a categorical variable, which we have recategorized into White, Black/African American, Latinx, and Other for ease of analysis.

* \textbf{SES}. We are using insurance type (Medi-Cal, Medicare or commercial/private) as a marker of SES status, which is again a categorical variable.
-->
\small

| Demographic | Category | n | % |
| ----------------- | ----------------- | -------- | --------|
| Sex | Male | `r male` | `r round(malep, 1)`% |
|        | Female | `r female` | `r round(femalep, 1)`% |
|  | 
|        | Black/African American | `r black` | `r round(blackp, 1)`% |
|        | Latinx | `r latinx` | `r round(latinxp, 1)`% |
| Race/ethnicity | White | `r white` | `r round(whitep, 1)`% |
|        | Other | `r other` | `r round(otherp, 1)`% |
|        | Unknown | `r unkrace` | `r round(unkracep, 1)`% |  
|  | 
|        | Medi-Cal | `r medical` | `r round(medicalp, 1)`% |
| SES (Payor type) | Medicare | `r medicare` | `r round(medicarep, 1)`% |
|        | Commercial/Private | `r private` | `r round(privatep, 1)`% |
|        | Unknown | `r unkins` | `r round(unkinsp, 1)`% |
|  | 
| TOTAL | | `r n` | 100% |}

\normalsize

# 3. Specify Observed Data

## Missingness

\vspace{8pt}

```{r fibpercents, eval=TRUE}
ssum <- as.numeric(summary(HCVData$totalFIB4BY2015==0)[2])
start <- ssum/nrow(HCVData)*100
esum <- as.numeric(summary(HCVData$totalFIB4BY2019==0)[2])
end <- esum/nrow(HCVData)*100
```

FIB-4 scores were available from 2009 onward.

<!--* `r round(start, 1)`% of participants had FIB-4 scores at the start of the study.-->
* __82.8%__ of participants had FIB-4 scores by 2015.
* Simple imputation for FIB-4 score for anyone still missing it at 2015 (median).
* Updated $L(t)$ every year the requisite labs were measured after 2015.
<!--* `r round(end, 1)`% of participants had a measured FIB-4 score at the end of the study (2019).-->
* __95.5%__ of participants had a measured FIB-4 score at the end of the study (2019).

\vspace{8pt}

No missingness expected in exposure, since EMR designed for clinical billing

\vspace{8pt}

No missingness assumed for outcome, unless patient is censored at end of study

* However, if no visits at a particular $t$, that $Y(t)$ unknown

<!--
  Note that we have FIB-4 scores calculated annually (when the appropriate components are available) from 2009 forward. Thus, we have a FIB-4 score available for `r as.numeric(summary(HCVData$totalFIB4BY2015==0)[2])/nrow(HCVData)` % of participants at the start of the study interval (calculated somewhere in 2009-2015). For the rest of the participants, we used multiple imputation to impute a 2015 FIB-4 score. For all participants, the FIB-4 score and years since measured are updated every year that all the requisite labs were measured. Thus, by the end of interval, `r as.numeric(summary(HCVData$totalFIB4BY2019==0)[2])/nrow(HCVData)` % of participants had a measured FIB-4 score rather than an imputed value.
  
  There is not missingness expected in the exposure-since EMRs are designed for clinical billing, the data on whether or not visit(s) occurred are expected to be highly accurate. Because HCC is a common and severe complication of HCV, we are comfortable assuming that a patient who is still followed in the system and does not yet have a diagnosis of HCC, is truly negative for HCC, rather than simply missing that data. Further, we will intervene at the end to ensure everyone has outcome measured.

Patients can be censored from the dataset in one of two ways: 

* No longer seeking care within the UCSF system
* Becoming deceased
-->

#
\begin{center} \usebeamerfont*{frametitle} \usebeamercolor[fg]{frametitle} 4. Identification \end{center}

# 4. Identification 

Our target causal parameter is identified under the following conditions:

* Assumed independence between each of the exogenous variables (no shared unknowns)

\vspace{6pt}

* No practical positivity violations
<!--i.e. >0 probability of HCC among all of the baseline covariate and treatment regime combinations-->

\vspace{6pt}

* Sequential randomization assumption for our data generating process

\vspace{6pt}

* Controlling for baseline covariates ($W$s)

<!--
**Under what assumptions is the target causal parameter identified as a function of the observed data distribution?**

Our target causal parameter is identified as a function of the observed data distribution under the assumptions that there is independence between each of the exogenous variables (i.e. there are no shared unknown variables influencing each of the endogenous nodes in our SCM) and that there are no practical positivity violations (i.e. there is a >0 probability of HCC among all of the baseline covariate and treatment regime combinations). In addition to controlling for any baseline covariates ($W$s), we also must rely on the sequential randomization assumption for our data generating process.
-->

#
\begin{center} \usebeamerfont*{frametitle} \usebeamercolor[fg]{frametitle} 5. Commit to an Estimand and Statistical Model \end{center}

# 5. Commit to an Estimand and Statistical Model

Our statistical estimand is: $$\Psi(P_0) = m(\bar{a}|\beta) = E[Y_{\bar{a}}] = \beta_0 + \beta_1 \sum_{t=1}^5a(t)$$

\vspace{8pt}

Our statistical model is an MSM:
$$\Psi^F(P_{U,X}) = E(Y_{\bar{a}, C(K)=0}) = m(\bar{a} | \beta) = \beta_0 \ + \ \beta_1 \sum\limits_{t = 1}^Ka(t)$$

#
\begin{center} \usebeamerfont*{frametitle} \usebeamercolor[fg]{frametitle} 6. Estimation \end{center}

# 6. Estimation

We estimated our target causal parameter using MSMs implemented with G-computation, IPTW, and LTMLE estimators, via the $\tt{ltmleMSM}$ function in the *ltmle* R package.

\vspace{5pt}

## a. Simulation

\vspace{5pt}

Exogenous variables:

* $U_{W}, U_{C(t)}, \ \text{and} \ U_{Y(t)}$ variables have a uniform distribution with a min of 0 and max of 1. 
* $U_{L(t)}$ variables have a gamma distribution with a shape parameter of 0.6 and scale parameter of 2.6. 
* $U_{A(t)}$ variables have a negative binomial distribution with a dispersion parameter of 4 and a probability of 0.6. 

<!--The shape and scale parameters for these distributions were chosen by having them reflect the distribution of variables in our observed data.-->

# 6. Estimation

\vspace{5pt}

## a. Simulation

\vspace{5pt}

Endogenous variables:
  
* $W$ = a nominal categorical variable for the 16 possible different combinations of sex, race, and SES. 
<!--* $L(1)$ = underlying $U_{L(1)}$ gamma distribution.--> 
* $L(t)$ = FIB-4 score from the prior year ($L(t-1)$) + 10% of the value generated by underlying gamma distribution for $U_{L(t)}$ <!--i.e. we expect FIB-4 score to increase slightly each year as people's liver disease slowly progresses.-->
* $A(t)$ = underlying negative binomial distribution for $U_{A(t)}$ plus FIB-4 score (more visits for higher FIB-4<!--, indicating worsening cirrhosis-->). **Dichotomitized into $A(t)=0$ if visits are 0-1 or $A(t)=1$ if visits are 2+.** 
* $C(K) = 1$ if a subject had no primary care or hepatology visits in the final year, otherwise $C(K) = 0$.
* $Y(t)$ = 10% chance of HCC if no visits over the prior interval, with a decreasing chance of HCC with every visit the subject had in the prior year and an increasing chance of HCC as the FIB-4 score rises, indicating worsening cirrhosis: ($Y(t) = I(U_{Y(t)} + 0.01(A(t-1)) - 0.05(L(t-1))) < 0.03)$.

<!--
```{r simulation, include = FALSE, echo = FALSE, eval = TRUE}

generate_data <- function(n) {
  U <- data.frame(UW = runif(n = n, min = 0, max = 1),
                  UL1 = rgamma(n = n, shape = 1.5, scale = 2),
                  UA1 = rnbinom(n=n, size = 4, prob = 0.6),
                  UL2 = rgamma(n = n, shape = 1.5, scale = 2), 
                  UA2 = rnbinom(n=n, size = 4, prob = 0.6),
                  UY2 = runif(n = n, min = 0, max = 1),
                  UL3 = rgamma(n = n, shape = 1.5, scale = 2),
                  UA3 = rnbinom(n=n, size = 4, prob = 0.6),
                  UY3 = runif(n = n, min = 0, max = 1),
                  UL4 = rgamma(n = n, shape = 1.5, scale = 2),
                  UA4 = rnbinom(n=n, size = 4, prob = 0.6),
                  UY4 = runif(n = n, min = 0, max = 1),
                  UA5 = rnbinom(n=n, size = 4, prob = 0.6),
                  UC5 = runif(n = n, min = 0, max = 1), 
                  UY5 = runif(n = n, min = 0, max = 1))
  
  O <- U
  O <- O %>% 
    mutate(W = ifelse(UW < 1/16, 1,
                      ifelse(UW<2/16, 2,
                             ifelse(UW<3/16, 3, 
                                    ifelse(UW<4/16,4,
                                           ifelse(UW<5/16, 5,
                                                  ifelse(UW<6/16, 6, 
                                                         ifelse(UW<7/16, 7, 
                        ifelse(UW<8/16, 8, 
                               ifelse(UW<9/16, 9,
                                      ifelse(UW<10/16, 10,
                                             ifelse(UW<11/16, 11,
                                                    ifelse(UW<12/16, 12,
                                                           ifelse(UW<13/16, 13,
                                                                  ifelse(UW<14/16, 14,
                        ifelse(UW<15/16, 15, 16))))))))))))))),
           L1 = UL1,
           A1 = round(as.numeric(UA1 + 0.1*L1),0),
           L2 =  L1 + 0.1*UL2,
           A2 = round(as.numeric(UA2 + 0.1*L2),0),
           Y2 = as.numeric((UY2+0.01*A1-0.007*L1)< 0.03),
           L3 = ifelse(Y2==1, NA, L2 + 0.1*UL3),
           A3 = ifelse(Y2==1, NA, round(as.numeric(UA3 + 0.1*L3),0)),
           Y3 = ifelse(Y2==1, 1, as.numeric((UY3+0.01*A2-0.007*L2)< 0.03)),
           L4 = ifelse(Y3==1, NA, L3 + 0.1*UL4),
           A4 = ifelse(Y3==1, NA,round(as.numeric(UA4 + 0.1*L4),0)), 
           Y4 = ifelse(Y3==1, 1, as.numeric((UY4+0.01*A3-0.007*L3)< 0.03)),
           A5 = ifelse(Y4==1, NA,round(as.numeric(UA5 + 0.1*L4),0)), 
           C5 = ifelse(A5 == 0, 1, 0),
           Y5 = ifelse(Y4==1, 1, as.numeric((UY5+0.01*A4-0.007*L4)< 0.03)))
  
  #If visits are 0-1 make 0 and if 2+ visits make it 1
  O$A1.bin <- 0
  O$A1.bin[O$A1>1]<-1
  O$A2.bin <- 0
  O$A2.bin[O$A2>1]<-1
  O$A3.bin <- 0
  O$A3.bin[O$A3>1]<-1
  O$A4.bin <- 0
  O$A4.bin[O$A4>1]<-1
  
  O <- O %>% dplyr::select(W, L1, A1 = A1.bin, L2, A2 = A2.bin, Y2, L3, A3 = A3.bin, Y3, L4, A4 = A4.bin, Y4, A5, C5, Y5)
  
  return(O)
}

set.seed(8675309)
SimData <- generate_data(3000)

```

#### Cases of HCC in the Simulated Data
In our simulated dataset, there were `r sum(SimData$Y5, na.rm = TRUE)` cases of hepatocellular carcinoma (HCC) by the end of the study interval.

#### Histograms of Visits and FIB-4 Scores in the Simulated Data
Here are density plots demonstrating the distribution of FIB-4 scores over the years they were measured. 

```{r FIB4 Histograms, include = FALSE, echo = FALSE, fig.height = 5, fig.width = 11}
#found at https://stackoverflow.com/questions/6957549/overlaying-histograms-with-ggplot2-in-r
# plot_multi_histogram <- function(df, feature, label_column) {
#     plt <- ggplot(df, aes(x=eval(parse(text=feature)), fill=eval(parse(text=label_column)))) +
#     geom_histogram(alpha=0.7, position="identity", aes(y = ..density..), color="black") +
#     geom_density(alpha=0.7) +
#     geom_vline(aes(xintercept=mean(eval(parse(text=feature)))), color="black", linetype="dashed", size=1) +
#     labs(x=feature, y = "Density")
#     plt + guides(fill=guide_legend(title=label_column))
# }

FIB4Only <- SimData %>% dplyr::select(L1, L2, L3, L4)
FIB4Long <- FIB4Only %>% gather
FIB4Density <- plot_multi_density(FIB4Long, 'value', 'key')
suppressWarnings(print(FIB4Density))
```

Here are histograms of the number of visits each patient had per year. 

```{r Hist of Visits, include = FALSE, echo = FALSE, message = FALSE, fig.height = 4}
VisitsOnly <- SimData %>% dplyr::select(A1, A2, A3, A4)
VisitsLong <- VisitsOnly %>% gather
VisitsHist<- plot_multi_histonly(VisitsLong, 'value', 'key')
suppressWarnings(print(VisitsHist))
```

## b. Implement our intervention computationally.

To do this, we use the simulation code written earlier, but adapt our function, replacing the structural equations for $\bar{C}(t)$ and  $\bar{A}(t)$ with flexible parameters allowing us to specify values for our intervention.

```{r intervene, include = FALSE, echo = FALSE}

generate_data_intervene <- function(n, c, a1, a2, a3, a4, a5) {
  U <- data.frame(UW = runif(n = n, min = 0, max = 1),
                  UL1 = rgamma(n = n, shape = 1.5, scale = 2),
                  UA1 = rnbinom(n=n, size = 4, prob = 0.6),
                  UL2 = rgamma(n = n, shape = 1.5, scale = 2), 
                  UA2 = rnbinom(n=n, size = 4, prob = 0.6),
                  UY2 = runif(n = n, min = 0, max = 1),
                  UL3 = rgamma(n = n, shape = 1.5, scale = 2),
                  UA3 = rnbinom(n=n, size = 4, prob = 0.6),
                  UY3 = runif(n = n, min = 0, max = 1),
                  UL4 = rgamma(n = n, shape = 1.5, scale = 2),
                  UA4 = rnbinom(n=n, size = 4, prob = 0.6),
                  UY4 = runif(n = n, min = 0, max = 1),
                  UA5 = rnbinom(n=n, size = 4, prob = 0.6),
                  UC5 = runif(n = n, min = 0, max = 1), 
                  UY5 = runif(n = n, min = 0, max = 1))
  
  O <- U
  O <- O %>% 
    mutate(W = ifelse(UW < 1/16, 1,
                      ifelse(UW<2/16, 2,
                             ifelse(UW<3/16, 3, 
                                    ifelse(UW<4/16,4,
                                           ifelse(UW<5/16, 5,
                                                  ifelse(UW<6/16, 6, 
                                                         ifelse(UW<7/16, 7, 
                        ifelse(UW<8/16, 8, 
                               ifelse(UW<9/16, 9,
                                      ifelse(UW<10/16, 10,
                                             ifelse(UW<11/16, 11,
                                                    ifelse(UW<12/16, 12,
                                                           ifelse(UW<13/16, 13,
                                                                  ifelse(UW<14/16, 14,
                        ifelse(UW<15/16, 15, 16))))))))))))))),
        
           L1 = UL1,
           A1 = a1,
           L2 =  L1 + 0.1*UL2,
           A2 = a2,
           Y2 = as.numeric((UY2+0.01*A1-0.007*L1)< 0.03),
           L3 = ifelse(Y2==1, NA, L2 + 0.1*UL3),
           A3 = ifelse(Y2==1, NA, a3),
           Y3 = ifelse(Y2==1, 1, as.numeric((UY3+0.01*A2-0.007*L2)< 0.03)),
           L4 = ifelse(Y3==1, NA, L3 + 0.1*UL4),
           A4 = ifelse(Y3==1, NA, a4), 
           Y4 = ifelse(Y3==1, 1, as.numeric((UY4+0.01*A3-0.007*L3)< 0.03)),
           A5 = ifelse(Y4==1, NA, a5), 
           C5 = 0,
           Y5 = ifelse(Y4==1, 1, as.numeric((UY5+0.01*A4-0.007*L4)< 0.03)))
  
   #If visits are 0-1 make 0 and if 2+ visits make it 1
  O$A1.bin <- 0
  O$A1.bin[O$A1>1]<-1
  O$A2.bin <- 0
  O$A2.bin[O$A2>1]<-1
  O$A3.bin <- 0
  O$A3.bin[O$A3>1]<-1
  O$A4.bin <- 0
  O$A4.bin[O$A4>1]<-1
  
  O <- O %>% dplyr::select(W, L1, A1 = A1.bin, L2, A2 = A2.bin, Y2, L3, A3 = A3.bin, Y3, L4, A4 = A4.bin, Y4, A5, C5, Y5)
  
  return(O)
}

```

### i. Generate many counterfactual outcomes, then evaluate $\Psi^F(P_{U,X})$
```{r PsiF, include = FALSE}
set.seed(8675309)
n<-1000


x <- list(0:1)
TreatmentLevels<- expand.grid(rep(x, 4))

k <- nrow(TreatmentLevels)
sum_abar <- rep(NA, k)
EY_abar <- rep(NA, k)

for (i in 1:k){
  temporary <- as.vector(TreatmentLevels[i,])
df <- generate_data_intervene(
                          n = n,
                          c = 0,
                          a1 = as.numeric(temporary[1]),
                          a2 = as.numeric(temporary[2]),
                          a3 = as.numeric(temporary[3]),
                          a4 = as.numeric(temporary[4]),
                          a5 = 1
)

sum_abar[i] <- sum(as.numeric(temporary[1])+ as.numeric(temporary[2]) + as.numeric(temporary[3]) + as.numeric(temporary[4]), na.rm = TRUE)
EY_abar[i] <- mean(df$Y5)
}


#checking linearity
PlottingData <-as.data.frame(cbind(sum_abar, EY_abar))

PlottingData <- PlottingData %>% 
                group_by(sum_abar) %>%
                summarise(sumY = sum(EY_abar), number = n())


Plot2 <- ggplot(PlottingData, aes(x = sum_abar, y = (sumY/number))) +
geom_point() +
geom_smooth(method = "lm") +
ggtitle("Expected Probability of HCC Dependent on Number of Visits in Simulated Data")  +
xlab("Total Number of Years with Visits 2015-2018")+ 
ylab("Expected Probability of HCC")

#This is checking for linearity based on whether visits occured more than annually among our observed data
Plot2


#Regressing to get beta value
TrueParameterRegression <-lm(EY_abar ~ sum_abar)
summary(TrueParameterRegression)

#PsiF
PsiF <- as.numeric(TrueParameterRegression$coefficients[2])
PsiF

PsiFpercent <- PsiF*100
```

We simulated counterfactual outcomes with all possible combinations of 0-3 visits per year to try to determine $\Psi^F(P_{U,X})$ as the coefficient on the total number of visits in the marginal structural model $\Psi^F(P_{U,X})$ = `r round(PsiF, 3)`.


Note that some individuals have more than 3 visits per year but we felt that 3 or more indicated being well-connected to care, and this still results in `r nrow(TreatmentLevels)` possible  treatment combinations. 
-->

# 6. Estimation

\vspace{5pt}

## a. Simulation

\vspace{5pt}

We generated data with $n = 1000$. When we regressed to get the value of $\beta_1$ in our simulated MSM, it gave us $\psi^F$ = `r PsiF`.

\vspace{10pt} 

The plot below assesses the linearity of our simulated data.

\vspace{6pt}

```{r Plot of linearity in simulated data,  include = TRUE, echo = FALSE, fig.height = 5}
Plot2
```

<!--
### ii. Write a sentence interpreting your $\Psi^F(P_{U,X})$

This means that for every additional primary care or hepatology visit (up to three annually), patients are are `r round(PsiFpercent, 1)`% less likely to develop HCC than people who have one fewer primary care or hepatology visits in the five years under study.

## c. Confirm that in your simulation, the value of your estimand equals the value of your target causal parameter.

```{r IPTW by hand, include = FALSE, echo = FALSE}
# Analysis.IPTW <- function(df){
#   df2 <-df
#   
#   #IPTW
#   
#   #Creating probabilities
# g2A1 <- glm.nb(A1 ~ L1, data = df2)
# g2A2 <- glm.nb(A2 ~ L1 + A1 + L2, data = df2)
# g2A3 <- glm.nb(A3 ~ L1 + A1 + L2 + A2 + L3, data = df2)
# g2A4 <- glm.nb(A4 ~ L1 + A1 + L2 + A2 + L3 + A3 + L4, data = df2)
# 
# gA1_2 <-round(predict(g2A1, type="response", newdata= df2),0)
# gA2_2 <- round(predict(g2A2, type="response", newdata= df2),0)
# gA3_2 <- round(predict(g2A3, type="response", newdata= df2),0)
# gA4_2 <- round(predict(g2A4, type="response", newdata= df2),0)
# 
# df3 <- cbind(df2, gA1_2, gA2_2, gA3_2, gA4_2)
# 
# #Checking for Practical Positivity violations.
# summary(df3)
# 
# #probabilities of observed exposure status- armadillo!these are for binomial...not sure how to getthese probabilities for counts
# gA1 <- (df3$A1 == 1) * gA1_2 + (df3$A1 == 0) * (1 - gA1_2)
# gA2 <- (df3$A2 == 1) * gA2_2 + (df3$A2 == 0) * (1 - gA2_2)
# gA3 <- (df3$A3 == 1) * gA3_2 + (df3$A3 == 0) * (1 - gA3_2)
# gA4 <- (df3$A4 == 1) * gA4_2 + (df3$A4 == 0) * (1 - gA4_2)
# 
# #Creating IPTW Weights
# Weight <-ifelse(is.na(gA1), 0, 
#                 (ifelse(is.na(gA2), 0, 
#                        (ifelse(is.na(gA3), 0, 
#                               (ifelse(is.na(gA4), 0, (1/gA1)*(1/gA2)*(1/gA3)*(1/gA4))))))))
# 
# df4 <- df3 %>% dplyr::select(A1,A2, A3,A4)
# sum_a <- rowSums(df4, na.rm = TRUE)
# 
# MSM <- glm(df3$Y5~sum_a, weights = Weight)
# MSMbeta1<-as.numeric(MSM$coefficients[2])
# return(MSMbeta1)
# }
```

```{r checking estimator performance with ltmle and 2 levels}

# B = 500
# n= 1000
# estimates_Sim <- matrix(nrow = B, ncol = 3)
# colnames(estimates_Sim) <- c("Gcomp", "IPTW",  "TMLE")
# 
# #version with 2 levels for each A
# x <- list(0:1)
# abar<- expand.grid(rep(x, 4))
# n2 <- as.numeric(nrow(abar))
# 
# 
# #initialize sumA
# sumA= rep(NA, n2)
# 
# # initialize regimes with dim n X num Anodes = 4 X num regimes
# regimes = array(NA, dim=c(n,4,n2))
# 
# #fill in regimes and sumA
# for(i in 1:n2){
#   regimes[,,i] <- matrix(rep(as.numeric(abar[i,]),n), byrow=TRUE, nrow=n)
#   sumA[i] =rowSums(abar[i,],  na.rm = TRUE)
# }
# 
# #initialize and define summary measures
# summary.measures = array(dim=c(n2,1,1))
# dimnames(summary.measures)[[2]]=list("sumA")
# summary.measures[,,1]=as.matrix(sumA)
# 
# 
# for(b in 1:B){
# df <-generate_data(1000)
# 
# #define working.msm = character formula for working MSM
# working.msm = "Y ~ sumA"
# 
# 
# 
# df <- df %>% dplyr::select(W, L1, A1,
#                            L2, A2, Y2,
#                            L3, A3, Y3,
#                            L4, A4, Y4,
#                            C5, Y5)
# 
# 
# #Rescale Ls
# maxL1 <-max(df$L1)
# df$L1<-ifelse(is.na(df$L1), NA, (maxL1-df$L1)/maxL1)
# 
# maxL2 <-max(df$L2)
# df$L2<-ifelse(is.na(df$L2), NA,(maxL2-df$L2)/maxL2)
# 
# maxL3 <-max(df$L3,na.rm = T)
# df$L3<-ifelse(is.na(df$L3), NA, (maxL3-df$L3)/maxL3)
# 
# maxL4 <-max(df$L4, na.rm = T)
# df$L4<-ifelse(is.na(df$L4), NA,(maxL4-df$L4)/maxL4)
# 
# #estimate parameter using ltmleMSM function-
# results2.MSM <- ltmle::ltmleMSM(df,
#                      Anodes = c("A1", "A2", "A3", "A4"),
#                      Lnodes = c("L1", "L2", "L3", "L4"),
#                      Ynodes = c("Y2", "Y3", "Y4", "Y5"),
#                      Cnodes = "C5",
#                      working.msm = working.msm,
#                      regimes = regimes,
#                      summary.measures = summary.measures,
#                      msm.weights = NULL,
#                      survivalOutcome = TRUE)
# 
# sum.results2.MSM.tmle= summary(results2.MSM, "tmle")
# sum.results2.MSM.tmle
# 
# sum.results2.MSM.iptw= summary(results2.MSM, "iptw")
# sum.results2.MSM.iptw
# 
# results2.MSM.g <- ltmle::ltmleMSM(df,
#                      Anodes = c("A1", "A2", "A3", "A4"),
#                      Lnodes = c("L1", "L2", "L3", "L4"),
#                      Ynodes = c("Y2", "Y3", "Y4", "Y5"),
#                      Cnodes = "C5",
#                      working.msm = working.msm,
#                      regimes = regimes,
#                      summary.measures = summary.measures,
#                      msm.weights = NULL,
#                      survivalOutcome = TRUE,
#                      gcomp = TRUE)
# 
# sum.results2.MSM.g = summary(results2.MSM.g, "gcomp")
# sum.results2.MSM.g
# 
# estimates_Sim[b,] <- c(sum.results2.MSM.g$cmat[2,1],
#                          sum.results2.MSM.iptw$cmat[2,1],
#                          sum.results2.MSM.tmle$cmat[2,1])
# print(b)
# 
# }
# 
#  save(estimates_Sim, file ="estimates_Sim112519_500iterations.Rdata")

load("estimates_Sim112519_500iterations.Rdata")
estimates_Sim<- as.data.frame(estimates_Sim)


Bias.g <- mean(estimates_Sim[,1]) - PsiF
Variance.g <- var(estimates_Sim[,1])
MSE.g <- mean((estimates_Sim[,1]- PsiF)^2)

Bias.iptw <- mean(estimates_Sim[,2]) - PsiF
Variance.iptw <- var(estimates_Sim[,2])
MSE.iptw <- mean((estimates_Sim[,2]- PsiF)^2)

Bias.tmle <- mean(estimates_Sim[,3]) - PsiF
Variance.tmle <- var(estimates_Sim[,3])
MSE.tmle <- mean((estimates_Sim[,3]- PsiF)^2)

```

For the binary example:
-->

# 6. Estimation

\vspace{5pt}

## a. Simulation

\vspace{5pt}

We then assessed the performance of our estimators relative to our target causal parameter:

\LARGE

|\textcolor{white}{.} | G-Comp | IPTW | TMLE |
|----------| ------ | ------ | ------ |
| Bias | `r round(Bias.g, 3)` | `r round(Bias.iptw, 3)` | `r round(Bias.tmle, 3)` |
| Variance | `r round(Variance.g, 3)` | `r round(Variance.iptw, 3)` | `r round(Variance.tmle, 3)` |
| MSE | `r round(MSE.g, 3)` | `r round(MSE.iptw, 3)` | `r round(MSE.tmle, 3)` |

\normalsize

# 6. Estimation

\vspace{5pt}

## a. Simulation

\vspace{5pt}

We then assessed the performance of our estimators relative to our target causal parameter:

\LARGE

|\textcolor{white}{.} | \textcolor{red}{G-Comp} | IPTW | TMLE |
|----------| ------ | ------ | ------ |
| Bias | `r round(Bias.g, 3)` | `r round(Bias.iptw, 3)` | `r round(Bias.tmle, 3)` |
| Variance | `r round(Variance.g, 3)` | `r round(Variance.iptw, 3)` | `r round(Variance.tmle, 3)` |
| MSE | \textcolor{red}{`r round(MSE.g, 3)`} | `r round(MSE.iptw, 3)` | `r round(MSE.tmle, 3)` |

\normalsize

<!--
```{r datasetreconfig, include = FALSE, eval = TRUE, warning = FALSE, message = FALSE, echo = FALSE}
#Turning observed data into something that we can analyze
O <- as.data.frame(matrix(nrow=nrow(HCVData), NA))
 
O$Y2 <- HCVData$HCC_2016
O$Y3 <- HCVData$HCC_2017
O$Y4 <- HCVData$HCC_2018
O$Y5 <- HCVData$HCC_2019

O$L1 <- HCVData$FIB4_by2015
O$L2 <- HCVData$FIB4_by2016
O$L3 <- HCVData$FIB4_by2017
O$L4 <- HCVData$FIB4_by2018

O$L1lm <- HCVData$YearsSinceFib4_2015
O$L2lm <- HCVData$YearsSinceFib4_2016
O$L3lm <- HCVData$YearsSinceFib4_2017
O$L4lm <- HCVData$YearsSinceFib4_2018

#If visits are 0-1 make 0 and if 2+ visits make it 1
  O$A1 <- 0
  O$A1[HCVData$VISIT_COUNT_2015>1]<-1
  O$A2 <- 0
  O$A2[HCVData$VISIT_COUNT_2016>1]<-1
  O$A3 <- 0
  O$A3[HCVData$VISIT_COUNT_2017>1]<-1
  O$A4 <- 0
  O$A4[HCVData$VISIT_COUNT_2018>1]<-1
  O$A5 <-HCVData$VISIT_COUNT_2019
  
  O$SES <- HCVData$PayorType
  O$Sex <- HCVData$Sex
  O$Race <- HCVData$race.ethnicity
  
  O$C5 <- ifelse(O$A5 == 0, 1, 0)
  
 #remove NAs for now, until we impute
  O <- subset(O, !is.na(O$SES))
  O <- subset(O, !is.na(O$Race))
  
  O <- O %>% dplyr::select(SES, Race, Sex, L1, A1, 
                           L2, A2, Y2, 
                           L3, A3, Y3, 
                           L4, A4, Y4, 
                           C5, Y5)

```

```{r dataset analysis with binary exposure, include = FALSE, cache = TRUE, warning = FALSE, message = FALSE}
#binary version of the analysis (yes/no visits each year)
x <- list(0:1)

abar<- expand.grid(rep(x, 4))

df <- O

#set n equal to number of rows
n <- as.numeric(nrow(df))

n2 <- as.numeric(nrow(abar))

#initialize sumA
sumA= rep(NA, n2)

# initialize regimes with dim n X num Anodes = 4 X num regimes
regimes = array(NA, dim=c(n,4,n2))

#fill in regimes and sumA
for(i in 1:n2){
  regimes[,,i] <- matrix(rep(as.numeric(abar[i,]),n), byrow=TRUE, nrow=n)
  sumA[i] =rowSums(abar[i,],  na.rm = TRUE)
}

#initialize and define summary measures
summary.measures = array(dim=c(n2,1,1))  
dimnames(summary.measures)[[2]]=list("sumA")
summary.measures[,,1]=as.matrix(sumA)

# #define working.msm = character formula for working MSM
working.msm = "Y ~ sumA"

#Rescale Ls
maxL1 <-max(df$L1)
df$L1<-ifelse(is.na(df$L1), NA, (maxL1-df$L1)/maxL1)

maxL2 <-max(df$L2)
df$L2<-ifelse(is.na(df$L2), NA,(maxL2-df$L2)/maxL2)

maxL3 <-max(df$L3,na.rm = T)
df$L3<-ifelse(is.na(df$L3), NA, (maxL3-df$L3)/maxL3)

maxL4 <-max(df$L4, na.rm = T)
df$L4<-ifelse(is.na(df$L4), NA,(maxL4-df$L4)/maxL4)

#estimate parameter using ltmleMSM function-
resultsbin.MSM <- ltmle::ltmleMSM(df,
                     Anodes = c("A1", "A2", "A3", "A4"),
                     Lnodes = c("L1", "L2", "L3", "L4"),
                     Ynodes = c("Y2", "Y3", "Y4", "Y5"),
                     Cnodes = "C5",
                     working.msm = working.msm,
                     regimes = regimes,
                     summary.measures = summary.measures,
                     msm.weights = NULL,
                     survivalOutcome = TRUE)

sum.resultsbin.MSM.tmle= summary(resultsbin.MSM, "tmle")
sum.resultsbin.MSM.tmle

sum.resultsbin.MSM.iptw= summary(resultsbin.MSM, "iptw")
sum.resultsbin.MSM.iptw

resultsbin.MSM.g <- ltmle::ltmleMSM(df,
                     Anodes = c("A1", "A2", "A3", "A4"),
                     Lnodes = c("L1", "L2", "L3", "L4"),
                     Ynodes = c("Y2", "Y3", "Y4", "Y5"),
                     Cnodes = "C5",
                     working.msm = working.msm,
                     regimes = regimes,
                     summary.measures = summary.measures,
                     msm.weights = NULL,
                     survivalOutcome = TRUE,
                     gcomp = TRUE)

sum.resultsbin.MSM.g = summary(resultsbin.MSM.g, "gcomp")
sum.resultsbin.MSM.g

estimates_O <- c(sum.resultsbin.MSM.g$cmat[2,1],
                         sum.resultsbin.MSM.iptw$cmat[2,1],
                         sum.resultsbin.MSM.tmle$cmat[2,1])

save(estimates_O, file = "estimates_Obin112619.Rdata")


#checking linearity
PlottingData <-as.data.frame(cbind(df$A1, df$A2, df$A3, df$A4, df$Y5))
PlottingData <- PlottingData %>% 
                mutate(sumA = V1+V2+V3+V4, Y5 = V5) %>% 
                dplyr::select(sumA, Y5) %>%
                group_by(sumA) %>%
                summarise(sumY = sum(Y5), number = n())


Plot4 <- ggplot(PlottingData, aes(x = sumA, y = (sumY/number))) +
geom_point() +
geom_smooth(method = "lm") +
ggtitle("Expected Probability of HCC Dependant on Whether a Visit Occured Each Year")  +
xlab("Total Number of Years with Visits 2015-2018")+ 
ylab("Expected Probability of HCC")

#This is checking for linearity based on whether visits occured more than annually among our observed data
Plot4
```

Ultimately, implementing \textit{ltmle} on our observed data produced the following estimates for the $\beta$ on $\bar{A}(t) = \bar{a}(t)$ where $a \in \{0,1,2,3+\}$ hepatology or primary care visits in each timepoint (i.e. per year):

| G-Comp | IPTW | TMLE |
| ------ | ------ | ------ |
| `r round(estimates_O[1], 3)` | `r round(estimates_O[2], 3)` | `r round(estimates_O[3], 3)` |

```{r interpretation rounding, include = FALSE, eval = TRUE}
tmlebeta <- exp(estimates_O[3])*100
gcompbeta <- (1-exp(estimates_O[1]))*100
```
-->

# 6. Estimation

\vspace{5pt}

## b. Observed data

\vspace{5pt}

Implementing \textit{ltmle} on our observed data produced the following estimates for $\beta_1$ on $\bar{A}(t) = \bar{a}(t)$ where $a \in \{0-1,2+\}$ hepatology or primary care visits in each timepoint (i.e. per year):

\vspace{8pt}

\LARGE

| G-Comp | IPTW | TMLE |
| --------- | --------- | --------- |
| `r round(estimates_O[1], 3)` | `r round(estimates_O[2], 3)` | `r round(estimates_O[3], 3)` |

\normalsize


# 6. Estimation

## b. Observed data

\vspace{10pt}

The linearity of our finding was encouraging:

\vspace{6pt}

```{r Plot of linearity in observed data,  include = TRUE, echo = FALSE, fig.height = 5}
Plot4
```

#
\begin{center} \usebeamerfont*{frametitle} \usebeamercolor[fg]{frametitle} 7. Interpret Results \end{center}

# 7. Interpret Results

Using the G-Comp estimator, which had the lowest MSE, once our estimate was exponentiated we have the following finding:

\vspace{8pt}

**Over the five years under study, patients are `r round(gcompbeta, 1)`% less likely to have developed HCC by the end of the 5 years, for each additional year that they had at least two primary care or hepatology visits.**

\vspace{8pt}
<!--
Current AASLD guidelines recommend liver monitoring every 6 months for **patients with cirrhosis** but these findings indicate such screening may be worthwhile for **all** patients with chronic HCV.
-->

<!--

## e. "None of the options are good", and other life lessons from Causal

Despite our efforts to simply our analysis to limit the number of possible treatment regimes (i.e. examining the effect of 0, 1, 2, and 3 or more visits, instead of the full distribution of visit counts), this analysis is quite competationally demanding; \textit{ltmle} is extremely slow, with 1 iteration of the simulation taking more than an hour to complete and 50 iterations running for >60 hours and crashing Steph's machine. We will continue to proceed and plan time for R to run analyses as needed, but any suggestions for how to streamline would be welcome!! 

## f. Next steps

We \textit{just} received an updated version of the dataset with diagnosis dates, while our simulation was already running (even though that was ultimately fruitless anyway). Besides trying to streamline our simulation and estimation code, we also plan to tune our simulation to be closer to our real data given that we know know the HCC diagnosis dates. We will then check estimator performance with our simulation, which will help us better interpret the findings from the implementation of those estimators on our observed data.

\newpage

# 5. References

Axley P, Ahmed Z, Ravi S, Singal AK. Hepatitis C Virus and Hepatocellular Carcinoma: A Narrative Review. J Clin Transl Hepatol. 2018 Mar 28; 6(1): 79-84.

Bosetti C, Turati F, La Vecchia C. Hepatocellular carcinoma epidemiology.Best Pract Res Clin Gastroenterol. 2014 Oct; 28(5):753-70.

Burman BE, Bacchetti P, Khalili M. Moderate Alcohol Use and Insulin Action in Chronic Hepatitis C Infection. Dig Dis Sci. 2016;61(8):2417-2425. doi:10.1007/s10620-016-4119-0

Burstow NJ, Mohamed Z, Gomaa AI, et al. Hepatitis C treatment: where are we now? Int J Gen Med 2017; 10:39-52.

Calle EE, Rodriguez C, Walker-Thurmond K, Thun MJ. Overweight, obesity, and mortality from cancer in a prospectively studied cohort of U.S. adults. N Engl J Med. 2003 Apr 24; 348(17):1625-38.

Chuang SC, Lee YC, Hashibe M, Dai M, Zheng T, Boffetta P. Interaction between cigarette smoking and hepatitis B and C virus infection on the risk of liver cancer: a meta-analysis. Cancer Epidemiol Biomarkers Prev. 2010 May; 19(5):1261-8.

Donato F, Tagger A, Gelatti U, Parrinello G, Boffetta P, Albertini A, Decarli A, Trevisi P, Ribero ML, Martelli C, Porru S, Nardi G. Alcohol and hepatocellular carcinoma: the effect of lifetime intake and hepatitis virus infections in men and women. Am J Epidemiol. 2002 Feb 15; 155(4):323-31.

El-Serag HB. Epidemiology of viral hepatitis and hepatocellular carcinoma. Gastroenterology. 2012 May; 142(6):1264-1273.e1.

European Association for Study of Liver. EASL Recommendations on Treatment of Hepatitis C 2015. 
J Hepatol. 2015 Jul; 63(1):199-236.

Huang TS, Lin CL, Lu MJ, Yeh CT, Liang KH, Sun CC, Shyu YC, Chien RN. Diabetes, hepatocellular carcinoma, and mortality in hepatitis C-infected patients: A population-based cohort study.
J Gastroenterol Hepatol. 2017 Jul; 32(7):1355-1362.

Khan MQ, Anand V, Hessefort N, Hassan A, Ahsan A, Sonnenberg A, Fimmel CJ. Utility of Electronic Medical record-based Fibrosis Scores in Predicting Advanced Cirrhosis in Patients with Hepatitic C Virus Infection. J Transl Int Med. 2017 Mar; 5(1): 43-48.

Omland LH, Krarup H, Jepsen P, Georgsen J, Harritsh?j LH, Riisom K, Jacobsen SE, Schouenborg P, Christensen PB, S?rensen HT, Obel N, DANVIR Cohort Study. Mortality in patients with chronic and cleared hepatitis C viral infection: a nationwide cohort study. J Hepatol. 2010 Jul; 53(1):36-42.

Sterling, R. K., Lissen, E. , Clumeck, N. , Sola, R. , Correa, M. C., Montaner, J. , S. Sulkowski, M. , Torriani, F. J., Dieterich, D. T., Thomas, D. L., Messinger, D. and Nelson, M. (2006), Development of a simple noninvasive index to predict significant fibrosis in patients with HIV/HCV coinfection. Hepatology, 43: 1317-1325. doi:10.1002/hep.21178
-->