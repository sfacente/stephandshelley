---
title: "HW 2"
author: "Steph Holm and Shelley Facente"
date: "February 15, 2019"
output:
  pdf_document: default
  word_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(include = FALSE, cache = TRUE)

library(survival)

```


```{r}
# First, (using provided code) load the data:
load("frmgham_recoded.Rdata")

#CREATE A SINGLE-RECORD DATASET (retain 1st observation)
frmgham_recoded <- frmgham_recoded[which(frmgham_recoded$period == 1),]

```

```{r}
#Referring to the code from the lecture notes, plot the Kaplan-Meier estimate of the survival function for each smoking category (using the variable cursmoke) for these data

#copied code from slide 23 of lecture 4, not edited yet
#### FOR THE KM SURVIVAL FUNCTION 
survmod1 <-survfit(Surv(time, status)~1, data=lung2,  
                   conf.type="log-log") 
survmod1.summary <-summary(survmod1) 

# Kaplan-Meier table 7 
keep.cols <-c("time","n.risk","n.event","n.censor","surv","std.err", 
               "upper","lower") 
# Picks off the columns we want
 KMtable <-sapply(survmod1.summary[keep.cols],cbind)
 # Shows 1st 30 rows (and all columns) of KM table
 round(KMtable[1:30,],digits = 3)
 
 #plot
 KMPlot <- plot(survmod1, main="Kaplan-Meier survival estimates",
    xlab="Time", ylab="Survival Probability", xlim=c(0,25))
 
 
 #Plot with curves split by a factor from slide 30, unedited
 survmod2 <-survfit(Surv(time, status) ~ sex, data=lung2)  
 
 plot(survmod2, main="Kaplan-Meier Survival Estimates by sex", 
      xlab="Time (days)", ylab="Survival Probability", 
      bty="l", col=c("darkblue","darkorange")) 
 
legend("topright",legend=c("Male","Female"),lty=1, lwd=2, 
       col=c("darkblue","darkorange"),cex=0.8,bty="o")

```

```{r}
#Using the code below, calculate the number of events and number of person-years in each exposure group:
# The "scale" option set to 1 tells pyears() that the time is already in yrs
# (default is to divide time by 365.25)
py.smoke <- pyears(Surv(timedth_yrs,death)~cursmoke, frmgham_recoded,
scale=1)[c("event","pyears")]
simplify2array(py.smoke) # Make it pretty
```

```{r}
#Referring to the code from the lecture notes, use the logrank test to determine if there are any differences in survival between the smoking groups.
#From slide 45, lecture 4
Logrank <- survdiff(Surv(timedth_yrs, death) ~ cursmoke, data=frmgham_recoded)

p.value.log.rank <-pchisq(Logrank$chisq,1, lower.tail = FALSE)

```

```{r}
#Using a Cox proportional hazards regression model, estimate the association between current smoking status (at baseline) and time to death. Estimate 2 model. First, An unadjusted model (only including smoking status):

#from lecture 5, slide 12, unedited
coxph.lung.unadj <-coxph(Surv(time, status)~karno.cat, data=lung2,
ties="efron")
 summary(coxph.lung.unadj)

```

```{r}
#Now do the same for an adjusted model that also includes age (continuous), sex (binary) and education (4-category) in this model. (For nominal categorical variables, you may need to use the factor() operator in the formula as demonstrated in class.)
```

```{r}
#Estimate a model with an interaction between linear follow-up time and each of the covariates in the model.

#Time transform the variables for modeling, from lecture 5, slide 22. Note that this doesn't work for factors- need to make indicators. unedited
lung2$karno.cat2 <-as.integer(lung2$karno.cat) 
cox.timeixn.lung <-coxph(Surv(time, status) ~ karno.cat + age + 
                           tt(as.integer(karno.cat2==2)) + 
                           tt(as.integer(karno.cat2==3)) + 
                           tt(age) + tt(as.integer(sex)), 
                           data=lung2, method="efron", 
                           tt=function(x,t,...) x*t) 
summary(cox.timeixn.lung)
```

# Question 1: 
Using the Kaplan-Meier plots, graphically assess the relationship between baseline smoking status
and time to death. Briefly interpret what you see. In 1-2 sentences describe the limitations of this
approach. [include the graph, labeled Figure 1] (10 points)

*ANSWER HERE*

\vspace{12pt}
\vspace{12pt}

# Question 2: 
Referring to the code from lecture, are you able to calculate the overall median survival time in this case? If so, provide an estimate of this quantity, if not, describe why and provide an estimate of a percentile of survival time. Interpret the quantity that you estimated. (15 points)

*ANSWER HERE*

\vspace{12pt}
\vspace{12pt}

# Question 3:
Answer the following questions about the log-rank test: (10 points total)

##i) Describe the specific hypothesis that the logrank test is considering here.

The null hypothesis, $h_0$, is that the number at risk at any time, $j$, multiplied by the probability of death at that time is the same for both groups (those who were current smokers at study enrollment versus not.)

If we use the indicator $k=1$ for the smoking group and $k=0$ for the nonsmoking group, this could be stated mathmatically as:

$\frac{n_{1j}*d_j}{n_j} = \frac{n_{0j}*d_j}{n_j}$

##ii) What do you conclude from this test (use 5% significance criteria)? What is the limitation of the inference that you obtain from the log-rank test?

Using 5% as our cut-off for statistical significance, we would conclude that these curves are *not* statistically significant as the p-value is \texttt{`r round(p.value.log.rank,3)`}, meaning that if the null hypothesis is true (there is truly no difference in survival between groups) we have a \texttt{`r 100*round(p.value.log.rank,3)`} percent chance of generating data such as these by chance.

\vspace{12pt}
\vspace{12pt}

# Question 4:
Answer the following questions about the Cox models estimated above: (20 points total)

##i) Why do we use specialized methods for survival analysis (instead of linear or logistic regression, for example)?

*ANSWER HERE*

##ii) What are the advantages of the Cox model over other survival analysis methods? What is a potential disadvantage of the Cox model?

*ANSWER HERE*

##iii) What assumptions, if any, does the standard Cox proportional hazards model make?

*ANSWER HERE*

##iv) Compare the test of the smoking-mortality association between the log-rank test and the likelihood ratio test from the <u>unadjusted</u> Cox proportional hazards model. What do you observe? Between these two analytic approaches, which one would you prefer, and why?

*ANSWER HERE*

\vspace{12pt}
\vspace{12pt}

# Question 5: 
Write the equation for the log-hazard function for the adjusted model you estimated. **Clearly define all parameters in the model.** (15 points)

*ANSWER HERE*

\vspace{12pt}
\vspace{12pt}

# Question 6: 
Using the model you specified in the previous question, show that the hazard ratio comparing current smokers to non-smokers, holding all other covariates constant, is exp($/beta$1) where $/beta$1 is the coefficient on the smoking indicator. (Hint: Start by showing the log-hazard for smokers and the log-hazard for non-smokers and use the fact that the log of the hazard ratio is the difference between two log-hazards.) (10 points)

*ANSWER HERE*

\vspace{12pt}
\vspace{12pt}

# Question 7. 
Complete the following table. How would you interpret the parameter estimate that compares smokers to non-smokers in the adjusted model? What measure of association common in epidemiologic research does this correspond to? (10 points)

Table 1: Crude and adjusted hazard ratio (HR) estimates of the
association between baseline smoking status and mortality.
Framingham Cohort Study. 1948-1972, Framingham, MA.

Smoker | Events| Follow-up Time (yrs) | crude HR (95% CI) | adj. HR (95% CI)
------------ | ------------------- | ------------------ | ------------------- | ------------------ | ------------------
No   | \texttt{`r unORCI[2,1]`} |  |  |  |
Yes  | \texttt{`r unORCI[2,1]`} |  |  |  |

*ANSWER HERE*

\vspace{12pt}
\vspace{12pt}

# Question 8: 
Is there evidence for a violation of the proportional hazards assumption in any of the variables? Indicate how you arrived at your conclusion. Describe how you would account for any noted
violations in the proportional hazards assumption. (10 points)

*ANSWER HERE*