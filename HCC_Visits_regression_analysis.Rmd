---
title: "Number of Health Care Visits and HCC Risk"
author: "Shelley Facente and Steph Holm"
date: "March 5, 2020"
output: pdf_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
library(pacman)
p_load(tidyverse, readxl, skimr, knitr, xslx, lubridate, MASS, ggplot2, ggpubr, data.table, mice, ltmle, SuperLearner, arm, gam, randomForest, earth, Amelia)
#library(Hmisc)

knitr::opts_chunk$set(include = FALSE, cache = TRUE)

# First, set up data loading functions
StephandShelleyDataLoad <- function(filename) 
{
  if(Sys.info()['sysname']=="Darwin"){
    
     read_excel(as.character(filename))}
  else{
    windowsfilepath <- paste("~/GitHub/stephandshelley/", filename, sep = "")
     read_excel(as.character(windowsfilepath))
  }
}

StephandShelleyDataLoad2 <- function(filename) 
{
  if(Sys.info()['sysname']=="Darwin"){
    
     load(as.character(filename))}
  else{
    windowsfilepath <- paste("~/GitHub/stephandshelley/", filename, sep = "")
     load(as.character(windowsfilepath))
  }
}

```

```{r Data_Cleaning, include = FALSE}

# HCVData <- StephandShelleyDataLoad("Deidentified Chronic HCV Dataset 11-21-19.xlsx")
# 
# #first just making variables their proper type, and renaming so there's no spaces
# HCVData$`Deidentifier  11-21-19` <-  as.factor(HCVData$`Deidentifier  11-21-19`)
# colnames(HCVData)[colnames(HCVData) == 'Deidentifier  11-21-19'] <- 'PtID'
# 
# HCVData$'Hep Visit?'<- as.factor(HCVData$'Hep Visit?')
# colnames(HCVData)[colnames(HCVData) == 'Hep Visit?'] <- 'EverHepVisit'
# 
# HCVData$'Ever Chronic HCV?' <- as.factor(HCVData$'Ever Chronic HCV?')
# colnames(HCVData)[colnames(HCVData) == 'Ever Chronic HCV?'] <- 'EverChronicHCV'
# 
# HCVData$'Spontaneous Clearance?' <- as.factor(HCVData$'Spontaneous Clearance?')
# colnames(HCVData)[colnames(HCVData) == 'Spontaneous Clearance?'] <- 'SpontClearance'
# 
# HCVData$'Ever Ab positive HCV?' <- as.factor(HCVData$'Ever Ab positive HCV?')
# colnames(HCVData)[colnames(HCVData) == 'Ever Ab positive HCV?'] <- 'EverAbPosHCV'
# 
# HCVData$'Ever Treated?'<- as.factor(HCVData$'Ever Treated?')
# colnames(HCVData)[colnames(HCVData) == 'Ever Treated?'] <- 'EverTreated'
# 
# HCVData$'Evidence of SVR?'<- as.factor(HCVData$'Evidence of SVR?')
# colnames(HCVData)[colnames(HCVData) == 'Evidence of SVR?'] <- 'SVRAchieved'
# 
# HCVData$'Treatment Definition' <- as.factor(HCVData$'Treatment Definition')
# colnames(HCVData)[colnames(HCVData) == 'Treatment Definition'] <- 'TreatmentDefinition'
# 
# HCVData$'DX_TYPE OR TEST_TYPE' <- as.factor(HCVData$'DX_TYPE OR TEST_TYPE')
# colnames(HCVData)[colnames(HCVData) == 'DX_TYPE OR TEST_TYPE'] <- 'inclusion.source'
# 
# HCVData$'DX_NAME OR TEST RESULT'<- as.factor(HCVData$'DX_NAME OR TEST RESULT')
# colnames(HCVData)[colnames(HCVData) == 'DX_NAME OR TEST RESULT'] <- 'inclusion.reason'
# 
# #Didn't do anything with the column 'ICD10 OR RESULT_DATE' because it's a mix of formats/info
# 
# colnames(HCVData)[colnames(HCVData) == 'SPECIMN TAKEN DATE'] <- 'date.first.pos.HCV.test'
# 
# HCVData$RESULT <- as.factor(HCVData$RESULT)
# colnames(HCVData)[colnames(HCVData) == 'RESULT'] <- 'HCV.test.result'
# 
# HCVData$'RNA EVER TESTED' <- as.factor(HCVData$'RNA EVER TESTED')
# colnames(HCVData)[colnames(HCVData) == 'RNA EVER TESTED'] <- 'RNAeverTested'
# 
# colnames(HCVData)[colnames(HCVData) == 'FIRST POS (Or if no POS, "SEE TEXT") RNA TEST DATE'] <- 'Date.First.Pos.RNA'
# 
# HCVData$'FIRST POS (Or if no POS, "SEE TEXT") RNA TEST RESULT' <- as.factor(HCVData$'FIRST POS (Or if no POS, "SEE TEXT") RNA TEST RESULT')
# colnames(HCVData)[colnames(HCVData) == 'FIRST POS (Or if no POS, "SEE TEXT") RNA TEST RESULT'] <- 'Result.First.Pos.RNA'
# 
# #Added this to address the "See Text" weirdness; I think "See Text" was inserted here when the test was undetectable or lab error, etc. ##### MAY WANT TO REMOVE IF NUMERIC PREFERRED
# ##Note from Steph- it's not undetectable/lab error, it's just that for a number of years, they used this as a way to 'hide' results so that people in someone's chart inadvertantly didn't see sensitive test results. It was sort of a weird thing and they eventually dropped it. But that's why it's there. Right now though this is erroring over the RNA.interpretation column so I've commented it out.
# #HCVData$Result.First.Pos.RNA <- ifelse(HCVData$Result.First.Pos.RNA == 'See Text', HCVData$RNA.interpretation, HCVData$Result.First.Pos.RNA)
# 
# colnames(HCVData)[colnames(HCVData) == 'MOST RECENT RNA POS'] <- 'Most.Recent.RNA.Pos'
# 
# colnames(HCVData)[colnames(HCVData) == 'MOST RECENT RNA NEG'] <- 'Most.Recent.RNA.Neg'
# 
# #This column is in the midst of the RNA testing section but is unlabeled. It's a date.
# colnames(HCVData)[colnames(HCVData) == '..19'] <- 'UnknownColumn'
# 
# colnames(HCVData)[colnames(HCVData) == 'MOST RECENT RNA "SEE TEXT"'] <- 'Most.Recent.RNA.SeeText'
# 
# colnames(HCVData)[colnames(HCVData) == 'RNA interpretation'] <- 'RNA.interpretation'
# 
# colnames(HCVData)[colnames(HCVData) == 'other notes on diagnosis'] <- 'Notes'
# 
# HCVData$'Where getting care' <- as.factor(HCVData$'Where getting care')
# colnames(HCVData)[colnames(HCVData) == 'Where getting care'] <- 'Care.Location'
# 
# #This errors because there are a number of non-dates in this column. Should discuss with Rena if using.
# #HCVData$'HEP C GENOTYPE DATE' <- as.POSIXct(HCVData$'HEP C GENOTYPE DATE')
# #colnames(HCVData)[colnames(HCVData) == 'HEP C GENOTYPE DATE'] <- 'HCV.Genotype.Date'
# 
# HCVData$'HEP C GENOTYPE RESULT' <- as.factor(HCVData$'HEP C GENOTYPE RESULT')
# colnames(HCVData)[colnames(HCVData) == 'HEP C GENOTYPE RESULT'] <- 'HCV.Genotype.Result'
# 
# colnames(HCVData)[colnames(HCVData) == 'ALPHAFETOPROTEIN_RESULT_DATE'] <- 'AFP.Date'
# 
# colnames(HCVData)[colnames(HCVData) == 'ALPHAFETOPROTEIN_RESULT'] <- 'AFP.Result'
# 
# colnames(HCVData)[colnames(HCVData) == 'FIRST_HEPATOLOGY_APPT'] <- 'First.Hep.Appt'
# 
# colnames(HCVData)[colnames(HCVData) == 'MOST_RECENT_HEPATOLOGY_APPT'] <- 'Most.Recent.Hep.Appt'
# 
# colnames(HCVData)[colnames(HCVData) == 'PLATLET_RESULT_DATE'] <- 'Lowest.Platelet.Date'
# 
# colnames(HCVData)[colnames(HCVData) == 'LOWEST_PLATELETS_RESULT'] <- 'Lowest.Platelet.Result'
# 
# colnames(HCVData)[colnames(HCVData) == 'HEPA_VACCINE_DATE'] <- 'HAV.Vax.Date'
# 
# colnames(HCVData)[colnames(HCVData) == 'HEPB_VACCINE_DATE'] <- 'HBV.Vax.Date'
# 
# HCVData$'Ever Had a Primary Care Visit' <- as.factor(HCVData$'Ever Had a Primary Care Visit')
# colnames(HCVData)[colnames(HCVData) == 'Ever Had a Primary Care Visit'] <- 'EverPrimaryCareVisit'
# 
# HCVData$'DEPT_NAME' <- as.factor(HCVData$'DEPT_NAME')
# 
# HCVData$'CURRENT_PCP' <- as.factor(HCVData$'CURRENT_PCP')
# 
# HCVData$'CURRENT_PCP_DEPT' <- as.factor(HCVData$'CURRENT_PCP_DEPT')
# 
# colnames(HCVData)[colnames(HCVData) == 'HBsAb_RESULT_DATE'] <- 'HBsAG.Date'
# 
# HCVData$'HBsAb_ORD_VALUE' <- as.factor(HCVData$'HBsAb_ORD_VALUE')
# colnames(HCVData)[colnames(HCVData) == 'HBsAb_ORD_VALUE'] <- 'HBsAb.Result'
# 
# colnames(HCVData)[colnames(HCVData) == 'HIV_RESULT_DATE'] <- 'HIV.Date'
# 
# HCVData$'ORD_VALUE' <- as.factor(HCVData$'ORD_VALUE')
# colnames(HCVData)[colnames(HCVData) == 'ORD_VALUE'] <- 'HIV.Result'
# 
# HCVData$'HepA_IgG_Result_Date' <- as.factor(HCVData$'HepA_IgG_Result_Date')
# colnames(HCVData)[colnames(HCVData) == 'HepA_IgG_Result_Date'] <- 'HepA_IgG.Date'
# 
# HCVData$'HepA_IgG' <- as.factor(HCVData$'HepA_IgG')
# colnames(HCVData)[colnames(HCVData) == 'HepA_IgG'] <- 'HepA_IgG.Result'
# 
# HCVData$'HBsAg_RESULT_DATE' <- as.factor(HCVData$'HBsAg_RESULT_DATE')
# colnames(HCVData)[colnames(HCVData) == 'HBsAg_RESULT_DATE'] <- 'HBsAg_Date'
# 
# HCVData$'HBsAg_Value' <- as.factor(HCVData$'HBsAg_Value')
# 
# HCVData$'Med_1' <- as.factor(HCVData$'Med_1')
# 
# HCVData$'Med_2' <- as.factor(HCVData$'Med_2')
# 
# HCVData$'HEPB_CORE_IgM_RESULT' <- as.factor(HCVData$'HEPB_CORE_IgM_RESULT')
# 
# HCVData$'HEPB_CORE_Total_RESULT' <- as.factor(HCVData$'HEPB_CORE_Total_RESULT')
# 
# HCVData$DX_TYPE <- as.factor(HCVData$DX_TYPE)
# colnames(HCVData)[colnames(HCVData) == 'DX_TYPE'] <- 'Cancer.Diagnosis.Source'
# 
# HCVData$'DX_NAME..56' <- as.factor(HCVData$'DX_NAME..56')
# colnames(HCVData)[colnames(HCVData) == 'DX_NAME..56'] <- 'Cancer.Diagnosis.Name'
# 
# HCVData$ICD10 <- as.factor(HCVData$ICD10)
# colnames(HCVData)[colnames(HCVData) == 'ICD10'] <- 'Cancer.ICD10'
# 
# HCVData$FIRST_DX_DATE <- as.numeric(HCVData$FIRST_DX_DATE)
# HCVData$FIRST_DX_DATE <- as.Date(HCVData$FIRST_DX_DATE, origin = "1899-12-30")
# colnames(HCVData)[colnames(HCVData) == 'FIRST_DX_DATE'] <- 'Cancer.Diagnosis.Date'
# 
# HCVData$RACE <- as.factor(HCVData$RACE)
# colnames(HCVData)[colnames(HCVData) == 'RACE'] <- 'Race'
# 
# HCVData$ETHNICTY <- as.factor(HCVData$ETHNICTY)
# colnames(HCVData)[colnames(HCVData) == 'ETHNICTY'] <- 'Ethnicity'
# 
# #Appears to only be male/female, I suspect really sex :(
# HCVData$SEX <- as.factor(HCVData$SEX)
# colnames(HCVData)[colnames(HCVData) == 'SEX'] <- 'Sex'
# 
# HCVData$LANGUAGE <- as.factor(HCVData$LANGUAGE)
# colnames(HCVData)[colnames(HCVData) == 'LANGUAGE'] <- 'Language'
# 
# colnames(HCVData)[colnames(HCVData) == 'Outpatient Completed'] <- 'Num.Outpatient.Visits'
# 
# colnames(HCVData)[colnames(HCVData) == 'Outpatient Canceled'] <- 'Num.Outpatient.Cancellations'
# 
# colnames(HCVData)[colnames(HCVData) == 'Outpatient No Show'] <- 'Num.Outpatient.NoShows'
# 
# colnames(HCVData)[colnames(HCVData) == 'Opiod'] <- 'Opioid.Hx'
# 
# colnames(HCVData)[colnames(HCVData) == 'ED'] <- 'ED.Visits'
# 
# colnames(HCVData)[colnames(HCVData) == 'Hosp Admission'] <- 'Hospital.Admissions'
# 
# ##removing extra variables with the same column names, unneeded for our analysis as far as I can tell
# HCVData <- subset(HCVData, select = -c(DX_NAME..71,
#            CURRENT_ICD10_LIST..72,
#            DX_NAME..74,
#            CURRENT_ICD10_LIST..75,
#            DX_NAME..77,
#            CURRENT_ICD10_LIST..78,
#            DX_NAME..80,
#            CURRENT_ICD10_LIST..81,
#            DX_NAME..83,
#            CURRENT_ICD10_LIST..84,
#            DX_NAME..86,
#            CURRENT_ICD10_LIST..87,
#            DX_NAME..89,
#            CURRENT_ICD10_LIST..90,
#            DX_NAME..92,
#            CURRENT_ICD10_LIST..93,
#            DX_NAME..95,
#            CURRENT_ICD10_LIST..96,
#            DX_NAME..98,
#            CURRENT_ICD10_LIST..99,
#            DX_NAME..101,
#            CURRENT_ICD10_LIST..102,
#            CURRENT_ICD10_LIST..104,
#            DX_NAME..105,
#            CURRENT_ICD10_LIST..107,
#            DX_NAME..108,
#            DX_NAME..110,
#            CURRENT_ICD10_LIST..111,
#            CURRENT_ICD10_LIST..113,
#            DX_NAME..114,
#            CURRENT_ICD10_LIST..116,
#            DX_NAME..117,
#            DX_NAME..119,
#            CURRENT_ICD10_LIST..120,
#            DX_NAME..122,
#            CURRENT_ICD10_LIST..123,
#            DX_NAME..125,
#            CURRENT_ICD10_LIST..126))
# 
# colnames(HCVData)[colnames(HCVData) == 'METASTATIC Cancer'] <- 'Metastatic.Cancer'
# 
# colnames(HCVData)[colnames(HCVData) == 'Nonmetastatic Cancer'] <- 'NON-Metastatic.Cancer'
# 
# colnames(HCVData)[colnames(HCVData) == 'Alcohol Abuse'] <- 'Alcohol.Abuse'
# 
# colnames(HCVData)[colnames(HCVData) == 'Drug Abuse'] <- 'Drug.Abuse'
# 
# colnames(HCVData)[colnames(HCVData) == 'Othe Neurological Disorder'] <- 'Other.Neuro.Disorder'
# 
# colnames(HCVData)[colnames(HCVData) == 'CHRONIC PULMONARY DISORDER'] <- 'CPD'
# 
# colnames(HCVData)[colnames(HCVData) == 'Renal Failure'] <- 'Renal.Failure'
# 
# colnames(HCVData)[colnames(HCVData) == 'Liver Disease'] <- 'Liver.Disease'
# 
# HCVData$PAYOR_NAME <- as.factor(HCVData$PAYOR_NAME)
# colnames(HCVData)[colnames(HCVData) == 'PAYOR_NAME'] <- 'PAYOR'
# 
# HCVData <- HCVData %>% mutate(PayorType = ifelse(str_detect(HCVData$PAYOR, "MCAL"), "MediCal", "Commercial"),
#                               PayorType = ifelse(str_detect(HCVData$PAYOR, "M-CAL"), "MediCal", PayorType),
#                               PayorType = ifelse(str_detect(HCVData$PAYOR, "MEDI-CAL"), "MediCal", PayorType),
#                               PayorType = ifelse(str_detect(HCVData$PAYOR, "SENIOR"), "Medicare", PayorType),
#                               PayorType = ifelse(str_detect(HCVData$PAYOR, "SNR"), "Medicare", PayorType),
#                               PayorType = ifelse(str_detect(HCVData$PAYOR, "MEDICARE"), "Medicare", PayorType),
#                               PayorType = ifelse(PayorType=="MediCal", "MediCal", "NotMediCal"))
# 
# HCVData$'FIRST PC APPT DEPT' <- as.factor(HCVData$'FIRST PC APPT DEPT')
# colnames(HCVData)[colnames(HCVData) == 'FIRST PC APPT DEPT'] <- 'FIRST_PC_APPT_DEPT'
# 
# HCVData$'MOST RECENT PC APPT DEPT' <- as.factor(HCVData$'MOST RECENT PC APPT DEPT')
# colnames(HCVData)[colnames(HCVData) == 'MOST RECENT PC APPT DEPT'] <- 'MOST_RECENT_PC_APPT_DEPT'
# 
# HCVData$VISIT_COUNT_2011 <-rowSums(cbind(HCVData$PC_2011_VISIT_COUNT, HCVData$HEP_2011_VISIT_COUNT), na.rm=TRUE)
# HCVData$VISIT_COUNT_2012 <-rowSums(cbind(HCVData$PC_2012_VISIT_COUNT, HCVData$HEP_2012_VISIT_COUNT), na.rm=TRUE)
# HCVData$VISIT_COUNT_2013 <-rowSums(cbind(HCVData$PC_2013_VISIT_COUNT, HCVData$HEP_2013_VISIT_COUNT), na.rm=TRUE)
# HCVData$VISIT_COUNT_2014 <-rowSums(cbind(HCVData$PC_2014_VISIT_COUNT, HCVData$HEP_2014_VISIT_COUNT), na.rm=TRUE)
# HCVData$VISIT_COUNT_2015 <-rowSums(cbind(HCVData$PC_2015_VISIT_COUNT, HCVData$HEP_2015_VISIT_COUNT), na.rm=TRUE)
# HCVData$VISIT_COUNT_2016 <-rowSums(cbind(HCVData$PC_2016_VISIT_COUNT, HCVData$HEP_2016_VISIT_COUNT), na.rm=TRUE)
# HCVData$VISIT_COUNT_2017 <-rowSums(cbind(HCVData$PC_2017_VISIT_COUNT, HCVData$HEP_2017_VISIT_COUNT), na.rm=TRUE)
# HCVData$VISIT_COUNT_2018 <-rowSums(cbind(HCVData$PC_2018_VISIT_COUNT, HCVData$HEP_2018_VISIT_COUNT), na.rm=TRUE)
# HCVData$VISIT_COUNT_2019 <-rowSums(cbind(HCVData$PC_2019_VISIT_COUNT, HCVData$HEP_2019_VISIT_COUNT), na.rm=TRUE)
# 
# HCVData$TotalVisits<- HCVData$VISIT_COUNT_2011 + HCVData$VISIT_COUNT_2012 + HCVData$VISIT_COUNT_2013 + HCVData$VISIT_COUNT_2014 + HCVData$VISIT_COUNT_2015 + HCVData$VISIT_COUNT_2016 + HCVData$VISIT_COUNT_2017 + HCVData$VISIT_COUNT_2018
# 
# HCVData$TotalVisits15to18 <- HCVData$VISIT_COUNT_2015 + HCVData$VISIT_COUNT_2016 + HCVData$VISIT_COUNT_2017 + HCVData$VISIT_COUNT_2018
# 
#  age <- function(dob, curryear, units = "years", floor = TRUE) {
#      calc.age = interval(dob, curryear) / duration(num = 1, units = units)
#      return(as.integer(floor(calc.age)))
#  }
# 
# HCVData$AGE_2009 <- age(dob = HCVData$BIRTH_DATE, curryear = as.Date('2009-12-31'))
# 
# HCVData$AGE_2010 <- age(dob = HCVData$BIRTH_DATE, curryear = as.Date('2010-12-31'))
# 
# HCVData$AGE_2011 <- age(dob = HCVData$BIRTH_DATE, curryear = as.Date('2011-12-31'))
# 
# HCVData$AGE_2012 <- age(dob = HCVData$BIRTH_DATE, curryear = as.Date('2012-12-31'))
# 
# HCVData$AGE_2013 <- age(dob = HCVData$BIRTH_DATE, curryear = as.Date('2013-12-31'))
# 
# HCVData$AGE_2014 <- age(dob = HCVData$BIRTH_DATE, curryear = as.Date('2014-12-31'))
# 
# HCVData$AGE_2015 <- age(dob = HCVData$BIRTH_DATE, curryear = as.Date('2015-12-31'))
# 
# HCVData$AGE_2016 <- age(dob = HCVData$BIRTH_DATE, curryear = as.Date('2016-12-31'))
# 
# HCVData$AGE_2017 <- age(dob = HCVData$BIRTH_DATE, curryear = as.Date('2017-12-31'))
# 
# HCVData$AGE_2018 <- age(dob = HCVData$BIRTH_DATE, curryear = as.Date('2018-12-31'))
# 
# HCVData$AGE_2019 <- age(dob = HCVData$BIRTH_DATE, curryear = as.Date('2019-12-31'))
# 
# #drop DOB from dataset for privacy reasons
# HCVData <- subset(HCVData, select = -c(BIRTH_DATE))
# 
# HCVData$FIB4_2009 <- HCVData$AGE_2009 * HCVData$AST_2009 / (HCVData$PLATELET_2009 * sqrt(HCVData$ALT_2009))
# 
# HCVData$FIB4_2010 <- HCVData$AGE_2010 * HCVData$AST_2010 / (HCVData$PLATELET_2010 * sqrt(HCVData$ALT_2010))
# 
# HCVData$FIB4_2011 <- HCVData$AGE_2011 * HCVData$AST_2011 / (HCVData$PLATELET_2011 * sqrt(HCVData$ALT_2011))
# 
# HCVData$FIB4_2012 <- HCVData$AGE_2012 * HCVData$AST_2012 / (HCVData$PLATELET_2012 * sqrt(HCVData$ALT_2012))
# 
# HCVData$FIB4_2013 <- HCVData$AGE_2013 * HCVData$AST_2013 / (HCVData$PLATELET_2013 * sqrt(HCVData$ALT_2013))
# 
# HCVData$FIB4_2014 <- HCVData$AGE_2011 * HCVData$AST_2014 / (HCVData$PLATELET_2014 * sqrt(HCVData$ALT_2014))
# 
# HCVData$FIB4_2015 <- HCVData$AGE_2011 * HCVData$AST_2015 / (HCVData$PLATELET_2015 * sqrt(HCVData$ALT_2015))
# 
# HCVData$FIB4_2016 <- HCVData$AGE_2011 * HCVData$AST_2016 / (HCVData$PLATELET_2016 * sqrt(HCVData$ALT_2016))
# 
# HCVData$FIB4_2017 <- HCVData$AGE_2011 * HCVData$AST_2017 / (HCVData$PLATELET_2017 * sqrt(HCVData$ALT_2017))
# 
# HCVData$FIB4_2018 <- HCVData$AGE_2011 * HCVData$AST_2018 / (HCVData$PLATELET_2018 * sqrt(HCVData$ALT_2018))
# 
# HCVData$FIB4_2019 <- HCVData$AGE_2011 * HCVData$AST_2019 / (HCVData$PLATELET_2019 * sqrt(HCVData$ALT_2019))
# 
# save(HCVData, file="HCVData.Rdata")

```

```{r filter_to_adults_with_visits_and_no_Ca_at_start_historical_FIB4s, include = FALSE, eval = TRUE}
load("HCVData.Rdata") 

#consolidating race categories
HCVData$race.ethnicity <- ifelse(HCVData$Race == "White or Caucasian" & HCVData$Ethnicity == "Not Hispanic or Latino", "W", ifelse(HCVData$Race == "Black or African American" & HCVData$Ethnicity == "Not Hispanic or Latino", "B", ifelse(HCVData$Ethnicity == "Hispanic or Latino", "L", ifelse(HCVData$Race == "Unknown" | HCVData$Race == "Declined" | HCVData$Race == "Unknown/Declined", NA, "O"))))
 
# #calculating a total fib4, NOT  because it's meaningful but to be ableto see how many had NO FIB4
# #commenting out for now bc just used this to explore
# HCVData$totalFIB4 <-rowSums(cbind(HCVData$FIB4_2009,
#                                   HCVData$FIB4_2010,
#                                   HCVData$FIB4_2011,
#                                   HCVData$FIB4_2012,
#                                   HCVData$FIB4_2013,
#                                   HCVData$FIB4_2014,
#                                   HCVData$FIB4_2015,
#                                   HCVData$FIB4_2016,
#                                   HCVData$FIB4_2017,
#                                   HCVData$FIB4_2018), na.rm=TRUE)
# summary(HCVData$totalFIB4==0)
# 
# HCVData$totalFIB4BY2011 <-rowSums(cbind(HCVData$FIB4_2009,
#                                   HCVData$FIB4_2010,
#                                   HCVData$FIB4_2011), na.rm=TRUE)
# summary(HCVData$totalFIB4BY2011==0)
# 
# HCVData$totalFIB4BY2014 <-rowSums(cbind(HCVData$FIB4_2009,
#                                   HCVData$FIB4_2010,
#                                   HCVData$FIB4_2011,
#                                   HCVData$FIB4_2012,
#                                   HCVData$FIB4_2013,
#                                   HCVData$FIB4_2014), na.rm=TRUE)
# summary(HCVData$totalFIB4BY2014==0)
# 
# HCVData$totalFIB4BY2015 <-rowSums(cbind(HCVData$FIB4_2009,
#                                   HCVData$FIB4_2010,
#                                   HCVData$FIB4_2011,
#                                   HCVData$FIB4_2012,
#                                   HCVData$FIB4_2013,
#                                   HCVData$FIB4_2014,
#                                   HCVData$FIB4_2015), na.rm=TRUE)
# summary(HCVData$totalFIB4BY2015==0)
# #note- by 2015 72% of our sample has a FIB4.
# 
# HCVData$totalFIB4BY2016 <-rowSums(cbind(HCVData$FIB4_2009,
#                                   HCVData$FIB4_2010,
#                                   HCVData$FIB4_2011,
#                                   HCVData$FIB4_2012,
#                                   HCVData$FIB4_2013,
#                                   HCVData$FIB4_2014,
#                                   HCVData$FIB4_2015,
#                                   HCVData$FIB4_2016), na.rm=TRUE)
# summary(HCVData$totalFIB4BY2016==0)
# 
# HCVData$totalFIB4BY2017 <-rowSums(cbind(HCVData$FIB4_2009,
#                                   HCVData$FIB4_2010,
#                                   HCVData$FIB4_2011,
#                                   HCVData$FIB4_2012,
#                                   HCVData$FIB4_2013,
#                                   HCVData$FIB4_2014,
#                                   HCVData$FIB4_2015,
#                                   HCVData$FIB4_2016,
#                                   HCVData$FIB4_2017), na.rm=TRUE)
# summary(HCVData$totalFIB4BY2017==0)
# 
# HCVData$totalFIB4BY2018 <-rowSums(cbind(HCVData$FIB4_2009,
#                                   HCVData$FIB4_2010,
#                                   HCVData$FIB4_2011,
#                                   HCVData$FIB4_2012,
#                                   HCVData$FIB4_2013,
#                                   HCVData$FIB4_2014,
#                                   HCVData$FIB4_2015,
#                                   HCVData$FIB4_2016,
#                                   HCVData$FIB4_2017,
#                                   HCVData$FIB4_2018), na.rm=TRUE)
# summary(HCVData$totalFIB4BY2018==0)
# 
# HCVData$totalFIB4BY2019 <-rowSums(cbind(HCVData$FIB4_2009,
#                                   HCVData$FIB4_2010,
#                                   HCVData$FIB4_2011,
#                                   HCVData$FIB4_2012,
#                                   HCVData$FIB4_2013,
#                                   HCVData$FIB4_2014,
#                                   HCVData$FIB4_2015,
#                                   HCVData$FIB4_2016,
#                                   HCVData$FIB4_2017,
#                                   HCVData$FIB4_2018,
#                                   HCVData$FIB4_2019), na.rm=TRUE)
# summary(HCVData$totalFIB4BY2019==0)

#Pulling forward FIB4 scores until 2014 where needed
HCVData <- HCVData %>% mutate(FIB4_by2010 = FIB4_2010, YearsSinceFib4_2010 = 0)
HCVData <- HCVData %>% mutate(FIB4_by2010 = ifelse(is.na(FIB4_2010)== "TRUE", FIB4_2009, FIB4_by2010),
                               YearsSinceFib4_2010 = ifelse(is.na(FIB4_2010)== "TRUE", 1, 0))
 
HCVData <-  HCVData %>% mutate(FIB4_by2011 = FIB4_2011, YearsSinceFib4_2011 = 0)
HCVData <-  HCVData %>% mutate(FIB4_by2011 = ifelse(is.na(FIB4_2011)== "TRUE", FIB4_by2010, FIB4_by2011),
                               YearsSinceFib4_2011 = ifelse(is.na(FIB4_2011)== "TRUE", YearsSinceFib4_2010 + 1, 0))

HCVData <-  HCVData %>% mutate(FIB4_by2012 = FIB4_2012, YearsSinceFib4_2012 = 0)
HCVData <-  HCVData %>% mutate(FIB4_by2012 = ifelse(is.na(FIB4_2012)== "TRUE", FIB4_by2011, FIB4_by2012),
                               YearsSinceFib4_2012 = ifelse(is.na(FIB4_2012)== "TRUE", YearsSinceFib4_2011 + 1, 0))

HCVData <-  HCVData %>% mutate(FIB4_by2013 = FIB4_2013, YearsSinceFib4_2013 = 0)
HCVData <-  HCVData %>%  mutate(FIB4_by2013 = ifelse(is.na(FIB4_2013)== "TRUE", FIB4_by2012, FIB4_by2013),
                               YearsSinceFib4_2013 = ifelse(is.na(FIB4_2013)== "TRUE", YearsSinceFib4_2012 + 1, 0))

HCVData <-  HCVData %>% mutate(FIB4_by2014 = FIB4_2014, YearsSinceFib4_2014 = 0)
HCVData <-  HCVData %>% mutate(FIB4_by2014 = ifelse(is.na(FIB4_2014)== "TRUE", FIB4_by2013, FIB4_by2014),
                               YearsSinceFib4_2014 = ifelse(is.na(FIB4_2014)== "TRUE", YearsSinceFib4_2013 + 1, 0))

#Fixing Outcome Variables
HCVData$HCC_2012only <- ifelse((HCVData$Cancer.Diagnosis.Date<'2012-1-1' | HCVData$Cancer.Diagnosis.Date>'2012-12-31') | is.na(HCVData$Cancer.Diagnosis.Date), 0, 1)
HCVData$HCC_2013only <- ifelse((HCVData$Cancer.Diagnosis.Date<'2013-1-1' | HCVData$Cancer.Diagnosis.Date>'2013-12-31') | is.na(HCVData$Cancer.Diagnosis.Date), 0, 1)
HCVData$HCC_2014only <- ifelse((HCVData$Cancer.Diagnosis.Date<'2014-1-1' | HCVData$Cancer.Diagnosis.Date>'2014-12-31') | is.na(HCVData$Cancer.Diagnosis.Date), 0, 1)
HCVData$HCC_2015only <- ifelse((HCVData$Cancer.Diagnosis.Date<'2015-1-1' | HCVData$Cancer.Diagnosis.Date>'2015-12-31') | is.na(HCVData$Cancer.Diagnosis.Date), 0, 1)
HCVData$HCC_2016only <- ifelse((HCVData$Cancer.Diagnosis.Date<'2016-1-1' | HCVData$Cancer.Diagnosis.Date>'2016-12-31') | is.na(HCVData$Cancer.Diagnosis.Date), 0, 1)
HCVData$HCC_2017only <- ifelse((HCVData$Cancer.Diagnosis.Date<'2017-1-1' | HCVData$Cancer.Diagnosis.Date>'2017-12-31') | is.na(HCVData$Cancer.Diagnosis.Date), 0, 1)
HCVData$HCC_2018only <- ifelse((HCVData$Cancer.Diagnosis.Date<'2018-1-1' | HCVData$Cancer.Diagnosis.Date>'2018-12-31') | is.na(HCVData$Cancer.Diagnosis.Date), 0, 1)
HCVData$HCC_2019only <- ifelse((HCVData$Cancer.Diagnosis.Date<'2019-1-1' | HCVData$Cancer.Diagnosis.Date>'2019-12-31') | is.na(HCVData$Cancer.Diagnosis.Date), 0, 1)

HCVData$HCC_2012 <- ifelse(HCVData$Cancer.Diagnosis.Date>'2012-12-31' | is.na(HCVData$Cancer.Diagnosis.Date), 0, 1)
HCVData$HCC_2013 <- ifelse(HCVData$Cancer.Diagnosis.Date>'2013-12-31' | is.na(HCVData$Cancer.Diagnosis.Date), 0, 1)
HCVData$HCC_2014 <- ifelse(HCVData$Cancer.Diagnosis.Date>'2014-12-31' | is.na(HCVData$Cancer.Diagnosis.Date), 0, 1)
HCVData$HCC_2015 <- ifelse(HCVData$Cancer.Diagnosis.Date>'2015-12-31' | is.na(HCVData$Cancer.Diagnosis.Date), 0, 1)
HCVData$HCC_2016 <- ifelse(HCVData$Cancer.Diagnosis.Date>'2016-12-31' | is.na(HCVData$Cancer.Diagnosis.Date), 0, 1)
HCVData$HCC_2017 <- ifelse(HCVData$Cancer.Diagnosis.Date>'2017-12-31' | is.na(HCVData$Cancer.Diagnosis.Date), 0, 1)
HCVData$HCC_2018 <- ifelse(HCVData$Cancer.Diagnosis.Date>'2018-12-31' | is.na(HCVData$Cancer.Diagnosis.Date), 0, 1)
HCVData$HCC_2019 <- ifelse(HCVData$Cancer.Diagnosis.Date>'2019-12-31' | is.na(HCVData$Cancer.Diagnosis.Date), 0, 1)

HCVData$InSystemBy2015 <- ifelse(as.POSIXct(HCVData$First.Hep.Appt) <'2015-12-31' | 
                                   as.POSIXct(HCVData$FIRST_PC_APPT) <'2015-12-31' | 
                                   as.POSIXct(HCVData$First.Hep.Appt) <'2015-12-31' | 
                                   as.POSIXct(HCVData$date.first.pos.HCV.test) < '2015-12-31' | 
                                   as.POSIXct(HCVData$Date.First.Pos.RNA) < '2015-12-31' | 
                                   as.POSIXct(HCVData$AFP.Date) < '2015-12-31'| 
                                   as.POSIXct(HCVData$Lowest.Platelet.Date) < '2015-12-31'| 
                                   as.POSIXct(HCVData$APPT_DATE) < '2015-12-31' | 
                                   as.POSIXct(HCVData$HBsAG.Date) < '2015-12-31' | 
                                   as.POSIXct(HCVData$HBsAg_Date) < '2015-12-31'| 
                                   as.POSIXct(HCVData$HIV.Date) < '2015-12-31'|
                                   as.POSIXct(HCVData$HepA_IgG.Date) < '2015-12-31'|
                                   as.POSIXct(HCVData$HEPB_CORE_IgM_Date) < '2015-12-31' |
                                   as.POSIXct(HCVData$HEPB_CORE_Total_Date) < '2015-12-31' |
                                   as.POSIXct(HCVData$ABD_IMAGING_DATE) < '2015-12-31' |
                                   as.POSIXct(HCVData$BIOPSY_DATE) < '2015-12-31' |
                                   HCVData$VISIT_COUNT_2011 >0 |
                                   HCVData$VISIT_COUNT_2012 >0 |
                                   HCVData$VISIT_COUNT_2013 >0 |
                                   HCVData$VISIT_COUNT_2014 >0 |
                                   HCVData$VISIT_COUNT_2015 >0 |
                                   !is.na(HCVData$AST_2009) |
                                   !is.na(HCVData$AST_2010) |
                                   !is.na(HCVData$AST_2011) |
                                   !is.na(HCVData$AST_2012) |
                                   !is.na(HCVData$AST_2013) |
                                   !is.na(HCVData$AST_2014) |
                                   !is.na(HCVData$AST_2015) |
                                   !is.na(HCVData$ALT_2009) |
                                   !is.na(HCVData$ALT_2010) |
                                   !is.na(HCVData$ALT_2011) |
                                   !is.na(HCVData$ALT_2012) |
                                   !is.na(HCVData$ALT_2013) |
                                   !is.na(HCVData$ALT_2014) |
                                   !is.na(HCVData$ALT_2015) |
                                   !is.na(HCVData$PLATELET_2009) |
                                   !is.na(HCVData$PLATELET_2010) |
                                   !is.na(HCVData$PLATELET_2011) |
                                   !is.na(HCVData$PLATELET_2012) |
                                   !is.na(HCVData$PLATELET_2013) |
                                   !is.na(HCVData$PLATELET_2014) |
                                   !is.na(HCVData$PLATELET_2015), 1, 0)

#Filtering to those who had some visits in 2015-2019, were adults at the start of 2015 and didn't have HCC before 12/31/14
HCVData <- HCVData %>% filter(TotalVisits != 0) %>%
                      filter(AGE_2015 >18) %>%
                      filter(HCC_2014 == 0) %>%
                      filter(InSystemBy2015 ==1)

#Changing abdominal imaging variables to be zero if it's NA
HCVData$ABD_IMAGING_2015[is.na(HCVData$ABD_IMAGING_2015)] <-0
HCVData$ABD_IMAGING_2016[is.na(HCVData$ABD_IMAGING_2016)] <-0
HCVData$ABD_IMAGING_2017[is.na(HCVData$ABD_IMAGING_2017)] <-0
HCVData$ABD_IMAGING_2018[is.na(HCVData$ABD_IMAGING_2018)] <-0

#Making Abd imaging variables that are yes/no to whether someone had imaging that year
HCVData$ABD_IMAGING_YN_2015[HCVData$ABD_IMAGING_2015 == 0] <- 0
HCVData$ABD_IMAGING_YN_2015[HCVData$ABD_IMAGING_2015 > 0] <- 1

HCVData$ABD_IMAGING_YN_2016[HCVData$ABD_IMAGING_2016 == 0] <- 0
HCVData$ABD_IMAGING_YN_2016[HCVData$ABD_IMAGING_2016 > 0] <- 1

HCVData$ABD_IMAGING_YN_2017[HCVData$ABD_IMAGING_2017 == 0] <- 0
HCVData$ABD_IMAGING_YN_2017[HCVData$ABD_IMAGING_2017 > 0] <- 1

HCVData$ABD_IMAGING_YN_2018[HCVData$ABD_IMAGING_2018 == 0] <- 0
HCVData$ABD_IMAGING_YN_2018[HCVData$ABD_IMAGING_2018 > 0] <- 1

#These were just to explore the data once we filtered out those with cirrhosis at baseline
# table(HCVData_inclcirr$HCC_2019)
# table(HCVData$HCC_2019)
# HCVData_outcome <- HCVData %>% filter(HCC_2019==1)
# HCVData_nooutcome <- HCVData %>% filter(HCC_2019==0)
# summary(HCVData_outcome$FIB4_2019)
# summary(HCVData_nooutcome$FIB4_2019)
# 
# table(HCVData$VISIT_COUNT_2015, HCVData$ABD_IMAGING_2015)
# 
# HCVData_imaging <- HCVData %>% filter(HCVData$ABD_IMAGING_2015 > 0 & HCVData$ABD_IMAGING_2016 > 0 & HCVData$ABD_IMAGING_2017 > 0 & HCVData$ABD_IMAGING_2018 > 0)
# table(HCVData_imaging$HCC_2019)


#impute FIB4, SES, Race
HCVData$PayorType <- as.factor(HCVData$PayorType)
HCVData$race.ethnicity <- as.factor(HCVData$race.ethnicity)

impute <- c("PtID", "PayorType", "race.ethnicity", "FIB4_by2014")
keeps <- c("PayorType", "race.ethnicity", "FIB4_by2014")
###commenting out imputation to save computation time###
#imputation <- mice(HCVData[, (names(HCVData) %in% impute)], m=5, maxit=5, nnet.MaxNWts=10000, printFlag=TRUE, seed = 252)
load("ImputedData.RData")

#######TRYING SOMETING NEW WITH IMPUTATION, FAILED SO COMMENTED OUT########
# keep <- c("PtID", "PayorType", "race.ethnicity", "FIB4_by2014", "Sex", "VISIT_COUNT_2014", "VISIT_COUNT_2015", "VISIT_COUNT_2016", "VISIT_COUNT_2017", "VISIT_COUNT_2018", "ABD_IMAGING_2014", "ABD_IMAGING_2015", "ABD_IMAGING_2016", "ABD_IMAGING_2017", "ABD_IMAGING_2018", "HCC_2019", "FIB4_2015", "FIB4_2016", "FIB4_2017", "FIB4_2018", "FIB4_2019")
# HCVData_min <- HCVData[keep]
# imputation <- mice(HCVData_min, method = ifelse(colnames(HCVData_min) == "PayorType" | colnames(HCVData_min) == "race.ethnicity" | colnames(HCVData_min) == "FIB4_by2014", "pmm", ""), m=5, maxit=5, nnet.MaxNWts=10000, printFlag=TRUE, seed = 252)
# save(imputation, file = "ImputedData2.Rdata")
# load("ImputedData2.Rdata")

impute1 <- complete(imputation, 1)
impute2 <- complete(imputation, 2)
impute3 <- complete(imputation, 3)
impute4 <- complete(imputation, 4)
impute5 <- complete(imputation, 5)
HCVData1 <- merge(impute1, HCVData[, !(names(HCVData) %in% keeps)], by = "PtID")
HCVData2 <- merge(impute2, HCVData[, !(names(HCVData) %in% keeps)], by = "PtID")
HCVData3 <- merge(impute3, HCVData[, !(names(HCVData) %in% keeps)], by = "PtID")
HCVData4 <- merge(impute4, HCVData[, !(names(HCVData) %in% keeps)], by = "PtID")
HCVData5 <- merge(impute5, HCVData[, !(names(HCVData) %in% keeps)], by = "PtID")

# #OLD - keeping just in case
# #Imputing as the median value for those without a FIB4 by 2014
# HCVData <-  HCVData %>% mutate(YearsSinceFib4_2014 = ifelse(is.na(FIB4_by2014)== "TRUE", 0, YearsSinceFib4_2014),
#                                ImputedFIB4_2014 = ifelse(is.na(FIB4_by2014)== "TRUE", 1, 0),
#                                FIB4_by2014 = ifelse(is.na(FIB4_by2014)== "TRUE", median(HCVData$FIB4_by2014,na.rm= "TRUE"), FIB4_by2014))
# 
# HCVData <-  HCVData %>% mutate(FIB4_by2015 = FIB4_2015, YearsSinceFib4_2015 = 0)
# HCVData <-  HCVData %>% mutate(FIB4_by2015 = ifelse(is.na(FIB4_2015)== "TRUE", FIB4_by2014, FIB4_by2015),
#                                YearsSinceFib4_2015 = ifelse(is.na(FIB4_2015)== "TRUE", YearsSinceFib4_2014 + 1, 0),
#                                ImputedFIB4_2015 = ifelse(is.na(FIB4_2015)== "TRUE", ImputedFIB4_2014, 0))
# 
# HCVData <-  HCVData %>% mutate(FIB4_by2016 = FIB4_2016, YearsSinceFib4_2016 = 0)
# HCVData <-  HCVData %>% mutate(FIB4_by2016 = ifelse(is.na(FIB4_2016)== "TRUE", FIB4_by2015, FIB4_by2016),
#                                YearsSinceFib4_2016 = ifelse(is.na(FIB4_2016)== "TRUE", YearsSinceFib4_2015 + 1, 0),
#                                ImputedFIB4_2016 = ifelse(is.na(FIB4_2016)== "TRUE", ImputedFIB4_2015, 0))
# 
# HCVData <-  HCVData %>% mutate(FIB4_by2017 = FIB4_2017, YearsSinceFib4_2017 = 0)
# HCVData <-  HCVData %>% mutate(FIB4_by2017 = ifelse(is.na(FIB4_2017)== "TRUE", FIB4_by2016, FIB4_by2017),
#                                YearsSinceFib4_2017 = ifelse(is.na(FIB4_2017)== "TRUE", YearsSinceFib4_2016 + 1, 0),
#                                ImputedFIB4_2017 = ifelse(is.na(FIB4_2017)== "TRUE", ImputedFIB4_2016, 0))
# 
# HCVData <-  HCVData %>% mutate(FIB4_by2018 = FIB4_2018, YearsSinceFib4_2018 = 0)
# HCVData <-  HCVData %>% mutate(FIB4_by2018 = ifelse(is.na(FIB4_2018)== "TRUE", FIB4_by2017, FIB4_by2018),
#                                YearsSinceFib4_2018 = ifelse(is.na(FIB4_2018)== "TRUE", YearsSinceFib4_2017 + 1, 0),
#                                ImputedFIB4_2018 = ifelse(is.na(FIB4_2018)== "TRUE", ImputedFIB4_2017, 0))
# 
# HCVData <-  HCVData %>% mutate(FIB4_by2019 = FIB4_2019, YearsSinceFib4_2019 = 0)
# HCVData <-  HCVData %>% mutate(FIB4_by2019 = ifelse(is.na(FIB4_2019)== "TRUE", FIB4_by2018, FIB4_by2019),
#                                YearsSinceFib4_2019 = ifelse(is.na(FIB4_2019)== "TRUE", YearsSinceFib4_2018 + 1, 0),
#                                ImputedFIB4_2019 = ifelse(is.na(FIB4_2019)== "TRUE", ImputedFIB4_2018, 0))

#Filtering to those with no cirrhosis at baseline
HCVData1 <- HCVData1 %>% filter(FIB4_by2014 < 3.25)
HCVData2 <- HCVData2 %>% filter(FIB4_by2014 < 3.25)
HCVData3 <- HCVData3 %>% filter(FIB4_by2014 < 3.25)
HCVData4 <- HCVData4 %>% filter(FIB4_by2014 < 3.25)
HCVData5 <- HCVData5 %>% filter(FIB4_by2014 < 3.25)

#Pulling forward FIB4s post-2014
HCVData1 <-  HCVData1 %>% mutate(FIB4_by2015 = FIB4_2015, YearsSinceFib4_2015 = 0)
HCVData1 <-  HCVData1 %>% mutate(
  FIB4_by2015 = ifelse(is.na(FIB4_2015)== "TRUE", FIB4_by2014, FIB4_by2015),
  YearsSinceFib4_2015 = ifelse(is.na(FIB4_2015)== "TRUE", YearsSinceFib4_2014 + 1, 0),
  ImputedFIB4_2015 = ifelse(is.na(FIB4_2015)== "TRUE", FIB4_by2014, 0))
HCVData1 <-  HCVData1 %>% mutate(FIB4_by2016 = FIB4_2016, YearsSinceFib4_2016 = 0)
HCVData1 <-  HCVData1 %>% mutate(FIB4_by2016 = ifelse(is.na(FIB4_2016)== "TRUE", FIB4_by2015, FIB4_by2016),
                               YearsSinceFib4_2016 = ifelse(is.na(FIB4_2016)== "TRUE", YearsSinceFib4_2015 + 1, 0),
                               ImputedFIB4_2016 = ifelse(is.na(FIB4_2016)== "TRUE", ImputedFIB4_2015, 0))
HCVData1 <-  HCVData1 %>% mutate(FIB4_by2017 = FIB4_2017, YearsSinceFib4_2017 = 0)
HCVData1 <-  HCVData1 %>% mutate(FIB4_by2017 = ifelse(is.na(FIB4_2017)== "TRUE", FIB4_by2016, FIB4_by2017),
                               YearsSinceFib4_2017 = ifelse(is.na(FIB4_2017)== "TRUE", YearsSinceFib4_2016 + 1, 0),
                               ImputedFIB4_2017 = ifelse(is.na(FIB4_2017)== "TRUE", ImputedFIB4_2016, 0))
HCVData1 <-  HCVData1 %>% mutate(FIB4_by2018 = FIB4_2018, YearsSinceFib4_2018 = 0)
HCVData1 <-  HCVData1 %>% mutate(FIB4_by2018 = ifelse(is.na(FIB4_2018)== "TRUE", FIB4_by2017, FIB4_by2018),
                               YearsSinceFib4_2018 = ifelse(is.na(FIB4_2018)== "TRUE", YearsSinceFib4_2017 + 1, 0),
                               ImputedFIB4_2018 = ifelse(is.na(FIB4_2018)== "TRUE", ImputedFIB4_2017, 0))
HCVData1 <-  HCVData1 %>% mutate(FIB4_by2019 = FIB4_2019, YearsSinceFib4_2019 = 0)
HCVData1 <-  HCVData1 %>% mutate(FIB4_by2019 = ifelse(is.na(FIB4_2019)== "TRUE", FIB4_by2018, FIB4_by2019),
                               YearsSinceFib4_2019 = ifelse(is.na(FIB4_2019)== "TRUE", YearsSinceFib4_2018 + 1, 0),
                               ImputedFIB4_2019 = ifelse(is.na(FIB4_2019)== "TRUE", ImputedFIB4_2018, 0))

HCVData2 <-  HCVData2 %>% mutate(FIB4_by2015 = FIB4_2015, YearsSinceFib4_2015 = 0)
HCVData2 <-  HCVData2 %>% mutate(FIB4_by2015 = ifelse(is.na(FIB4_2015)== "TRUE", FIB4_by2014, FIB4_by2015),
                               YearsSinceFib4_2015 = ifelse(is.na(FIB4_2015)== "TRUE", YearsSinceFib4_2014 + 1, 0),
                               ImputedFIB4_2015 = ifelse(is.na(FIB4_2015)== "TRUE", FIB4_by2014, 0))
HCVData2 <-  HCVData2 %>% mutate(FIB4_by2016 = FIB4_2016, YearsSinceFib4_2016 = 0)
HCVData2 <-  HCVData2 %>% mutate(FIB4_by2016 = ifelse(is.na(FIB4_2016)== "TRUE", FIB4_by2015, FIB4_by2016),
                               YearsSinceFib4_2016 = ifelse(is.na(FIB4_2016)== "TRUE", YearsSinceFib4_2015 + 1, 0),
                               ImputedFIB4_2016 = ifelse(is.na(FIB4_2016)== "TRUE", ImputedFIB4_2015, 0))
HCVData2 <-  HCVData2 %>% mutate(FIB4_by2017 = FIB4_2017, YearsSinceFib4_2017 = 0)
HCVData2 <-  HCVData2 %>% mutate(FIB4_by2017 = ifelse(is.na(FIB4_2017)== "TRUE", FIB4_by2016, FIB4_by2017),
                               YearsSinceFib4_2017 = ifelse(is.na(FIB4_2017)== "TRUE", YearsSinceFib4_2016 + 1, 0),
                               ImputedFIB4_2017 = ifelse(is.na(FIB4_2017)== "TRUE", ImputedFIB4_2016, 0))
HCVData2 <-  HCVData2 %>% mutate(FIB4_by2018 = FIB4_2018, YearsSinceFib4_2018 = 0)
HCVData2 <-  HCVData2 %>% mutate(FIB4_by2018 = ifelse(is.na(FIB4_2018)== "TRUE", FIB4_by2017, FIB4_by2018),
                               YearsSinceFib4_2018 = ifelse(is.na(FIB4_2018)== "TRUE", YearsSinceFib4_2017 + 1, 0),
                               ImputedFIB4_2018 = ifelse(is.na(FIB4_2018)== "TRUE", ImputedFIB4_2017, 0))
HCVData2 <-  HCVData2 %>% mutate(FIB4_by2019 = FIB4_2019, YearsSinceFib4_2019 = 0)
HCVData2 <-  HCVData2 %>% mutate(FIB4_by2019 = ifelse(is.na(FIB4_2019)== "TRUE", FIB4_by2018, FIB4_by2019),
                               YearsSinceFib4_2019 = ifelse(is.na(FIB4_2019)== "TRUE", YearsSinceFib4_2018 + 1, 0),
                               ImputedFIB4_2019 = ifelse(is.na(FIB4_2019)== "TRUE", ImputedFIB4_2018, 0))

HCVData3 <-  HCVData3 %>% mutate(FIB4_by2015 = FIB4_2015, YearsSinceFib4_2015 = 0)
HCVData3 <-  HCVData3 %>% mutate(FIB4_by2015 = ifelse(is.na(FIB4_2015)== "TRUE", FIB4_by2014, FIB4_by2015),
                               YearsSinceFib4_2015 = ifelse(is.na(FIB4_2015)== "TRUE", YearsSinceFib4_2014 + 1, 0),
                               ImputedFIB4_2015 = ifelse(is.na(FIB4_2015)== "TRUE", FIB4_by2014, 0))
HCVData3 <-  HCVData3 %>% mutate(FIB4_by2016 = FIB4_2016, YearsSinceFib4_2016 = 0)
HCVData3 <-  HCVData3 %>% mutate(FIB4_by2016 = ifelse(is.na(FIB4_2016)== "TRUE", FIB4_by2015, FIB4_by2016),
                               YearsSinceFib4_2016 = ifelse(is.na(FIB4_2016)== "TRUE", YearsSinceFib4_2015 + 1, 0),
                               ImputedFIB4_2016 = ifelse(is.na(FIB4_2016)== "TRUE", ImputedFIB4_2015, 0))
HCVData3 <-  HCVData3 %>% mutate(FIB4_by2017 = FIB4_2017, YearsSinceFib4_2017 = 0)
HCVData3 <-  HCVData3 %>% mutate(FIB4_by2017 = ifelse(is.na(FIB4_2017)== "TRUE", FIB4_by2016, FIB4_by2017),
                               YearsSinceFib4_2017 = ifelse(is.na(FIB4_2017)== "TRUE", YearsSinceFib4_2016 + 1, 0),
                               ImputedFIB4_2017 = ifelse(is.na(FIB4_2017)== "TRUE", ImputedFIB4_2016, 0))
HCVData3 <-  HCVData3 %>% mutate(FIB4_by2018 = FIB4_2018, YearsSinceFib4_2018 = 0)
HCVData3 <-  HCVData3 %>% mutate(FIB4_by2018 = ifelse(is.na(FIB4_2018)== "TRUE", FIB4_by2017, FIB4_by2018),
                               YearsSinceFib4_2018 = ifelse(is.na(FIB4_2018)== "TRUE", YearsSinceFib4_2017 + 1, 0),
                               ImputedFIB4_2018 = ifelse(is.na(FIB4_2018)== "TRUE", ImputedFIB4_2017, 0))
HCVData3 <-  HCVData3 %>% mutate(FIB4_by2019 = FIB4_2019, YearsSinceFib4_2019 = 0)
HCVData3 <-  HCVData3 %>% mutate(FIB4_by2019 = ifelse(is.na(FIB4_2019)== "TRUE", FIB4_by2018, FIB4_by2019),
                               YearsSinceFib4_2019 = ifelse(is.na(FIB4_2019)== "TRUE", YearsSinceFib4_2018 + 1, 0),
                               ImputedFIB4_2019 = ifelse(is.na(FIB4_2019)== "TRUE", ImputedFIB4_2018, 0))

HCVData4 <-  HCVData4 %>% mutate(FIB4_by2015 = FIB4_2015, YearsSinceFib4_2015 = 0)
HCVData4 <-  HCVData4 %>% mutate(FIB4_by2015 = ifelse(is.na(FIB4_2015)== "TRUE", FIB4_by2014, FIB4_by2015),
                               YearsSinceFib4_2015 = ifelse(is.na(FIB4_2015)== "TRUE", YearsSinceFib4_2014 + 1, 0),
                               ImputedFIB4_2015 = ifelse(is.na(FIB4_2015)== "TRUE", FIB4_by2014, 0))
HCVData4 <-  HCVData4 %>% mutate(FIB4_by2016 = FIB4_2016, YearsSinceFib4_2016 = 0)
HCVData4 <-  HCVData4 %>% mutate(FIB4_by2016 = ifelse(is.na(FIB4_2016)== "TRUE", FIB4_by2015, FIB4_by2016),
                               YearsSinceFib4_2016 = ifelse(is.na(FIB4_2016)== "TRUE", YearsSinceFib4_2015 + 1, 0),
                               ImputedFIB4_2016 = ifelse(is.na(FIB4_2016)== "TRUE", ImputedFIB4_2015, 0))
HCVData4 <-  HCVData4 %>% mutate(FIB4_by2017 = FIB4_2017, YearsSinceFib4_2017 = 0)
HCVData4 <-  HCVData4 %>% mutate(FIB4_by2017 = ifelse(is.na(FIB4_2017)== "TRUE", FIB4_by2016, FIB4_by2017),
                               YearsSinceFib4_2017 = ifelse(is.na(FIB4_2017)== "TRUE", YearsSinceFib4_2016 + 1, 0),
                               ImputedFIB4_2017 = ifelse(is.na(FIB4_2017)== "TRUE", ImputedFIB4_2016, 0))
HCVData4 <-  HCVData4 %>% mutate(FIB4_by2018 = FIB4_2018, YearsSinceFib4_2018 = 0)
HCVData4 <-  HCVData4 %>% mutate(FIB4_by2018 = ifelse(is.na(FIB4_2018)== "TRUE", FIB4_by2017, FIB4_by2018),
                               YearsSinceFib4_2018 = ifelse(is.na(FIB4_2018)== "TRUE", YearsSinceFib4_2017 + 1, 0),
                               ImputedFIB4_2018 = ifelse(is.na(FIB4_2018)== "TRUE", ImputedFIB4_2017, 0))
HCVData4 <-  HCVData4 %>% mutate(FIB4_by2019 = FIB4_2019, YearsSinceFib4_2019 = 0)
HCVData4 <-  HCVData4 %>% mutate(FIB4_by2019 = ifelse(is.na(FIB4_2019)== "TRUE", FIB4_by2018, FIB4_by2019),
                               YearsSinceFib4_2019 = ifelse(is.na(FIB4_2019)== "TRUE", YearsSinceFib4_2018 + 1, 0),
                               ImputedFIB4_2019 = ifelse(is.na(FIB4_2019)== "TRUE", ImputedFIB4_2018, 0))

HCVData5 <-  HCVData5 %>% mutate(FIB4_by2015 = FIB4_2015, YearsSinceFib4_2015 = 0)
HCVData5 <-  HCVData5 %>% mutate(FIB4_by2015 = ifelse(is.na(FIB4_2015)== "TRUE", FIB4_by2014, FIB4_by2015),
                               YearsSinceFib4_2015 = ifelse(is.na(FIB4_2015)== "TRUE", YearsSinceFib4_2014 + 1, 0),
                               ImputedFIB4_2015 = ifelse(is.na(FIB4_2015)== "TRUE", FIB4_by2014, 0))
HCVData5 <-  HCVData5 %>% mutate(FIB4_by2016 = FIB4_2016, YearsSinceFib4_2016 = 0)
HCVData5 <-  HCVData5 %>% mutate(FIB4_by2016 = ifelse(is.na(FIB4_2016)== "TRUE", FIB4_by2015, FIB4_by2016),
                               YearsSinceFib4_2016 = ifelse(is.na(FIB4_2016)== "TRUE", YearsSinceFib4_2015 + 1, 0),
                               ImputedFIB4_2016 = ifelse(is.na(FIB4_2016)== "TRUE", ImputedFIB4_2015, 0))
HCVData5 <-  HCVData5 %>% mutate(FIB4_by2017 = FIB4_2017, YearsSinceFib4_2017 = 0)
HCVData5 <-  HCVData5 %>% mutate(FIB4_by2017 = ifelse(is.na(FIB4_2017)== "TRUE", FIB4_by2016, FIB4_by2017),
                               YearsSinceFib4_2017 = ifelse(is.na(FIB4_2017)== "TRUE", YearsSinceFib4_2016 + 1, 0),
                               ImputedFIB4_2017 = ifelse(is.na(FIB4_2017)== "TRUE", ImputedFIB4_2016, 0))
HCVData5 <-  HCVData5 %>% mutate(FIB4_by2018 = FIB4_2018, YearsSinceFib4_2018 = 0)
HCVData5 <-  HCVData5 %>% mutate(FIB4_by2018 = ifelse(is.na(FIB4_2018)== "TRUE", FIB4_by2017, FIB4_by2018),
                               YearsSinceFib4_2018 = ifelse(is.na(FIB4_2018)== "TRUE", YearsSinceFib4_2017 + 1, 0),
                               ImputedFIB4_2018 = ifelse(is.na(FIB4_2018)== "TRUE", ImputedFIB4_2017, 0))
HCVData5 <-  HCVData5 %>% mutate(FIB4_by2019 = FIB4_2019, YearsSinceFib4_2019 = 0)
HCVData5 <-  HCVData5 %>% mutate(FIB4_by2019 = ifelse(is.na(FIB4_2019)== "TRUE", FIB4_by2018, FIB4_by2019),
                               YearsSinceFib4_2019 = ifelse(is.na(FIB4_2019)== "TRUE", YearsSinceFib4_2018 + 1, 0),
                               ImputedFIB4_2019 = ifelse(is.na(FIB4_2019)== "TRUE", ImputedFIB4_2018, 0))
```

<!--armadillo-->
# 1. Background 
## A. Brief Introduction
Hepatocellular carcinoma (HCC), a type of liver cancer, is the second most common cause of liver-related death throughout the world (Bosetti et al 2014). HCC is a major complication of infection with hepatitis C (HCV) virus, occuring in 1%-4% of people with liver cirrhosis each year (Omland et al 2010). HCV becomes chronic infection for about 80% of adults, and if left untreated can cause increasing cirrhosis over a period of 20-30 years of often asymptomatic disease, until damage is severe and major complications are irreversable (El-Serag 2012). Certain HCV viral genotypes (particularly genotype 3) are associated with higher risk of HCC, as is continued smoking (Chuang et al 2010) and alcohol use (Donato et al 2002), as well as concurrent diabetes or obesity (Huang et al 2017, Calle et al 2003). 

Since 2014, direct-acting antiviral (DAA) therapy has dramatically improved prognosis for people living with HCV; 8-12 weeks of well-tolerated oral therapy leads to cure in more than 90% of patients (Burstow et al 2017), halting cirrhosis progression and apparently reducing the elevated risk of HCC (Axley et al 2017). Patients whose HCV has already caused some cirrhosis continue to be at some increased risk of HCC even post-cure, and given the high mortality risk it is recommended that people with HCV infection receive systematic monitoring with liver ultrasound (EASL 2015). However, despite having evidence of visits with a primary care physician or hepatologist, some UCSF patients chronically infected with HCV do not have evidence of abdominal imaging at least once per year. In this study we aimed to estimate the longitudinal association of abdominal imaging on HCC risk using causal inference methods. We hypothesized that patients with no cirrhosis at baseline would be less likely to develop HCC within 5 years when they had evidence of abdominal imaging at least once per year for 5 years, compared to patients who did not have annual abdominal imaging.

## B. Description of our Dataset

We are using a dataset of chronic hepatitis C patients receiving care in the UCSF system since 2009. There are `r nrow(HCVData)` patients, who were adults seen in the UCSF system by the end of 2015 and have been seen in a variety of primary care clinics and the hepatology (liver) clinic between 2015 and 2019. These data come from a query of Apex, the UCSF-specific build of the electronic medical record system Epic.

We restricted our dataset to adult UCSF patients diagnosed with HCV who, prior to the start of follow up (ie. as of 12/31/14) were not known to have indications of cirrhosis or HCC. (n = `r nrow(HCVData1)`) For those who had been in the system prior to 2015, historical data back to 2011 was used to calculate their FIB-4 score at the beinning of follow up (ie. by the end of 2014). For those who did not yet have those data, the FIB-4 score in 2014 was imputed using multiple imputation (m=5). 

<!-- reminder that if someone had no data through 2014, and first showed up in 2015, they're still in this dataset even if they had, say, cirrhosis diagnosed elsewhere prior to 2015. So we should be careful to describe the dataset as those in the system, 'not known to have cirrhosis' prior to 1/1/2015 or sth similar-->

```{r demographics, include = FALSE, eval = TRUE}
#note that the demographics in this table are based on imputation dataset 1, for simplicity
sex <- table(HCVData1$Sex, useNA = "ifany")
race <- table(HCVData1$race.ethnicity, useNA  = "ifany")
SES <- table(HCVData1$PayorType, useNA = "ifany")
n <- nrow(HCVData1)
male <- sex[2]
malep <- male/n*100
female <- sex[1]
femalep <- female/n*100
white <- race[4]
whitep <- white/n*100
black <- race[1]
blackp <- black/n*100
latinx <- race[2]
latinxp <- latinx/n*100
other <- race[3]
otherp <- other/n*100
unkrace <- race[5]
unkracep <- unkrace/n*100
medical <- SES[1]
medicalp <- medical/n*100
notmedical <- SES[2]
notmedicalp <- notmedical/n*100

```

## C. Our Observed Data

**Number of Visits (annually)**

The number of visits per patient ranges from 0 to 44 in any given year, with a median of 1 visit per year overall. The figure below presents number of visits per patient in each year, truncated at 25 visits.

```{r HCC, include=FALSE}
HCVData1$HCC <- ifelse(is.na(HCVData1$Cancer.Diagnosis.Name), 0, 1)
HCCpercent <- mean(HCVData1$HCC)*100
```

`r sum(HCVData1$HCC)` people (`r round(HCCpercent, 1)`%) developed the outcome of interest (were diagnosed with HCC during the course of the study). The figure below shows the number of people diagnosed with HCC in each year, and cumulatively, throughout the study period (\textbf{note} that 2019 is an incomplete year of data.)


```{r HCCplots, include = TRUE, echo = FALSE, warning = FALSE, message = FALSE, fig.width=11, fig.height=6.5}

HCCyearly <- HCVData1 %>% dplyr::select(HCC_2016only, HCC_2017only, HCC_2018only, HCC_2019only)
colnames(HCCyearly) <- c("2016", "2017", "2018", "2019")
HCCYearlyLong <- HCCyearly %>% gather
plotHCCann <- ggplot(HCCYearlyLong, aes(x=key, y=value)) + geom_col(fill = "darkgreen") + scale_y_continuous(breaks = seq(0,100,10)) + xlab("Year") + ylab("Number of Patients") + ggtitle("New HCC diagnoses, by year") + theme(legend.position = "none") + theme_minimal() + theme(plot.title = element_text(size = 14, hjust = 0.5))

HCCtotal <- HCVData1 %>% dplyr::select(HCC_2016, HCC_2017, HCC_2018, HCC_2019)
colnames(HCCtotal) <- c("2016", "2017", "2018", "2019")
HCCLong <- HCCtotal %>% gather
plotHCCcum <- ggplot(HCCLong, aes(x=key, y=value)) + geom_col(fill = "darkgreen") + scale_y_continuous(breaks = seq(0,500,50)) + xlab("Year") + ylab("Number of Patients") + ggtitle("Cumulative HCC cases, by year") + theme(legend.position = "none") + theme_minimal() + theme(plot.title = element_text(size = 14, hjust = 0.5))

HCCplots <- ggarrange(plotHCCann, plotHCCcum, ncol = 2, nrow = 1)
suppressWarnings(print(HCCplots))
```

**FIB-4 Score (annually)**

```{r FIBLongitems, include = FALSE, eval = TRUE}
FIBscores <- HCVData1 %>% dplyr::select(FIB4_2011, FIB4_2012, FIB4_2013, FIB4_2014, FIB4_2015, FIB4_2016, FIB4_2017, FIB4_2018)
FIBLong <- FIBscores %>% gather
cirrhosis <- nrow(subset(FIBLong, value>3.25))
outliers <- nrow(subset(FIBLong, value>9))
minFib <- round(range(FIBLong$value, na.rm = TRUE)[1],3)
maxFib <- round(range(FIBLong$value, na.rm = TRUE)[2],2)
FibIQR <- round(IQR(FIBLong$value, na.rm = TRUE),4)
Fib25 <- round(quantile(FIBLong$value, na.rm = TRUE)[2],4)
Fib75 <- round(quantile(FIBLong$value, na.rm = TRUE)[4],4)
```

FIB-4 scores are calculated with inputs of age, platelet count, AST, and ALT. Scores of <1.45 are considered to be strongly suggestive of no liver fibrosis, and scores >3.25 are indicative of advanced fibrosis and/or cirrhosis. 

FIB-4 scores in this dataset range of `r minFib` to `r maxFib`, with an IQR of `r FibIQR` (`r Fib25`-`r Fib75`), indicating the FIB-4 score of 45 is a substantial outlier. `r cirrhosis` FIB-4 scores are >3.25 throughout all years of follow-up on all patients, indicating likely cirrhosis and increased risk of HCC at those timepoints.  There are `r outliers` instances where a patient's FIB-4 score was calculated to be greater than 9.
  
\vspace{12pt}

**Other demographics**

\vspace{-6pt}

* \textbf{Sex}. This is a dichotomous variable, with two categories (male, female), as UCSF has not been capturing other gender categories within Epic.

* \textbf{Race}. This is a categorical variable, which recategorized into White, Black/African American, Latinx, and Other for ease of analysis given the bias introduced into causal analyses by practical positivity violations.

* \textbf{SES}. We used insurance type (Medi-Cal, or not Medi-Cal) as a marker of SES status, which is again a dichotomous variable.

The table below displays the demographic breakdown of the sample.

| Demographic | Category | n | % |
| ----------------- | ----------------- | -------- | --------|
| Sex | Male | `r male` | `r round(malep, 1)`% |
|        | Female | `r female` | `r round(femalep, 1)`% |
|  | 
|        | Black/African American | `r black` | `r round(blackp, 1)`% |
|        | Latinx | `r latinx` | `r round(latinxp, 1)`% |
| Race/ethnicity | White | `r white` | `r round(whitep, 1)`% |
|        | Other | `r other` | `r round(otherp, 1)`% |
|        | Unknown | `r unkrace` | `r round(unkracep, 1)`% |  
|  | 
|   SES (Payor type)   | Medi-Cal | `r medical` | `r round(medicalp, 1)`% |
|  | Not Medi-Cal | `r notmedical` | `r round(notmedicalp, 1)`% |
|  | 
| TOTAL | | `r n` | 100% |

<!--armadillo-->
## D. Structural Model

We defined our **exposure** as the total number of abdominal imaging results reported within the UCSF system for each chronic HCV patient, annually from 2015 through 2018. We then dichotomized this variable (0 images, or 1+ images) due to the current computational limitations of longitudinal targeted machine learning estimation (LTMLE). 

We defined our **outcome** as diagnosis of HCC, by the final year (2019). 

We included 6 **covariates** in our model: race, sex, and SES as defined above, as well as:

\vspace{-8pt}

* Total number of primary care or hepatology visits in the UCSF system, annually from 2015 - 2019.

* FIB-4 score (a validated measure used for prediction of cirrhosis (Khan et al 2017), which uses age, platelet count and liver transaminases), 

This is a survival analysis

```{r Regression setup}
HCVData1$Visits2014 <- ifelse(HCVData1$VISIT_COUNT_2014>0, 1, 0)
HCVData1$Visits2015 <- ifelse(HCVData1$VISIT_COUNT_2015>0, 1, 0)
HCVData1$Visits2016 <- ifelse(HCVData1$VISIT_COUNT_2016>0, 1, 0)
HCVData1$Visits2017 <- ifelse(HCVData1$VISIT_COUNT_2017>0, 1, 0)
HCVData1$Visits2018 <- ifelse(HCVData1$VISIT_COUNT_2018>0, 1, 0)
HCVData1$YearsofVisits <- HCVData1$Visits2014 + HCVData1$Visits2015 + HCVData1$Visits2016 + HCVData1$Visits2017 + HCVData1$Visits2018

HCVData1$ABD_IMAGING_2014 <- ifelse(is.na(HCVData1$ABD_IMAGING_2014), 0, HCVData1$ABD_IMAGING_2014)
HCVData1$ABD_IMAGING_2015 <- ifelse(is.na(HCVData1$ABD_IMAGING_2015), 0, HCVData1$ABD_IMAGING_2015)
HCVData1$ABD_IMAGING_2016 <- ifelse(is.na(HCVData1$ABD_IMAGING_2016), 0, HCVData1$ABD_IMAGING_2016)
HCVData1$ABD_IMAGING_2017 <- ifelse(is.na(HCVData1$ABD_IMAGING_2017), 0, HCVData1$ABD_IMAGING_2017)
HCVData1$ABD_IMAGING_2018 <- ifelse(is.na(HCVData1$ABD_IMAGING_2018), 0, HCVData1$ABD_IMAGING_2018)

HCVData1$VwI2014 <- ifelse(HCVData1$VISIT_COUNT_2014>0 & HCVData1$ABD_IMAGING_2014>0, 1, 0)
HCVData1$VwI2015 <- ifelse(HCVData1$VISIT_COUNT_2015>0 & HCVData1$ABD_IMAGING_2015>0, 1, 0)
HCVData1$VwI2016 <- ifelse(HCVData1$VISIT_COUNT_2016>0 & HCVData1$ABD_IMAGING_2016>0, 1, 0)
HCVData1$VwI2017 <- ifelse(HCVData1$VISIT_COUNT_2017>0 & HCVData1$ABD_IMAGING_2017>0, 1, 0)
HCVData1$VwI2018 <- ifelse(HCVData1$VISIT_COUNT_2018>0 & HCVData1$ABD_IMAGING_2018>0, 1, 0)
HCVData1$YearsofVwI <- HCVData1$VwI2014 + HCVData1$VwI2015 + HCVData1$VwI2016 + HCVData1$VwI2017 + HCVData1$VwI2018

HCVData1$VwI2_2014 <- ifelse(HCVData1$VISIT_COUNT_2014>1 & HCVData1$ABD_IMAGING_2014>1, 1, 0)
HCVData1$VwI2_2015 <- ifelse(HCVData1$VISIT_COUNT_2015>1 & HCVData1$ABD_IMAGING_2015>1, 1, 0)
HCVData1$VwI2_2016 <- ifelse(HCVData1$VISIT_COUNT_2016>1 & HCVData1$ABD_IMAGING_2016>1, 1, 0)
HCVData1$VwI2_2017 <- ifelse(HCVData1$VISIT_COUNT_2017>1 & HCVData1$ABD_IMAGING_2017>1, 1, 0)
HCVData1$VwI2_2018 <- ifelse(HCVData1$VISIT_COUNT_2018>1 & HCVData1$ABD_IMAGING_2018>1, 1, 0)
HCVData1$Yearsof2VwI <- HCVData1$VwI2_2014 + HCVData1$VwI2_2015 + HCVData1$VwI2_2016 + HCVData1$VwI2_2017 + HCVData1$VwI2_2018

HCVData1$TotalVisits5years <- HCVData1$VISIT_COUNT_2014 + HCVData1$VISIT_COUNT_2015 + HCVData1$VISIT_COUNT_2016 + HCVData1$VISIT_COUNT_2017 + HCVData1$VISIT_COUNT_2018

HCVData1$Imaging2014 <- ifelse(HCVData1$ABD_IMAGING_2014>0, 1, 0)
HCVData1$Imaging2015 <- ifelse(HCVData1$ABD_IMAGING_2015>0, 1, 0) 
HCVData1$Imaging2016 <- ifelse(HCVData1$ABD_IMAGING_2016>0, 1, 0)
HCVData1$Imaging2017 <- ifelse(HCVData1$ABD_IMAGING_2017>0, 1, 0)
HCVData1$Imaging2018 <- ifelse(HCVData1$ABD_IMAGING_2018>0, 1, 0)
HCVData1$YearsofImaging <- HCVData1$Imaging2014 + HCVData1$Imaging2015 + HCVData1$Imaging2016 + HCVData1$Imaging2017 + HCVData1$Imaging2018
HCVData1$Imaged <- ifelse(HCVData1$YearsofImaging > HCVData1$YearsofVisits-2, 1, 0)

HCVData1$race.ethnicity <- relevel(HCVData1$race.ethnicity, "W")

fit.glm1_base <- glm(HCC_2019 ~ Yearsof2VwI + TotalVisits5years + race.ethnicity + Sex + PayorType, family = binomial(log), HCVData1)
fit.glm1 <- glm(HCC_2019 ~ Yearsof2VwI + TotalVisits5years + FIB4_by2019 + race.ethnicity + Sex + PayorType, family = binomial(log), data = HCVData1, start=c(fit.glm1_base$coefficients[1:3],0,fit.glm1_base$coefficients[4:8]))

# fit.glm1a_base <- glm(HCC_2019 ~ YearsofVwI + TotalVisits5years + race.ethnicity + Sex + PayorType, family = binomial(log), HCVData1)
# fit.glm1a <- glm(HCC_2019 ~ YearsofVwI + TotalVisits5years + FIB4_by2019 + race.ethnicity + Sex + PayorType, family = binomial(log), data = HCVData1, start=c(fit.glm1a_base$coefficients[1:3],0,fit.glm1a_base$coefficients[4:8]))
# 
# fit.glm1b_base <- glm(HCC_2019 ~ YearsofVisits + Imaged + TotalVisits5years + race.ethnicity + Sex + PayorType, family = binomial(log), data = HCVData1, trace = TRUE, maxit = 100)
# fit.glm1b <- glm(HCC_2019 ~ YearsofVisits + Imaged + TotalVisits5years + FIB4_by2019 + race.ethnicity + Sex + PayorType, family = binomial(log), data = HCVData1, start=c(fit.glm1b_base$coefficients[1:4],0,fit.glm1b_base$coefficients[5:9]))


HCVData2$Visits2014 <- ifelse(HCVData2$VISIT_COUNT_2014>0, 1, 0)
HCVData2$Visits2015 <- ifelse(HCVData2$VISIT_COUNT_2015>0, 1, 0)
HCVData2$Visits2016 <- ifelse(HCVData2$VISIT_COUNT_2016>0, 1, 0)
HCVData2$Visits2017 <- ifelse(HCVData2$VISIT_COUNT_2017>0, 1, 0)
HCVData2$Visits2018 <- ifelse(HCVData2$VISIT_COUNT_2018>0, 1, 0)
HCVData2$YearsofVisits <- HCVData2$Visits2014 + HCVData2$Visits2015 + HCVData2$Visits2016 + HCVData2$Visits2017 + HCVData2$Visits2018

HCVData2$ABD_IMAGING_2014 <- ifelse(is.na(HCVData2$ABD_IMAGING_2014), 0, HCVData2$ABD_IMAGING_2014)
HCVData2$ABD_IMAGING_2015 <- ifelse(is.na(HCVData2$ABD_IMAGING_2015), 0, HCVData2$ABD_IMAGING_2015)
HCVData2$ABD_IMAGING_2016 <- ifelse(is.na(HCVData2$ABD_IMAGING_2016), 0, HCVData2$ABD_IMAGING_2016)
HCVData2$ABD_IMAGING_2017 <- ifelse(is.na(HCVData2$ABD_IMAGING_2017), 0, HCVData2$ABD_IMAGING_2017)
HCVData2$ABD_IMAGING_2018 <- ifelse(is.na(HCVData2$ABD_IMAGING_2018), 0, HCVData2$ABD_IMAGING_2018)

HCVData2$VwI2014 <- ifelse(HCVData2$VISIT_COUNT_2014>0 & HCVData2$ABD_IMAGING_2014>0, 1, 0)
HCVData2$VwI2015 <- ifelse(HCVData2$VISIT_COUNT_2015>0 & HCVData2$ABD_IMAGING_2015>0, 1, 0)
HCVData2$VwI2016 <- ifelse(HCVData2$VISIT_COUNT_2016>0 & HCVData2$ABD_IMAGING_2016>0, 1, 0)
HCVData2$VwI2017 <- ifelse(HCVData2$VISIT_COUNT_2017>0 & HCVData2$ABD_IMAGING_2017>0, 1, 0)
HCVData2$VwI2018 <- ifelse(HCVData2$VISIT_COUNT_2018>0 & HCVData2$ABD_IMAGING_2018>0, 1, 0)
HCVData2$YearsofVwI <- HCVData2$VwI2014 + HCVData2$VwI2015 + HCVData2$VwI2016 + HCVData2$VwI2017 + HCVData2$VwI2018

HCVData2$VwI2_2014 <- ifelse(HCVData2$VISIT_COUNT_2014>1 & HCVData2$ABD_IMAGING_2014>1, 1, 0)
HCVData2$VwI2_2015 <- ifelse(HCVData2$VISIT_COUNT_2015>1 & HCVData2$ABD_IMAGING_2015>1, 1, 0)
HCVData2$VwI2_2016 <- ifelse(HCVData2$VISIT_COUNT_2016>1 & HCVData2$ABD_IMAGING_2016>1, 1, 0)
HCVData2$VwI2_2017 <- ifelse(HCVData2$VISIT_COUNT_2017>1 & HCVData2$ABD_IMAGING_2017>1, 1, 0)
HCVData2$VwI2_2018 <- ifelse(HCVData2$VISIT_COUNT_2018>1 & HCVData2$ABD_IMAGING_2018>1, 1, 0)
HCVData2$Yearsof2VwI <- HCVData2$VwI2_2014 + HCVData2$VwI2_2015 + HCVData2$VwI2_2016 + HCVData2$VwI2_2017 + HCVData2$VwI2_2018

HCVData2$TotalVisits5years <- HCVData2$VISIT_COUNT_2014 + HCVData2$VISIT_COUNT_2015 + HCVData2$VISIT_COUNT_2016 + HCVData2$VISIT_COUNT_2017 + HCVData2$VISIT_COUNT_2018

HCVData2$Imaging2014 <- ifelse(HCVData2$ABD_IMAGING_2014>0, 1, 0)
HCVData2$Imaging2015 <- ifelse(HCVData2$ABD_IMAGING_2015>0, 1, 0) 
HCVData2$Imaging2016 <- ifelse(HCVData2$ABD_IMAGING_2016>0, 1, 0)
HCVData2$Imaging2017 <- ifelse(HCVData2$ABD_IMAGING_2017>0, 1, 0)
HCVData2$Imaging2018 <- ifelse(HCVData2$ABD_IMAGING_2018>0, 1, 0)
HCVData2$YearsofImaging <- HCVData2$Imaging2014 + HCVData2$Imaging2015 + HCVData2$Imaging2016 + HCVData2$Imaging2017 + HCVData2$Imaging2018
HCVData2$Imaged <- ifelse(HCVData2$YearsofImaging > HCVData2$YearsofVisits-2, 1, 0)

HCVData2$race.ethnicity <- relevel(HCVData2$race.ethnicity, "W")

fit.glm2_base <- glm(HCC_2019 ~ Yearsof2VwI + TotalVisits5years + race.ethnicity + Sex + PayorType, family = binomial(log), HCVData2)
fit.glm2 <- glm(HCC_2019 ~ Yearsof2VwI + TotalVisits5years + FIB4_by2019 + race.ethnicity + Sex + PayorType, family = binomial(log), data = HCVData2, start=c(fit.glm2_base$coefficients[1:3],0,fit.glm2_base$coefficients[4:8]))


HCVData3$Visits2014 <- ifelse(HCVData3$VISIT_COUNT_2014>0, 1, 0)
HCVData3$Visits2015 <- ifelse(HCVData3$VISIT_COUNT_2015>0, 1, 0)
HCVData3$Visits2016 <- ifelse(HCVData3$VISIT_COUNT_2016>0, 1, 0)
HCVData3$Visits2017 <- ifelse(HCVData3$VISIT_COUNT_2017>0, 1, 0)
HCVData3$Visits2018 <- ifelse(HCVData3$VISIT_COUNT_2018>0, 1, 0)
HCVData3$YearsofVisits <- HCVData3$Visits2014 + HCVData3$Visits2015 + HCVData3$Visits2016 + HCVData3$Visits2017 + HCVData3$Visits2018

HCVData3$ABD_IMAGING_2014 <- ifelse(is.na(HCVData3$ABD_IMAGING_2014), 0, HCVData3$ABD_IMAGING_2014)
HCVData3$ABD_IMAGING_2015 <- ifelse(is.na(HCVData3$ABD_IMAGING_2015), 0, HCVData3$ABD_IMAGING_2015)
HCVData3$ABD_IMAGING_2016 <- ifelse(is.na(HCVData3$ABD_IMAGING_2016), 0, HCVData3$ABD_IMAGING_2016)
HCVData3$ABD_IMAGING_2017 <- ifelse(is.na(HCVData3$ABD_IMAGING_2017), 0, HCVData3$ABD_IMAGING_2017)
HCVData3$ABD_IMAGING_2018 <- ifelse(is.na(HCVData3$ABD_IMAGING_2018), 0, HCVData3$ABD_IMAGING_2018)

HCVData3$VwI2014 <- ifelse(HCVData3$VISIT_COUNT_2014>0 & HCVData3$ABD_IMAGING_2014>0, 1, 0)
HCVData3$VwI2015 <- ifelse(HCVData3$VISIT_COUNT_2015>0 & HCVData3$ABD_IMAGING_2015>0, 1, 0)
HCVData3$VwI2016 <- ifelse(HCVData3$VISIT_COUNT_2016>0 & HCVData3$ABD_IMAGING_2016>0, 1, 0)
HCVData3$VwI2017 <- ifelse(HCVData3$VISIT_COUNT_2017>0 & HCVData3$ABD_IMAGING_2017>0, 1, 0)
HCVData3$VwI2018 <- ifelse(HCVData3$VISIT_COUNT_2018>0 & HCVData3$ABD_IMAGING_2018>0, 1, 0)
HCVData3$YearsofVwI <- HCVData3$VwI2014 + HCVData3$VwI2015 + HCVData3$VwI2016 + HCVData3$VwI2017 + HCVData3$VwI2018

HCVData3$VwI2_2014 <- ifelse(HCVData3$VISIT_COUNT_2014>1 & HCVData3$ABD_IMAGING_2014>1, 1, 0)
HCVData3$VwI2_2015 <- ifelse(HCVData3$VISIT_COUNT_2015>1 & HCVData3$ABD_IMAGING_2015>1, 1, 0)
HCVData3$VwI2_2016 <- ifelse(HCVData3$VISIT_COUNT_2016>1 & HCVData3$ABD_IMAGING_2016>1, 1, 0)
HCVData3$VwI2_2017 <- ifelse(HCVData3$VISIT_COUNT_2017>1 & HCVData3$ABD_IMAGING_2017>1, 1, 0)
HCVData3$VwI2_2018 <- ifelse(HCVData3$VISIT_COUNT_2018>1 & HCVData3$ABD_IMAGING_2018>1, 1, 0)
HCVData3$Yearsof2VwI <- HCVData3$VwI2_2014 + HCVData3$VwI2_2015 + HCVData3$VwI2_2016 + HCVData3$VwI2_2017 + HCVData3$VwI2_2018

HCVData3$TotalVisits5years <- HCVData3$VISIT_COUNT_2014 + HCVData3$VISIT_COUNT_2015 + HCVData3$VISIT_COUNT_2016 + HCVData3$VISIT_COUNT_2017 + HCVData3$VISIT_COUNT_2018

HCVData3$Imaging2014 <- ifelse(HCVData3$ABD_IMAGING_2014>0, 1, 0)
HCVData3$Imaging2015 <- ifelse(HCVData3$ABD_IMAGING_2015>0, 1, 0) 
HCVData3$Imaging2016 <- ifelse(HCVData3$ABD_IMAGING_2016>0, 1, 0)
HCVData3$Imaging2017 <- ifelse(HCVData3$ABD_IMAGING_2017>0, 1, 0)
HCVData3$Imaging2018 <- ifelse(HCVData3$ABD_IMAGING_2018>0, 1, 0)
HCVData3$YearsofImaging <- HCVData3$Imaging2014 + HCVData3$Imaging2015 + HCVData3$Imaging2016 + HCVData3$Imaging2017 + HCVData3$Imaging2018
HCVData3$Imaged <- ifelse(HCVData3$YearsofImaging > HCVData3$YearsofVisits-2, 1, 0)

HCVData3$race.ethnicity <- relevel(HCVData3$race.ethnicity, "W")

fit.glm3_base <- glm(HCC_2019 ~ Yearsof2VwI + race.ethnicity + Sex + PayorType, family = binomial(log), HCVData3)
fit.glm3 <- glm(HCC_2019 ~ Yearsof2VwI + TotalVisits5years + FIB4_by2019 + race.ethnicity + Sex + PayorType, family = binomial(log), data = HCVData3, start=c(fit.glm3_base$coefficients[1:2],0,0,fit.glm3_base$coefficients[3:7]))


HCVData4$Visits2014 <- ifelse(HCVData4$VISIT_COUNT_2014>0, 1, 0)
HCVData4$Visits2015 <- ifelse(HCVData4$VISIT_COUNT_2015>0, 1, 0)
HCVData4$Visits2016 <- ifelse(HCVData4$VISIT_COUNT_2016>0, 1, 0)
HCVData4$Visits2017 <- ifelse(HCVData4$VISIT_COUNT_2017>0, 1, 0)
HCVData4$Visits2018 <- ifelse(HCVData4$VISIT_COUNT_2018>0, 1, 0)
HCVData4$YearsofVisits <- HCVData4$Visits2014 + HCVData4$Visits2015 + HCVData4$Visits2016 + HCVData4$Visits2017 + HCVData4$Visits2018

HCVData4$ABD_IMAGING_2014 <- ifelse(is.na(HCVData4$ABD_IMAGING_2014), 0, HCVData4$ABD_IMAGING_2014)
HCVData4$ABD_IMAGING_2015 <- ifelse(is.na(HCVData4$ABD_IMAGING_2015), 0, HCVData4$ABD_IMAGING_2015)
HCVData4$ABD_IMAGING_2016 <- ifelse(is.na(HCVData4$ABD_IMAGING_2016), 0, HCVData4$ABD_IMAGING_2016)
HCVData4$ABD_IMAGING_2017 <- ifelse(is.na(HCVData4$ABD_IMAGING_2017), 0, HCVData4$ABD_IMAGING_2017)
HCVData4$ABD_IMAGING_2018 <- ifelse(is.na(HCVData4$ABD_IMAGING_2018), 0, HCVData4$ABD_IMAGING_2018)

HCVData4$VwI2014 <- ifelse(HCVData4$VISIT_COUNT_2014>0 & HCVData4$ABD_IMAGING_2014>0, 1, 0)
HCVData4$VwI2015 <- ifelse(HCVData4$VISIT_COUNT_2015>0 & HCVData4$ABD_IMAGING_2015>0, 1, 0)
HCVData4$VwI2016 <- ifelse(HCVData4$VISIT_COUNT_2016>0 & HCVData4$ABD_IMAGING_2016>0, 1, 0)
HCVData4$VwI2017 <- ifelse(HCVData4$VISIT_COUNT_2017>0 & HCVData4$ABD_IMAGING_2017>0, 1, 0)
HCVData4$VwI2018 <- ifelse(HCVData4$VISIT_COUNT_2018>0 & HCVData4$ABD_IMAGING_2018>0, 1, 0)
HCVData4$YearsofVwI <- HCVData4$VwI2014 + HCVData4$VwI2015 + HCVData4$VwI2016 + HCVData4$VwI2017 + HCVData4$VwI2018

HCVData4$VwI2_2014 <- ifelse(HCVData4$VISIT_COUNT_2014>1 & HCVData4$ABD_IMAGING_2014>1, 1, 0)
HCVData4$VwI2_2015 <- ifelse(HCVData4$VISIT_COUNT_2015>1 & HCVData4$ABD_IMAGING_2015>1, 1, 0)
HCVData4$VwI2_2016 <- ifelse(HCVData4$VISIT_COUNT_2016>1 & HCVData4$ABD_IMAGING_2016>1, 1, 0)
HCVData4$VwI2_2017 <- ifelse(HCVData4$VISIT_COUNT_2017>1 & HCVData4$ABD_IMAGING_2017>1, 1, 0)
HCVData4$VwI2_2018 <- ifelse(HCVData4$VISIT_COUNT_2018>1 & HCVData4$ABD_IMAGING_2018>1, 1, 0)
HCVData4$Yearsof2VwI <- HCVData4$VwI2_2014 + HCVData4$VwI2_2015 + HCVData4$VwI2_2016 + HCVData4$VwI2_2017 + HCVData4$VwI2_2018

HCVData4$TotalVisits5years <- HCVData4$VISIT_COUNT_2014 + HCVData4$VISIT_COUNT_2015 + HCVData4$VISIT_COUNT_2016 + HCVData4$VISIT_COUNT_2017 + HCVData4$VISIT_COUNT_2018

HCVData4$Imaging2014 <- ifelse(HCVData4$ABD_IMAGING_2014>0, 1, 0)
HCVData4$Imaging2015 <- ifelse(HCVData4$ABD_IMAGING_2015>0, 1, 0) 
HCVData4$Imaging2016 <- ifelse(HCVData4$ABD_IMAGING_2016>0, 1, 0)
HCVData4$Imaging2017 <- ifelse(HCVData4$ABD_IMAGING_2017>0, 1, 0)
HCVData4$Imaging2018 <- ifelse(HCVData4$ABD_IMAGING_2018>0, 1, 0)
HCVData4$YearsofImaging <- HCVData4$Imaging2014 + HCVData4$Imaging2015 + HCVData4$Imaging2016 + HCVData4$Imaging2017 + HCVData4$Imaging2018
HCVData4$Imaged <- ifelse(HCVData4$YearsofImaging > HCVData4$YearsofVisits-2, 1, 0)

HCVData4$race.ethnicity <- relevel(HCVData4$race.ethnicity, "W")

fit.glm4_base <- glm(HCC_2019 ~ Yearsof2VwI + race.ethnicity + Sex + PayorType, family = binomial(log), HCVData4)
fit.glm4 <- glm(HCC_2019 ~ Yearsof2VwI + TotalVisits5years + FIB4_by2019 + race.ethnicity + Sex + PayorType, family = binomial(log), data = HCVData4, start=c(fit.glm4_base$coefficients[1:2],0,0,fit.glm4_base$coefficients[3:7]))


HCVData5$Visits2014 <- ifelse(HCVData5$VISIT_COUNT_2014>0, 1, 0)
HCVData5$Visits2015 <- ifelse(HCVData5$VISIT_COUNT_2015>0, 1, 0)
HCVData5$Visits2016 <- ifelse(HCVData5$VISIT_COUNT_2016>0, 1, 0)
HCVData5$Visits2017 <- ifelse(HCVData5$VISIT_COUNT_2017>0, 1, 0)
HCVData5$Visits2018 <- ifelse(HCVData5$VISIT_COUNT_2018>0, 1, 0)
HCVData5$YearsofVisits <- HCVData5$Visits2014 + HCVData5$Visits2015 + HCVData5$Visits2016 + HCVData5$Visits2017 + HCVData5$Visits2018

HCVData5$ABD_IMAGING_2014 <- ifelse(is.na(HCVData5$ABD_IMAGING_2014), 0, HCVData5$ABD_IMAGING_2014)
HCVData5$ABD_IMAGING_2015 <- ifelse(is.na(HCVData5$ABD_IMAGING_2015), 0, HCVData5$ABD_IMAGING_2015)
HCVData5$ABD_IMAGING_2016 <- ifelse(is.na(HCVData5$ABD_IMAGING_2016), 0, HCVData5$ABD_IMAGING_2016)
HCVData5$ABD_IMAGING_2017 <- ifelse(is.na(HCVData5$ABD_IMAGING_2017), 0, HCVData5$ABD_IMAGING_2017)
HCVData5$ABD_IMAGING_2018 <- ifelse(is.na(HCVData5$ABD_IMAGING_2018), 0, HCVData5$ABD_IMAGING_2018)

HCVData5$VwI2014 <- ifelse(HCVData5$VISIT_COUNT_2014>0 & HCVData5$ABD_IMAGING_2014>0, 1, 0)
HCVData5$VwI2015 <- ifelse(HCVData5$VISIT_COUNT_2015>0 & HCVData5$ABD_IMAGING_2015>0, 1, 0)
HCVData5$VwI2016 <- ifelse(HCVData5$VISIT_COUNT_2016>0 & HCVData5$ABD_IMAGING_2016>0, 1, 0)
HCVData5$VwI2017 <- ifelse(HCVData5$VISIT_COUNT_2017>0 & HCVData5$ABD_IMAGING_2017>0, 1, 0)
HCVData5$VwI2018 <- ifelse(HCVData5$VISIT_COUNT_2018>0 & HCVData5$ABD_IMAGING_2018>0, 1, 0)
HCVData5$YearsofVwI <- HCVData5$VwI2014 + HCVData5$VwI2015 + HCVData5$VwI2016 + HCVData5$VwI2017 + HCVData5$VwI2018

HCVData5$VwI2_2014 <- ifelse(HCVData5$VISIT_COUNT_2014>1 & HCVData5$ABD_IMAGING_2014>1, 1, 0)
HCVData5$VwI2_2015 <- ifelse(HCVData5$VISIT_COUNT_2015>1 & HCVData5$ABD_IMAGING_2015>1, 1, 0)
HCVData5$VwI2_2016 <- ifelse(HCVData5$VISIT_COUNT_2016>1 & HCVData5$ABD_IMAGING_2016>1, 1, 0)
HCVData5$VwI2_2017 <- ifelse(HCVData5$VISIT_COUNT_2017>1 & HCVData5$ABD_IMAGING_2017>1, 1, 0)
HCVData5$VwI2_2018 <- ifelse(HCVData5$VISIT_COUNT_2018>1 & HCVData5$ABD_IMAGING_2018>1, 1, 0)
HCVData5$Yearsof2VwI <- HCVData5$VwI2_2014 + HCVData5$VwI2_2015 + HCVData5$VwI2_2016 + HCVData5$VwI2_2017 + HCVData5$VwI2_2018

HCVData5$TotalVisits5years <- HCVData5$VISIT_COUNT_2014 + HCVData5$VISIT_COUNT_2015 + HCVData5$VISIT_COUNT_2016 + HCVData5$VISIT_COUNT_2017 + HCVData5$VISIT_COUNT_2018

HCVData5$Imaging2014 <- ifelse(HCVData5$ABD_IMAGING_2014>0, 1, 0)
HCVData5$Imaging2015 <- ifelse(HCVData5$ABD_IMAGING_2015>0, 1, 0) 
HCVData5$Imaging2016 <- ifelse(HCVData5$ABD_IMAGING_2016>0, 1, 0)
HCVData5$Imaging2017 <- ifelse(HCVData5$ABD_IMAGING_2017>0, 1, 0)
HCVData5$Imaging2018 <- ifelse(HCVData5$ABD_IMAGING_2018>0, 1, 0)
HCVData5$YearsofImaging <- HCVData5$Imaging2014 + HCVData5$Imaging2015 + HCVData5$Imaging2016 + HCVData5$Imaging2017 + HCVData5$Imaging2018
HCVData5$Imaged <- ifelse(HCVData5$YearsofImaging > HCVData5$YearsofVisits-2, 1, 0)

HCVData5$race.ethnicity <- relevel(HCVData5$race.ethnicity, "W")

fit.glm5_base <- glm(HCC_2019 ~ Yearsof2VwI + race.ethnicity + Sex + PayorType, family = binomial(log), HCVData5)
fit.glm5 <- glm(HCC_2019 ~ Yearsof2VwI + TotalVisits5years + FIB4_by2019 + race.ethnicity + Sex + PayorType, family = binomial(log), data = HCVData5, start=c(fit.glm5_base$coefficients[1:2],0,0,fit.glm5_base$coefficients[3:7]))


Yearsof2VwI_1 <- exp(fit.glm1$coefficients[2])
Yearsof2VwI_2 <- exp(fit.glm2$coefficients[2])
Yearsof2VwI_3 <- exp(fit.glm3$coefficients[2])
Yearsof2VwI_4 <- exp(fit.glm4$coefficients[2])
Yearsof2VwI_5 <- exp(fit.glm5$coefficients[2])
Yearsof2VwI_pt.est <- as.vector(c(Yearsof2VwI_1, Yearsof2VwI_2, Yearsof2VwI_3, Yearsof2VwI_4, Yearsof2VwI_5))
Yearsof2VwI_pt.est <- mean(Yearsof2VwI_ptest); Yearsof2VwI_ptest

#NNT
NNTdenom <- Yearsof2VwI_pt.est/100
NNT <- round(1/(Yearsof2VwI_pt.est/100), 0); NNT
```

<!--armadillo-->
## F. Findings

Ultimately, implementing \textit{ltmle} with \textit{Super Learner} on our observed data produced the following estimates for the risk difference of developing HCC in year 5 when receiving abdominal imaging at least once per year for the 4 preceding years, compared to not receiving abdominal imaging during that time, when controlling for the number of hepatology or primary care visits, FIB-4 score, sex, race, and SES was:

| **G-Comp** (95% CI) | **IPTW** (95% CI) | **TMLE** (95% CI) |
| ------------- | ------------- | ------------- |
| `r round(gcomp_ATE, 3)` (`r gcomp_low`, `r gcomp_high`) | `r round(iptw_ATE, 3)` (`r iptw_low`, `r iptw_high`) | `r round(tmle_ATE, 3)` (`r tmle_low`, `r tmle_high`) |

Using any of our estimators, we found that over the five years under study, patients with no cirrhosis at baseline were `r round(gcomp_ATE, 1)`% less likely to develop HCC by year 5 when they had abdominal imaging each year for the 4 previous years, compared to patients who had no abdominal imaging, when controlling for liver cirrhosis, number of primary care or hepatology visits, sex, race, and SES. While a `r round(gcomp_ATE, 1)`% decrease in HCC risk over 5 years sounds clinically non-significant at first glance, **this represents a number needed to treat (NNT) of `r NNT`**: for every `r NNT` people who receive annual abdominal imaging despite no evidence of cirrhosis at baseline, 1 case of HCC could be prevented over 5 years. Given that abdominal imaging is a non-invasive and relatively inexpensive intervention, this underscores the potential impact of an intervention to educate primary care and hepatology providers about the importance of ensuring their chronically HCV-infected patients receive abdominal imaging at least once per year, regardless of liver cirrhosis.
