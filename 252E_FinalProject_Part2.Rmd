---
title: "252E Final Project Part 2: \nRelationship between Frequency of Care and Progression to Hepatocellular Carcinoma \namong Chronic Hepatitis C Patients"
author: "Stephanie Holm and Shelley Facente"
date: "11/14/2019"
output: pdf_document
---

```{r setup, include=FALSE}
library(tidyverse)
library(readxl)
library(skimr)
library(knitr)
library(xlsx)
library(lubridate)
library(Hmisc)

knitr::opts_chunk$set(include = FALSE, cache = TRUE)

# First, load the data
StephandShelleyDataLoad <- function(filename) 
{
  if(Sys.info()['sysname']=="Darwin"){
    
     read_excel(as.character(filename))}
  else{
    windowsfilepath <- paste("~/GitHub/stephandshelley/", filename, sep = "")
     read_excel(as.character(windowsfilepath))
  }
}

HCVData <- StephandShelleyDataLoad("Deidentified Chronic HCV Dataset 11-14-19.xlsx")

```

```{r Data_Cleaning}
#Let's do all Variable prep/Data cleaning in this chunk

#first just making variables their proper type, and renaming so there's no spaces
HCVData$'Deidentified Pt Number (updated)'<- as.factor(HCVData$'Deidentified Pt Number (updated)')
colnames(HCVData)[colnames(HCVData) == 'Deidentified Pt Number (updated)'] <- 'PtID'

HCVData$'Hep Visit?'<- as.factor(HCVData$'Hep Visit?')
colnames(HCVData)[colnames(HCVData) == 'Hep Visit?'] <- 'EverHepVisit'

HCVData$'Ever Chronic HCV?' <- as.factor(HCVData$'Ever Chronic HCV?')
colnames(HCVData)[colnames(HCVData) == 'Ever Chronic HCV?'] <- 'EverChronicHCV'

HCVData$'Spontaneous Clearance?' <- as.factor(HCVData$'Spontaneous Clearance?')
colnames(HCVData)[colnames(HCVData) == 'Spontaneous Clearance?'] <- 'SpontClearance'

HCVData$'Ever Ab positive HCV?' <- as.factor(HCVData$'Ever Ab positive HCV?')
colnames(HCVData)[colnames(HCVData) == 'Ever Ab positive HCV?'] <- 'EverAbPosHCV'

HCVData$'Ever Treated?'<- as.factor(HCVData$'Ever Treated?')
colnames(HCVData)[colnames(HCVData) == 'Ever Treated?'] <- 'EverTreated'

HCVData$'Evidence of SVR?'<- as.factor(HCVData$'Evidence of SVR?')
colnames(HCVData)[colnames(HCVData) == 'Evidence of SVR?'] <- 'SVRAchieved'

HCVData$'Treatment Definition' <- as.factor(HCVData$'Treatment Definition')
colnames(HCVData)[colnames(HCVData) == 'Treatment Definition'] <- 'TreatmentDefinition'

HCVData$'DX_TYPE OR TEST_TYPE' <- as.factor(HCVData$'DX_TYPE OR TEST_TYPE')
colnames(HCVData)[colnames(HCVData) == 'DX_TYPE OR TEST_TYPE'] <- 'inclusion.source'

HCVData$'DX_NAME OR TEST RESULT'<- as.factor(HCVData$'DX_NAME OR TEST RESULT')
colnames(HCVData)[colnames(HCVData) == 'DX_NAME OR TEST RESULT'] <- 'inclusion.reason'

#Didn't do anything with the column 'ICD10 OR RESULT_DATE' because it's a mix of formats/info

colnames(HCVData)[colnames(HCVData) == 'SPECIMN TAKEN DATE'] <- 'date.first.pos.HCV.test'

HCVData$RESULT <- as.factor(HCVData$RESULT)
colnames(HCVData)[colnames(HCVData) == 'RESULT'] <- 'HCV.test.result'

HCVData$'RNA EVER TESTED' <- as.factor(HCVData$'RNA EVER TESTED')
colnames(HCVData)[colnames(HCVData) == 'RNA EVER TESTED'] <- 'RNAeverTested'

colnames(HCVData)[colnames(HCVData) == 'FIRST POS (Or if no POS, "SEE TEXT") RNA TEST DATE'] <- 'Date.First.Pos.RNA'

HCVData$'FIRST POS (Or if no POS, "SEE TEXT") RNA TEST RESULT' <- as.factor(HCVData$'FIRST POS (Or if no POS, "SEE TEXT") RNA TEST RESULT')
colnames(HCVData)[colnames(HCVData) == 'FIRST POS (Or if no POS, "SEE TEXT") RNA TEST RESULT'] <- 'Result.First.Pos.RNA'

#Added this to address the "See Text" weirdness; I think "See Text" was inserted here when the test was undetectable or lab error, etc. ##### MAY WANT TO REMOVE IF NUMERIC PREFERRED
##Note from Steph- it's not undetectable/lab error, it's just that for a number of years, they used this as a way to 'hide' results so that people in someone's chart inadvertantly didn't see sensitive test results. It was sort of a weird thing and they eventually dropped it. But that's why it's there. Right now though this is erroring over the RNA.interpretation column so I've commented it out.
#HCVData$Result.First.Pos.RNA <- ifelse(HCVData$Result.First.Pos.RNA == 'See Text', HCVData$RNA.interpretation, HCVData$Result.First.Pos.RNA)

colnames(HCVData)[colnames(HCVData) == 'MOST RECENT RNA POS'] <- 'Most.Recent.RNA.Pos'

colnames(HCVData)[colnames(HCVData) == 'MOST RECENT RNA NEG'] <- 'Most.Recent.RNA.Neg'

#This column is in the midst of the RNA testing section but is unlabeled. It's a date.
colnames(HCVData)[colnames(HCVData) == '...19'] <- 'UnknownColumn'

colnames(HCVData)[colnames(HCVData) == 'MOST RECENT RNA "SEE TEXT"'] <- 'Most.Recent.RNA.SeeText'

colnames(HCVData)[colnames(HCVData) == 'RNA interpretation'] <- 'RNA.interpretation'

colnames(HCVData)[colnames(HCVData) == 'other notes on diagnosis'] <- 'Notes'

HCVData$'Where getting care' <- as.factor(HCVData$'Where getting care')
colnames(HCVData)[colnames(HCVData) == 'Where getting care'] <- 'Care.Location'

#This errors because there are a number of non-dates in this column. Should discuss with Rena if using.
#HCVData$'HEP C GENOTYPE DATE' <- as.POSIXct(HCVData$'HEP C GENOTYPE DATE')
#colnames(HCVData)[colnames(HCVData) == 'HEP C GENOTYPE DATE'] <- 'HCV.Genotype.Date'

HCVData$'HEP C GENOTYPE RESULT' <- as.factor(HCVData$'HEP C GENOTYPE RESULT')
colnames(HCVData)[colnames(HCVData) == 'HEP C GENOTYPE RESULT'] <- 'HCV.Genotype.Result'

colnames(HCVData)[colnames(HCVData) == 'ALPHAFETOPROTEIN_RESULT_DATE'] <- 'AFP.Date'

colnames(HCVData)[colnames(HCVData) == 'ALPHAFETOPROTEIN_RESULT'] <- 'AFP.Result'

colnames(HCVData)[colnames(HCVData) == 'FIRST_HEPATOLOGY_APPT'] <- 'First.Hep.Appt'

colnames(HCVData)[colnames(HCVData) == 'MOST_RECENT_HEPATOLOGY_APPT'] <- 'Most.Recent.Hep.Appt'

colnames(HCVData)[colnames(HCVData) == 'PLATLET_RESULT_DATE'] <- 'Lowest.Platelet.Date'

colnames(HCVData)[colnames(HCVData) == 'LOWEST_PLATELETS_RESULT'] <- 'Lowest.Platelet.Result'

colnames(HCVData)[colnames(HCVData) == 'HEPA_VACCINE_DATE'] <- 'HAV.Vax.Date'

colnames(HCVData)[colnames(HCVData) == 'HEPB_VACCINE_DATE'] <- 'HBV.Vax.Date'

HCVData$'Ever Had a Primary Care Visit' <- as.factor(HCVData$'Ever Had a Primary Care Visit')
colnames(HCVData)[colnames(HCVData) == 'Ever Had a Primary Care Visit'] <- 'EverPrimaryCareVisit'

HCVData$'DEPT_NAME' <- as.factor(HCVData$'DEPT_NAME')

HCVData$'CURRENT_PCP' <- as.factor(HCVData$'CURRENT_PCP')

HCVData$'CURRENT_PCP_DEPT' <- as.factor(HCVData$'CURRENT_PCP_DEPT')

colnames(HCVData)[colnames(HCVData) == 'HBsAb_RESULT_DATE'] <- 'HBsAG.Date'

HCVData$'HBsAb_ORD_VALUE' <- as.factor(HCVData$'HBsAb_ORD_VALUE')
colnames(HCVData)[colnames(HCVData) == 'HBsAb_ORD_VALUE'] <- 'HBsAb.Result'

colnames(HCVData)[colnames(HCVData) == 'HIV_RESULT_DATE'] <- 'HIV.Date'

HCVData$'ORD_VALUE' <- as.factor(HCVData$'ORD_VALUE')
colnames(HCVData)[colnames(HCVData) == 'ORD_VALUE'] <- 'HIV.Result'

HCVData$'HepA_IgG_Result_Date' <- as.factor(HCVData$'HepA_IgG_Result_Date')
colnames(HCVData)[colnames(HCVData) == 'HepA_IgG_Result_Date'] <- 'HepA_IgG.Date'

HCVData$'HepA_IgG' <- as.factor(HCVData$'HepA_IgG')
colnames(HCVData)[colnames(HCVData) == 'HepA_IgG'] <- 'HepA_IgG.Result'

HCVData$'HBsAg_RESULT_DATE' <- as.factor(HCVData$'HBsAg_RESULT_DATE')
colnames(HCVData)[colnames(HCVData) == 'HBsAg_RESULT_DATE'] <- 'HBsAg_Date'

HCVData$'HBsAg_Value' <- as.factor(HCVData$'HBsAg_Value')

HCVData$'Med_1' <- as.factor(HCVData$'Med_1')

HCVData$'Med_2' <- as.factor(HCVData$'Med_2')

HCVData$'HEPB_CORE_IgM_RESULT' <- as.factor(HCVData$'HEPB_CORE_IgM_RESULT')

HCVData$'HEPB_CORE_Total_RESULT' <- as.factor(HCVData$'HEPB_CORE_Total_RESULT')

HCVData$DX_TYPE <- as.factor(HCVData$DX_TYPE)
colnames(HCVData)[colnames(HCVData) == 'DX_TYPE'] <- 'Cancer.Diagnosis.Source'

HCVData$'DX_NAME...56' <- as.factor(HCVData$'DX_NAME...56')
colnames(HCVData)[colnames(HCVData) == 'DX_NAME...56'] <- 'Cancer.Diagnosis.Name'

HCVData$ICD10 <- as.factor(HCVData$ICD10)
colnames(HCVData)[colnames(HCVData) == 'ICD10'] <- 'Cancer.ICD10'

##Need to check with Rena if this is indeed HCC Dx (not HCV Dx)
colnames(HCVData)[colnames(HCVData) == 'FIRST_DX_DATE'] <- 'Cancer.Diagnosis.Date'

HCVData$RACE <- as.factor(HCVData$RACE)
colnames(HCVData)[colnames(HCVData) == 'RACE'] <- 'Race'

HCVData$ETHNICTY <- as.factor(HCVData$ETHNICTY)
colnames(HCVData)[colnames(HCVData) == 'ETHNICTY'] <- 'Ethnicity'

#Appears to only be male/female, I suspect really sex :(
HCVData$SEX <- as.factor(HCVData$SEX)
colnames(HCVData)[colnames(HCVData) == 'SEX'] <- 'Sex'

HCVData$LANGUAGE <- as.factor(HCVData$LANGUAGE)
colnames(HCVData)[colnames(HCVData) == 'LANGUAGE'] <- 'Language'

colnames(HCVData)[colnames(HCVData) == 'Outpatient Completed'] <- 'Num.Outpatient.Visits'

colnames(HCVData)[colnames(HCVData) == 'Outpatient Canceled'] <- 'Num.Outpatient.Cancellations'

colnames(HCVData)[colnames(HCVData) == 'Outpatient No Show'] <- 'Num.Outpatient.NoShows'

colnames(HCVData)[colnames(HCVData) == 'Opiod'] <- 'Opioid.Hx'

colnames(HCVData)[colnames(HCVData) == 'ED'] <- 'ED.Visits'

colnames(HCVData)[colnames(HCVData) == 'Hosp Admission'] <- 'Hospital.Admissions'

##removing extra variables with the same column names, unneeded for our analysis as far as I can tell
HCVData <- subset(HCVData, select = -c(DX_NAME...70,
           CURRENT_ICD10_LIST...71, 
           DX_NAME...73,
           CURRENT_ICD10_LIST...74,
           DX_NAME...76,
           CURRENT_ICD10_LIST...77,
           DX_NAME...79,
           CURRENT_ICD10_LIST...80,
           DX_NAME...82,
           CURRENT_ICD10_LIST...83,
           DX_NAME...85,
           CURRENT_ICD10_LIST...86,
           DX_NAME...88,
           CURRENT_ICD10_LIST...89,
           DX_NAME...91,
           CURRENT_ICD10_LIST...92,
           DX_NAME...94,
           CURRENT_ICD10_LIST...95,
           DX_NAME...97,
           CURRENT_ICD10_LIST...98,
           DX_NAME...100,
           CURRENT_ICD10_LIST...101, 
           CURRENT_ICD10_LIST...103, 
           DX_NAME...104,
           CURRENT_ICD10_LIST...106,
           DX_NAME...107,
           DX_NAME...109,
           CURRENT_ICD10_LIST...110,
           CURRENT_ICD10_LIST...112,
           DX_NAME...113,
           CURRENT_ICD10_LIST...115,
           DX_NAME...116,
           DX_NAME...118,
           CURRENT_ICD10_LIST...119,
           DX_NAME...121,
           CURRENT_ICD10_LIST...122,
           DX_NAME...124,
           CURRENT_ICD10_LIST...125))

colnames(HCVData)[colnames(HCVData) == 'METASTATIC Cancer'] <- 'Metastatic.Cancer'

colnames(HCVData)[colnames(HCVData) == 'Nonmetastatic Cancer'] <- 'NON-Metastatic.Cancer'

colnames(HCVData)[colnames(HCVData) == 'Alcohol Abuse'] <- 'Alcohol.Abuse'

colnames(HCVData)[colnames(HCVData) == 'Drug Abuse'] <- 'Drug.Abuse'

colnames(HCVData)[colnames(HCVData) == 'Othe Neurological Disorder'] <- 'Other.Neuro.Disorder'

colnames(HCVData)[colnames(HCVData) == 'CHRONIC PULMONARY DISORDER'] <- 'CPD'

colnames(HCVData)[colnames(HCVData) == 'Renal Failure'] <- 'Renal.Failure'

colnames(HCVData)[colnames(HCVData) == 'Liver Disease'] <- 'Liver.Disease'

HCVData$PAYOR_NAME <- as.factor(HCVData$PAYOR_NAME)
colnames(HCVData)[colnames(HCVData) == 'PAYOR_NAME'] <- 'PAYOR'

HCVData <- HCVData %>% mutate(PayorType = ifelse(str_detect(HCVData$PAYOR, "MCAL"), "MediCal", "Commercial"),
                              PayorType = ifelse(str_detect(HCVData$PAYOR, "M-CAL"), "MediCal", PayorType),
                              PayorType = ifelse(str_detect(HCVData$PAYOR, "MEDI-CAL"), "MediCal", PayorType),
                              PayorType = ifelse(str_detect(HCVData$PAYOR, "SENIOR"), "Medicare", PayorType),
                              PayorType = ifelse(str_detect(HCVData$PAYOR, "SNR"), "Medicare", PayorType),
                              PayorType = ifelse(str_detect(HCVData$PAYOR, "MEDICARE"), "Medicare", PayorType))

HCVData$'FIRST PC APPT DEPT' <- as.factor(HCVData$'FIRST PC APPT DEPT')
colnames(HCVData)[colnames(HCVData) == 'FIRST PC APPT DEPT'] <- 'FIRST_PC_APPT_DEPT'

HCVData$'MOST RECENT PC APPT DEPT' <- as.factor(HCVData$'MOST RECENT PC APPT DEPT')
colnames(HCVData)[colnames(HCVData) == 'MOST RECENT PC APPT DEPT'] <- 'MOST_RECENT_PC_APPT_DEPT'

HCVData$VISIT_COUNT_2011 <-rowSums(cbind(HCVData$PC_2011_VISIT_COUNT, HCVData$HEP_2011_VISIT_COUNT), na.rm=TRUE)
HCVData$VISIT_COUNT_2012 <-rowSums(cbind(HCVData$PC_2012_VISIT_COUNT, HCVData$HEP_2012_VISIT_COUNT), na.rm=TRUE)
HCVData$VISIT_COUNT_2013 <-rowSums(cbind(HCVData$PC_2013_VISIT_COUNT, HCVData$HEP_2013_VISIT_COUNT), na.rm=TRUE)
HCVData$VISIT_COUNT_2014 <-rowSums(cbind(HCVData$PC_2014_VISIT_COUNT, HCVData$HEP_2014_VISIT_COUNT), na.rm=TRUE)
HCVData$VISIT_COUNT_2015 <-rowSums(cbind(HCVData$PC_2015_VISIT_COUNT, HCVData$HEP_2015_VISIT_COUNT), na.rm=TRUE)
HCVData$VISIT_COUNT_2016 <-rowSums(cbind(HCVData$PC_2016_VISIT_COUNT, HCVData$HEP_2016_VISIT_COUNT), na.rm=TRUE)
HCVData$VISIT_COUNT_2017 <-rowSums(cbind(HCVData$PC_2017_VISIT_COUNT, HCVData$HEP_2017_VISIT_COUNT), na.rm=TRUE)
HCVData$VISIT_COUNT_2018 <-rowSums(cbind(HCVData$PC_2018_VISIT_COUNT, HCVData$HEP_2018_VISIT_COUNT), na.rm=TRUE)
HCVData$VISIT_COUNT_2019 <-rowSums(cbind(HCVData$PC_2019_VISIT_COUNT, HCVData$HEP_2019_VISIT_COUNT), na.rm=TRUE)

HCVData$TotalVisits<- HCVData$VISIT_COUNT_2011 + HCVData$VISIT_COUNT_2012 + HCVData$VISIT_COUNT_2013 + HCVData$VISIT_COUNT_2014 + HCVData$VISIT_COUNT_2015 + HCVData$VISIT_COUNT_2016 + HCVData$VISIT_COUNT_2017 + HCVData$VISIT_COUNT_2018

HCVData$TotalVisits15to18 <- HCVData$VISIT_COUNT_2015 + HCVData$VISIT_COUNT_2016 + HCVData$VISIT_COUNT_2017 + HCVData$VISIT_COUNT_2018


```

```{r Age_and_FIB-4}

age <- function(dob, curryear, units = "years", floor = TRUE) {
    calc.age = interval(dob, curryear) / duration(num = 1, units = units)
    return(as.integer(floor(calc.age)))
}

HCVData$AGE_2009 <- age(dob = HCVData$BIRTH_DATE, curryear = as.Date('2009-12-31'))

HCVData$AGE_2010 <- age(dob = HCVData$BIRTH_DATE, curryear = as.Date('2010-12-31'))

HCVData$AGE_2011 <- age(dob = HCVData$BIRTH_DATE, curryear = as.Date('2011-12-31'))

HCVData$AGE_2012 <- age(dob = HCVData$BIRTH_DATE, curryear = as.Date('2012-12-31'))

HCVData$AGE_2013 <- age(dob = HCVData$BIRTH_DATE, curryear = as.Date('2013-12-31'))

HCVData$AGE_2014 <- age(dob = HCVData$BIRTH_DATE, curryear = as.Date('2014-12-31'))

HCVData$AGE_2015 <- age(dob = HCVData$BIRTH_DATE, curryear = as.Date('2015-12-31'))

HCVData$AGE_2016 <- age(dob = HCVData$BIRTH_DATE, curryear = as.Date('2016-12-31'))

HCVData$AGE_2017 <- age(dob = HCVData$BIRTH_DATE, curryear = as.Date('2017-12-31'))

HCVData$AGE_2018 <- age(dob = HCVData$BIRTH_DATE, curryear = as.Date('2018-12-31'))

HCVData$AGE_2019 <- age(dob = HCVData$BIRTH_DATE, curryear = as.Date('2019-12-31'))

#drop DOB from dataset for privacy reasons
HCVData <- subset(HCVData, select = -c(BIRTH_DATE))

HCVData$FIB4_2009 <- HCVData$AGE_2009 * HCVData$AST_2009 / (HCVData$PLATELET_2009 * sqrt(HCVData$ALT_2009))

HCVData$FIB4_2010 <- HCVData$AGE_2010 * HCVData$AST_2010 / (HCVData$PLATELET_2010 * sqrt(HCVData$ALT_2010))
  
HCVData$FIB4_2011 <- HCVData$AGE_2011 * HCVData$AST_2011 / (HCVData$PLATELET_2011 * sqrt(HCVData$ALT_2011))
  
HCVData$FIB4_2012 <- HCVData$AGE_2012 * HCVData$AST_2012 / (HCVData$PLATELET_2012 * sqrt(HCVData$ALT_2012))

HCVData$FIB4_2013 <- HCVData$AGE_2013 * HCVData$AST_2013 / (HCVData$PLATELET_2013 * sqrt(HCVData$ALT_2013))

HCVData$FIB4_2014 <- HCVData$AGE_2011 * HCVData$AST_2014 / (HCVData$PLATELET_2014 * sqrt(HCVData$ALT_2014))

HCVData$FIB4_2015 <- HCVData$AGE_2011 * HCVData$AST_2015 / (HCVData$PLATELET_2015 * sqrt(HCVData$ALT_2015))

HCVData$FIB4_2016 <- HCVData$AGE_2011 * HCVData$AST_2016 / (HCVData$PLATELET_2016 * sqrt(HCVData$ALT_2016))

HCVData$FIB4_2017 <- HCVData$AGE_2011 * HCVData$AST_2017 / (HCVData$PLATELET_2017 * sqrt(HCVData$ALT_2017))

HCVData$FIB4_2018 <- HCVData$AGE_2011 * HCVData$AST_2018 / (HCVData$PLATELET_2018 * sqrt(HCVData$ALT_2018))

HCVData$FIB4_2019 <- HCVData$AGE_2011 * HCVData$AST_2019 / (HCVData$PLATELET_2019 * sqrt(HCVData$ALT_2019))


```

```{r Export_age_and_FIB4_for_Rena}
#
#adds <- data.frame(HCVData$PtID, HCVData$AGE_2009, HCVData$AGE_2010, HCVData$AGE_2011, HCVData$AGE_2012, HCVData$AGE_2013, HCVData$AGE_2014, HCVData$AGE_2015, HCVData$AGE_2016, HCVData$AGE_2017, HCVData$AGE_2018, HCVData$AGE_2019, HCVData$FIB4_2009, HCVData$FIB4_2010, HCVData$FIB4_2011, HCVData$FIB4_2012, HCVData$FIB4_2013, HCVData$FIB4_2014, HCVData$FIB4_2015, HCVData$FIB4_2016, HCVData$FIB4_2017, HCVData$FIB4_2018, HCVData$FIB4_2019)
#colnames(adds) <- c("Deidentified Pt Number", "AGE_2009", "AGE_2010", "AGE_2011", "AGE_2012", "AGE_2013", "AGE_2014", "AGE_2015", "AGE_2016", "AGE_2017", "AGE_2018", "AGE_2019", "FIB4_2009", "FIB4_2010", "FIB4_2011", "FIB4_2012", "FIB4_2013", "FIB4_2014", "FIB4_2015", "FIB4_2016", "FIB4_2017", "FIB4_2018", "FIB4_2019")
#
#filename <- paste0("HCVadds", ".xlsx")
#write.xlsx(adds, filename)
#rm(adds)
```


```{r filter to adults with visits, historical FIB4s}
HCVData<- HCVData %>% filter(TotalVisits != 0) %>%
                      filter(AGE_2011 >18)

# #calculating a total fib4, NOT  because it's meaningful but to be ableto see how many had NO FIB4
# #commenting out for now bc just used this to explore
# HCVData$totalFIB4 <-rowSums(cbind(HCVData$FIB4_2009,
#                                   HCVData$FIB4_2010,
#                                   HCVData$FIB4_2011,
#                                   HCVData$FIB4_2012,
#                                   HCVData$FIB4_2013,
#                                   HCVData$FIB4_2014,
#                                   HCVData$FIB4_2015,
#                                   HCVData$FIB4_2016,
#                                   HCVData$FIB4_2017,
#                                   HCVData$FIB4_2018), na.rm=TRUE)
# summary(HCVData$totalFIB4==0)
# 
# HCVData$totalFIB4BY2011 <-rowSums(cbind(HCVData$FIB4_2009,
#                                   HCVData$FIB4_2010,
#                                   HCVData$FIB4_2011), na.rm=TRUE)
# summary(HCVData$totalFIB4BY2011==0)
# 
# HCVData$totalFIB4BY2014 <-rowSums(cbind(HCVData$FIB4_2009,
#                                   HCVData$FIB4_2010,
#                                   HCVData$FIB4_2011,
#                                   HCVData$FIB4_2012,
#                                   HCVData$FIB4_2013,
#                                   HCVData$FIB4_2014), na.rm=TRUE)
# summary(HCVData$totalFIB4BY2014==0)
# 
# HCVData$totalFIB4BY2015 <-rowSums(cbind(HCVData$FIB4_2009,
#                                   HCVData$FIB4_2010,
#                                   HCVData$FIB4_2011,
#                                   HCVData$FIB4_2012,
#                                   HCVData$FIB4_2013,
#                                   HCVData$FIB4_2014,
#                                   HCVData$FIB4_2015), na.rm=TRUE)
# summary(HCVData$totalFIB4BY2015==0)
# #note- by 2015 72% of our sample has a FIB4.
# 
# HCVData$totalFIB4BY2016 <-rowSums(cbind(HCVData$FIB4_2009,
#                                   HCVData$FIB4_2010,
#                                   HCVData$FIB4_2011,
#                                   HCVData$FIB4_2012,
#                                   HCVData$FIB4_2013,
#                                   HCVData$FIB4_2014,
#                                   HCVData$FIB4_2015,
#                                   HCVData$FIB4_2016), na.rm=TRUE)
# summary(HCVData$totalFIB4BY2016==0)
# 
# HCVData$totalFIB4BY2017 <-rowSums(cbind(HCVData$FIB4_2009,
#                                   HCVData$FIB4_2010,
#                                   HCVData$FIB4_2011,
#                                   HCVData$FIB4_2012,
#                                   HCVData$FIB4_2013,
#                                   HCVData$FIB4_2014,
#                                   HCVData$FIB4_2015,
#                                   HCVData$FIB4_2016,
#                                   HCVData$FIB4_2017), na.rm=TRUE)
# summary(HCVData$totalFIB4BY2017==0)
# 
# HCVData$totalFIB4BY2018 <-rowSums(cbind(HCVData$FIB4_2009,
#                                   HCVData$FIB4_2010,
#                                   HCVData$FIB4_2011,
#                                   HCVData$FIB4_2012,
#                                   HCVData$FIB4_2013,
#                                   HCVData$FIB4_2014,
#                                   HCVData$FIB4_2015,
#                                   HCVData$FIB4_2016,
#                                   HCVData$FIB4_2017,
#                                   HCVData$FIB4_2018), na.rm=TRUE)
# summary(HCVData$totalFIB4BY2018==0)
# 
# HCVData$totalFIB4BY2019 <-rowSums(cbind(HCVData$FIB4_2009,
#                                   HCVData$FIB4_2010,
#                                   HCVData$FIB4_2011,
#                                   HCVData$FIB4_2012,
#                                   HCVData$FIB4_2013,
#                                   HCVData$FIB4_2014,
#                                   HCVData$FIB4_2015,
#                                   HCVData$FIB4_2016,
#                                   HCVData$FIB4_2017,
#                                   HCVData$FIB4_2018,
#                                   HCVData$FIB4_2019), na.rm=TRUE)
# summary(HCVData$totalFIB4BY2019==0)




#creating the FIB4 scores that  pull forward past scores
HCVData <-  HCVData %>% mutate(FIB4_by2010 = FIB4_2010, YearsSinceFib4_2010 = 0)
HCVData <- HCVData %>% mutate(FIB4_by2010 = ifelse(is.na(FIB4_2010)== "TRUE", FIB4_2009, FIB4_by2010),
                               YearsSinceFib4_2010 = ifelse(is.na(FIB4_2010)== "TRUE", 1, 0))
 

HCVData <-  HCVData %>% mutate(FIB4_by2011 = FIB4_2011, YearsSinceFib4_2011 = 0)
HCVData <-  HCVData %>% mutate(FIB4_by2011 = ifelse(is.na(FIB4_2011)== "TRUE", FIB4_by2010, FIB4_by2011),
                               YearsSinceFib4_2011 = ifelse(is.na(FIB4_2011)== "TRUE", YearsSinceFib4_2010 + 1, 0))

HCVData <-  HCVData %>% mutate(FIB4_by2012 = FIB4_2012, YearsSinceFib4_2012 = 0)
HCVData <-  HCVData %>% mutate(FIB4_by2012 = ifelse(is.na(FIB4_2012)== "TRUE", FIB4_by2011, FIB4_by2012),
                               YearsSinceFib4_2012 = ifelse(is.na(FIB4_2012)== "TRUE", YearsSinceFib4_2011 + 1, 0))

HCVData <-  HCVData %>% mutate(FIB4_by2013 = FIB4_2013, YearsSinceFib4_2013 = 0)
HCVData <-  HCVData %>%  mutate(FIB4_by2013 = ifelse(is.na(FIB4_2013)== "TRUE", FIB4_by2012, FIB4_by2013),
                               YearsSinceFib4_2013 = ifelse(is.na(FIB4_2013)== "TRUE", YearsSinceFib4_2012 + 1, 0))

HCVData <-  HCVData %>% mutate(FIB4_by2014 = FIB4_2014, YearsSinceFib4_2014 = 0)
HCVData <-  HCVData %>% mutate(FIB4_by2014 = ifelse(is.na(FIB4_2014)== "TRUE", FIB4_by2013, FIB4_by2014),
                               YearsSinceFib4_2014 = ifelse(is.na(FIB4_2014)== "TRUE", YearsSinceFib4_2013 + 1, 0))

HCVData <-  HCVData %>% mutate(FIB4_by2015 = FIB4_2015, YearsSinceFib4_2015 = 0)
HCVData <-  HCVData %>% mutate(FIB4_by2015 = ifelse(is.na(FIB4_2015)== "TRUE", FIB4_by2014, FIB4_by2015),
                               YearsSinceFib4_2015 = ifelse(is.na(FIB4_2015)== "TRUE", YearsSinceFib4_2014 + 1, 0))


#Imputing as the median value for those without a FIB4 by 2015
HCVData <-  HCVData %>% mutate(YearsSinceFib4_2015 = ifelse(is.na(FIB4_by2015)== "TRUE", 0, YearsSinceFib4_2015),
                               ImputedFIB4_2015 = ifelse(is.na(FIB4_by2015)== "TRUE", 1, 0),
                               FIB4_by2015 = ifelse(is.na(FIB4_by2015)== "TRUE", median(HCVData$FIB4_by2015,na.rm= "TRUE"), FIB4_by2015))


HCVData <-  HCVData %>% mutate(FIB4_by2016 = FIB4_2016, YearsSinceFib4_2016 = 0)
HCVData <-  HCVData %>% mutate(FIB4_by2016 = ifelse(is.na(FIB4_2016)== "TRUE", FIB4_by2015, FIB4_by2016),
                               YearsSinceFib4_2016 = ifelse(is.na(FIB4_2016)== "TRUE", YearsSinceFib4_2015 + 1, 0),
                               ImputedFIB4_2016 = ifelse(is.na(FIB4_2016)== "TRUE", ImputedFIB4_2015, 0))

HCVData <-  HCVData %>% mutate(FIB4_by2017 = FIB4_2017, YearsSinceFib4_2017 = 0)
HCVData <-  HCVData %>% mutate(FIB4_by2017 = ifelse(is.na(FIB4_2017)== "TRUE", FIB4_by2016, FIB4_by2017),
                               YearsSinceFib4_2017 = ifelse(is.na(FIB4_2017)== "TRUE", YearsSinceFib4_2016 + 1, 0),
                               ImputedFIB4_2017 = ifelse(is.na(FIB4_2017)== "TRUE", ImputedFIB4_2016, 0))

HCVData <-  HCVData %>% mutate(FIB4_by2018 = FIB4_2018, YearsSinceFib4_2018 = 0)
HCVData <-  HCVData %>% mutate(FIB4_by2018 = ifelse(is.na(FIB4_2018)== "TRUE", FIB4_by2017, FIB4_by2018),
                               YearsSinceFib4_2018 = ifelse(is.na(FIB4_2018)== "TRUE", YearsSinceFib4_2017 + 1, 0),
                               ImputedFIB4_2018 = ifelse(is.na(FIB4_2018)== "TRUE", ImputedFIB4_2017, 0))

HCVData <-  HCVData %>% mutate(FIB4_by2019 = FIB4_2019, YearsSinceFib4_2019 = 0)
HCVData <-  HCVData %>% mutate(FIB4_by2019 = ifelse(is.na(FIB4_2019)== "TRUE", FIB4_by2018, FIB4_by2019),
                               YearsSinceFib4_2019 = ifelse(is.na(FIB4_2019)== "TRUE", YearsSinceFib4_2018 + 1, 0),
                               ImputedFIB4_2019 = ifelse(is.na(FIB4_2019)== "TRUE", ImputedFIB4_2018, 0))


```


```{r Code_for_the_DAG}
#DAGGity code- ie to use in the online Daggity tool...I don't love rDaggity
#But am putting the code here so we have it. Reminder that you can command/control-shift-c to comment in or out a whole chunk.

###NEW DAG 11/15/19###
# C_2019 1 @0.964,-0.558
# HCC_2019 O @0.964,-0.471
# L(2017) 1 @-1.411,-0.550
# L(2018) 1 @-0.248,-0.553
# Visits_2017 E @-1.416,-0.465
# Visits_2018 E @-0.216,-0.468
# Ws 1 @-2.247,-0.626
# 
# C_2019 HCC_2019
# L(2017) L(2018) Visits_2017 Visits_2018
# L(2018) C_2019 HCC_2019 Visits_2018
# Visits_2017 L(2018) Visits_2018
# Visits_2018 C_2019 HCC_2019
# Ws C_2019 @0.348,-0.700 HCC_2019 @-2.361,-0.250 Visits_2017 @-1.733,-0.500 Visits_2018 @-1.943,-0.302

#####OLD DAG#####
# C2 1 @0.166,2.321
# C3 1 @1.507,2.005
# Delta1 1 @-0.292,1.289
# Delta2 1 @0.724,1.251
# FIB-4_Score_Y1 1 @-0.303,0.743
# FIB-4_Score_Y2 1 @0.813,0.640
# Gender 1 @-1.945,1.903
# HCC%20Year%203 O @1.449,-0.615
# HCC_Y1 1 @-0.321,-0.350
# HCC_Y2 1 @0.659,-0.463
# Race 1 @-2.228,0.483
# SES 1 @-1.939,-1.213
# Visits_Y1 E @-0.321,0.204
# Visits_Y2 E @0.735,0.031
# 
# C2 C3 Delta2 @0.683,1.671 HCC_Y2 @1.700,0.966 Visits_Y2 @1.533,0.510
# C3 HCC%20Year%203
# Delta1 Delta2 FIB-4_Score_Y1
# Delta2 FIB-4_Score_Y2
# FIB-4_Score_Y1 FIB-4_Score_Y2 HCC_Y2 Visits_Y1 Visits_Y2
# FIB-4_Score_Y2 HCC%20Year%203 Visits_Y2
# Gender C2 @-0.915,2.484 C3 @0.445,2.505 Delta1 Delta2 @-0.730,2.493 HCC%20Year%203 @1.694,1.823 HCC_Y1 @-1.467,-0.374 HCC_Y2 @-0.545,-1.642 Visits_Y1 @-1.311,0.421 Visits_Y2 @0.270,2.609
# HCC_Y1 C2 @0.255,-0.201 Delta2 FIB-4_Score_Y2 HCC_Y2 Visits_Y1 Visits_Y2
# HCC_Y2 C3 @1.679,0.432 HCC%20Year%203 Visits_Y2
# Race C2 C3 Delta1 @-1.740,1.126 Delta2 @-1.687,2.003 HCC%20Year%203 @-0.188,-1.761 HCC_Y1 HCC_Y2 @-1.734,-1.440 Visits_Y1 Visits_Y2 @0.240,1.841
# SES C2 @-0.861,1.622 C3 @-1.212,1.129 Delta1 @-1.275,0.153 Delta2 @-1.999,0.600 FIB-4_Score_Y2 @1.569,-1.615 HCC%20Year%203 @1.676,-2.097 HCC_Y1 @-0.012,-1.731 HCC_Y2 @0.317,-1.195 Visits_Y1 @-1.910,-0.061 Visits_Y2 @1.389,-1.213
# Visits_Y1 C2 @0.344,0.427 Delta2 FIB-4_Score_Y2 HCC_Y2 Visits_Y2
# Visits_Y2 C3 @1.584,0.844 HCC%20Year%203
```

# 1. Background
## a. Brief Introduction
Hepatocellular carcinoma (HCC), a type of liver cancer, is the second most common cause of liver-related death throughout the world (Bosetti et al 2014). HCC is a major complication of infection with hepatitis C (HCV) virus, occuring in 1%-4% of people with liver cirrhosis each year (Omland et al 2010). HCV becomes chronic infection for about 80% of adults, and if left untreated can cause increasing cirrhosis over a period of 20-30 years of often asymptomatic disease, until damage is severe and major complications are irreversable (El-Serag 2012). Certain HCV viral genotypes (particularly genotype 3) are associated with higher risk of HCC, as is continued smoking (Chuang et al 2010) and alcohol use (Donato et al 2002), as well as concurrent diabetes or obesity (Huang et al 2017, Calle et al 2003). 

Since 2014, direct-acting antiviral (DAA) therapy has dramatically improved prognosis for people living with HCV; 8-12 weeks of well-tolerated oral therapy leads to cure in more than 90% of patients (Burstow et al 2017), halting cirrhosis progression and apparently reducing the elevated risk of HCC (Axley et al 2017). Patients whose HCV has already caused some cirrhosis continue to be at some increased risk of HCC even post-cure, and given the high mortality risk it is critical that people with HCV infection receive systematic monitoring with liver ultrasound (the European Association for Study of the Liver currently recommends screening twice per year) (EASL 2015). Therefore, we hypothesize that regular visits to a primary care physician or hepatologist who can provide screening and ongoing disease management (including curative treatment for HCV infection in most cases) is preventive for development of HCC among people with known chronic HCV infection.

## b. Description of our Dataset

We are using a dataset of chronic hepatitis C patients receiving care in the UCSF system since 2009. There are `r nrow(HCVData)` patients, who were adults by the start of 2015 and have been seen in a variety of primary care clinics and the hepatology (liver) clinic between 2015 and 2019. These data come from a query of Apex, the UCSF-specific build of the electronic medical record system Epic. 

# 2. Roadmap
##a. Causal Model
### i. Defining Our Variables

**Exposures**: We have data on the annual number of clinical visits that each chronic HCV patient had in the UCSF system annually from 2015 through 2018.

**Outcome**: The outcome is diagnosis of hepatocellular carcinoma (HCC), by the final year (2019) which occured in `r nrow(HCVData)- as.numeric(summary(HCVData$Cancer.Diagnosis.Source)["NA's"])` patients. 

**Covariates**: FIB-4 score (a validated measure used for prediction of cirrhosis (Khan et al 2017), which uses age, platelet count and liver transaminases), years since FIB-4 score last measured, biologic sex, race, insurance type (Medi-Cal vs private- a surrogate of socioeconomic status.)

### ii. Our DAG
```{r DAG, include = TRUE, echo = FALSE, out.width= "60%"}
knitr::include_graphics("dagitty-model.png")
```

This analysis includes 5 years worth of data (4 of exposure and 1 of outcome), but in order to simplify the DAG we present only the final 3 years (two of exposure data and the final year of outcome) here. This DAG includes a $C$ value indicating whether or not the patient had the outcome measured by the end of the study.

### iii. Our Structural Causal Model, $O= (W, C(t), \Delta(t), L(t), Y(t), A(t))$
This is survival data with missingness and censoring, where:

* W is the baseline covariates (race, sex and SES)
* L(t) is the set of covariates (most recent FIB-4 score, years since last FIB-4) at time t
* A(t) is the exposure (number of visits)
* C(t) is an indicator of being censored at the final timepoint (1 means they were censored)
* Y(t) is the outcome (an indicator of HCC diagnosis)

$U = (U_{L(t)}, U_{A(t)}, U_{C(t)}, U_{Y(t)},), t = 1,2,3,4,5$ ~ $P_U$

Structural Equations, F,  for t from 1 to 5:
\begin{align*}
W &= f_{W}(U_{W}) \\
L(1) &= f_{L(1)}(U_{L(1)}) \\
A(1) &= f_{A(1)}(W, L(1), U_{A(1)}) \\
L(t) &= f_{L(t)}(\bar{L}(t-1), \bar{A}(t-1), U_{L(t)}) \\
A(t) &= f_{A(t)}(W, \bar{L}(t), \bar{A}(t-1), U_{A(1)}) \\
C(t) &= f_{C(t)}(W, \bar{A}(t-1), \bar{Y}(t-1)) \\
Y(t) &= f_{Y(t)}(W, C(t), \bar{L}(t-1), \bar{A}(t-1), Y(t-1), U_{Y(t)}) \\
\end{align*}

## b. Proposed causal question

**What is the Causal Question (or questions) of interest for your dataset?**

For our project, we plan to ask whether frequency of primary care and hepatology visits at UCSF affect the likelihood of developing hepatocellular carcinoma (HCC) by the end of the follow up period among patients diagnosed with chronic hepatitis C (HCV), who were HCC-free at the beginning of the follow up interval.

**What is the ideal experiment that would answer your Causal Question?**

The ideal experiment to answer our Causal Question would be to deny people access to primary care and hepatology visits, and see how many developed HCC, then roll back the clock and give them access to just one visit annually (primary care OR hepatology) and see how many developed HCC, then roll back the clock and give them access to 1 visits annually and see how many developed HCC, then roll back the clock and give them access to 1 visits annually and see how many developed HCC, and so on.

**Which of your variables would you intervene on to answer your Causal Question(s)? What values would you set them equal to?**

We would intervene on $\bar{A}(t)$ to answer our Causal Question, and set them all equal to zero, then just one of the A timepoints equal to 1 (ultimately we might be interested in the effect of only A(1)=1 compared to only A(2)=1, compared to only A(3)=1, etc.), then each of them equal to 1. We also intervene on C(t) to ensure that all participants have outcome assessed at the end of the interval.

**What outcomes are you interested in? Measured when?**

We are interested in whether a patient is diagnosed with hepatocellular carcinoma, a liver cancer that commonly develops in people with liver cirrhosis (including as a result of chronic HCV infection) and has a very low survival rate. For our project, anyone diagnosed with HCC anytime before the final timepoint in the dataset (i.e. the date the data were pulled from the electronic medical record) will be counted as having the outcome.

**What are your counterfactual outcomes, and how would you explain them in words?**

  Our counterfactual outcomes are the prevalence of HCC at the end of study follow-up if no one had any primary care or hepatology visits, and the difference in prevalence of HCC at the end of study follow-up for every additional annual primary care or hepatology visit over the study period.

**What aspects of the counterfactual outcome distribution are you interested in contrasting?**
  
  We are interested in contrasting the counterfactual outcome from various numbers of primary care and/or hepatology visits with the counterfactual outcome from fewer visits, to see if there is some sort of exposure-response relationship.

**What contrast are you interested in (e.g., absolute difference? relative difference? MSMs? conditional on subgroups?)?**
  
  We are interested in a MSM that helps us understand the relationship between frequency of primary care or hepatology visits and risk of HCC diagnosis, conditional on FIB-4 score and a variety of other demographics.

**How would you intervene on the SCM you came up with to evaluate the causal target parameter?**

We will intervene to deterministically set $\bar{C}(t) = 1$ and $\bar{A}(t) = \bar{a}(t)$.

## c. Our Observed Data
<!-- armadillo! This bit needs to be re-done now that we have data-->

Many of the variables that we intend to use will be coming in the next data pull from the EMR, so we can't present histograms or tables of counts yet. Instead we've listed below each of the variables that we will have after the next data query and their variable types; we listed details for the  variables that we *do* have already.

* Number of Visits (annually)- this will be a count variable, at each year
* Diagnosed with HCC (annually)- this will be a binary yes/no
* FIB-4 Score (annually)- Based on previous literature (Sterling et al 2006), we expect these scores to range 0.2 to 10, with much of the probability mass below 1. 
* Gender- this will be a categorical variable, likely with three categories (man, woman and non-binary). Based on a prior (small) study of HCV patients at UCSF (Burman et al 2016), it is expected that the cohort will be approximately 70% men.
* Race- this will be a categorical variable. Based on a prior (small) study of HCV patients at UCSF (Burman et al 2016), it is expected that the cohort will be approximately 40% White, 20% Latinx, 30% Black and 10% other races.
* SES- we are using insurance type (MediCal or private) as a marker of SES status, which will be a categorical variable.
* Delta (annually)- is an indicator of missingness for FIB-4
* C (annually)- is an indicator of whether the patient has been censored. Based on our current data, we estimate that `r as.numeric(summary(HCVData$MOST_RECENT_HEPATOLOGY_APPT < as.POSIXct(strptime("2014-01-01", "%Y-%m-%d")))["FALSE"])-as.numeric(summary(HCVData$MOST_RECENT_HEPATOLOGY_APPT < as.POSIXct(strptime("2015-01-01", "%Y-%m-%d")))["FALSE"])` patients will be censored in the year 2015, `r as.numeric(summary(HCVData$MOST_RECENT_HEPATOLOGY_APPT < as.POSIXct(strptime("2015-01-01", "%Y-%m-%d")))["FALSE"])-as.numeric(summary(HCVData$MOST_RECENT_HEPATOLOGY_APPT < as.POSIXct(strptime("2016-01-01", "%Y-%m-%d")))["FALSE"])` in the year 2016, `r as.numeric(summary(HCVData$MOST_RECENT_HEPATOLOGY_APPT < as.POSIXct(strptime("2016-01-01", "%Y-%m-%d")))["FALSE"])-as.numeric(summary(HCVData$MOST_RECENT_HEPATOLOGY_APPT < as.POSIXct(strptime("2017-01-01", "%Y-%m-%d")))["FALSE"])` in the year 2017, and `r as.numeric(summary(HCVData$MOST_RECENT_HEPATOLOGY_APPT < as.POSIXct(strptime("2017-01-01",  "%Y-%m-%d")))["FALSE"])-as.numeric(summary(HCVData$MOST_RECENT_HEPATOLOGY_APPT < as.POSIXct(strptime("2018-01-01", "%Y-%m-%d")))["FALSE"])` in the year 2018. 

<!-- note that these numbers are just based on last hepatology visit since we don't have last primary care, so they're likely an OVERestimate--> 


### Missingness
  Note that we have FIB-4 scores calculated annually (when the appropriate components are available) from 2009 forward. Thus, we have a FIB-4 score available for `r as.numeric(summary(HCVData$totalFIB4BY2015==0)[2])/nrow(HCVData)` % of participants at the start of the study interval (calculated somewhere in 2009-2015). For the rest of the participants, we used multiple imputation to impute a 2015 FIB-4 score. For all participants, the FIB-4 score and years since measured are updated every year that all the requisite labs were measured. Thus, by the end of interval, `r as.numeric(summary(HCVData$totalFIB4BY2019==0)[2])/nrow(HCVData)` % of participants had a measured FIB-4 score rather than an imputed value.
  
  There is not missingness expected in the exposure-since EMRs are designed for clinical billing, the data on whether or not visit(s) occurred are expected to be highly accurate. Because HCC is a common and severe complication of HCV, we are comfortable assuming that a patient who is still followed in the system and does not yet have a diagnosis of HCC, is truly negative for HCC, rather than simply missing that data. Further, we will intervene at the end to ensure everyone has outcome measured.

Patients can be censored from the dataset in one of two ways: either by no longer seeking care within the UCSF system, or if they are deceased. 

## d. Identification Result and Estimand

**Under what assumptions is the target causal parameter identified as a function of the observed data distribution?**

Our target causal parameter is identified as a function of the observed data distribution under the assumptions that there is independence between each of the exogenous variables (i.e. there are no shared unknown variables influencing each of the endogenous nodes in our SCM) and that there are no practical positivity violations (i.e. there is a >0 probability of HCC among all of the baseline covariate and treatment regime combinations). In addition to controlling for any baseline covariates ($W$s), we also must rely on the sequential randomization assumption for our data generating process.

**What is your $\Psi(P_0)$, the statistical estimand?**

*Our statistical estimand is: $$\Psi(P_0) = m(\bar{a}|\beta) = E[Y_{\bar{a}}] = \beta_0 + \beta_1 \sum_{t=1}^8a(t)$$



#3. Estimation
## a. What estimators will you use?

-g comp and ltmle?

## b. How will you implement these estimators?

ltmle package?

#4. Preliminary Results
## a. Simulation
  To run our simulation, we first create a dataframe $O$ which includes all of the exogenous and endogenous variables in our SCM. Each of our $U_{W}, U_{C(t)}, \ \text{and} \ U_{Y(t)}$ variables have a uniform distribution with a min of 0 and max of 1. Each of our $U_{L(t)}$ variables have a gamma distribution with a shape parameter of 0.6 and scale parameter of 2.6. Each of our $U_{A(t)}$ variables have a negative binomial distribution with a dispersion parameter of 4 and a probability of 0.6. The shape and scale parameters for these distributions were chosen by having them reflect the distribution of variables in our observed data.
  
  For our endogenous variables:
  
* For $W$ we created a nominal categorical variable for the 16 possible different combinations of race, gender, and SES that apply to our dataset. 
* For the $L(t)$ variables, we set L(1) equal to the underlying $U_{L(1)}$ gamma distribution. In subsequent years, we set $L(t)$ to the FIB-4 score from the prior year ($L(t-1)$) and add 10% of the value generated by the underlying gamma distribution for $U_{L(t)}$ - i.e. we expect FIB-4 score to increase slightly each year as people's liver disease slowly progresses. 
* $A(t)$ is calculated by using the underlying poisson distribution for $U_{A(t)}$ plus FIB-4 score (adding more visits for higher FIB-4 scores, indicating worsening cirrhosis) 
* For the $C(t)$ variable, if a subject had no primary care or hepatology visits in the prior year they were censored; if they had at least one visit in the prior year then they were not censored. 
* For $Y(t)$ we calculated it as having a 10% chance of indicating HCC diagnosis if they had no visits over the prior interval, with a decreasing chance of HCC with every visit the subject had in the prior year and an increasing chance of HCC as the FIB-4 score rises, indicating worsening cirrhosis ($Y(t) = I(U_{Y(t)} + 0.01(A(t-1)) - 0.05(L(t-1))) < 0.03)$.

We then set a seed so our numbers could be replicated exactly, and generated data with n = 3000. The following table and plots describe the results of the simulation.

```{r simulation, include = FALSE}

generate_data <- function(n) {
  U <- data.frame(UW = runif(n = n, min = 0, max = 1),
                  UL1 = rgamma(n = n, shape = 1.5, scale = 2),
                  UA1 = rnbinom(n=n, size = 4, prob = 0.6),
                  UL2 = rgamma(n = n, shape = 1.5, scale = 2), 
                  UA2 = rnbinom(n=n, size = 4, prob = 0.6),
                  UY2 = runif(n = n, min = 0, max = 1),
                  UL3 = rgamma(n = n, shape = 1.5, scale = 2),
                  UA3 = rnbinom(n=n, size = 4, prob = 0.6),
                  UY3 = runif(n = n, min = 0, max = 1),
                  UL4 = rgamma(n = n, shape = 1.5, scale = 2),
                  UA4 = rnbinom(n=n, size = 4, prob = 0.6),
                  UY4 = runif(n = n, min = 0, max = 1),
                  UA5 = rnbinom(n=n, size = 4, prob = 0.6),
                  UC5 = runif(n = n, min = 0, max = 1), 
                  UY5 = runif(n = n, min = 0, max = 1))
  
  O <- U
  O <- O %>% 
    mutate(W = ifelse(UW < 1/16, 1,
                      ifelse(UW<2/16, 2,
                             ifelse(UW<3/16, 3, 
                                    ifelse(UW<4/16,4,
                                           ifelse(UW<5/16, 5,
                                                  ifelse(UW<6/16, 6, 
                                                         ifelse(UW<7/16, 7, 
                        ifelse(UW<8/16, 8, 
                               ifelse(UW<9/16, 9,
                                      ifelse(UW<10/16, 10,
                                             ifelse(UW<11/16, 11,
                                                    ifelse(UW<12/16, 12,
                                                           ifelse(UW<13/16, 13,
                                                                  ifelse(UW<14/16, 14,
                        ifelse(UW<15/16, 15, 16))))))))))))))),
           L1 = UL1,
           A1 = round(as.numeric(UA1 + 0.1*L1),0),
           L2 =  L1 + 0.1*UL2,
           A2 = round(as.numeric(UA2 + 0.1*L2),0),
           Y2 = as.numeric((UY2+0.01*A1-0.05*L1)< 0.03),
           L3 = ifelse(Y2==1, NA, L2 + 0.1*UL3),
           A3 = ifelse(Y2==1, NA, round(as.numeric(UA3 + 0.1*L3),0)),
           Y3 = ifelse(Y2==1, 1, as.numeric((UY3+0.01*A2-0.05*L2)< 0.03)),
           L4 = ifelse(Y3==1, NA, L3 + 0.1*UL4),
           A4 = ifelse(Y3==1, NA,round(as.numeric(UA4 + 0.1*L4),0)), 
           Y4 = ifelse(Y3==1, 1, as.numeric((UY4+0.01*A3-0.05*L3)< 0.03)),
           A5 = ifelse(Y4==1, NA,round(as.numeric(UA5 + 0.1*L4),0)), 
           C5 = ifelse(A5 == 0, 1, 0),
           Y5 = ifelse(Y4==1, 1, as.numeric((UY5+0.01*A4-0.05*L4)< 0.03)))
  return(O)
}

set.seed(8675309)
SimData <- generate_data(3000)

```

\vspace{20pt}

#### Cases of HCC in the Simulated Data

In our simulated dataset, there were `r sum(SimData$Y5, na.rm = TRUE)` cases of hepatocellular carcinoma (HCC) by the end of the study interval.


\vspace{20pt}

#### Histograms of Visits and FIB-4 Scores in the Simulated Data
Here are density plots demonstrating the distribution of FIB-4 scores over the years they were measured. 

```{r FIB4 Histograms, include = TRUE, echo = FALSE, out.width= '100%'}
#found at https://stackoverflow.com/questions/6957549/overlaying-histograms-with-ggplot2-in-r
# plot_multi_histogram <- function(df, feature, label_column) {
#     plt <- ggplot(df, aes(x=eval(parse(text=feature)), fill=eval(parse(text=label_column)))) +
#     geom_histogram(alpha=0.7, position="identity", aes(y = ..density..), color="black") +
#     geom_density(alpha=0.7) +
#     geom_vline(aes(xintercept=mean(eval(parse(text=feature)))), color="black", linetype="dashed", size=1) +
#     labs(x=feature, y = "Density")
#     plt + guides(fill=guide_legend(title=label_column))
# }

plot_multi_histonly <- function(df, feature, label_column) {
    plt <- ggplot(df, aes(x=eval(parse(text=feature)), fill=eval(parse(text=label_column)))) +
    geom_histogram(alpha=0.7, position="dodge", aes(y = ..density..), color="black") +
    geom_vline(aes(xintercept=mean(eval(parse(text=feature)))), color="black", linetype="dashed", size=1) +
    labs(x=feature, y = "Density")
    plt + guides(fill=guide_legend(title=label_column))
}

plot_multi_density <- function(df, feature, label_column) {
    plt <- ggplot(df, aes(x=eval(parse(text=feature)), fill=eval(parse(text=label_column)))) +
    geom_density(alpha=0.7) +
    geom_vline(aes(xintercept=mean(eval(parse(text=feature)))), color="black", linetype="dashed", size=1) +
    labs(x=feature, y = "Density")
    plt + guides(fill=guide_legend(title=label_column))
}

FIB4Only <- SimData %>% select(L1, L2, L3, L4)
FIB4Long <- FIB4Only %>% gather
FIB4Density <- plot_multi_density(FIB4Long, 'value', 'key')
suppressWarnings(print(FIB4Density))
```

\newpage
Here are histograms of the number of visits each patient had per year. 

```{r Hist of Visits, include = TRUE, echo = FALSE, message = FALSE}
VisitsOnly <- SimData %>% select(A1, A2, A3, A4)
VisitsLong <- VisitsOnly %>% gather
VisitsHist<- plot_multi_histonly(VisitsLong, 'value', 'key')
suppressWarnings(print(VisitsHist))
```



**Implement our intervention computationally.**

To do this, we use the simulation code written earlier, but adapt our function, replacing the structural equations for $\bar{C}(t)$ and  $\bar{A}(t)$ with flexible parameters allowing us to specify values for our intervention.

```{r intervene, include = FALSE}

generate_data_intervene <- function(n, c, a1, a2, a3, a4, a5) {
  U <- data.frame(UW = runif(n = n, min = 0, max = 1),
                  UL1 = rgamma(n = n, shape = 1.5, scale = 2),
                  UA1 = rnbinom(n=n, size = 4, prob = 0.6),
                  UL2 = rgamma(n = n, shape = 1.5, scale = 2), 
                  UA2 = rnbinom(n=n, size = 4, prob = 0.6),
                  UY2 = runif(n = n, min = 0, max = 1),
                  UL3 = rgamma(n = n, shape = 1.5, scale = 2),
                  UA3 = rnbinom(n=n, size = 4, prob = 0.6),
                  UY3 = runif(n = n, min = 0, max = 1),
                  UL4 = rgamma(n = n, shape = 1.5, scale = 2),
                  UA4 = rnbinom(n=n, size = 4, prob = 0.6),
                  UY4 = runif(n = n, min = 0, max = 1),
                  UA5 = rnbinom(n=n, size = 4, prob = 0.6),
                  UC5 = runif(n = n, min = 0, max = 1), 
                  UY5 = runif(n = n, min = 0, max = 1))
  
  O <- U
  O <- O %>% 
    mutate(W = ifelse(UW < 1/16, 1,
                      ifelse(UW<2/16, 2,
                             ifelse(UW<3/16, 3, 
                                    ifelse(UW<4/16,4,
                                           ifelse(UW<5/16, 5,
                                                  ifelse(UW<6/16, 6, 
                                                         ifelse(UW<7/16, 7, 
                        ifelse(UW<8/16, 8, 
                               ifelse(UW<9/16, 9,
                                      ifelse(UW<10/16, 10,
                                             ifelse(UW<11/16, 11,
                                                    ifelse(UW<12/16, 12,
                                                           ifelse(UW<13/16, 13,
                                                                  ifelse(UW<14/16, 14,
                        ifelse(UW<15/16, 15, 16))))))))))))))),
        
           L1 = UL1,
           A1 = a1,
           L2 =  L1 + 0.1*UL2,
           A2 = a2,
           Y2 = as.numeric((UY2+0.01*A1-0.05*L1)< 0.03),
           L3 = ifelse(Y2==1, NA, L2 + 0.1*UL3),
           A3 = ifelse(Y2==1, NA, a3),
           Y3 = ifelse(Y2==1, 1, as.numeric((UY3+0.01*A2-0.05*L2)< 0.03)),
           L4 = ifelse(Y3==1, NA, L3 + 0.1*UL4),
           A4 = ifelse(Y3==1, NA, a4), 
           Y4 = ifelse(Y3==1, 1, as.numeric((UY4+0.01*A3-0.05*L3)< 0.03)),
           A5 = ifelse(Y4==1, NA, a5), 
           C5 = 0,
           Y5 = ifelse(Y4==1, 1, as.numeric((UY5+0.01*A4-0.05*L4)< 0.03)))
  return(O)
}

```

**Generate many counterfactual outcomes, then evaluate $\Psi^F(P_{U,X})$**
```{r PsiF, include = FALSE}
set.seed(8675309)
n<-3000


x <- list(0:6)
TreatmentLevels<- expand.grid(rep(x, 5))

k <- nrow(TreatmentLevels)

for (i in 1:k){
  temporary <- as.vector(TreatmentLevels[i,])
df <- generate_data_intervene(
                          n = 3000,
                          c = 0,
                          a1 = as.numeric(temporary[1]),
                          a2 = as.numeric(temporary[2]),
                          a3 = as.numeric(temporary[3]),
                          a4 = as.numeric(temporary[4]),
                          a5 = as.numeric(temporary[5])
)

sum_abar <- rep(NA, k)
EY_abar <- rep(NA, k)
sum_abar[i] <- sum(as.numeric(temporary[1]) + as.numeric(temporary[2]) + as.numeric(temporary[3]) + as.numeric(temporary[4]) + as.numeric(temporary[5]))
EY_abar[i] <- mean(df$Y5)
}

```

For simplicity, we simulated counterfactual outcomes to try to determine $\Psi^F(P_{U,X})$ as the ratio between the proportion of patients diagnosed with HCC under the counterfactual scenario where $\bar{A}(t) = 6$ (all people had 6 visits per year, an extremely high number of visits), and $\bar{A} = 0$ (all people had no primary care or hepatology visits in any year). If we simulate data with n = 1000, then* $\Psi^F(P_{U,X})$ = `r round(PsiF, 3)`.

**Write a sentence interpreting your $\Psi^F(P_{U,X})$**

This means that people with very frequent primary care or hepatology visits ($\bar{A} = 6$ used to represent that in this example) are `r round(PsiFpercent, 1)`% more likely to develop HCC than people who have no primary care or hepatology visits ($\bar{A} = 0$) in the five years under study.

\vspace{24pt}

<!--### C. Confirm that in your simulation, the value of your estimand equals the value of your target causal parameter.-->

```{r IPTW, include = FALSE}
# sum_a <- rowSums(SimData[c("A1", "A2", "A3", "A4")])
# 
# g2A1 <- glm(A1 ~ L1, Y1, family = "poisson", data = SimData)
# g2A2 <- glm(A2 ~ L2, Y2, family = "poisson", data = SimData)
# g2A3 <- glm(A3 ~ L3, Y3, family = "poisson", data = SimData)
# g2A4 <- glm(A4 ~ L4, Y4, family = "poisson", data = SimData)
# 
# gA1_1 <- predict(g2A1, type = 'response')
# gA2_1 <- predict(g2A2, type = 'response')
# gA3_1 <- predict(g2A3, type = 'response')
# gA4_1 <- predict(g2A4, type = 'response')
# 
# gA1 <- mean(gA1_1)
# gA2 <- mean(gA2_1)
# gA3 <- mean(gA3_1)
# gA4 <- mean(gA4_1)

# w <- 1/(gA1 * gA2 * gA3 * gA4)
# 
# MSM <- glm(Y5 ~ sum_a, weights = w, data = SimData)
# beta1 <- coef(MSM)[2]
```

<!--*In our simulation, armadillo! ###NEED TO FINISH THIS###-->

## b. Data example

<!-- armadillo! ###NEED TO DO THIS###-->

## 5. References

Axley P, Ahmed Z, Ravi S, Singal AK. Hepatitis C Virus and Hepatocellular Carcinoma: A Narrative Review. J Clin Transl Hepatol. 2018 Mar 28; 6(1): 79-84.

Bosetti C, Turati F, La Vecchia C. Hepatocellular carcinoma epidemiology.Best Pract Res Clin Gastroenterol. 2014 Oct; 28(5):753-70.

Burman BE, Bacchetti P, Khalili M. Moderate Alcohol Use and Insulin Action in Chronic Hepatitis C Infection. Dig Dis Sci. 2016;61(8):2417-2425. doi:10.1007/s10620-016-4119-0

Burstow NJ, Mohamed Z, Gomaa AI, et al. Hepatitis C treatment: where are we now? Int J Gen Med 2017; 10:39-52.

Calle EE, Rodriguez C, Walker-Thurmond K, Thun MJ. Overweight, obesity, and mortality from cancer in a prospectively studied cohort of U.S. adults. N Engl J Med. 2003 Apr 24; 348(17):1625-38.

Chuang SC, Lee YC, Hashibe M, Dai M, Zheng T, Boffetta P. Interaction between cigarette smoking and hepatitis B and C virus infection on the risk of liver cancer: a meta-analysis. Cancer Epidemiol Biomarkers Prev. 2010 May; 19(5):1261-8.

Donato F, Tagger A, Gelatti U, Parrinello G, Boffetta P, Albertini A, Decarli A, Trevisi P, Ribero ML, Martelli C, Porru S, Nardi G. Alcohol and hepatocellular carcinoma: the effect of lifetime intake and hepatitis virus infections in men and women. Am J Epidemiol. 2002 Feb 15; 155(4):323-31.

El-Serag HB. Epidemiology of viral hepatitis and hepatocellular carcinoma. Gastroenterology. 2012 May; 142(6):1264-1273.e1.

European Association for Study of Liver. EASL Recommendations on Treatment of Hepatitis C 2015. 
J Hepatol. 2015 Jul; 63(1):199-236.

Huang TS, Lin CL, Lu MJ, Yeh CT, Liang KH, Sun CC, Shyu YC, Chien RN. Diabetes, hepatocellular carcinoma, and mortality in hepatitis C-infected patients: A population-based cohort study.
J Gastroenterol Hepatol. 2017 Jul; 32(7):1355-1362.

Khan MQ, Anand V, Hessefort N, Hassan A, Ahsan A, Sonnenberg A, Fimmel CJ. Utility of Electronic Medical record-based Fibrosis Scores in Predicting Advanced Cirrhosis in Patients with Hepatitic C Virus Infection. J Transl Int Med. 2017 Mar; 5(1): 43-48.

Omland LH, Krarup H, Jepsen P, Georgsen J, Harritsh?j LH, Riisom K, Jacobsen SE, Schouenborg P, Christensen PB, S?rensen HT, Obel N, DANVIR Cohort Study. Mortality in patients with chronic and cleared hepatitis C viral infection: a nationwide cohort study. J Hepatol. 2010 Jul; 53(1):36-42.

Sterling, R. K., Lissen, E. , Clumeck, N. , Sola, R. , Correa, M. C., Montaner, J. , S. Sulkowski, M. , Torriani, F. J., Dieterich, D. T., Thomas, D. L., Messinger, D. and Nelson, M. (2006), Development of a simple noninvasive index to predict significant fibrosis in patients with HIV/HCV coinfection. Hepatology, 43: 1317-1325. doi:10.1002/hep.21178